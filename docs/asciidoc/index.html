<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Stephane Maldini, Simon BaslÃ©">
<title>Reactor 3 Reference Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Reactor 3 Reference Guide</h1>
<div class="details">
<span id="author" class="author">Stephane Maldini</span><br>
<span id="email" class="email"><a href="https://twitter.com/smaldini">@smaldini</a></span><br>
<span id="author2" class="author">Simon BaslÃ©</span><br>
<span id="email2" class="email"><a href="https://twitter.com/simonbasle">@simonbasle</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#about-doc">1. About the Documentation</a>
<ul class="sectlevel2">
<li><a href="#_latest_version_copyright_notice">1.1. Latest Version &amp; Copyright Notice</a></li>
<li><a href="#_contributing_to_the_documentation">1.2. Contributing to the Documentation</a></li>
<li><a href="#_getting_help">1.3. Getting Help</a></li>
<li><a href="#_where_to_go_from_here">1.4. Where to Go from Here</a></li>
</ul>
</li>
<li><a href="#getting-started">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#getting-started-introducing-reactor">2.1. Introducing Reactor</a></li>
<li><a href="#prerequisites">2.2. Prerequisites</a></li>
<li><a href="#getting-started-understanding-bom">2.3. Understanding the BOM</a></li>
<li><a href="#getting">2.4. Getting Reactor</a></li>
</ul>
</li>
<li><a href="#intro-reactive">3. Introduction to Reactive Programming</a>
<ul class="sectlevel2">
<li><a href="#_blocking_can_be_wasteful">3.1. Blocking Can Be Wasteful</a></li>
<li><a href="#_asynchronicity_to_the_rescue">3.2. Asynchronicity to the Rescue?</a></li>
<li><a href="#_from_imperative_to_reactive_programming">3.3. From Imperative to Reactive Programming</a></li>
</ul>
</li>
<li><a href="#core-features">4. Reactor Core Features</a>
<ul class="sectlevel2">
<li><a href="#flux">4.1. <code>Flux</code>, an Asynchronous Sequence of 0-N Items</a></li>
<li><a href="#mono">4.2. <code>Mono</code>, an Asynchronous 0-1 Result</a></li>
<li><a href="#_simple_ways_to_create_a_flux_or_mono_and_subscribe_to_it">4.3. Simple Ways to Create a Flux or Mono and Subscribe to It</a></li>
<li><a href="#producing">4.4. Programmatically creating a sequence</a></li>
<li><a href="#schedulers">4.5. Threading and Schedulers</a></li>
<li><a href="#error.handling">4.6. Handling Errors</a></li>
<li><a href="#processors">4.7. Processors</a></li>
</ul>
</li>
<li><a href="#kotlin">5. Kotlin support</a>
<ul class="sectlevel2">
<li><a href="#kotlin-requirements">5.1. Requirements</a></li>
<li><a href="#kotlin-extensions">5.2. Extensions</a></li>
<li><a href="#kotlin-null-safety">5.3. Null Safety</a></li>
</ul>
</li>
<li><a href="#testing">6. Testing</a>
<ul class="sectlevel2">
<li><a href="#_testing_a_scenario_with_stepverifier">6.1. Testing a Scenario with <code>StepVerifier</code></a></li>
<li><a href="#_manipulating_time">6.2. Manipulating Time</a></li>
<li><a href="#_performing_post_execution_assertions_with_stepverifier">6.3. Performing Post-execution Assertions with <code>StepVerifier</code></a></li>
<li><a href="#_testing_the_context">6.4. Testing the <code>Context</code></a></li>
<li><a href="#_manually_emitting_with_testpublisher">6.5. Manually Emitting with <code>TestPublisher</code></a></li>
<li><a href="#_checking_the_execution_path_with_publisherprobe">6.6. Checking the Execution Path with <code>PublisherProbe</code></a></li>
</ul>
</li>
<li><a href="#debugging">7. Debugging Reactor</a>
<ul class="sectlevel2">
<li><a href="#_the_typical_reactor_stack_trace">7.1. The Typical Reactor Stack Trace</a></li>
<li><a href="#debug-activate">7.2. Activating Debug Mode - aka tracebacks</a></li>
<li><a href="#_reading_a_stack_trace_in_debug_mode">7.3. Reading a Stack Trace in Debug Mode</a></li>
<li><a href="#reactor-tools-debug">7.4. Production-ready Global Debugging</a></li>
<li><a href="#_logging_a_sequence">7.5. Logging a Sequence</a></li>
</ul>
</li>
<li><a href="#metrics">8. Exposing Reactor metrics</a>
<ul class="sectlevel2">
<li><a href="#_scheduler_metrics">8.1. Scheduler metrics</a></li>
<li><a href="#_publisher_metrics">8.2. Publisher metrics</a></li>
</ul>
</li>
<li><a href="#advanced">9. Advanced Features and Concepts</a>
<ul class="sectlevel2">
<li><a href="#advanced-mutualizing-operator-usage">9.1. Mutualizing Operator Usage</a></li>
<li><a href="#reactor.hotCold">9.2. Hot Versus Cold</a></li>
<li><a href="#advanced-broadcast-multiple-subscribers-connectableflux">9.3. Broadcasting to Multiple Subscribers with <code>ConnectableFlux</code></a></li>
<li><a href="#advanced-three-sorts-batching">9.4. Three Sorts of Batching</a></li>
<li><a href="#advanced-parallelizing-parralelflux">9.5. Parallelizing Work with <code>ParallelFlux</code></a></li>
<li><a href="#scheduler-factory">9.6. Replacing Default <code>Schedulers</code></a></li>
<li><a href="#hooks">9.7. Using Global Hooks</a></li>
<li><a href="#context">9.8. Adding a Context to a Reactive Sequence</a></li>
<li><a href="#cleanup">9.9. Dealing with Objects that Need Cleanup</a></li>
<li><a href="#null-safety">9.10. Null Safety</a></li>
</ul>
</li>
<li><a href="#which-operator">Appendix A: Which operator do I need?</a>
<ul class="sectlevel2">
<li><a href="#which.create">A.1. Creating a New Sequence&#8230;&#8203;</a></li>
<li><a href="#which.values">A.2. Transforming an Existing Sequence</a></li>
<li><a href="#which.peeking">A.3. Peeking into a Sequence</a></li>
<li><a href="#which.filtering">A.4. Filtering a Sequence</a></li>
<li><a href="#which.errors">A.5. Handling Errors</a></li>
<li><a href="#which.time">A.6. Working with Time</a></li>
<li><a href="#which.window">A.7. Splitting a <code>Flux</code></a></li>
<li><a href="#which.blocking">A.8. Going Back to the Synchronous World</a></li>
<li><a href="#which.multicasting">A.9. Multicasting a <code>Flux</code> to several <code>Subscribers</code></a></li>
</ul>
</li>
<li><a href="#faq">Appendix B: FAQ, Best Practices, and "How do I&#8230;&#8203;?"</a>
<ul class="sectlevel2">
<li><a href="#faq.wrap-blocking">B.1. How Do I Wrap a Synchronous, Blocking Call? å¦ä½åè£åæ­¥é»å¡å¼å«?</a></li>
<li><a href="#faq.chain">B.2. I Used an Operator on my <code>Flux</code> but it Doesn&#8217;t Seem to Apply. What Gives?</a></li>
<li><a href="#faq.retryWhen">B.3. How to Use <code>retryWhen</code> to Emulate <code>retry(3)</code>?</a></li>
<li><a href="#faq.exponentialBackoff">B.4. How can I use <code>retryWhen</code> for Exponential Backoff?</a></li>
<li><a href="#faq.thread-affinity-publishon">B.5. How Do I Ensure Thread Affinity when I Use <code>publishOn()</code>?</a></li>
<li><a href="#faq.mdc">B.6. What Is a Good Pattern for Contextual Logging? (MDC)</a></li>
</ul>
</li>
<li><a href="#reactor-extra">Appendix C: Reactor-Extra</a>
<ul class="sectlevel2">
<li><a href="#extra-tuples">C.1. <code>TupleUtils</code> and Functional Interfaces</a></li>
<li><a href="#extra-math">C.2. Math Operators With <code>MathFlux</code></a></li>
<li><a href="#extra-repeat-retry">C.3. Repeat and Retry Utilities</a></li>
<li><a href="#extra-schedulers">C.4. Schedulers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="about-doc"><a class="anchor" href="#about-doc"></a>1. About the Documentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section provides a brief overview of Reactor reference documentation. You do not
need to read this guide in a linear fashion. Each piece stands on its own, though they
often refer to other pieces.</p>
</div>
<div class="sect2">
<h3 id="_latest_version_copyright_notice"><a class="anchor" href="#_latest_version_copyright_notice"></a>1.1. Latest Version &amp; Copyright Notice</h3>
<div class="paragraph">
<p>The Reactor reference guide is available as HTML documents. The latest copy is available
at <a href="https://projectreactor.io/docs/core/release/reference/index.html" class="bare">https://projectreactor.io/docs/core/release/reference/index.html</a></p>
</div>
<div class="paragraph">
<p>Copies of this document may be made for your own use and for distribution to others,
provided that you do not charge any fee for such copies and further provided that each
copy contains this Copyright Notice, whether distributed in print or electronically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_contributing_to_the_documentation"><a class="anchor" href="#_contributing_to_the_documentation"></a>1.2. Contributing to the Documentation</h3>
<div class="paragraph">
<p>The reference guide is written in
<a href="https://asciidoctor.org/docs/asciidoc-writers-guide/">Asciidoc</a>, and you can find its sources at
<a href="https://github.com/reactor/reactor-core/tree/master/docs/asciidoc" class="bare">https://github.com/reactor/reactor-core/tree/master/docs/asciidoc</a>.</p>
</div>
<div class="paragraph">
<p>If you have an improvement or a suggestion, we will be happy to get a pull request from you!</p>
</div>
<div class="paragraph">
<p>We recommend that you check out a local copy of the repository so that you can
generate the documentation by running the <code>asciidoctor</code> gradle task and checking the
rendering. Some of the sections rely on included files, so GitHub rendering is
not always complete.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To facilitate documentation edits, most sections have a link at the end that opens
an edit UI directly on GitHub for the main source file for that section. These links are
only present in the HTML5 version of this reference guide. They look like the following:
<a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/aboutDoc.adoc" class="fa fa-edit" target="_blank" rel="noopener">Suggest Edit</a> to <a href="#about-doc">About the Documentation</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_help"><a class="anchor" href="#_getting_help"></a>1.3. Getting Help</h3>
<div class="paragraph">
<p>You can reach out for help in several ways with Reactor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get in touch with the community on <a href="https://gitter.im/reactor/reactor">Gitter</a>.</p>
</li>
<li>
<p>Ask a question on stackoverflow.com at
<a href="https://stackoverflow.com/tags/project-reactor"><code>project-reactor</code></a>.</p>
</li>
<li>
<p>Report bugs in Github issues. We closely monitor the following repositories:
<a href="https://github.com/reactor/reactor-core/issues">reactor-core</a> (which covers the
essential features) and <a href="https://github.com/reactor/reactor-addons/issues">reactor-addons</a>
(which covers reactor-test and adapters issues).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All of Reactor is open source,
<a href="https://github.com/reactor/reactor-core/tree/master/docs/asciidoc">including this
documentation</a>. If you find problems with the docs or if you want to improve them,
please <a href="https://github.com/reactor/.github/blob/master/CONTRIBUTING.md">get involved</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_where_to_go_from_here"><a class="anchor" href="#_where_to_go_from_here"></a>1.4. Where to Go from Here</h3>
<div class="ulist">
<ul>
<li>
<p>å¦æä½ åæ¬¢ç´æ¥å¼å§ä»£ç ï¼è¯·è·³è½¬å°  <a href="#getting-started">Getting Started</a></p>
</li>
<li>
<p>å¦æä½ ç¬¬ä¸æ¬¡æ¥è§¦ reactive ç¼ç¨, ä½ åºè¯¥ä»
<a href="#intro-reactive">Introduction to Reactive Programming</a> å¼å§.</p>
</li>
<li>
<p>å¦æä½ æ¯è¾çæ Reactor ç¸å³æå¿µï¼åªæ¯æ³ä¸ºå·¥ä½ä¸­æ¾äºæ­£ç¡®å°æ¹æ³ï¼ä½æ¯å¯¹ç¨åªäºè¿ç®ç¬¦æä¸æ¯å¾äºè§£ï¼ä½ å¯ä»¥è®¿é® <a href="#which-operator">Which operator do I need?</a> éå½.</p>
</li>
<li>
<p>ä¸ºäºæ´æ·±å¥å¯¹äºè§£ Reactor æ ¸å¿åè½, ç¹å» <a href="#core-features">Reactor Core Features</a> å­¦ä¹ ç¸å³åå®¹:</p>
<div class="ulist">
<ul>
<li>
<p>æ´å¤å¯¹å­¦ä¹ äºè§£ Reactor&#8217;s ååºç±»åï¼å¨ <a href="#flux"><code>Flux</code>, an Asynchronous Sequence of 0-N Items</a> å <a href="#mono"><code>Mono</code>, an Asynchronous 0-1 Result</a>
ç« èä¸­.</p>
</li>
<li>
<p>å¦ä½éä¸­çº¿ç¨ä¸ä¸æå»ä½¿ç¨ <a href="#schedulers">a scheduler</a>.</p>
</li>
<li>
<p>å¦ä½æè·å¤çéè¯¯ <a href="#error.handling">Handling Errors</a> ç« è.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Unit ååæµè¯? æ¯ä»¥éè¿ <code>reactor-test</code> é¡¹ç®åå°! æ¥ç <a href="#testing">Testing</a>.</p>
</li>
<li>
<p><a href="#producing">Programmatically creating a sequence</a> å­¦ä¹ è·å¤é«çº§çæ¹æ³å»åå»º reactive æºç .</p>
</li>
<li>
<p>å¶ä»é«çº§ä¸»é¢é½å¨ <a href="#advanced">Advanced Features and Concepts</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/aboutDoc.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#about-doc">About the Documentation</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>2. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>æ¬ç« èé½åå®¹ä¿¡æ¯å°å¸®å©å¤§å®¶æ´å¥½çå­¦ä¹ çè§£Reactorï¼ä¸»è¦åæ¬ä»¥ä¸å°èåå®¹</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#getting-started-introducing-reactor">Introducing Reactor</a></p>
</li>
<li>
<p><a href="#prerequisites">Prerequisites</a></p>
</li>
<li>
<p><a href="#getting-started-understanding-bom">Understanding the BOM</a></p>
</li>
<li>
<p><a href="#getting">Getting Reactor</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="getting-started-introducing-reactor"><a class="anchor" href="#getting-started-introducing-reactor"></a>2.1. Introducing Reactor</h3>
<div class="paragraph">
<p>Reactor æ¯ä¸ä¸ªç»äºJVMå®ç°çå®å¨éå µå¡ç reactive ç¼ç¨åºç¡, å·æé«æç demand ç®¡ç (ä»¥ "`backpressure`"çå½¢å¼ç®¡ç). å®ä»¬ç´æ¥ä¸Java 8 ç
functional APIs å°±è¡äºæ´å, ç¹å«æ´åäº <code>CompletableFuture</code>, <code>Stream</code>, and
<code>Duration</code>. æä¾äºä¸ç³»åçå¯ç»åçå¼æ­¥ APIs&#8201;&#8212;&#8201;<code>Flux</code> (ä¸ºäº [N] åç´ ) and
<code>Mono</code> (ä¸ºäº [0|1] åç´ )&#8201;&#8212;&#8201;å¹¶å¤§éçå®ç°äº
<a href="https://www.reactive-streams.org/">Reactive Streams</a> è§èè¦æ±.</p>
</div>
<div class="paragraph">
<p>Reactor è¿æ¯æä¸ç»äº`reactor-netty` çé¡¹ç®è¿è¡éå µå¡çè¿ç¨é´çéä¿¡
. éç¨äºå¾®æå¡æ¶æ, Reactor Netty ä¸º  HTTP (åæ¬ Websockets), TCP, and UDP
æä¾äºæ¯æ backpressure çç½ç»å¼æ. Reactive çç¼ç ä¸è§£ç æ¹å¼æ¯å®å¨æ¯æ.</p>
</div>
</div>
<div class="sect2">
<h3 id="prerequisites"><a class="anchor" href="#prerequisites"></a>2.2. Prerequisites</h3>
<div class="paragraph">
<p>Reactor Core runs on <code>Java 8</code> and above.</p>
</div>
<div class="paragraph">
<p>It has a transitive dependency on <code>org.reactivestreams:reactive-streams:1.0.3</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Android Support</div>
<div class="ulist">
<ul>
<li>
<p>Reactor 3 does not officially support or target Android (consider using RxJava 2 if
such support is a strong requirement).</p>
</li>
<li>
<p>However, it should work fine with Android SDK 26 (Android O) and above.</p>
</li>
<li>
<p>We are open to evaluating changes that benefit Android support in a best-effort
fashion. However, we cannot make guarantees. Each decision must be made on a
case-by-case basis.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="getting-started-understanding-bom"><a class="anchor" href="#getting-started-understanding-bom"></a>2.3. Understanding the BOM</h3>
<div class="paragraph">
<p>Reactor 3 uses a BOM (Bill of Materials) model (since <code>reactor-core 3.0.4</code>, with the <code>Aluminium</code> release train).
This curated list groups artifacts that are meant to work well together, providing
the relevant versions despite potentially divergent versioning schemes in these artifacts.</p>
</div>
<div class="paragraph">
<p>The BOM is itself versioned, using a release train scheme
with a codename followed by a qualifier. The following list shows a few examples:</p>
</div>
<div class="verseblock">
<pre class="content">Aluminium-RELEASE
Californium-BUILD-SNAPSHOT
Aluminium-SR1
Bismuth-RELEASE
Californium-SR32</pre>
</div>
<div class="paragraph">
<p>The codenames represent what would traditionally be the MAJOR.MINOR number. They (mostly)
come from the <a href="https://en.wikipedia.org/wiki/Periodic_table#Overview">Periodic Table of
Elements</a>, in increasing alphabetical order.</p>
</div>
<div class="paragraph">
<p>The qualifiers are (in chronological order):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BUILD-SNAPSHOT</code>: Builds for development and testing.</p>
</li>
<li>
<p><code>M1</code>..<code>N</code>: Milestones or developer previews.</p>
</li>
<li>
<p><code>RELEASE</code>: The first GA (General Availability) release in a codename series.</p>
</li>
<li>
<p><code>SR1</code>..<code>N</code>: The subsequent GA releases in a codename series&#8201;&#8212;&#8201;equivalent to a PATCH
number. (SR stands for &#8220;Service Release&#8221;).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="getting"><a class="anchor" href="#getting"></a>2.4. Getting Reactor</h3>
<div class="paragraph">
<p>As <a href="#getting-started-understanding-bom">mentioned earlier</a>, the easiest way to use Reactor in your core is to use the BOM and
add the relevant dependencies to your project. Note that, when you add such a dependency,
you must omit the version so that the version gets picked up from the BOM.</p>
</div>
<div class="paragraph">
<p>However, if you want to force the use of a specific artifact&#8217;s version, you can specify
it when adding your dependency, as you usually would. You can also forgo the BOM entirely
and specify dependencies by their artifact versions.</p>
</div>
<div class="sect3">
<h4 id="_maven_installation"><a class="anchor" href="#_maven_installation"></a>2.4.1. Maven Installation</h4>
<div class="paragraph">
<p>Maven natively supports the BOM concept. First, you need to import the BOM by
adding the following snippet to your <code>pom.xml</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencyManagement&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
            &lt;artifactId&gt;reactor-bom&lt;/artifactId&gt;
            &lt;version&gt;Bismuth-RELEASE&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice the <code>dependencyManagement</code> tag. This is in addition to the regular
<code>dependencies</code> section.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>If the top section (<code>dependencyManagement</code>) already exists in your pom, add only the contents.</p>
</div>
<div class="paragraph">
<p>Next, add your dependencies to the relevant reactor projects, as usual, except without a
<code>&lt;version&gt;</code>, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
        &lt;artifactId&gt;reactor-core&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
        &lt;artifactId&gt;reactor-test&lt;/artifactId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dependency on the core library.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>No version tag here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>reactor-test</code> provides facilities to unit test reactive streams.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gradle_installation"><a class="anchor" href="#_gradle_installation"></a>2.4.2. Gradle Installation</h4>
<div class="paragraph">
<p>Prior to version 5.0, Gradle has no core support for Maven BOMs, but you can use Spring&#8217;s
<a href="https://github.com/spring-gradle-plugins/dependency-management-plugin">gradle-dependency-management</a>
plugin.</p>
</div>
<div class="paragraph">
<p>First, apply the plugin from the Gradle Plugin Portal, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id "io.spring.dependency-management" version "1.0.7.RELEASE" <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>as of this writing, 1.0.7.RELEASE is the latest version of the plugin.
Check for updates.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Then use it to import the BOM, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencyManagement {
     imports {
          mavenBom "io.projectreactor:reactor-bom:Bismuth-RELEASE"
     }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally add a dependency to your project, without a version number, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
     implementation 'io.projectreactor:reactor-core' <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There is no third <code>:</code> separated section for the version. It is taken from
the BOM.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Since Gradle 5.0, you can use the native Gradle support for BOMs:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
     implementation platform('io.projectreactor:reactor-bom:Bismuth-RELEASE')
     implementation 'io.projectreactor:reactor-core' <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There is no third <code>:</code> separated section for the version. It is taken from
the BOM.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_milestones_and_snapshots"><a class="anchor" href="#_milestones_and_snapshots"></a>2.4.3. Milestones and Snapshots</h4>
<div class="paragraph">
<p>Milestones and developer previews are distributed through the Spring Milestones
repository rather than Maven Central. To add it to your build configuration
file, use the following snippet:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Milestones in Maven</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
	&lt;repository&gt;
		&lt;id&gt;spring-milestones&lt;/id&gt;
		&lt;name&gt;Spring Milestones Repository&lt;/name&gt;
		&lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
	&lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For Gradle, use the following snippet:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Milestones in Gradle</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">repositories {
  maven { url 'https://repo.spring.io/milestone' }
  mavenCentral()
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, snapshots are also available in a separate dedicated repository, as the following example show:</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. BUILD-SNAPSHOTs in Maven</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
	&lt;repository&gt;
		&lt;id&gt;spring-snapshots&lt;/id&gt;
		&lt;name&gt;Spring Snapshot Repository&lt;/name&gt;
		&lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
	&lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. BUILD-SNAPSHOTs in Gradle</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">repositories {
  maven { url 'https://repo.spring.io/snapshot' }
  mavenCentral()
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/gettingStarted.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#getting-started">Getting Started</a>"</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="intro-reactive"><a class="anchor" href="#intro-reactive"></a>3. Introduction to Reactive Programming</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Reactor æ¯ååºå¼ç¼ç¨èä¾çå®ç°ï¼å¯ä»¥æ»ç»å¦ä¸:</p>
</div>
<div class="quoteblock">
<blockquote>
Reactive ç¼ç¨æ¯ä¸ç§å¼æ­¥ç¼ç¨èå¼ï¼å®æ¶åæ°æ®æµåååçä¼ æ­.
ç°å¨å¯ä»¥éè¿æéç¨çç¼ç¨è¯­è¨è½»æ¾è¡¨è¾¾éæï¼ä¾å¦æ°ç»ï¼æå¨æï¼ä¾å¦äºä»¶åå°å¨ï¼æ°æ®æµã
</blockquote>
<div class="attribution">
&#8212; https://en.wikipedia.org/wiki/Reactive_programming
</div>
</div>
<div class="paragraph">
<p>As a first step in the direction of reactive programming, Microsoft created the Reactive
Extensions (Rx) library in the .NET ecosystem. Then RxJava implemented reactive
programming on the JVM.  As time went on, a standardization for Java emerged through the
Reactive Streams effort, a specification that defines a set of interfaces and
interaction rules for reactive libraries on the JVM. Its interfaces have been
integrated into Java 9 under the <code>Flow</code> class.</p>
</div>
<div class="paragraph">
<p>ä½ä¸ºååºå¼ç¼ç¨æ¹åä¸çç¬¬ä¸æ­¥ï¼Microsoftå¨.NETçæç³»ç»ä¸­åå»ºäºååºå¼æ©å±ï¼Rxï¼åºã
ç¶åRxJavaå¨JVMä¸å®ç°äºååºå¼ç¼ç¨ãéçæ¶é´çæµéï¼éè¿Reactive Streamsçåªååºç°äºJavaçæ ååï¼
è¯¥è§èå®ä¹äºJVMä¸çååºåºçä¸ç»æ¥å£åäº¤äºè§åãå®çæ¥å£å·²éæå°äºJava 9ä¸­çFlowç±»ä¸ã</p>
</div>
<div class="paragraph">
<p>The reactive programming paradigm is often presented in object-oriented languages as an
extension of the Observer design pattern. You can also compare the main reactive streams
pattern with the familiar Iterator design pattern, as there is a duality to the
<code>Iterable</code>-<code>Iterator</code> pair in all of these libraries. One major difference is that, while
an Iterator is pull-based, reactive streams are push-based.</p>
</div>
<div class="paragraph">
<p>ååºå¼ç¼ç¨èä¾éå¸¸ä»¥é¢åå¯¹è±¡çè¯­è¨è¡¨ç¤ºï¼åæ¯ä¸ä¸ªObserverè®¾è®¡æ¨¡å¼çæ©å±ã
æ¨è¿å¯ä»¥å°ä¸»è¦çååºæµæ¨¡å¼ä¸çæçIteratorè®¾è®¡æ¨¡å¼è¿è¡æ¯è¾ï¼å ä¸ºææè¿äºåºä¸­çIterable- Iteratorå¯¹é½æåéæ§ ã
ä¸ä¸ªä¸»è¦çåºå«æ¯ï¼è½ç¶Iteratoræ¯åºäºpullçï¼ä½æ¯ååºæµå´æ¯åºäºpushçã</p>
</div>
<div class="paragraph">
<p>Using an iterator is an imperative programming pattern, even though the method of
accessing values is solely the responsibility of the <code>Iterable</code>. Indeed, it is up to the
developer to choose when to access the <code>next()</code> item in the sequence. In reactive
streams, the equivalent of the above pair is <code>Publisher-Subscriber</code>. But it is the
<code>Publisher</code> that notifies the Subscriber of newly available values <em>as they come</em>, and
this push aspect is the key to being reactive. Also, operations applied to pushed values
are expressed declaratively rather than imperatively: The programmer expresses the logic
of the computation rather than describing its exact control flow.</p>
</div>
<div class="paragraph">
<p>ä½¿ç¨è¿­ä»£å¨æ¯å½ä»¤å¼ç¼ç¨æ¨¡å¼ï¼å³ä½¿è®¿é®å¼çæ¹æ³ä»ç±è´è´£Iterableã
å®éä¸ï¼ç±å¼åäººåå³å®ä½æ¶éæ©next()åºåä¸­çé¡¹ç®ã
å¨ååºæµä¸­ï¼ä¸è¿°å¯¹çç­ä»·ç©ä¸ºPublisher-Subscriberã
ä½æ¯ï¼å½ Publisheræ°å¯ç¨å¼åºç°æ¶ï¼æ­£æ¯éç¥è®¢æ·ï¼èè¿ä¸æ¨å¨æ¹é¢æ¯ååºååºçå³é®ã
åæ ·ï¼åºç¨äºæ¨å¥å¼çæä½ä»¥å£°ææ¹å¼èä¸æ¯å½ä»¤æ¹å¼è¡¨ç¤ºï¼ç¨åºåè¡¨ç¤ºè®¡ç®çé»è¾ï¼èä¸æ¯æè¿°å¶ç¡®åçæ§å¶æµç¨ã</p>
</div>
<div class="paragraph">
<p>In addition to pushing values, the error-handling and completion aspects are also covered
in a well defined manner. A <code>Publisher</code> can push new values to its <code>Subscriber</code> (by
calling <code>onNext</code>) but can also signal an error (by calling <code>onError</code>) or completion (by
calling <code>onComplete</code>). Both errors and completion terminate the sequence. This can
be summed up as follows:</p>
</div>
<div class="paragraph">
<p>é¤äºæ¨éå¼ä¹å¤ï¼è¿ä»¥æç¡®å®ä¹çæ¹å¼æ¶µçäºéè¯¯å¤çåå®ææ¹é¢ã
A Publisherå¯ä»¥Subscriberï¼éè¿è°ç¨onNextï¼å°æ°å¼æ¨å¥å¶å¼ï¼ä½ä¹å¯ä»¥ååºéè¯¯ä¿¡å·ï¼è°ç¨onErrorï¼æå®æä¿¡å·ï¼éè¿è°ç¨onCompleteï¼ã
éè¯¯åå®æé½ä¼ç»æ­¢åºåãå¯ä»¥æ»ç»å¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>onNext x 0..N [onError | onComplete]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach is very flexible. The pattern supports use cases where there is no value,
one value, or n values (including an infinite sequence of values, such as the continuing
ticks of a clock).</p>
</div>
<div class="paragraph">
<p>è¿ç§æ¹æ³éå¸¸çµæ´»ãè¯¥æ¨¡å¼æ¯ææ²¡æå¼ï¼ä¸ä¸ªå¼ænä¸ªå¼ï¼åæ¬æ éä¸ªæå¼åºåï¼ä¾å¦æ¶éçè¿ç»­æ»´ç­å£°ï¼çç¨ä¾ã</p>
</div>
<div class="paragraph">
<p>But why do we need such an asynchronous reactive library in the first place?</p>
</div>
<div class="paragraph">
<p>ä½æ¯ä¸ºä»ä¹æä»¬é¦åéè¦è¿æ ·çå¼æ­¥ååºå¼åºï¼</p>
</div>
<div class="sect2">
<h3 id="_blocking_can_be_wasteful"><a class="anchor" href="#_blocking_can_be_wasteful"></a>3.1. Blocking Can Be Wasteful</h3>
<div class="paragraph">
<p>Modern applications can reach huge numbers of concurrent users, and, even though the
capabilities of modern hardware have continued to improve, performance of
modern software is still a key concern.</p>
</div>
<div class="paragraph">
<p>ç°ä»£åºç¨ç¨åºå¯ä»¥å¸å¼å¤§éçå¹¶åç¨æ·ï¼å³ä½¿ç°ä»£ç¡¬ä»¶çåè½ä¸æ­æé«ï¼ç°ä»£è½¯ä»¶çæ§è½ä»ç¶æ¯å³é®é®é¢ã</p>
</div>
<div class="paragraph">
<p>There are, broadly, two ways one can improve a program&#8217;s performance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>parallelize</strong> to use more threads and more hardware resources.</p>
</li>
<li>
<p><strong>seek more efficiency</strong> in how current resources are used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>å¹¿ä¹ä¸è®²ï¼æä¸¤ç§æ¹æ³å¯ä»¥æé«ç¨åºçæ§è½ï¼</p>
</div>
<div class="paragraph">
<p>å¹¶è¡ä½¿ç¨æ´å¤çº¿ç¨åæ´å¤ç¡¬ä»¶èµæºã</p>
</div>
<div class="paragraph">
<p>å¨ä½¿ç¨ç°æèµæºæ¹é¢å¯»æ±æ´é«çæçã</p>
</div>
<div class="paragraph">
<p>Usually, Java developers write programs by using blocking code. This practice
is fine until there is a performance bottleneck. Then it is time
to introduce additional threads, running similar blocking code. But this
scaling in resource utilization can quickly introduce contention and concurrency
problems.</p>
</div>
<div class="paragraph">
<p>éå¸¸ï¼Javaå¼åäººåéè¿ä½¿ç¨é»å¡ä»£ç æ¥ç¼åç¨åºãé¤éå­å¨æ§è½ç¶é¢ï¼å¦åè¿ç§åæ³å¾å¥½ã
ç¶åæ¯æ¶åå¼å¥å¶ä»çº¿ç¨ï¼è¿è¡ç±»ä¼¼çé»å¡ä»£ç äºãä½æ¯è¿ç§èµæºå©ç¨çæ©å±ä¼è¿éå¼å¥ç«äºåå¹¶åé®é¢ã</p>
</div>
<div class="paragraph">
<p>Worse still, blocking wastes resources. If you look closely, as soon as a
program involves some latency (notably I/O, such as a database request or a
network call), resources are wasted because threads (possibly many threads)
now sit idle, waiting for data.</p>
</div>
<div class="paragraph">
<p>æ´ç³ç³çæ¯ï¼é»å¡ä¼æµªè´¹èµæºã
å¦æä»ç»è§å¯ï¼ç¨åºä¸æ¦éå°ä¸äºå»¶è¿ï¼ç¹å«æ¯I / Oï¼ä¾å¦æ°æ®åºè¯·æ±æç½ç»è°ç¨ï¼ï¼å°±ä¼æµªè´¹èµæºï¼
å ä¸ºçº¿ç¨ï¼å¯è½æå¾å¤çº¿ç¨ï¼ç°å¨å¤äºç©ºé²ç¶æï¼ç­å¾æ°æ®ã</p>
</div>
<div class="paragraph">
<p>So the parallelization approach is not a silver bullet. It is necessary
to access the full power of the hardware, but it is also complex to
reason about and susceptible to resource wasting.</p>
</div>
<div class="paragraph">
<p>å æ­¤ï¼å¹¶è¡åæ¹æ³ä¸æ¯çµä¸¹å¦è¯ãæå¿è¦è®¿é®ç¡¬ä»¶çå¨é¨åè½ï¼ä½æ¯æ¨çåèµæºæµªè´¹ä¹å¾å¤æã</p>
</div>
</div>
<div class="sect2">
<h3 id="_asynchronicity_to_the_rescue"><a class="anchor" href="#_asynchronicity_to_the_rescue"></a>3.2. Asynchronicity to the Rescue?</h3>
<div class="paragraph">
<p>The second approach mentioned earlier, seeking more efficiency, can be a solution
to the resource wasting problem. By writing asynchronous, non-blocking code,
you let the execution switch to another active task that uses the same underlying
resources and later comes back to the current process when the asynchronous
processing has finished.</p>
</div>
<div class="paragraph">
<p>åé¢æå°çç¬¬äºç§æ¹æ³ï¼å¯»æ±æ´é«çæçï¼å¯ä»¥è§£å³èµæºæµªè´¹çé®é¢ã
éè¿ç¼åå¼æ­¥çéé»å¡ä»£ç ï¼æ¨å¯ä»¥å°æ§è¡åæ¢å°ä½¿ç¨ç¸ååºç¡èµæºçå¦ä¸ä¸ªæ´»å¨ä»»å¡ï¼
å¹¶å¨å¼æ­¥å¤çå®æåè¿åå°å½åè¿ç¨ã</p>
</div>
<div class="paragraph">
<p>But how can you produce asynchronous code on the JVM? Java offers two models of
asynchronous programming:</p>
</div>
<div class="paragraph">
<p>ä½æ¯å¦ä½å¨JVMä¸çæå¼æ­¥ä»£ç ï¼Javaæä¾äºä¸¤ç§å¼æ­¥ç¼ç¨æ¨¡åï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Callbacks</strong>: Asynchronous methods do not have a return value but take an extra
<code>callback</code> parameter (a lambda or anonymous class) that gets called when the result is
available. A well known example is Swing&#8217;s <code>EventListener</code> hierarchy.</p>
</li>
<li>
<p><strong>Futures</strong>: Asynchronous methods <em>immediately</em> return a <code>Future&lt;T&gt;</code>. The asynchronous
process computes a <code>T</code> value, but the <code>Future</code> object wraps access to it. The value is
not immediately available, and the object can be polled until the value is available. For
instance, an <code>ExecutorService</code> running <code>Callable&lt;T&gt;</code> tasks use <code>Future</code> objects.</p>
</li>
<li>
<p><strong>Callbacks</strong>: å¼æ­¥æ¹æ³æ²¡æè¿åå¼ï¼ä½å¸¦æä¸ä¸ªé¢å¤ç callbackåæ°ï¼lambdaæå¿åç±»ï¼ï¼è¯¥åæ°å¨ç»æå¯ç¨æ¶è¢«è°ç¨ãä¸ä¸ªèåçä¾å­æ¯SwingçEventListenerå±æ¬¡ç»æ.</p>
</li>
<li>
<p><strong>Futures</strong>: å¼æ­¥æ¹æ³ç«å³è¿åFuture&lt;T&gt;ãå¼æ­¥è¿ç¨è®¡ç®ä¸ä¸ªTå¼ï¼ä½æ¯Futureå¯¹è±¡åè£äºå¯¹å¶çè®¿é®ãè¯¥å¼ä¸æ¯ç«å³å¯ç¨çï¼å¹¶ä¸å¯ä»¥è½®è¯¢è¯¥å¯¹è±¡ï¼ç´å°è¯¥å¼å¯ç¨ä¸ºæ­¢ãä¾å¦ï¼ExecutorServiceæ­£å¨è¿è¡çCallable&lt;T&gt;ä»»å¡ä½¿ç¨Futureå¯¹è±¡.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Are these techniques good enough? Not for every use case, and both approaches have
limitations.</p>
</div>
<div class="paragraph">
<p>è¿äºææ¯å¤å¥½åï¼å¹¶ééå¯¹æ¯ä¸ªç¨ä¾ï¼è¿ä¸¤ç§æ¹æ³é½æå±éæ§ã</p>
</div>
<div class="paragraph">
<p>Callbacks are hard to compose together, quickly leading to code that is difficult to read
and maintain (known as &#8220;Callback Hell&#8221;).</p>
</div>
<div class="paragraph">
<p>åè°å¾é¾ç»åå¨ä¸èµ·ï¼è¿éå¯¼è´é¾ä»¥éè¯»åç»´æ¤çä»£ç ï¼ç§°ä¸ºâåè°å°ç±âï¼ã</p>
</div>
<div class="paragraph">
<p>Consider an example: showing the top five favorites from a user on the UI or suggestions
if she does not have a favorite. This goes through three services (one gives favorite IDs,
the second fetches favorite details, and the third offers suggestions with details), as
follows:</p>
</div>
<div class="paragraph">
<p>èèä¸ä¸ªç¤ºä¾ï¼å¨ç¨æ·çé¢ä¸æ¾ç¤ºç¨æ·çåäºä¸ªæ¶èå¤¹ï¼å¦ææ²¡ææ¶èå¤¹åæ¾ç¤ºå»ºè®®ãè¿éè¦ä¸é¡¹æå¡ï¼ä¸é¡¹æä¾åæ¬¢çIDï¼ç¬¬äºé¡¹è·ååæ¬¢çè¯¦ç»ä¿¡æ¯ï¼ç¬¬ä¸é¡¹æä¾å¸¦æè¯¦ç»ä¿¡æ¯çå»ºè®®ï¼ï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Example of Callback Hell</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">userService.getFavorites(userId, new Callback&lt;List&lt;String&gt;&gt;() { <i class="conum" data-value="1"></i><b>(1)</b>
  public void onSuccess(List&lt;String&gt; list) { <i class="conum" data-value="2"></i><b>(2)</b>
    if (list.isEmpty()) { <i class="conum" data-value="3"></i><b>(3)</b>
      suggestionService.getSuggestions(new Callback&lt;List&lt;Favorite&gt;&gt;() {
        public void onSuccess(List&lt;Favorite&gt; list) { <i class="conum" data-value="4"></i><b>(4)</b>
          UiUtils.submitOnUiThread(() -&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
            list.stream()
                .limit(5)
                .forEach(uiList::show); <i class="conum" data-value="6"></i><b>(6)</b>
            });
        }

        public void onError(Throwable error) { <i class="conum" data-value="7"></i><b>(7)</b>
          UiUtils.errorPopup(error);
        }
      });
    } else {
      list.stream() <i class="conum" data-value="8"></i><b>(8)</b>
          .limit(5)
          .forEach(favId -&gt; favoriteService.getDetails(favId, <i class="conum" data-value="9"></i><b>(9)</b>
            new Callback&lt;Favorite&gt;() {
              public void onSuccess(Favorite details) {
                UiUtils.submitOnUiThread(() -&gt; uiList.show(details));
              }

              public void onError(Throwable error) {
                UiUtils.errorPopup(error);
              }
            }
          ));
    }
  }

  public void onError(Throwable error) {
    UiUtils.errorPopup(error);
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬æåºäºåè°çæå¡ï¼ä¸ç§Callbackæ¥å£ï¼è¯¥æ¥å£çæ¹æ³å¨å¼æ­¥è¿ç¨æåæ¶è¢«è°ç¨ï¼å¨éè¯¯åçæ¶è¢«è°ç¨ã.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ç¬¬ä¸ä¸ªæå¡ä½¿ç¨æ¶èå¤¹IDåè¡¨è°ç¨å¶åè°.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¦æåè¡¨ä¸ºç©ºï¼åå¿é¡»è½¬å°suggestionService.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>å¨suggestionServiceç»åºäºä¸ä¸ªList&lt;Favorite&gt;å°ç¬¬äºä¸ªåè°.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ç±äºæä»¬å¤ççæ¯UIï¼å æ­¤æä»¬éè¦ç¡®ä¿ä½¿ç¨çä»£ç å¨UIçº¿ç¨ä¸­è¿è¡.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>æä»¬ä½¿ç¨Java 8 Streamå°å¤ççå»ºè®®æ°éå¶ä¸ºäºä¸ªï¼å¹¶å¨UIçå¾å½¢åè¡¨ä¸­æ¾ç¤ºå®ä»¬.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>å¨æ¯ä¸ªçº§å«ï¼æä»¬ä»¥ç¸åçæ¹å¼å¤çéè¯¯ï¼å¨å¼¹åºçªå£ä¸­æ¾ç¤ºå®ä»¬.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>è¿åæ¶èå¤¹IDçº§å«ãå¦ææå¡è¿åäºå®æ´åè¡¨ï¼åéè¦è½¬å°favoriteServiceä»¥è·åè¯¦ç»çFavoriteå¯¹è±¡ãç±äºæä»¬åªéè¦äºä¸ªï¼å æ­¤æä»¬é¦åä¼ è¾IDåè¡¨ä»¥å°å¶éå¶ä¸ºäºä¸ª.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>åä¸æ¬¡ï¼åè°ãè¿æ¬¡ï¼æä»¬å¾å°äºä¸ä¸ªå®æ´çFavoriteå¯¹è±¡ï¼æä»¬å°è¯¥å¯¹è±¡åå¥UIçº¿ç¨ä¸­çUI.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>That is a lot of code, and it is a bit hard to follow and has repetitive parts.
Consider its equivalent in Reactor:</p>
</div>
<div class="paragraph">
<p>é£æ¯å¾å¤ä»£ç ï¼å¾é¾éµå¾ªå¹¶ä¸åå«éå¤çé¨åãèèå®å¨Reactorä¸­çç­æåè½:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Example of Reactor code equivalent to callback code</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">userService.getFavorites(userId) <i class="conum" data-value="1"></i><b>(1)</b>
           .flatMap(favoriteService::getDetails) <i class="conum" data-value="2"></i><b>(2)</b>
           .switchIfEmpty(suggestionService.getSuggestions()) <i class="conum" data-value="3"></i><b>(3)</b>
           .take(5) <i class="conum" data-value="4"></i><b>(4)</b>
           .publishOn(UiUtils.uiThreadScheduler()) <i class="conum" data-value="5"></i><b>(5)</b>
           .subscribe(uiList::show, UiUtils::errorPopup); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬ä»æ¶èå¤¹IDçæµå¼å§.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬å°è¿äºå¼æ­¥è½¬æ¢ä¸ºè¯¦ç»çFavoriteå¯¹è±¡ï¼flatMapï¼ãç°å¨æä»¬æä¸ä¸ªæµç¨Favorite.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¦æçæµç¨Favoriteä¸ºç©ºï¼åéè¿åæ¢å°åå¤å¹¿å suggestionService.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>æä»¬æå¤åªå¯¹ç»ææµä¸­çäºä¸ªåç´ æå´è¶£.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>æåï¼æä»¬è¦å¤çUIçº¿ç¨ä¸­çæ¯ä¸ªæ°æ®.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>æä»¬éè¿æè¿°å¦ä½å¤çæ°æ®çæç»å½¢å¼ï¼å¨UIåè¡¨ä¸­æ¾ç¤ºï¼ä»¥ååçéè¯¯çæåµï¼æ¾ç¤ºå¼¹åºçªå£ï¼æ¥è§¦åæµç¨.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>What if you want to ensure the favorite IDs are retrieved in less than 800ms or, if it
takes longer, get them from a cache? In the callback-based code, that is a complicated
task. In Reactor it becomes as easy as adding a <code>timeout</code> operator in the chain, as follows:</p>
</div>
<div class="paragraph">
<p>å¦æè¦ç¡®ä¿å¨å°äº800æ¯«ç§çæ¶é´åæ£ç´¢åæ¬¢çIDï¼æèå¦æè±è´¹æ´é¿çæ¶é´æä»¬å°±ä»ç¼å­ä¸­è·åå®ä»¬ï¼è¯¥æä¹åï¼
å¨åºäºåè°çä»£ç ä¸­ï¼è¿æ¯ä¸é¡¹å¤æçä»»å¡ãå¨Reactorä¸­ï¼å°±åå¨é¾ä¸­æ·»å ä¸ä¸ªtimeoutè¿ç®ç¬¦ä¸æ ·å®¹æï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Example of Reactor code with timeout and fallback</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">userService.getFavorites(userId)
           .timeout(Duration.ofMillis(800)) <i class="conum" data-value="1"></i><b>(1)</b>
           .onErrorResume(cacheService.cachedFavoritesFor(userId)) <i class="conum" data-value="2"></i><b>(2)</b>
           .flatMap(favoriteService::getDetails) <i class="conum" data-value="3"></i><b>(3)</b>
           .switchIfEmpty(suggestionService.getSuggestions())
           .take(5)
           .publishOn(UiUtils.uiThreadScheduler())
           .subscribe(uiList::show, UiUtils::errorPopup);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>å¦æä»¥ä¸é¨åå¨800msåæ²¡æååºä»»ä½åï¼åä¼ æ­ä¸ä¸ªéè¯¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦æåçéè¯¯ï¼è¯·éåå°cacheService.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>é¾çå¶ä½é¨åä¸åé¢çç¤ºä¾ç¸ä¼¼.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p><code>Future</code> objects are a bit better than callbacks, but they still do not do well at composition,
despite the improvements brought in Java 8 by <code>CompletableFuture</code>. Orchestrating multiple
<code>Future</code> objects together is doable but not easy. Also, <code>Future</code> has other problems:</p>
</div>
<div class="paragraph">
<p>Futureå¯¹è±¡æ¯åè°è¦å¥½ä¸äºï¼ä½æ¯å°½ç®¡Java 8å¸¦æ¥äºæ¹è¿ï¼ä½å®ä»¬å¨ç»åæ¹é¢ä»ç¶è¡¨ç°ä¸ä½³CompletableFutureã
Futureä¸èµ·ç¼æå¤ä¸ª å¯¹è±¡æ¯å¯è¡çï¼ä½å¹¶ä¸å®¹æãå¦å¤ï¼Futureè¿æå¶ä»é®é¢ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is easy to end up with another blocking situation with <code>Future</code> objects by calling
the <code>get()</code> method.</p>
</li>
<li>
<p>They do not support lazy computation.</p>
</li>
<li>
<p>They lack support for multiple values and advanced error handling.</p>
</li>
<li>
<p>Futureéè¿è°ç¨è¯¥get()æ¹æ³å¾å®¹æå¯¼è´å¯¹è±¡çå¦ä¸ç§é»å¡æåµ.</p>
</li>
<li>
<p>å®ä»¬ä¸æ¯ææ°æ§è®¡ç®.</p>
</li>
<li>
<p>ä»ä»¬ç¼ºä¹å¯¹å¤ä¸ªå¼åé«çº§éè¯¯å¤ççæ¯æ.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider another example: We get a list of IDs from which we want to fetch a name and a
statistic and combine these pair-wise, all of it asynchronously. The following example
does so with a list of type <code>CompletableFuture</code>:</p>
</div>
<div class="paragraph">
<p>åçä¸ä¸ªä¾å­ï¼æä»¬å¾å°ä¸ä¸ªIDåè¡¨ï¼æä»¬è¦ä»ä¸­è·åä¸ä¸ªåç§°åä¸ä¸ªç»è®¡ä¿¡æ¯ï¼å¹¶å°å®ä»¬æå¯¹ç»åï¼ææè¿äºä¿¡æ¯é½æ¯å¼æ­¥çã
ä»¥ä¸ç¤ºä¾ä½¿ç¨ç±»ååè¡¨è¿è¡æä½CompletableFuture:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Example of <code>CompletableFuture</code> combination</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CompletableFuture&lt;List&lt;String&gt;&gt; ids = ifhIds(); <i class="conum" data-value="1"></i><b>(1)</b>

CompletableFuture&lt;List&lt;String&gt;&gt; result = ids.thenComposeAsync(l -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
	Stream&lt;CompletableFuture&lt;String&gt;&gt; zip =
			l.stream().map(i -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
				CompletableFuture&lt;String&gt; nameTask = ifhName(i); <i class="conum" data-value="4"></i><b>(4)</b>
				CompletableFuture&lt;Integer&gt; statTask = ifhStat(i); <i class="conum" data-value="5"></i><b>(5)</b>

				return nameTask.thenCombineAsync(statTask, (name, stat) -&gt; "Name " + name + " has stats " + stat); <i class="conum" data-value="6"></i><b>(6)</b>
			});
	List&lt;CompletableFuture&lt;String&gt;&gt; combinationList = zip.collect(Collectors.toList()); <i class="conum" data-value="7"></i><b>(7)</b>
	CompletableFuture&lt;String&gt;[] combinationArray = combinationList.toArray(new CompletableFuture[combinationList.size()]);

	CompletableFuture&lt;Void&gt; allDone = CompletableFuture.allOf(combinationArray); <i class="conum" data-value="8"></i><b>(8)</b>
	return allDone.thenApply(v -&gt; combinationList.stream()
			.map(CompletableFuture::join) <i class="conum" data-value="9"></i><b>(9)</b>
			.collect(Collectors.toList()));
});

List&lt;String&gt; results = result.join(); <i class="conum" data-value="10"></i><b>(10)</b>
assertThat(results).contains(
		"Name NameJoe has stats 103",
		"Name NameBart has stats 104",
		"Name NameHenry has stats 105",
		"Name NameNicole has stats 106",
		"Name NameABSLAJNFOAJNFOANFANSF has stats 121");</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬ä»ä¸ä¸ªå¯ä»¥ä¸ºæä»¬æä¾idä»·å¼æ¸åçFutureå¼å§.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä¸æ¦è·å¾åè¡¨ï¼æä»¬æ³å¼å§æ´æ·±å±æ¬¡çå¼æ­¥å¤ç.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¯¹äºåè¡¨ä¸­çæ¯ä¸ªåç´ :</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>å¼æ­¥è·åå³èåç§°.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å¼æ­¥è·åå³èçä»»å¡.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>åå¹¶ä¸¤ä¸ªç»æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>ç°å¨ï¼æä»¬æäºä»£è¡¨ææç»åä»»å¡çæè´§æ¸åãè¦æ§è¡è¿äºä»»å¡ï¼æä»¬éè¦å°åè¡¨è½¬æ¢ä¸ºæ°ç».</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>å°æ°ç»ä¼ éç»CompletableFuture.allOfï¼å¨ææä»»å¡å®æåè¾åºCompletableFuture.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>æ£æçä¸ç¹æ¯allOfreturn CompletableFuture&lt;Void&gt;ï¼å æ­¤æä»¬å¨æè´§åè¡¨ä¸éç³ï¼éè¿ä½¿ç¨æ¶éå¶ç»æjoin() ï¼æ­¤å¤ä¸ä¼é»å¡ï¼å ä¸ºallOfç¡®ä¿äºæè´§å¨é¨å®æäºï¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>ä¸æ¦æ´ä¸ªå¼æ­¥ç®¡éè¢«è§¦åï¼æä»¬ç­å¾å®è¢«å¤çå¹¶è¿åç»æåè¡¨.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Since Reactor has more combination operators out of the box, this process can be
simplified, as follows:</p>
</div>
<div class="paragraph">
<p>ç±äºReactoræä¾äºæ´å¤ç»åè¿ç®ç¬¦ï¼å æ­¤å¯ä»¥ç®åæ­¤è¿ç¨ï¼å¦ä¸æç¤º</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Example of Reactor code equivalent to future code</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; ids = ifhrIds(); <i class="conum" data-value="1"></i><b>(1)</b>

Flux&lt;String&gt; combinations =
		ids.flatMap(id -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
			Mono&lt;String&gt; nameTask = ifhrName(id); <i class="conum" data-value="3"></i><b>(3)</b>
			Mono&lt;Integer&gt; statTask = ifhrStat(id); <i class="conum" data-value="4"></i><b>(4)</b>

			return nameTask.zipWith(statTask, <i class="conum" data-value="5"></i><b>(5)</b>
					(name, stat) -&gt; "Name " + name + " has stats " + stat);
		});

Mono&lt;List&lt;String&gt;&gt; result = combinations.collectList(); <i class="conum" data-value="6"></i><b>(6)</b>

List&lt;String&gt; results = result.block(); <i class="conum" data-value="7"></i><b>(7)</b>
assertThat(results).containsExactly( <i class="conum" data-value="8"></i><b>(8)</b>
		"Name NameJoe has stats 103",
		"Name NameBart has stats 104",
		"Name NameHenry has stats 105",
		"Name NameNicole has stats 106",
		"Name NameABSLAJNFOAJNFOANFANSF has stats 121"
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è¿æ¬¡ï¼æä»¬ä»idsï¼a Flux&lt;String&gt;ï¼çå¼æ­¥æä¾åºåå¼å§.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¯¹äºåºåä¸­çæ¯ä¸ªåç´ ï¼æä»¬ï¼å¨ä¸»ä½flatMapè°ç¨çå½æ°åé¨ï¼å¼æ­¥å¤çä¸¤æ¬¡.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>è·åå³èçåç§°.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>è·åç¸å³çç»è®¡ä¿¡æ¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å¼æ­¥ç»åä¸¤ä¸ªå¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>å½å¼å¯ç¨å®æå¯ç¨æ¶ï¼å°å¼æ±æ»å°Listä¸­.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>å¨çäº§ä¸­ï¼æä»¬å°Fluxéè¿è¿ä¸æ­¥ç»åæè®¢éæ¥ç»§ç»­å¼æ­¥å¤çãå¾å¯è½ä¼è¿åresult Monoãç±äºæä»¬æ­£å¨æµè¯ä¸­ï¼å æ­¤æä»¬æ¹ä¸ºé»å¡ï¼ç­å¾å¤çå®æï¼ç¶åç´æ¥è¿åæ±æ»çå¼åè¡¨.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>å£°æç»æ.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The perils of using callbacks and <code>Future</code> objects are similar and are what reactive programming
addresses with the <code>Publisher-Subscriber</code> pair.</p>
</div>
<div class="paragraph">
<p>ä½¿ç¨åè°åFutureå¯¹è±¡çé£é©æ¯ç¸ä¼¼çï¼è¿æ¯ååºå¼ç¼ç¨Publisher-Subscriberå®ä»¬ä¸èµ·è¦è§£å³çé®é¢</p>
</div>
</div>
<div class="sect2">
<h3 id="_from_imperative_to_reactive_programming"><a class="anchor" href="#_from_imperative_to_reactive_programming"></a>3.3. From Imperative to Reactive Programming</h3>
<div class="paragraph">
<p>Reactive libraries, such as Reactor, aim to address these drawbacks of &#8220;classic&#8221;
asynchronous approaches on the JVM while also focusing on a few additional aspects:</p>
</div>
<div class="paragraph">
<p>ååºæ§åºï¼ä¾å¦Reactorï¼æ¨å¨è§£å³JVMä¸âç»å¸âå¼æ­¥æ¹æ³çè¿äºç¼ºç¹ï¼åæ¶è¿çéäºå¶ä»ä¸äºæ¹é¢ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Composability</strong> and <strong>readability</strong></p>
</li>
<li>
<p>Data as a <strong>flow</strong> manipulated with a rich vocabulary of <strong>operators</strong></p>
</li>
<li>
<p>Nothing happens until you <strong>subscribe</strong></p>
</li>
<li>
<p><strong>Backpressure</strong> or <em>the ability for the consumer to signal the producer that the rate of
emission is too high</em></p>
</li>
<li>
<p><strong>High level</strong> but <strong>high value</strong> abstraction that is <em>concurrency-agnostic</em></p>
</li>
<li>
<p>å¯ç»åæ§åå¯è¯»æ§</p>
</li>
<li>
<p>ä»¥ä¸°å¯çè¿ç®ç¬¦è¯æ±æçºµæ°æ®æµ</p>
</li>
<li>
<p>subscribeä¹åæ²¡æä»»ä½ååº</p>
</li>
<li>
<p><strong>Backpressure</strong> ææ¶è´¹èåçäº§èååºææ¾éçè¿é«ä¿¡å·çè½å</p>
</li>
<li>
<p>å¹¶åä¸å¯ç¥çé«çº§ä½é«ä»·å¼çæ½è±¡</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_composability_and_readability"><a class="anchor" href="#_composability_and_readability"></a>3.3.1. Composability and Readability</h4>
<div class="paragraph">
<p>By &#8220;composability&#8221;, we mean the ability to orchestrate multiple asynchronous tasks, in
which we use results from previous tasks to feed input to subsequent ones.
Alternatively, we can run several tasks in a fork-join style.
In addition, we can reuse asynchronous tasks as discrete components in a
higher-level system.</p>
</div>
<div class="paragraph">
<p>The ability to orchestrate tasks is tightly coupled to the readability and
maintainability of code. As the layers of asynchronous processes increase in both number
and complexity, being able to compose and read code becomes increasingly difficult. As we
saw, the callback model is simple, but one of its main drawbacks is that, for complex
processes, you need to have a callback executed from a callback, itself nested inside
another callback, and so on. That mess is known as &#8220;Callback Hell&#8221;. As you can guess (or
know from experience), such code is pretty hard to go back to and reason about.</p>
</div>
<div class="paragraph">
<p>Reactor offers rich composition options, wherein code mirrors the organization of the
abstract process, and everything is generally kept at the same level (nesting is
minimized).</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_assembly_line_analogy"><a class="anchor" href="#_the_assembly_line_analogy"></a>3.3.2. The Assembly Line Analogy</h4>
<div class="paragraph">
<p>You can think of data processed by a reactive application as moving through an assembly
line. Reactor is both the conveyor belt and the workstations. The raw material pours from
a source (the original <code>Publisher</code>) and ends up as a finished product ready to be pushed
to the consumer (or <code>Subscriber</code>).</p>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥å°ååºå¼åºç¨ç¨åºå¤ççæ°æ®è§ä¸ºæµæ°´çº¿ãååºå æ¢æ¯ä¼ éå¸¦åæ¯å·¥ä½ç«ãåææä»æ¥æºï¼åå§Publisherï¼å¾æ³»èåºï¼æç»æä¸ºåå¤å¥½æ¨åæ¶è´¹èï¼æSubscriberï¼çæå</p>
</div>
<div class="paragraph">
<p>The raw material can go through various transformations and other intermediary steps or
be part of a larger assembly line that aggregates intermediate pieces together. If there
is a glitch or clogging at one point (perhaps boxing the products takes a
disproportionately long time), the afflicted workstation can signal upstream to limit the
flow of raw material.</p>
</div>
<div class="paragraph">
<p>åææå¯ä»¥ç»è¿åç§è½¬æ¢åå¶ä»ä¸­é´æ­¥éª¤ï¼ä¹å¯ä»¥æä¸ºå°ä¸­é´ä»¶èéå¨ä¸èµ·çè¾å¤§è£éçº¿çä¸é¨åãå¦ææä¸ç¹åºç°æéæå µå¡ï¼ä¹è®¸è£ç®±äº§åè±è´¹çæ¶é´è¿é¿ï¼ï¼é£ä¹åç¾çå·¥ä½ç«å¯ä»¥åä¸æ¸¸ååºä¿¡å·ï¼ä»¥éå¶åææçæµå¨</p>
</div>
</div>
<div class="sect3">
<h4 id="_operators"><a class="anchor" href="#_operators"></a>3.3.3. Operators</h4>
<div class="paragraph">
<p>In Reactor, operators are the workstations in our assembly analogy. Each operator adds
behavior to a <code>Publisher</code> and wraps the previous step&#8217;s <code>Publisher</code> into a new instance.
The whole chain is thus linked, such that data originates from the first <code>Publisher</code> and
moves down the chain, transformed by each link. Eventually, a <code>Subscriber</code> finishes the
process. Remember that nothing happens until a <code>Subscriber</code> subscribes to a <code>Publisher</code>,
as we see shortly.</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­ï¼æä½åæ¯æä»¬è£éç±»æ¯ä¸­çå·¥ä½ç«ãæ¯ä¸ªè¿ç®ç¬¦é½å°è¡ä¸ºæ·»å å°Publisherï¼å¹¶å°ä¸ä¸æ­¥åè£Publisherå°æ°å®ä¾ä¸­ã
å æ­¤ï¼æ´ä¸ªé¾è¢«é¾æ¥å¨ä¸èµ·ï¼è¿æ ·æ°æ®å°±ä»ç¬¬ä¸ä¸ªPublisheré¾å¼å§å¹¶åä¸ç§»å¨ï¼å¹¶ç±æ¯ä¸ªé¾æ¥è½¬æ¢ã
æç»ï¼Subscriberå®æè¯¥è¿ç¨ãè¯·è®°ä½ï¼ç´å°a Subscriberè®¢éäºPublisherï¼ä»ä¹é½ä¸ä¼åçï¼æ­£å¦æä»¬å¾å¿«çå°çé£æ ·ã</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Understanding that operators create new instances can help you avoid a common
mistake that would lead you to believe that an operator you used in your chain is not
being applied. See this <a href="#faq.chain">item</a> in the FAQ.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While the Reactive Streams specification does not specify operators at all, one of the
best added values of reactive libraries, such as Reactor, is the rich vocabulary of
operators that they provide. These cover a lot of ground, from simple transformation and
filtering to complex orchestration and error handling.</p>
</div>
<div class="paragraph">
<p>è½ç¶ååºå¼æµè§èæ ¹æ¬æ²¡ææå®è¿ç®ç¬¦ï¼
ä½æ¯ååºå¼åºçæä½³éå å¼ä¹ä¸ï¼ä¾å¦Reactorï¼æ¯å®ä»¬æä¾çè¿ç®ç¬¦çä¸°å¯è¯æ±è¡¨ã
ä»ç®åçè½¬æ¢åè¿æ»¤å°å¤æçç¼æåéè¯¯å¤çï¼è¿äºåå®¹æ¶åå¾å¤é¢å</p>
</div>
</div>
<div class="sect3">
<h4 id="reactive.subscribe"><a class="anchor" href="#reactive.subscribe"></a>3.3.4. Nothing Happens Until You <code>subscribe()</code></h4>
<div class="paragraph">
<p>In Reactor, when you write a <code>Publisher</code> chain, data does not start pumping into it by
default. Instead, you create an abstract description of your asynchronous process (which
can help with reusability and composition).</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­ï¼å½æ¨ç¼åPublisheré¾æ¶ï¼é»è®¤æåµä¸ä¸ä¼å¼å§å°æ°æ®æ³µå¥é¾ä¸­ã
ç¸åï¼æ¨å¯ä»¥åå»ºå¼æ­¥è¿ç¨çæ½è±¡æè¿°ï¼è¿æå©äºéç¨åç»åï¼ã</p>
</div>
<div class="paragraph">
<p>By the act of <strong>subscribing</strong>, you tie the <code>Publisher</code> to a <code>Subscriber</code>, which triggers
the flow of data in the whole chain. This is achieved internally by a single <code>request</code>
signal from the <code>Subscriber</code> that is propagated upstream, all the way back to the source
<code>Publisher</code>.</p>
</div>
<div class="paragraph">
<p>éè¿subscribingæä½ï¼æ¨å¯ä»¥å°ç»å®Publisherå°Subscriberï¼ä»èè§¦åæ´ä¸ªé¾ä¸­çæ°æ®æµã
è¿æ¯éè¿request æ¥èªçä¿¡å·å¨åé¨å®ç°çï¼è¯¥ä¿¡å·å¨Subscriberä¸æ¸¸ä¼ æ­ï¼ä¸ç´ä¼ åå°ä¿¡å·æº Publisherã</p>
</div>
</div>
<div class="sect3">
<h4 id="reactive.backpressure"><a class="anchor" href="#reactive.backpressure"></a>3.3.5. Backpressure</h4>
<div class="paragraph">
<p>Propagating signals upstream is also used to implement <strong>backpressure</strong>, which we described
in the assembly line analogy as a feedback signal sent up the line when a workstation
processes more slowly than an upstream workstation.</p>
</div>
<div class="paragraph">
<p>ä¸æ¸¸ä¼ æ­çä¿¡å·ä¹ç¨äºå®ç°èåï¼æä»¬å¨ç»è£æµæ°´çº¿ä¸­å°å¶æè¿°ä¸ºå½å·¥ä½ç«çå¤çéåº¦æ¯ä¸æ¸¸å·¥ä½ç«æ¢æ¶ï¼æ²¿çäº§çº¿åä¸åéçåé¦ä¿¡å·ã</p>
</div>
<div class="paragraph">
<p>The real mechanism defined by the Reactive Streams specification is pretty close to the
analogy: A subscriber can work in <em>unbounded</em> mode and let the source push all the data
at its fastest achievable rate or it can use the <code>request</code> mechanism to signal the source
that it is ready to process at most <code>n</code> elements.</p>
</div>
<div class="paragraph">
<p>Reactive Streamsè§èå®ä¹çå®éæºå¶ä¸ç±»æ¨éå¸¸æ¥è¿ï¼
subscriber å¯ä»¥ä»¥æ çæ¨¡å¼å·¥ä½ï¼å¹¶è®©æºä»¥æå¿«å¯è¾¾å°çéçæ¨éæææ°æ®ï¼æèå¯ä»¥ä½¿ç¨è¯¥requestæºå¶åæºååºå·²åå¤å°±ç»ªçä¿¡å·å¤çæå¤çnåç´ ã</p>
</div>
<div class="paragraph">
<p>Intermediate operators can also change the request in-transit. Imagine a <code>buffer</code>
operator that groups elements in batches of ten. If the subscriber requests one buffer, it
is acceptable for the source to produce ten elements. Some operators also implement
<strong>prefetching</strong> strategies, which avoid <code>request(1)</code> round-trips and is beneficial
if producing the elements before they are requested is not too costly.</p>
</div>
<div class="paragraph">
<p>ä¸­é´çIntermediateè¿å¯ä»¥å¨éä¸­æ´æ¹è¯·æ±ãæ³è±¡ä¸ä¸ï¼ä¸ä¸ªbuffer è¿ç®ç¬¦å°åç´ ä»¥åä¸ªä¸ºä¸ç»è¿è¡åç»ã
å¦æsubscriberè¯·æ±ä¸ä¸ªç¼å²åºï¼åæºäº§çåä¸ªåç´ æ¯å¯ä»¥æ¥åçã
ä¸äºoperatorsè¿å®æ½äº é¢åç­ç¥ï¼è¯¥ç­ç¥å¯é¿årequest(1)å¾è¿ï¼å¹¶ä¸å¦æå¨è¯·æ±ä¹åçäº§åç´ çææ¬ä¸å¤ªé«çè¯ï¼åæ¯æççã</p>
</div>
<div class="paragraph">
<p>This transforms the push model into a <strong>push-pull hybrid</strong>, where the downstream can pull n
elements from upstream if they are readily available. But if the elements are not ready,
they get pushed by the upstream whenever they are produced.</p>
</div>
<div class="paragraph">
<p>è¿ä¼å°æ¨æ¨¡åè½¬æ¢ä¸ºæ¨ææ··åæ¨¡åï¼å¦æä¸æ¸¸å¯ä»¥éæ¶ä½¿ç¨ï¼åä¸æ¸¸å¯ä»¥ä»ä¸æ¸¸æånä¸ªåç´ ã
ä½æ¯ï¼å¦æåç´ å°æªåå¤å°±ç»ªï¼åæ¯å½å®ä»¬è¢«çäº§æ¶å°±ä¼è¢«ä¸æ¸¸æ¨åºã</p>
</div>
</div>
<div class="sect3">
<h4 id="reactive.hotCold"><a class="anchor" href="#reactive.hotCold"></a>3.3.6. Hot vs Cold</h4>
<div class="paragraph">
<p>The Rx family of reactive libraries distinguishes two broad categories of
reactive sequences: <strong>hot</strong> and <strong>cold</strong>. This distinction mainly has to do with how the
reactive stream reacts to subscribers:</p>
</div>
<div class="paragraph">
<p>Rxååºåºçå®¶æå°ååºåºååä¸ºä¸¤å¤§ç±»ï¼ç­åå·ãè¿ç§åºå«ä¸»è¦ä¸ååºæµå¯¹è®¢æ·çååºæå³ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>Cold</strong> sequence starts anew for each <code>Subscriber</code>, including at the source of data.
For example, if the source wraps an HTTP call, a new HTTP request is made for each subscription.</p>
</li>
<li>
<p>A <strong>Hot</strong> sequence does not start from scratch for each <code>Subscriber</code>. Rather, late
subscribers receive signals emitted <em>after</em> they subscribed. Note, however, that some hot
reactive streams can cache or replay the history of emissions totally or partially. From
a general perspective, a hot sequence can even emit when no subscriber is listening (an
exception to the &#8220;nothing happens before you subscribe&#8221; rule).</p>
</li>
<li>
<p>æ¯ä¸ä¸ªå·åºåé½éæ°å¼å§Subscriberï¼åæ¬å¨æ°æ®æºå¤ãä¾å¦ï¼å¦ææºåè£äºä¸ä¸ªHTTPè°ç¨ï¼åä¼ä¸ºæ¯ä¸ªè®¢éååºä¸ä¸ªæ°çHTTPè¯·æ±.</p>
</li>
<li>
<p>æ¯ä¸ªHotåºåé½ä¸æ¯ä»å¤´å¼å§çSubscriberãç¸åï¼åæç¨æ·æ¥æ¶ååºçä¿¡å·åï¼ä»ä»¬è®¤è´­ãä½æ¯è¯·æ³¨æï¼æäºç­ååºæµå¯ä»¥å¨é¨æé¨åç¼å­æéæ¾ææ¾åå²ãä»ä¸è¬çè§åº¦æ¥çï¼å³ä½¿æ²¡æè®¢éèå¨æ¶å¬ï¼ç­åºåçè³ä¼ååºï¼âè®¢éä¹åä»ä¹ä¹æ²¡æåçâè§åçä¾å¤ï¼.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information on hot vs cold in the context of Reactor, see
<a href="#reactor.hotCold">this reactor-specific section</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/reactiveProgramming.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#intro-reactive">Introduction to Reactive Programming</a>"</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="core-features"><a class="anchor" href="#core-features"></a>4. Reactor Core Features</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Reactor project main artifact is <code>reactor-core</code>, a reactive library that focuses on
the Reactive Streams specification and targets Java 8.</p>
</div>
<div class="paragraph">
<p>Reactoré¡¹ç®çä¸»è¦å·¥ä»¶æ¯reactor-coreä¸ä¸ªååºå¼åºï¼è¯¥åºä¾§éäºReactive Streamsè§èï¼å¹¶éå¯¹Java 8ã</p>
</div>
<div class="paragraph">
<p>Reactor introduces composable reactive types that implement <code>Publisher</code> but also provide
a rich vocabulary of operators: <code>Flux</code> and <code>Mono</code>. A <code>Flux</code> object
represents a reactive sequence of 0..N items, while a <code>Mono</code> object represents a
single-value-or-empty (0..1) result.</p>
</div>
<div class="paragraph">
<p>Reactorå¼å¥äºå¯å®ç°çå¯ååºç±»åï¼è¿äºå¯å®ç°Publisherä½ä¹æä¾äºä¸°å¯çè¿ç®ç¬¦è¯æ±ï¼FluxåMonoã
Fluxå¯¹è±¡è¡¨ç¤ºç0..Né¡¹çååºåºåï¼èä¸ä¸ªMonoå¯¹è±¡è¡¨ç¤ºåå¼æç©ºï¼0..1ï¼çç»æã</p>
</div>
<div class="paragraph">
<p>This distinction carries a bit of semantic information into the type, indicating the
rough cardinality of the asynchronous processing. For instance, an HTTP request produces
only one response, so there is not much sense in doing a <code>count</code> operation. Expressing
the result of such an HTTP call as a <code>Mono&lt;HttpResponse&gt;</code> thus makes more sense than
expressing it as a <code>Flux&lt;HttpResponse&gt;</code>, as it offers only operators that are relevant to
a context of zero items or one item.</p>
</div>
<div class="paragraph">
<p>è¿ç§åºå«å¨ç±»åä¸­åå«äºä¸äºè¯­ä¹ä¿¡æ¯ï¼è¡¨æäºå¼æ­¥å¤ççç²ç¥åºæ°ã
ä¾å¦ï¼ä¸ä¸ªHTTPè¯·æ±ä»äº§çä¸ä¸ªååºï¼å æ­¤è¿è¡countæä½æ²¡æå¤ªå¤§æä¹ã
å æ­¤ï¼å°HTTPè°ç¨çç»æè¡¨ç¤ºä¸º Mono&lt;HttpResponse&gt;æ¯å°å¶è¡¨ç¤ºä¸ºFlux&lt;HttpResponse&gt;æ´ææä¹ï¼å ä¸ºå®ä»æä¾ä¸é¶é¡¹æä¸ä¸ªé¡¹çä¸ä¸æç¸å³çè¿ç®ç¬¦ã</p>
</div>
<div class="paragraph">
<p>Operators that change the maximum cardinality of the processing also switch to the
relevant type. For instance, the <code>count</code> operator exists in <code>Flux</code>, but it returns a
<code>Mono&lt;Long&gt;</code>.</p>
</div>
<div class="paragraph">
<p>æ´æ¹å¤çæå¤§åºæ°çè¿ç®ç¬¦ä¹å°åæ¢å°ç¸å³ç±»åãä¾å¦ï¼countè¿ç®ç¬¦å­å¨äºä¸­Fluxï¼ä½è¿å Mono&lt;Long&gt;ã</p>
</div>
<div class="sect2">
<h3 id="flux"><a class="anchor" href="#flux"></a>4.1. <code>Flux</code>, an Asynchronous Sequence of 0-N Items</h3>
<div class="paragraph">
<p>The following image shows how a <code>Flux</code> transforms items:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/flux.png" alt="Flux">
</div>
</div>
<div class="paragraph">
<p>A <code>Flux&lt;T&gt;</code> is a standard <code>Publisher&lt;T&gt;</code> that represents an asynchronous sequence of 0 to N
emitted items, optionally terminated by either a completion signal or an error.
As in the Reactive Streams spec, these three types of signal translate to calls to a downstream
Subscriber&#8217;s <code>onNext</code>, <code>onComplete</code>, and <code>onError</code> methods.</p>
</div>
<div class="paragraph">
<p>Flux&lt;T&gt;æ¯Publisher&lt;T&gt;ä»£è¡¨0å°Nä¸ªåå°é¡¹ç®çå¼æ­¥åºåçæ åï¼å¯ä»¥éæ©éè¿å®æä¿¡å·æéè¯¯ç»æ­¢ã
å¦ååºå¼æµè§èä¸­ï¼è¿ä¸ç§ç±»åçä¿¡å·è½¬æ¢ä¸ºå¼å«å°ä¸æ¸¸SubscriberçonNextï¼onCompleteåonErroræ¹æ³ã</p>
</div>
<div class="paragraph">
<p>With this large scope of possible signals, <code>Flux</code> is the general-purpose reactive type.
Note that all events, even terminating ones, are optional: no <code>onNext</code> event but an
<code>onComplete</code> event represents an <em>empty</em> finite sequence, but remove the <code>onComplete</code> and
you have an <em>infinite</em> empty sequence (not particularly useful, except for tests around cancellation).
Similarly, infinite sequences are not necessarily empty. For example, <code>Flux.interval(Duration)</code>
produces a <code>Flux&lt;Long&gt;</code> that is infinite and emits regular ticks from a clock.</p>
</div>
<div class="paragraph">
<p>å¨è¿ä¹å¤§èå´çå¯è½ä¿¡å·ä¸­ï¼Fluxæ¯éç¨ä¿¡å·ç±»åã
è¯·æ³¨æï¼ææäºä»¶ï¼çè³æ¯ç»æ­¢äºä»¶ï¼é½æ¯å¯éçï¼æ²¡æonNextäºä»¶ï¼ä½ä¸ä¸ª onCompleteäºä»¶è¡¨ç¤ºä¸ä¸ªç©ºçæéåºåï¼ä½æ¯å é¤onCompleteï¼æ¨å°è·å¾ä¸ä¸ªæ éçç©ºåºåï¼é¤äºåæ¶æµè¯å¤ï¼å®ä¸æ¯ç¹å«æç¨ï¼ã
åæ ·ï¼æ éåºåä¸ä¸å®ä¸ºç©ºãä¾å¦ï¼Flux.interval(Duration) äº§çä¸ä¸ªFlux&lt;Long&gt;æ éçå¹¶ä¸ä»æ¶éååºè§åçæ»´ç­å£°ã</p>
</div>
</div>
<div class="sect2">
<h3 id="mono"><a class="anchor" href="#mono"></a>4.2. <code>Mono</code>, an Asynchronous 0-1 Result</h3>
<div class="paragraph">
<p>The following image shows how a <code>Mono</code> transforms an item:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/mono.png" alt="Mono">
</div>
</div>
<div class="paragraph">
<p>A <code>Mono&lt;T&gt;</code> is a specialized <code>Publisher&lt;T&gt;</code> that emits at most one item and then
(optionally) terminates with an <code>onComplete</code> signal or an <code>onError</code> signal.</p>
</div>
<div class="paragraph">
<p>Mono&lt;T&gt;æ¯ä¸ä¸ªä¸é¨çPublisher&lt;T&gt;ï¼æå¤ååºä¸ä¸ªé¡¹ç®ï¼
ç¶åï¼å¯éï¼ä»¥ä¸ä¸ªonCompleteä¿¡å·æä¸ä¸ªonErrorä¿¡å·ç»æ­¢ã</p>
</div>
<div class="paragraph">
<p>It offers only a subset of the operators that are available for a <code>Flux</code>, and
some operators (notably those that combine the <code>Mono</code> with another <code>Publisher</code>)
switch to a <code>Flux</code>.
For example, <code>Mono#concatWith(Publisher)</code> returns a <code>Flux</code> while <code>Mono#then(Mono)</code>
returns another <code>Mono</code>.</p>
</div>
<div class="paragraph">
<p>å®ä»æä¾å¯ç¨äºFluxçè¿ç®ç¬¦çä¸ä¸ªå­éï¼èæäºè¿ç®ç¬¦ï¼ç¹å«æ¯é£äºMonoä¸å¦ä¸ä¸ªç»åçè¿ç®ç¬¦Publisherï¼åæ¢å°Fluxã
ä¾å¦ï¼Mono#concatWith(Publisher)è¿åFluxä¸ä¼å¿Mono#then(Mono) è¿åå¦ä¸ä¸ªMonoã</p>
</div>
<div class="paragraph">
<p>Note that you can use a <code>Mono</code> to represent no-value asynchronous processes that only
have the concept of completion (similar to a <code>Runnable</code>). To create one, you can use an empty
<code>Mono&lt;Void&gt;</code>.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼æ¨å¯ä»¥ä½¿ç¨ Monoè¡¨ç¤ºä»å·æå®ææ¦å¿µçæ å¼å¼æ­¥æµç¨ï¼ç±»ä¼¼äºRunnableï¼ãè¦åå»ºä¸ä¸ªï¼æ¨å¯ä»¥ä½¿ç¨empty Mono&lt;Void&gt;ã</p>
</div>
</div>
<div class="sect2">
<h3 id="_simple_ways_to_create_a_flux_or_mono_and_subscribe_to_it"><a class="anchor" href="#_simple_ways_to_create_a_flux_or_mono_and_subscribe_to_it"></a>4.3. Simple Ways to Create a Flux or Mono and Subscribe to It</h3>
<div class="paragraph">
<p>The easiest way to get started with <code>Flux</code> and <code>Mono</code> is to use one of the numerous
factory methods found in their respective classes.</p>
</div>
<div class="paragraph">
<p>æç®åçæ¹å¼å¼å§ä½¿ç¨FluxåMonoæ¯ä½¿ç¨å¨åèªçç±»å«ä¸­çä¼å¤å·¥åæ¹æ³ä¹ä¸ã</p>
</div>
<div class="paragraph">
<p>For instance, to create a sequence of <code>String</code>, you can either enumerate them or put them
in a collection and create the Flux from it, as follows:</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼è¦åå»ºçåºåStringï¼æ¨å¯ä»¥æä¸¾å®ä»¬æå°å®ä»¬æ¾å¥éåä¸­å¹¶ä»ä¸­åå»ºFluxï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; seq1 = Flux.just("foo", "bar", "foobar");

List&lt;String&gt; iterable = Arrays.asList("foo", "bar", "foobar");
Flux&lt;String&gt; seq2 = Flux.fromIterable(iterable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Other examples of factory methods include the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Mono&lt;String&gt; noData = Mono.empty(); <i class="conum" data-value="1"></i><b>(1)</b>

Mono&lt;String&gt; data = Mono.just("foo");

Flux&lt;Integer&gt; numbersFromFiveToSeven = Flux.range(5, 3); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è¯·æ³¨æï¼å³ä½¿å·¥åæ¹æ³æ²¡æä»»ä½ä»·å¼ï¼å®ä¹ä¼å°éè¯¥æ³åç±»å.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ç¬¬ä¸ä¸ªåæ°æ¯èå´çå¼å§ï¼èç¬¬äºä¸ªåæ°æ¯è¦çæçé¡¹ç®æ°.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>When it comes to subscribing, <code>Flux</code> and <code>Mono</code> make use of Java 8 lambdas. You
have a wide choice of <code>.subscribe()</code> variants that take lambdas for different
combinations of callbacks, as shown in the following method signatures:</p>
</div>
<div class="paragraph">
<p>å½è°å°è®¢éï¼Fluxä»¥åMono éç¨Java 8 lambdaè¡¨è¾¾å¼ã
æ¨å¯ä»¥éæ©å¤ç§.subscribe()ç±»åçåä½ï¼å®ä»¬éå¯¹ä¸åçåè°ç»åéç¨lambdaè¡¨è¾¾å¼ï¼å¦ä»¥ä¸æ¹æ³ç­¾åæç¤ºï¼</p>
</div>
<div id="subscribeMethods" class="exampleblock">
<div class="title">Example 10. Lambda-based subscribe variants for <code>Flux</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">subscribe(); <i class="conum" data-value="1"></i><b>(1)</b>

subscribe(Consumer&lt;? super T&gt; consumer); <i class="conum" data-value="2"></i><b>(2)</b>

subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer); <i class="conum" data-value="3"></i><b>(3)</b>

subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer,
          Runnable completeConsumer); <i class="conum" data-value="4"></i><b>(4)</b>

subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer,
          Runnable completeConsumer,
          Consumer&lt;? super Subscription&gt; subscriptionConsumer); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è®¢éå¹¶è§¦ååºå.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä¸ºæ¯ä¸ªäº§ççå¼åç¹äº.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¤çå¼ï¼ä½ä¹ä¼å¯¹éè¯¯ååºååº.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>å¤çå¼åéè¯¯ï¼ä½å¨åºåæåå®æåè¿è¦è¿è¡ä¸äºä»£ç .</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å¤çå¼åéè¯¯å¹¶æåå®æï¼ä½è¿è¦å¤çå subscribeè°ç¨äº§ççç»æSubscription.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
These variants return a reference to the subscription that you can use to cancel the
subscription when no more data is needed. Upon cancellation, the source should stop
producing values and clean up any resources it created. This cancel-and-clean-up behavior
is represented in Reactor by the general-purpose <code>Disposable</code> interface.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
è¿äºåä½è¿åå¯¹è®¢éçå¼ç¨ï¼æ¨å¯ä»¥å¨ä¸éè¦æ´å¤æ°æ®æ¶ä½¿ç¨è¯¥å¼ç¨æ¥åæ¶è®¢éã
åæ¶åï¼æºåºåæ­¢äº§çå¼å¹¶æ¸é¤å¶åå»ºçä»»ä½èµæºãè¿ç§åæ¶åæ¸çè¡ä¸ºå¨Reactorä¸­ç±éç¨Disposableæ¥å£è¡¨ç¤ºã
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_subscribe_method_examples"><a class="anchor" href="#_subscribe_method_examples"></a>4.3.1. <code>subscribe</code> Method Examples</h4>
<div class="paragraph">
<p>This section contains minimal examples of each of the five signatures for the <code>subscribe</code>
method. The following code shows an example of the basic method with no arguments:</p>
</div>
<div class="paragraph">
<p>æ¬èåå«è¯¥subscribe æ¹æ³çäºä¸ªç­¾åä¸­æ¯ä¸ªç­¾åçæå°ç¤ºä¾ãä»¥ä¸ä»£ç æ¾ç¤ºäºä¸å¸¦åæ°çåºæ¬æ¹æ³çç¤ºä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; ints = Flux.range(1, 3); <i class="conum" data-value="1"></i><b>(1)</b>
ints.subscribe(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è®¾ç½®ä¸ä¸ªFluxå¨è®¢éèå å¥æ¶äº§çä¸ä¸ªå¼çãä»¥æç®åçæ¹å¼è®¢é.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä»¥æç®åçæ¹å¼è®¢é.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code produces no visible output, but it does work. The <code>Flux</code> produces
three values. If we provide a lambda, we can make the values visible. The next example
for the <code>subscribe</code> method shows one way to make the values appear:</p>
</div>
<div class="paragraph">
<p>åé¢çä»£ç æ²¡æäº§çå¯è§çè¾åºï¼ä½æ¯å®ç¡®å®èµ·ä½ç¨ãå°Fluxäº§çä¸ä¸ªå¼ãå¦ææä¾lambdaï¼åå¯ä»¥ä½¿å¼å¯è§ã
è¯¥subscribeæ¹æ³çä¸ä¸ä¸ªç¤ºä¾æ¾ç¤ºäºä¸ç§ä½¿å¼åºç°çæ¹æ³</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; ints = Flux.range(1, 3); <i class="conum" data-value="1"></i><b>(1)</b>
ints.subscribe(i -&gt; System.out.println(i)); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è®¾ç½®ä¸ä¸ªFluxå¨è®¢éèå å¥æ¶äº§çä¸ä¸ªå¼ç.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ç¨å°æå°å¼çè®¢éèè®¢é.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1
2
3</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To demonstrate the next signature, we intentionally introduce an error, as
shown in the following example:</p>
</div>
<div class="paragraph">
<p>ä¸ºäºæ¼ç¤ºä¸ä¸ä¸ªç­¾åï¼æä»¬ææå¼å¥ä¸ä¸ªéè¯¯ï¼å¦ä»¥ä¸ç¤ºä¾æç¤º</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; ints = Flux.range(1, 4) <i class="conum" data-value="1"></i><b>(1)</b>
      .map(i -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
        if (i &lt;= 3) return i; <i class="conum" data-value="3"></i><b>(3)</b>
        throw new RuntimeException("Got to 4"); <i class="conum" data-value="4"></i><b>(4)</b>
      });
ints.subscribe(i -&gt; System.out.println(i), <i class="conum" data-value="5"></i><b>(5)</b>
      error -&gt; System.err.println("Error: " + error));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è®¾ç½®ä¸ä¸ªFluxï¼å½è®¢éèè¿æ¥æ¶å®ä¼äº§çåä¸ªå¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬éè¦ä¸ä¸ªmapï¼ä»¥ä¾¿æä»¬å¯ä»¥ä¸åå°å¤çæäºå¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¯¹äºå¤§å¤æ°å¼ï¼è¯·è¿åè¯¥å¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>å¯¹äºä¸ä¸ªå¼ï¼å¼ºå¶æ§è¡éè¯¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ç¨åå«éè¯¯å¤çç¨åºçè®¢éèè¿è¡Subscribe.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>We now have two lambda expressions: one for the content we expect and one for
errors. The preceding code produces the following output:</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼æä»¬æä¸¤ä¸ªlambdaè¡¨è¾¾å¼ï¼ä¸ä¸ªç¨äºææçåå®¹ï¼å¦ä¸ä¸ªç¨äºéè¯¯ãä¸é¢çä»£ç äº§çä»¥ä¸è¾åºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1
2
3
Error: java.lang.RuntimeException: Got to 4</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next signature of the <code>subscribe</code> method includes both an error handler and
a handler for completion events, as shown in the following example:</p>
</div>
<div class="paragraph">
<p>è¯¥subscribeæ¹æ³çä¸ä¸ä¸ªç­¾ååæ¬éè¯¯å¤çç¨åºåå®æäºä»¶å¤çç¨åºï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; ints = Flux.range(1, 4); <i class="conum" data-value="1"></i><b>(1)</b>
ints.subscribe(i -&gt; System.out.println(i),
    error -&gt; System.err.println("Error " + error),
    () -&gt; System.out.println("Done")); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è®¾ç½®ä¸ä¸ªFluxï¼å½è®¢éèè¿æ¥æ¶å®ä¼äº§çåä¸ªå¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä½¿ç¨åæ¬å®æäºä»¶å¤çç¨åºçè®¢éæå¡å¨è¿è¡è®¢é.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Error signals and completion signals are both terminal events and are exclusive of one
another (you never get both). To make the completion consumer work, we must take care not
to trigger an error.</p>
</div>
<div class="paragraph">
<p>éè¯¯ä¿¡å·åå®æä¿¡å·é½æ¯ç»ç«¯äºä»¶ï¼å¹¶ä¸å½¼æ­¤äºæ¥ï¼æ¨æ°¸è¿ä¸ä¼é½å¾å°ï¼ãä¸ºäºä½¿å®ææ¶è´¹èå·¥ä½ï¼æä»¬å¿é¡»æ³¨æä¸è¦è§¦åéè¯¯</p>
</div>
<div class="paragraph">
<p>The completion callback has no input, as represented by an empty pair of
parentheses: It matches the <code>run</code> method in the <code>Runnable</code> interface. The preceding code
produces the following output:</p>
</div>
<div class="paragraph">
<p>å®æåè°æ²¡æè¾å¥ï¼ç±ä¸å¯¹ç©ºæ¬å·è¡¨ç¤ºï¼å®ä¸æ¥å£ä¸­çrunæ¹æ³å¹éRunnableãä¸é¢çä»£ç äº§çä»¥ä¸è¾åºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1
2
3
4
Done</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The last signature of the <code>subscribe</code> method includes a <code>Consumer&lt;Subscription&gt;</code>.</p>
</div>
<div class="paragraph">
<p>è¯¥subscribeæ¹æ³çæåä¸ä¸ªç­¾ååæ¬Consumer&lt;Subscription&gt;ã</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
That variant requires you to do something with the <code>Subscription</code> (perform a
<code>request(long)</code> on it or <code>cancel()</code> it). Otherwise the <code>Flux</code> hangs.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
è¯¥åä½è¦æ±æ¨å¯¹Subscriptionè¿è¡æäºæä½ï¼request(long)æ cancel()ï¼ãå¦åFluxä¼æèµ·ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows the last signature of the <code>subscribe</code> method:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; ints = Flux.range(1, 4);
ints.subscribe(i -&gt; System.out.println(i),
    error -&gt; System.err.println("Error " + error),
    () -&gt; System.out.println("Done"),
    sub -&gt; sub.request(10)); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>å½æä»¬è®¢éæ¶ï¼æä»¬ä¼æ¶å°Subscriptionãè¡¨ç¤ºæä»¬è¦ä»æºå¤´è·å 10 ä¸ªåç´ ï¼å®éä¸å°ååº4ä¸ªåç´ å¹¶å®æ).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelling_a_subscribe_with_its_disposable"><a class="anchor" href="#_cancelling_a_subscribe_with_its_disposable"></a>4.3.2. Cancelling a <code>subscribe()</code> with Its <code>Disposable</code></h4>
<div class="paragraph">
<p>All these lambda-based variants of <code>subscribe()</code> have a <code>Disposable</code> return type.
In this case, the <code>Disposable</code> interface represents the fact that the subscription
can be <em>cancelled</em>, by calling its <code>dispose()</code> method.</p>
</div>
<div class="paragraph">
<p>ææè¿äºåºäºlambdaçåä½subscribe()é½å·æDisposableè¿åç±»åã
å¨è¿ç§æåµä¸ï¼è¯¥Disposableæ¥å£è¡¨ç¤ºå¯ä»¥å®ç°éè¿è°ç¨æ¹æ³dispose()æ¥åæ¶è®¢éã</p>
</div>
<div class="paragraph">
<p>For a <code>Flux</code> or <code>Mono</code>, cancellation is a signal that the source should stop
producing elements. However, it is NOT guaranteed to be immediate: Some sources
might produce elements so fast that they could complete even before receiving the
cancel instruction.</p>
</div>
<div class="paragraph">
<p>å¯¹äºFluxæMonoï¼åæ¶è¡¨ç¤ºä¿¡å·æºåºåæ­¢äº§çåç´ ã
ä½æ¯ï¼å¹¶ä¸è½ä¿è¯ç«å³æ§è¡ï¼æäºæºå¯è½ä¼äº§çå¦æ­¤å¿«çåç´ ï¼ä»¥è³äºçè³å¨æ¥æ¶å°åæ¶æä»¤ä¹åå®ä»¬ä¹å¯ä»¥å®æã</p>
</div>
<div class="paragraph">
<p>Some utilities around <code>Disposable</code> are available in the <code>Disposables</code> class.
Among these, <code>Disposables.swap()</code> creates a <code>Disposable</code> wrapper that lets
you atomically cancel and replace a concrete <code>Disposable</code>. This can be useful,
for instance, in a UI scenario where you want to cancel a request and replace it
with a new one whenever the user clicks on a button. Disposing the wrapper itself
closes it. Doing so disposes the current concrete value and all future attempted replacements.</p>
</div>
<div class="paragraph">
<p>å¨Disposableç±»ä¸­æä¾äºä¸äºå®ç¨ç¨åºã
å¨å¶ä¸­ï¼Disposables.swap()åå»ºä¸ä¸ªDisposableåè£å¨ï¼ä½¿æ¨å¯ä»¥èªå¨åæ¶åæ¿æ¢å·ä½çDisposableã
ä¾å¦ï¼è¿å¨UIåºæ¯ä¸­å¾æç¨ï¼å¨UIåºæ¯ä¸­ï¼æ¨å¸æå¨ç¨æ·åå»æé®æ¶åæ¶è¯·æ±å¹¶å°å¶æ¿æ¢ä¸ºæ°è¯·æ±ã
åè£å¨æ¬èº«ä¼å°å¶èªå¨å³é­ãè¿æ ·åä¼å¤ç½®å½åçå·ä½çå¼ä»¥åå°æ¥ææå°è¯çæ¿ä»£åã</p>
</div>
<div class="paragraph">
<p>Another interesting utility is <code>Disposables.composite(&#8230;&#8203;)</code>. This composite
lets you collect several <code>Disposable</code>&#8201;&#8212;&#8201;for instance, multiple in-flight requests
associated with a service call&#8201;&#8212;&#8201;and dispose all of them at once later on.
Once the composite&#8217;s <code>dispose()</code> method has been called, any attempt to add
another <code>Disposable</code> immediately disposes it.</p>
</div>
<div class="paragraph">
<p>å¦ä¸ä¸ªæè¶£çå®ç¨ç¨åºæ¯Disposables.composite(â¦â)ãéè¿æ­¤ç»åï¼æ¨å¯ä»¥æ¶éå¤ä¸ªDisposableâï¼ä¾å¦ï¼ä¸æå¡è°ç¨å³èçå¤ä¸ªè¿è¡ä¸­çè¯·æ±ï¼ï¼å¹¶å¨ä»¥åä¸æ¬¡å¤çææè¿äºè¯·æ±ã
ä¸æ¦å¤åæ¹æ³è°ç¨äºdispose()ï¼ä»»ä½æ·»å å¶ä»Disposableæ¹æ³çå°è¯é½ä¼ç«å³ä¸¢å¼æã</p>
</div>
</div>
<div class="sect3">
<h4 id="_an_alternative_to_lambdas_basesubscriber"><a class="anchor" href="#_an_alternative_to_lambdas_basesubscriber"></a>4.3.3. An Alternative to Lambdas: <code>BaseSubscriber</code></h4>
<div class="paragraph">
<p>There is an additional <code>subscribe</code> method that is more generic and takes a full-blown
<code>Subscriber</code> rather than composing one out of lambdas. In order to help with writing
such a <code>Subscriber</code>, we provide an extendable class called <code>BaseSubscriber</code>.</p>
</div>
<div class="paragraph">
<p>è¿æä¸ç§subscribeæ´éç¨çæ¹æ³ï¼å®éç¨æççæ¹æ³ï¼ ä½¿ç¨Subscriberèä¸æ¯ç¨lambdaç»æä¸ä¸ªæ¹æ³ã
ä¸ºäºå¸®å©ç¼åè¿æ ·ç Subscriberï¼æä»¬æä¾äºä¸ä¸ªç§°ä¸ºçå¯æ©å±çç±»å« BaseSubscriberã</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Instances of <code>BaseSubscriber</code> (or subclasses of it) are <strong>single-use</strong>,
meaning that a <code>BaseSubscriber</code> cancels its subscription to the first <code>Publisher</code> if it
is subscribed to a second <code>Publisher</code>.
That is because using an instance twice would violate the Reactive Streams rule that a
the <code>onNext</code> method of a <code>Subscriber</code> must not be called in parallel.
As a result, anonymous implementations are fine only if they are declared directly within
the call to <code>Publisher#subscribe(Subscriber)</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
BaseSubscriberï¼æå®çå­ç±»ï¼ç å®ä¾æ¯ä¸æ¬¡æ§çï¼è¿æå³çå¦æä¸ä¸ª BaseSubscriber å¯¹ç¬¬äºä¸ª Publisher å°±è¡è®¢éï¼åå®ä¼åæ¶å¶å¯¹ç¬¬ä¸ä¸ªçPublisherçè®¢éã
é£æ¯å ä¸ºä¸¤æ¬¡ä½¿ç¨ä¸ä¸ªå®ä¾ä¼è¿åååºå¼æµè§åï¼å³ä¸è½å¹¶è¡è°ç¨SubscriberçonNextæ¹æ³ã
å æ­¤ï¼åªæå¨å¯¹çè°ç¨ä¸­ç´æ¥å£°æäºå¿åå®ç°æ¶ï¼å¿åå®ç°æå¯ä»¥Publisher#subscribe(Subscriber)ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can implement one of these. We call it a <code>SampleSubscriber</code>. The following
example shows how it would be attached to a <code>Flux</code>:</p>
</div>
<div class="paragraph">
<p>ç°å¨æä»¬å¯ä»¥å®ç°å¶ä¸­ä¹ä¸ãæä»¬ç§°å®ä¸ºSampleSubscriberãä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½å°å¶éå å°Fluxï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">SampleSubscriber&lt;Integer&gt; ss = new SampleSubscriber&lt;Integer&gt;();
Flux&lt;Integer&gt; ints = Flux.range(1, 4);
ints.subscribe(i -&gt; System.out.println(i),
    error -&gt; System.err.println("Error " + error),
    () -&gt; {System.out.println("Done");},
    s -&gt; s.request(10));
ints.subscribe(ss);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows what <code>SampleSubscriber</code> could look like, as a minimalistic
implementation of a <code>BaseSubscriber</code>:</p>
</div>
<div class="paragraph">
<p>ä»¥ä¸ç¤ºä¾æ¾ç¤ºäºSampleSubscriberä½ä¸ºä¸ä¸ªBaseSubscriberçç®çº¦å®ç°ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.projectreactor.samples;

import org.reactivestreams.Subscription;

import reactor.core.publisher.BaseSubscriber;

public class SampleSubscriber&lt;T&gt; extends BaseSubscriber&lt;T&gt; {

	public void hookOnSubscribe(Subscription subscription) {
		System.out.println("Subscribed");
		request(1);
	}

	public void hookOnNext(T value) {
		System.out.println(value);
		request(1);
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>SampleSubscriber</code> class extends <code>BaseSubscriber</code>, which is the recommended abstract
class for user-defined <code>Subscribers</code> in Reactor. The class offers hooks that can be
overridden to tune the subscriber&#8217;s behavior. By default, it triggers an unbounded
request and behaves exactly as <code>subscribe()</code>. However, extending <code>BaseSubscriber</code> is
much more useful when you want a custom request amount.</p>
</div>
<div class="paragraph">
<p>è¿SampleSubscriberç±»æ¯æ©å±BaseSubscriberï¼å¨Reactorä¸­ï¼æ¨èä½¿ç¨Subscribersçæ½è±¡ç±»SampleSubscriberï¼å»å®ç°èªå®ä¹åè½ã
è¯¥ç±»æä¾äºå¯ä»¥è¢«è¦ççhookï¼ä»¥è°æ´è®¢éèçè¡ä¸ºãé»è®¤æåµä¸ï¼å®ä¼è§¦åä¸ä¸ªæ éå¶çè¯·æ±ï¼å¹¶ä¸è¡ä¸ºä¸å®å¨ç¸åsubscribe()ã
ä½æ¯ï¼å½æ¨éè¦èªå®ä¹è¯·æ±éæ¶ï¼BaseSubscriberçæ©å±åè½ä¼æ´å æç¨ã</p>
</div>
<div class="paragraph">
<p>For a custom request amount, the bare minimum is to implement <code>hookOnSubscribe(Subscription subscription)</code>
and <code>hookOnNext(T value)</code>, as we did. In our case, the <code>hookOnSubscribe</code> method
prints a statement to standard out and makes the first request. Then the <code>hookOnNext</code>
method prints a statement and performs additional requests, one request
at a time.</p>
</div>
<div class="paragraph">
<p>å¯¹äºèªå®ä¹è¯·æ±éï¼æèµ·ç çæ¯å®æ½hookOnSubscribe(Subscription subscription) åhookOnNext(T value)ï¼å°±åæä»¬æåçé£æ ·ã
å¨æä»¬çä¾å­ä¸­ï¼è¯¥hookOnSubscribeæ¹æ³è¾åºæ åå£°æå¹¶ååºç¬¬ä¸ä¸ªè¯·æ±ãç¶åï¼è¯¥hookOnNext æ¹æ³æå°ä¸æ¡è¯­å¥å¹¶æ§è¡å¶ä»è¯·æ±ï¼ä¸æ¬¡æ§è¡ä¸ä¸ªè¯·æ±ã</p>
</div>
<div class="paragraph">
<p>The <code>SampleSubscriber</code> class produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Subscribed
1
2
3
4</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>BaseSubscriber</code> also offers a <code>requestUnbounded()</code> method to switch to unbounded mode
(equivalent to <code>request(Long.MAX_VALUE)</code>), as well as a <code>cancel()</code> method.</p>
</div>
<div class="paragraph">
<p>BaseSubscriberè¿æä¾äºrequestUnbounded()ä¸ç§åæ¢å°æ çæ¨¡å¼çæ¹æ³ï¼ç­æäºrequest(Long.MAX_VALUE)ï¼ï¼ä»¥åä¸ç§cancel()æ¹æ³ã</p>
</div>
<div class="paragraph">
<p>It also has additional hooks: <code>hookOnComplete</code>, <code>hookOnError</code>, <code>hookOnCancel</code>, and <code>hookFinally</code>
(which is always called when the sequence terminates, with the type of termination passed
in as a <code>SignalType</code> parameter)</p>
</div>
<div class="paragraph">
<p>å®è¿å·æå¦å¤çé©ï¼hookOnCompleteï¼hookOnErrorï¼hookOnCancelï¼åhookFinally ï¼å¶æ»æ¯å¨åºåç»æ­¢æ¶è°ç¨ï¼å¹¶å¨åºåéè¿åï¼ä¼ å¥ç±»åä¸ºSignalTypeçåæ°ï¼</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You almost certainly want to implement the <code>hookOnError</code>, <code>hookOnCancel</code>, and
<code>hookOnComplete</code> methods. You may also want to implement the <code>hookFinally</code> method.
<code>SampleSubscribe</code> is the absolute minimum implementation of a <code>Subscriber</code> <em>that performs
bounded requests</em>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ä½ å ä¹å¯ä»¥è¯å®è¦å®ç°çhookOnErrorï¼hookOnCancelå hookOnCompleteæ¹æ³ã
æ¨å¯è½è¿æ³å®ç°è¯¥hookFinallyæ¹æ³ã SampleSubscribeæ¯Subscriber æ§è¡åéè¯·æ±ççç»å¯¹æå°çå®ç°ã
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_on_backpressure_and_ways_to_reshape_requests"><a class="anchor" href="#_on_backpressure_and_ways_to_reshape_requests"></a>4.3.4. On Backpressure and Ways to Reshape Requests</h4>
<div class="paragraph">
<p>When implementing backpressure in Reactor, the way consumer pressure is propagated back to the source is by sending a <code>request</code> to the upstream operator.
The sum of current requests is sometimes referenced to as the current &#8220;demand&#8221;, or &#8220;pending request&#8221;.
Demand is capped at <code>Long.MAX_VALUE</code>, representing an unbounded request (meaning &#8220;produce as fast as you can&#8221;&#8201;&#8212;&#8201;basically disabling backpressure).</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­å®æ½èåæ¶ï¼éè¿å°åååérequestç»ä¸æ¸¸æä½åï¼å°ç¨æ·ååä¼ æ­åæºã
å½åè¯·æ±çæ»åææ¶è¢«ç§°ä¸ºå½åâéæ±âæâå¾å¤çè¯·æ±âã
éæ±ä¸éä¸ºLong.MAX_VALUEï¼è¡¨ç¤ºæ éå¶çè¯·æ±ï¼æææ¯âå°½å¯è½å¿«å°çæâï¼åºæ¬ä¸æ¯ç¦æ­¢èåï¼ã</p>
</div>
<div class="paragraph">
<p>The first request comes from the final subscriber at subscription time,
yet the most direct ways of subscribing all immediately trigger an unbounded request of <code>Long.MAX_VALUE</code>:</p>
</div>
<div class="paragraph">
<p>ç¬¬ä¸ä¸ªè¯·æ±å¨è®¢éæ¶æ¥èªæç»è®¢æ·ï¼ä½æ¯æç´æ¥çè®¢éæ¹å¼ç«å³è§¦åäºä»¥ä¸æ éè¯·æ±Long.MAX_VALUEï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>subscribe()</code> and most of its lambda-based variants (to the exception of the one that has a Consumer&lt;Subscription&gt;)</p>
</li>
<li>
<p><code>block()</code>, <code>blockFirst()</code> and <code>blockLast()</code></p>
</li>
<li>
<p>iterating over a <code>toIterable()</code> or <code>toStream()</code></p>
</li>
<li>
<p>subscribe() åå¶å¤§å¤æ°åºäºlambdaçåä½ï¼å·æConsumer &lt;Subscription&gt;çåä½é¤å¤ï¼</p>
</li>
<li>
<p>block()ï¼blockFirst()åblockLast()</p>
</li>
<li>
<p>éåå¨ä¸ä¸ªtoIterable()ætoStream()</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The simplest way of customizing the original request is to <code>subscribe</code> with a <code>BaseSubscriber</code> with the <code>hookOnSubscribe</code> method overridden, as the following example shows:</p>
</div>
<div class="paragraph">
<p>å®å¶åå§è¯·æ±çæç®åæ¹æ³æ¯subscribeä½¿ç¨BaseSubscriberï¼å¶ä¸­hookOnSubscribeæ¹æ³è¢«éåï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.range(1, 10)
    .doOnRequest(r -&gt; System.out.println("request of " + r))
    .subscribe(new BaseSubscriber&lt;Integer&gt;() {

      @Override
      public void hookOnSubscribe(Subscription subscription) {
        request(1);
      }

      @Override
      public void hookOnNext(Integer integer) {
        System.out.println("Cancelling after having received " + integer);
        cancel();
      }
    });</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding snippet prints out the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>request of 1
Cancelling after having received 1</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When manipulating a request, you must be careful to produce enough demand for
the sequence to advance, or your Flux can get &#8220;stuck&#8221;. That is why <code>BaseSubscriber</code>
defaults to an unbounded request in <code>hookOnSubscribe</code>. When overriding this hook, you should usually
call <code>request</code> at least once.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
å¨å¤çè¯·æ±æ¶ï¼æ¨å¿é¡»å°å¿ä»¥äº§çè¶³å¤çéæ±æ¥æ¨è¿åºåï¼å¦åæ¨çFluxå¯è½ä¼âå¡ä½âã
è¿å°±æ¯ä¸ºä»ä¹BaseSubscriberä¸­çhookOnSubscribe é»è®¤ä¸ºæ éå¶è¯·æ±ãè¦çæ­¤é©å­æ¶ï¼éå¸¸åºrequestè³å°è°ç¨ä¸æ¬¡ã
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_operators_that_change_the_demand_from_downstream"><a class="anchor" href="#_operators_that_change_the_demand_from_downstream"></a>Operators that Change the Demand from Downstream</h5>
<div class="paragraph">
<p>One thing to keep in mind is that demand expressed at the subscribe level <strong>can</strong> be reshaped by each operator in the upstream chain.
A textbook case is the <code>buffer(N)</code> operator: If it receives a <code>request(2)</code>, it is interpreted as a demand for <strong>two full buffers</strong>.
As a consequence, since buffers need <code>N</code> elements to be considered full, the <code>buffer</code> operator reshapes the request to <code>2 x N</code>.</p>
</div>
<div class="paragraph">
<p>è¦è®°ä½çä¸ä»¶äºæ¯ï¼ä¸æ¸¸é¾ä¸­çæ¯ä¸ªoperatoré½å¯ä»¥è°æ´å¨è®¢éçº§å«è¡¨è¾¾çéæ±ã
æç§ä¹¦çæåµæ¯buffer(N)è¿ç®ç¬¦ï¼å¦æå®æ¶å° request(2)ï¼åè§£éä¸ºå¯¹ä¸¤ä¸ªå®æ´ç¼å²åºçéæ±ã
ç»æï¼ç±äºç¼å²åºéè¦å°Nåç´ è§ä¸ºå·²æ»¡ï¼å æ­¤bufferè¿ç®ç¬¦å°è¯·æ±è°æ´ä¸º2 x Nã</p>
</div>
<div class="paragraph">
<p>You might also have noticed that some operators have variants that take an <code>int</code> input parameter called <code>prefetch</code>.
This is another category of operators that modify the downstream request.
These are usually operators that deal with inner sequences, deriving a <code>Publisher</code> from each incoming element (like <code>flatMap</code>).</p>
</div>
<div class="paragraph">
<p>æ¨å¯è½è¿å·²ç»æ³¨æå°ï¼æäºè¿ç®ç¬¦çåä½éç¨äºintç§°ä¸ºçè¾å¥åæ°prefetchãè¿æ¯ä¿®æ¹ä¸æ¸¸è¯·æ±çå¦ä¸ç±»è¿ç®ç¬¦ã
è¿äºéå¸¸æ¯å¤çåé¨åºåçè¿ç®ç¬¦ï¼å®ä»¬Publisherä»æ¯ä¸ªä¼ å¥åç´ ï¼å¦flatMapï¼æ´¾çä¸ä¸ªã</p>
</div>
<div class="paragraph">
<p><strong>Prefetch</strong> is a way to tune the initial request made on these inner sequences.
If unspecified, most of these operators start with a demand of <code>32</code>.</p>
</div>
<div class="paragraph">
<p>Prefetchæ¯ä¸ç§è°æ´å¯¹è¿äºåé¨åºåååºçåå§è¯·æ±çæ¹æ³ãå¦ææªæå®ï¼åå¤§å¤æ°è¿äºè¿ç®ç¬¦çèµ·å§è¦æ±ä¸º32ã</p>
</div>
<div class="paragraph">
<p>These operators usually also implement a <strong>replenishing optimization</strong>: Once the operator has seen 75% of the prefetch request fulfilled, it re-requests 75% from upstream.
This is a heuristic optimization made so that these operators proactively anticipate the upcoming requests.</p>
</div>
<div class="paragraph">
<p>è¿äºæä½åéå¸¸è¿ä¼å®ç°è¡¥åä¼åï¼ä¸æ¦æä½åçå°é¢åè¯·æ±ç75ï¼å·²å®æï¼å®å°±ä¼ä»ä¸æ¸¸éæ°è¯·æ±75ï¼ã
è¿è¡å¯åå¼ä¼åï¼ä»¥ä¾¿è¿äºæä½åä¸»å¨é¢æµå³å°å°æ¥çè¯·æ±ã</p>
</div>
<div class="paragraph">
<p>Finally, a couple of operators let you directly tune the request: <code>limitRate</code> and <code>limitRequest</code>.</p>
</div>
<div class="paragraph">
<p>æåï¼å ä¸ªè¿ç®ç¬¦å¯è®©æ¨ç´æ¥è°æ´è¯·æ±ï¼limitRateålimitRequestã</p>
</div>
<div class="paragraph">
<p><code>limitRate(N)</code> splits the downstream requests so that they are propagated upstream in smaller batches.
For instance, a request of <code>100</code> made to <code>limitRate(10)</code> would result in, at most, <code>10</code> requests of <code>10</code> being propagated to the upstream.
Note that, in this form, <code>limitRate</code> actually implements the replenishing optimization discussed earlier.</p>
</div>
<div class="paragraph">
<p>limitRate(N)æåä¸æ¸¸è¯·æ±ï¼ä»¥ä¾¿å°å®ä»¬ä»¥è¾å°çæ¹æ¬¡ä¼ æ­å°ä¸æ¸¸ãä¾å¦ï¼ä¸ä¸ªè¯·æ±100å°ç±limitRate(10)å°å¯¼è´ï¼é¡¶å¤10çè¯·æ±10ä¼ æ­å°ä¸æ¸¸ã
æ³¨æï¼ä»¥è¿ç§å½¢å¼ï¼limitRateå®éä¸å®ç°äºåé¢è®¨è®ºçè¡¥åä¼åã</p>
</div>
<div class="paragraph">
<p>The operator has a variant that also lets you tune the replenishing amount (referred to as the <code>lowTide</code> in the variant): <code>limitRate(highTide, lowTide)</code>.
Choosing a <code>lowTide</code> of <code>0</code> results in <strong>strict</strong> batches of <code>highTide</code> requests, instead of batches further reworked by the replenishing strategy.</p>
</div>
<div class="paragraph">
<p>ç»è¥èæä¸ä¸ªåç§ï¼ä¹å¯ä»¥è®©ä½ è°æ´è¡¥åéï¼ç®ç§°lowTideä¸­åä½ï¼ï¼ limitRate(highTide, lowTide)ã
éæ©ä¸ä¸ª lowTide åæ°0 ä¼å¯¼è´ä¸¥æ ¼çæ¹æ¬¡highTideè¯·æ±ï¼èä¸æ¯éè¿è¡¥åç­ç¥è¿ä¸æ­¥éåçæ¹æ¬¡ã</p>
</div>
<div class="paragraph">
<p><code>limitRequest(N)</code>, on the other hand, <strong>caps</strong> the downstream request to a maximum total demand.
It adds up requests up to <code>N</code>. If a single <code>request</code> does not make the total demand overflow over <code>N</code>, that particular request is wholly propagated upstream.
After that amount has been emitted by the source, <code>limitRequest</code> considers the sequence complete, sends an <code>onComplete</code> signal downstream, and cancels the source.</p>
</div>
<div class="paragraph">
<p>limitRequest(N)ï¼å¦ä¸æ¹é¢ï¼éé¢äºä¸æ¸¸è¯·æ±çæå¤§æ»éæ±ãå®å°è¯·æ±æ»è®¡ä¸ºNãå¦æåä¸ªè¯·æ±requestæ²¡æä½¿æ»éæ±è¶åºNï¼åè¯¥ç¹å®è¯·æ±å°å®å¨åä¸æ¸¸ä¼ æ­ã
å¨æºå¤´ååºè¯¥æ°éçä¿¡å·åï¼limitRequestè®¤ä¸ºåºåå·²å®æï¼åä¸æ¸¸åéonCompleteä¿¡å·ï¼ç¶ååæ¶æºã</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="producing"><a class="anchor" href="#producing"></a>4.4. Programmatically creating a sequence</h3>
<div class="paragraph">
<p>In this section, we introduce the creation of a <code>Flux</code> or a <code>Mono</code> by
programmatically defining its associated events (<code>onNext</code>, <code>onError</code>, and
<code>onComplete</code>). All these methods share the fact that they expose an API to
trigger the events that we call a <strong>sink</strong>. There are actually a few sink
variants, which we&#8217;ll get to shortly.</p>
</div>
<div class="paragraph">
<p>å¨æ¬èä¸­ï¼æä»¬ä»ç»çåå»ºFluxæMonoéè¿ç¼ç¨æ¹å¼å®ä¹åå¶ç¸å³äºä»¶ï¼onNextï¼onErrorï¼å onCompleteï¼ã
ææè¿äºæ¹æ³é½æ»¡è¶³ç¸åçè®¾è®¡ï¼å®ä»¬å¬å¼ä¸ä¸ªAPIæ¥è§¦åæä»¬ç§°ä¸ºæ¥æ¶å¨çäºä»¶ãå®éä¸æä¸äºæ¥æ¶å¨åä½ï¼ç¨åæä»¬å°ä»ç»ã</p>
</div>
<div class="sect3">
<h4 id="producing.generate"><a class="anchor" href="#producing.generate"></a>4.4.1. Synchronous <code>generate</code></h4>
<div class="paragraph">
<p>The simplest form of programmatic creation of a <code>Flux</code> is through the <code>generate</code>
method, which takes a generator function.</p>
</div>
<div class="paragraph">
<p>ä»¥ç¼ç¨æ¹å¼åå»ºâ Fluxâçæç®åå½¢å¼æ¯éè¿â generateâæ¹æ³ï¼éè¿ä½¿ç¨çæå¨åè½ã</p>
</div>
<div class="paragraph">
<p>This is for <strong>synchronous</strong> and <strong>one-by-one</strong> emissions, meaning that
the sink is a <code>SynchronousSink</code> and that its <code>next()</code> method can only be called
at most once per callback invocation. You can then additionally call <code>error(Throwable)</code>
or <code>complete()</code>, but this is optional.</p>
</div>
<div class="paragraph">
<p>è¿ç¨äº*åæ­¥åå°*å*ä¸å¯¹ä¸*åå°ï¼è¿æå³çæ¥æ¶å¨ä¸º SynchronousSinkï¼å¹¶ä¸å¶next()æ¹æ³æå¤åªè½å¨æ¯æ¬¡åè°è°ç¨æ¶è°ç¨ä¸æ¬¡ã
ç¶åï¼æ¨å¯ä»¥å¦å¤è°ç¨error(Throwable) æcomplete()ï¼ä½è¿æ¯å¯éçã</p>
</div>
<div class="paragraph">
<p>The most useful variant is probably the one that also lets you keep a state
that you can refer to in your sink usage to decide what to emit next. The generator
function then becomes a <code>BiFunction&lt;S, SynchronousSink&lt;T&gt;, S&gt;</code>, with <code>&lt;S&gt;</code> the
type of the state object. You have to provide a <code>Supplier&lt;S&gt;</code> for the initial
state, and your generator function now returns a new state on each round.</p>
</div>
<div class="paragraph">
<p>ææç¨çåä½å¯è½æ¯ä¸ç§åä½ï¼å®è¿å¯ä»¥è®©æ¨ä¿æå¨æ¥æ¶å¨ä½¿ç¨ä¸­å¯ä»¥åèçç¶æï¼ä»¥å³å®æ¥ä¸æ¥è¦åå°ä»ä¹ã
ç¶åï¼çæå¨å½æ°åä¸ºBiFunction&lt;S, SynchronousSink&lt;T&gt;, S&gt;å¸¦æ&lt;S&gt;ç¶æå¯¹è±¡ç±»åçã
æ¨å¿é¡»Supplier&lt;S&gt;ä¸ºåå§ç¶ææä¾ä¸ä¸ªï¼å¹¶ä¸çæå¨å½æ°ç°å¨å¨æ¯ä¸ªååä¸­é½è¿åä¸ä¸ªæ°ç¶æã</p>
</div>
<div class="paragraph">
<p>For instance, you could use an <code>int</code> as the state:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Example of state-based <code>generate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux.generate(
    () -&gt; 0, <i class="conum" data-value="1"></i><b>(1)</b>
    (state, sink) -&gt; {
      sink.next("3 x " + state + " = " + 3*state); <i class="conum" data-value="2"></i><b>(2)</b>
      if (state == 10) sink.complete(); <i class="conum" data-value="3"></i><b>(3)</b>
      return state + 1; <i class="conum" data-value="4"></i><b>(4)</b>
    });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬æä¾åå§ç¶æå¼0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬ä½¿ç¨ç¶ææ¥éæ©è¦ååºçä¿¡å·ï¼ä¹æ³è¡¨3ä¸­çä¸è¡ï¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>æä»¬è¿ä½¿ç¨å®æ¥éæ©ä½æ¶åæ­¢</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>æä»¬è¿åå¨ä¸ä¸ä¸ªè°ç¨ä¸­ä½¿ç¨çæ°ç¶æï¼é¤éåºåå¨æ­¤è°ç¨ä¸­ç»æ­¢).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code generates the table of 3, as the following sequence:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>3 x 0 = 0
3 x 1 = 3
3 x 2 = 6
3 x 3 = 9
3 x 4 = 12
3 x 5 = 15
3 x 6 = 18
3 x 7 = 21
3 x 8 = 24
3 x 9 = 27
3 x 10 = 30</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also use a mutable <code>&lt;S&gt;</code>. The example above could for instance be
rewritten using a single <code>AtomicLong</code> as the state, mutating it on each round:</p>
</div>
<div class="paragraph">
<p>æ¨ä¹å¯ä»¥ä½¿ç¨å¯åç&lt;S&gt;ãä¾å¦ï¼ä¸é¢çç¤ºä¾å¯ä»¥ä½¿ç¨ä¸ä¸ªAtomicLongç¶æä½ä¸ºéåç¶æï¼å¨æ¯ä¸ªååä¸­å¯¹å¶è¿è¡æ´æ¹</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Mutable state variant</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux.generate(
    AtomicLong::new, <i class="conum" data-value="1"></i><b>(1)</b>
    (state, sink) -&gt; {
      long i = state.getAndIncrement(); <i class="conum" data-value="2"></i><b>(2)</b>
      sink.next("3 x " + i + " = " + 3*i);
      if (i == 10) sink.complete();
      return state; <i class="conum" data-value="3"></i><b>(3)</b>
    });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è¿æ¬¡ï¼æä»¬çæä¸ä¸ªå¯åå¯¹è±¡ä½ä¸ºç¶æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬å¨è¿éæ¹åç¶æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>æä»¬è¿åä¸æ°ç¶æç¸åçå®ä¾.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If your state object needs to clean up some resources, use the
<code>generate(Supplier&lt;S&gt;, BiFunction, Consumer&lt;S&gt;)</code> variant to clean up the last
state instance.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
å¦ææ¨çç¶æå¯¹è±¡éè¦æ¸çä¸äºèµæºï¼è¯·ä½¿ç¨ generate(Supplier&lt;S&gt;, BiFunction, Consumer&lt;S&gt;)åä½æ¥æ¸çæåä¸ä¸ªç¶æå®ä¾
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example uses the <code>generate</code> method that includes a <code>Consumer</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux.generate(
    AtomicLong::new,
      (state, sink) -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      long i = state.getAndIncrement(); <i class="conum" data-value="2"></i><b>(2)</b>
      sink.next("3 x " + i + " = " + 3*i);
      if (i == 10) sink.complete();
      return state; <i class="conum" data-value="3"></i><b>(3)</b>
    }, (state) -&gt; System.out.println("state: " + state)); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>åæ ·ï¼æä»¬çæä¸ä¸ªå¯åå¯¹è±¡ä½ä¸ºç¶æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬å¨è¿éæ¹åç¶æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>æä»¬è¿åä¸æ°ç¶æç¸åçå®ä¾.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>æä»¬å°æåä¸ä¸ªç¶æå¼ï¼11ï¼è§ä¸ºæ­¤Consumerlambda çè¾åº.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In the case of the state containing a database connection or other resource
that needs to be handled at the end of the process, the <code>Consumer</code> lambda could
close the connection or  otherwise handle any tasks that should be done at the
end of the process.</p>
</div>
<div class="paragraph">
<p>å¦æç¶æåå«å¨è¿ç¨ç»ææ¶éè¦å¤ççæ°æ®åºè¿æ¥æå¶ä»èµæºï¼åConsumer lambdaå¯ä»¥å³é­è¿æ¥æä»¥å¶ä»æ¹å¼å¤çåºå¨è¿ç¨ç»ææ¶å®æçä»»ä½ä»»å¡</p>
</div>
</div>
<div class="sect3">
<h4 id="producing.create"><a class="anchor" href="#producing.create"></a>4.4.2. Asynchronous and Multi-threaded: <code>create</code></h4>
<div class="paragraph">
<p><code>create</code> is a more advanced form of programmatic creation of a <code>Flux</code> which is
suitable for multiple emissions per round, even from multiple threads.</p>
</div>
<div class="paragraph">
<p>createæ¯Fluxåçä¸ç§æ´é«çº§çç¨åºååå»ºå½¢å¼ï¼éç¨äºæ¯è½®å¤æ¬¡ææ¾ï¼çè³æ¥èªå¤ä¸ªçº¿ç¨ã</p>
</div>
<div class="paragraph">
<p>It exposes a <code>FluxSink</code>, with its <code>next</code>, <code>error</code>, and <code>complete</code> methods.
Contrary to <code>generate</code>, it doesn&#8217;t have a state-based variant. On the other
hand, it can trigger multi-threaded events in the callback.</p>
</div>
<div class="paragraph">
<p>å®æ´é²äºFluxSinkï¼ä¸å®çnextï¼erroråcompleteæ¹æ³ãä¸æ­¤ç¸ågenerateï¼å®æ²¡æåºäºç¶æçåä½ãå¦ä¸æ¹é¢ï¼å®å¯ä»¥è§¦ååè°ä¸­çå¤çº¿ç¨äºä»¶ã</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>create</code> can be very useful to bridge an existing API with the reactive
world - such as an asynchronous API based on listeners.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
create å°ç°æçAPIä¸ååºä¸çèç³»èµ·æ¥éå¸¸æç¨-ä¾å¦åºäºä¾¦å¬å¨çå¼æ­¥APIã
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>create</code> <strong>doesn&#8217;t parallelize your code nor does it make it asynchronous</strong>, even
though it <em>can</em> be used with asynchronous APIs. If you block within the <code>create</code> lambda,
you expose yourself to deadlocks and similar side effects. Even with the use of <code>subscribeOn</code>,
there&#8217;s the caveat that a long-blocking <code>create</code> lambda (such as an infinite loop calling
<code>sink.next(t)</code>) can lock the pipeline: the requests would never be performed due to the
loop starving the same thread they are supposed to run from. Use the <code>subscribeOn(Scheduler, false)</code>
variant: <code>requestOnSeparateThread = false</code> will use the <code>Scheduler</code> thread for the <code>create</code>
and still let data flow by performing <code>request</code> in the original thread.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
create å³ä½¿å®å¯ä»¥ä¸å¼æ­¥APIä¸èµ·ä½¿ç¨ï¼ä¹ä¸ä¼å¹¶è¡åæ¨çä»£ç ï¼ä¹ä¸ä¼ä½¿å¶å¼æ­¥ã
å¦ææ¨å¨createlambdaä¸­é»å¡ï¼åä¼ä½¿èªå·±é·å¥åµå±åç±»ä¼¼çå¯ä½ç¨ã
å³ä½¿ä½¿ç¨subscribeOnï¼ä¹æä¸ä¸ªè­¦åï¼å³é¿é»å¡çcreate lambdaï¼ä¾å¦æ éå¾ªç¯è°ç¨ sink.next(t)ï¼å¯ä»¥éå®ç®¡éï¼ç±äºå¾ªç¯ä¼é¥¿æ­»å®ä»¬åºè¯¥ä»ä¸­è¿è¡çç¸åçº¿ç¨ï¼å æ­¤å°æ°¸è¿ä¸ä¼æ§è¡è¯·æ±ã
ä½¿ç¨subscribeOn(Scheduler, false) åä½ï¼requestOnSeparateThread = falseå°Schedulerçº¿ç¨ç¨äºï¼create å¹¶ä»ç¶éè¿requestå¨åå§çº¿ç¨ä¸­æ§è¡æ¥è®©æ°æ®æµå¨ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Imagine that you use a listener-based API. It processes data by chunks
and has two events: (1) a chunk of data is ready and (2) the processing is
complete (terminal event), as represented in the <code>MyEventListener</code> interface:</p>
</div>
<div class="paragraph">
<p>åè®¾æ¨ä½¿ç¨åºäºä¾¦å¬å¨çAPIã
å®æåå¤çæ°æ®å¹¶æä¸¤ä¸ªäºä»¶ï¼ï¼1ï¼æ°æ®åå·²åå¤å°±ç»ªï¼å¹¶ä¸ï¼2ï¼å¤çå®æï¼ç»ç«¯äºä»¶ï¼ï¼å¦MyEventListeneræ¥å£æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">interface MyEventListener&lt;T&gt; {
    void onDataChunk(List&lt;T&gt; chunk);
    void processComplete();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can use <code>create</code> to bridge this into a <code>Flux&lt;T&gt;</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; bridge = Flux.create(sink -&gt; {
    myEventProcessor.register( <i class="conum" data-value="4"></i><b>(4)</b>
      new MyEventListener&lt;String&gt;() { <i class="conum" data-value="1"></i><b>(1)</b>

        public void onDataChunk(List&lt;String&gt; chunk) {
          for(String s : chunk) {
            sink.next(s); <i class="conum" data-value="2"></i><b>(2)</b>
          }
        }

        public void processComplete() {
            sink.complete(); <i class="conum" data-value="3"></i><b>(3)</b>
        }
    });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æ¡¥æ¥å°MyEventListenerAPI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>åä¸­çæ¯ä¸ªåç´ é½æä¸ºä¸­çä¸ä¸ªåç´ Flux.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>è¯¥processCompleteäºä»¶å·²ç¿»è¯ä¸ºonComplete.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>æ¯å½myEventProcessoræ§è¡æ¶ï¼ææè¿äºæä½é½æ¯å¼æ­¥å®æç.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Additionally, since <code>create</code> can bridge asynchronous APIs and manages backpressure, you
can refine how to behave backpressure-wise, by indicating an <code>OverflowStrategy</code>:</p>
</div>
<div class="paragraph">
<p>æ­¤å¤ï¼ç±äºcreateå¯ä»¥æ¡¥æ¥å¼æ­¥APIå¹¶ç®¡çèåï¼å æ­¤æ¨å¯ä»¥éè¿æç¤ºä»¥ä¸åå®¹æ¥ä¼åå¦ä½è¿è¡èåè¡ä¸ºOverflowStrategyï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IGNORE</code> to Completely ignore downstream backpressure requests.
This may yield <code>IllegalStateException</code> when queues get full downstream.</p>
</li>
<li>
<p><code>ERROR</code> to signal an <code>IllegalStateException</code> when the downstream can&#8217;t keep
up.</p>
</li>
<li>
<p><code>DROP</code> to drop the incoming signal if the downstream is not ready to receive
it.</p>
</li>
<li>
<p><code>LATEST</code> to let downstream only get the latest signals from upstream.</p>
</li>
<li>
<p><code>BUFFER</code> (the default) to buffer all signals if the downstream can&#8217;t keep up.
(this does unbounded buffering and may lead to <code>OutOfMemoryError</code>).</p>
</li>
<li>
<p>IGNOREå®å¨å¿½ç¥ä¸æ¸¸èåè¯·æ±ãIllegalStateExceptionå½éåä¸æ¸¸åæ»¡æ¶ï¼å¯è½ä¼äº§çè¿ç§æåµ.</p>
</li>
<li>
<p>ERROR å»åéä¸ä¸ª IllegalStateExceptionä¿¡å·ï¼å½ä¸æ¸¸æ æ³è·ä¸æ¶ååºä¿¡å·.</p>
</li>
<li>
<p>DROP å¦æä¸æ¸¸å°æªåå¤å¥½æ¥æ¶ä¿¡å·ï¼åä¸¢å¼è¯¥ä¿¡å·.</p>
</li>
<li>
<p>LATEST è®©ä¸æ¸¸åªä»ä¸æ¸¸è·åææ°ä¿¡å·.</p>
</li>
<li>
<p>BUFFERï¼é»è®¤è®¾ç½®ï¼ä»¥å¨ä¸æ¸¸æ æ³è·ä¸æ¶ç¼å²ææä¿¡å·ãï¼è¿ä¼å®ç°æ éç¼å²ï¼å¹¶å¯è½å¯¼è´OutOfMemoryError).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Mono</code> also has a <code>create</code> generator. The <code>MonoSink</code> of Mono&#8217;s create
doesn&#8217;t allow several emissions. It will drop all signals after the first one.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Monoä¹æä¸ä¸ªcreateåé å¨ãå¨MonoSinkçåé æ¹æ³ä¸­ä¸åè®¸å ä¸ªåå°ãå®å°å¨ç¬¬ä¸ä¸ªä¿¡å·ä¹åä¸¢å¼ææä¿¡å·
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_asynchronous_but_single_threaded_push"><a class="anchor" href="#_asynchronous_but_single_threaded_push"></a>4.4.3. Asynchronous but single-threaded: <code>push</code></h4>
<div class="paragraph">
<p><code>push</code> is a middle ground between <code>generate</code> and <code>create</code> which is suitable for
processing events from a single producer. It is similar to <code>create</code> in the sense
that it can also be asynchronous and can manage backpressure using any of the
overflow strategies supported by <code>create</code>. However, <strong>only one producing thread</strong>
may invoke <code>next</code>, <code>complete</code> or <code>error</code> at a time.</p>
</div>
<div class="paragraph">
<p>pushæ¯ä¹é´çä¸­é´æ¥å°generateå¹¶ä¸createå¶éç¨äºä»ä¸ä¸ªçäº§èå¤çäºä»¶ãä»createæç§æä¹ä¸è®²ï¼å®ç±»ä¼¼äºï¼å®ä¹å¯ä»¥æ¯å¼æ­¥çï¼å¹¶ä¸å¯ä»¥ä½¿ç¨ææ¯æçä»»ä½æº¢åºç­ç¥æ¥ç®¡çèåcreateã
ä½æ¯ï¼åªæä¸ä¸ªçº¿ç¨çäº§ å¯ä»¥è°ç¨nextï¼completeæerrorå¨åä¸æ¶é´ã</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; bridge = Flux.push(sink -&gt; {
    myEventProcessor.register(
      new SingleThreadEventListener&lt;String&gt;() { <i class="conum" data-value="1"></i><b>(1)</b>

        public void onDataChunk(List&lt;String&gt; chunk) {
          for(String s : chunk) {
            sink.next(s); <i class="conum" data-value="2"></i><b>(2)</b>
          }
        }

        public void processComplete() {
            sink.complete(); <i class="conum" data-value="3"></i><b>(3)</b>
        }

        public void processError(Throwable e) {
            sink.error(e); <i class="conum" data-value="4"></i><b>(4)</b>
        }
    });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æ¡¥æ¥å°SingleThreadEventListener API.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä½¿ç¨nextåä¸ªä¾¦å¬å¨çº¿ç¨å°äºä»¶æ¨éå°æ¥æ¶å¨.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>complete ä»åä¸ä¾¦å¬å¨çº¿ç¨çæçäºä»¶.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>error äºä»¶ä¹ä»åä¸ä¾¦å¬å¨çº¿ç¨çæ.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_a_hybrid_pushpull_model"><a class="anchor" href="#_a_hybrid_pushpull_model"></a>A hybrid push/pull model</h5>
<div class="paragraph">
<p>Most Reactor operators, like <code>create</code>, follow a hybrid <strong>push/pull</strong> model.
What we mean by that is that despite most of the processing being asynchronous
(suggesting a <em>push</em> approach), there is a small <em>pull</em> component to it: the
request.</p>
</div>
<div class="paragraph">
<p>åçå¤§å¤æ°Reactorè¿ç®ç¬¦é½createéµå¾ªæ··å æ¨/ææ¨¡åã
æä»¬çæææ¯ï¼å°½ç®¡å¤§å¤æ°å¤çé½æ¯å¼æ­¥çï¼å»ºè®®éç¨æ¨éæ¹æ³ï¼ï¼ä½å¶ä¸­æä¸ä¸ªå¾å°çæç»ä»¶ï¼è¯·æ±ã</p>
</div>
<div class="paragraph">
<p>The consumer <em>pulls</em> data from the source in the sense that it won&#8217;t emit anything
until first requested. The source <em>pushes</em> data to the consumer whenever it
becomes available, but within the bounds of its requested amount.</p>
</div>
<div class="paragraph">
<p>æ¶è´¹èä»æºä¸­æåæ°æ®ï¼è¿æå³çç´å°ç¬¬ä¸æ¬¡è¯·æ±å®æååºä»»ä½ä¸è¥¿ã
åªè¦æå¯ç¨ï¼æºå°±ä¼å°æ°æ®æ¨éå°ä½¿ç¨èï¼ä½è¦å¨å¶è¯·æ±æ°éçèå´å</p>
</div>
<div class="paragraph">
<p>Note that <code>push()</code> and <code>create()</code> both allow to set up an <code>onRequest</code> consumer
in order to manage the request amount and to ensure that data is pushed through
the sink only when there is pending request.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼push()å¹¶ä¸create()ä¸¤èé½åè®¸è®¾ç½®onRequestä½¿ç¨èä»¥ç®¡çè¯·æ±éï¼å¹¶ç¡®ä¿ä»å¨æå¾å¤ççè¯·æ±æ¶æéè¿æ¥æ¶å¨æ¨éæ°æ®</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; bridge = Flux.create(sink -&gt; {
    myMessageProcessor.register(
      new MyMessageListener&lt;String&gt;() {

        public void onMessage(List&lt;String&gt; messages) {
          for(String s : messages) {
            sink.next(s); <i class="conum" data-value="3"></i><b>(3)</b>
          }
        }
    });
    sink.onRequest(n -&gt; {
        List&lt;String&gt; messages = myMessageProcessor.getHistory(n); <i class="conum" data-value="1"></i><b>(1)</b>
        for(String s : message) {
           sink.next(s); <i class="conum" data-value="2"></i><b>(2)</b>
        }
    });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ååºè¯·æ±æ¶è½®è¯¢æ¶æ¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦ææ¶æ¯ç«å³å¯ç¨ï¼è¯·å°å¶æ¨å¥æ¥æ¶å¨.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¶ä½çæ¶æ¯ä¹å°å¨ç¨åè¢«å¼æ­¥ä¼ éå°è¾¾.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_cleaning_up_after_push_or_create"><a class="anchor" href="#_cleaning_up_after_push_or_create"></a>Cleaning up after <code>push()</code> or <code>create()</code></h5>
<div class="paragraph">
<p>Two callbacks, <code>onDispose</code> and <code>onCancel</code>, perform any cleanup on cancellation
or termination. <code>onDispose</code> can be used to perform cleanup when the <code>Flux</code>
completes, errors out, or is cancelled. <code>onCancel</code> can be used to perform any
action specific to cancellation prior to cleanup with <code>onDispose</code>.</p>
</div>
<div class="paragraph">
<p>ä¸¤ä¸ªåè°onDisposeåonCancelå¨åæ¶æ¶æ§è¡ä»»ä½æ¸çæç»æ­¢ã å½`Flux` å®æï¼åºéæèè¢«åæ¶æ¶ï¼`onDispose`å¯ç¨äºæ§è¡æ¸çã
`onCancel`å¯ç¨äºæ§è¡ä»»ä½å¨ä½¿ç¨onDisposeè¿è¡æ¸çä¹åï¼ç¹å®äºåæ¶çæä½ã</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; bridge = Flux.create(sink -&gt; {
    sink.onRequest(n -&gt; channel.poll(n))
        .onCancel(() -&gt; channel.cancel()) <i class="conum" data-value="1"></i><b>(1)</b>
        .onDispose(() -&gt; channel.close())  <i class="conum" data-value="2"></i><b>(2)</b>
    });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>onCancel é¦åè°ç¨ï¼ä»ç¨äºåæ¶ä¿¡å·.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>onDispose è°ç¨ä¸ºå®æï¼éè¯¯æåæ¶ä¿¡å·èè°ç¨.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_handle"><a class="anchor" href="#_handle"></a>4.4.4. Handle</h4>
<div class="paragraph">
<p>The <code>handle</code> method is a bit different: it is an instance method, meaning that
it is chained on an existing source (as are the common operators). It is present
in both <code>Mono</code> and <code>Flux</code>.</p>
</div>
<div class="paragraph">
<p>handleæ¹æ³æç¹ä¸åï¼å®æ¯ä¸ä¸ªå®ä¾æ¹æ³ï¼è¿æå³çå®è¢«é¾æ¥å¨ä¸ä¸ªç°æçæºä¸ï¼å¸¸è§çè¿ç®ç¬¦ä¹æ¯å¦æ­¤ï¼ãå®å­å¨äºMonoåä¸­Fluxã</p>
</div>
<div class="paragraph">
<p>It is close to <code>generate</code>, in the sense that it uses a <code>SynchronousSink</code> and
only allows one-by-one emissions. However, <code>handle</code> can be used to generate an
arbitrary value out of each source element, possibly skipping some elements. In
this way, it can serve as a combination of <code>map</code> and <code>filter</code>. The signature of
handle is as follows:</p>
</div>
<div class="paragraph">
<p>å®æ¥è¿generateï¼ä»æç§æä¹ä¸è¯´ï¼å®ä½¿ç¨ SynchronousSink ä¸ä»åè®¸ä¸å¯¹ä¸çåå°ã
ä½æ¯ï¼handleå¯ç¨äºä»æ¯ä¸ªæºåç´ ä¸­çæä»»æå¼ï¼å¯è½ä¼è·³è¿æäºåç´ ãéè¿è¿ç§æ¹å¼ï¼å®å¯ä»¥ä½ä¸ºmapåfilterç»åä¸æ ·ä½¿ç¨ã
handleçç­¾åå¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;R&gt; handle(BiConsumer&lt;T, SynchronousSink&lt;R&gt;&gt;);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s consider an example. The reactive streams specification disallows <code>null</code>
values in a sequence. What if you want to perform a <code>map</code> but you want to use
a preexisting method as the map function, and that method sometimes returns null?</p>
</div>
<div class="paragraph">
<p>è®©æä»¬èèä¸ä¸ªä¾å­ãååºæ§æµè§èä¸åè®¸nullå¼å¨åºåä¸­ãå¦æè¦æ§è¡ä¸ä¸ª mapæ¹æ³ï¼ä½æ³ä½¿ç¨ä¸ä¸ªé¢åå­å¨çæ¹æ³ä½ä¸ºmapå½æ°ï¼èè¯¥æ¹æ³ææ¶è¿ånullæä¹åï¼</p>
</div>
<div class="paragraph">
<p>For instance, the following method can be applied safely to a source of
integers:</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼ä»¥ä¸æ¹æ³å¯ä»¥å®å¨å°åºç¨äºæ´æ°æºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public String alphabet(int letterNumber) {
	if (letterNumber &lt; 1 || letterNumber &gt; 26) {
		return null;
	}
	int letterIndexAscii = 'A' + letterNumber - 1;
	return "" + (char) letterIndexAscii;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can then use <code>handle</code> to remove any nulls:</p>
</div>
<div class="paragraph">
<p>ç¶åï¼æä»¬å¯ä»¥ä½¿ç¨handleå é¤ä»»ä½ç©ºå¼ï¼</p>
</div>
<div class="paragraph">
<div class="title">Using <code>handle</code> for a "map and eliminate nulls" scenario</div>
<p>handleç¨äºâæ å°å¹¶æ¶é¤ç©ºå¼âåºæ¯</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; alphabet = Flux.just(-1, 30, 13, 9, 20)
    .handle((i, sink) -&gt; {
        String letter = alphabet(i); <i class="conum" data-value="1"></i><b>(1)</b>
        if (letter != null) <i class="conum" data-value="2"></i><b>(2)</b>
            sink.next(letter); <i class="conum" data-value="3"></i><b>(3)</b>
    });

alphabet.subscribe(System.out::println);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æ å°å°å­æ¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦æâ map functionâè¿ånull</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>éè¿ä¸è°ç¨è¿æ»¤æå®sink.next.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Which will print out:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>M
I
T</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="schedulers"><a class="anchor" href="#schedulers"></a>4.5. Threading and Schedulers</h3>
<div class="paragraph">
<p>Reactor, like RxJava, can be considered to be <strong>concurrency-agnostic</strong>. That is, it does not
enforce a concurrency model. Rather, it leaves you, the developer, in command. However,
that does not prevent the library from helping you with concurrency.</p>
</div>
<div class="paragraph">
<p>åRxJavaä¸æ ·ï¼Reactorå¯ä»¥è¢«è§ä¸ºä¸å¹¶åæ å³çã
ä¹å°±æ¯è¯´ï¼å®ä¸å¼ºå¶æ§è¡å¹¶åæ¨¡åãç¸åï¼å®ä½¿æ¨ï¼å¼åäººåï¼å¤äºå½ä»¤ç¶æãä½æ¯ï¼è¿ä¸ä¼é»æ­¢ä½ ä½¿ç¨å¹¶ååºã</p>
</div>
<div class="paragraph">
<p>Obtaining a <code>Flux</code> or a <code>Mono</code> does not necessarily mean that it runs in a dedicated
<code>Thread</code>. Instead, most operators continue working in the <code>Thread</code> on which the
previous operator executed. Unless specified, the topmost operator (the source)
itself runs on the <code>Thread</code> in which the <code>subscribe()</code> call was made. The following
example runs a <code>Mono</code> in a new thread:</p>
</div>
<div class="paragraph">
<p>è·å¾ Fluxæ Monoä¸ä¸å®æå³çå®è¿è¡å¨ä¸ç¨çThread ä¸­ãåèä»£ä¹çæ¯ï¼å¤§å¤æ°è¿ç®ç¬¦Threadå°å¨ååçè¿ç®ç¬¦æ§è¡æ¶ç»§ç»­å·¥ä½ã
é¤éå¦æè¯´æï¼æä¸é¢çæä½ï¼æºï¼æ¬èº«ä¸è¿è¡ï¼Threadå¶å¨subscribe()æäººå¼åãä»¥ä¸ç¤ºä¾Monoå¨æ°çº¿ç¨ä¸­è¿è¡ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void main(String[] args) throws InterruptedException {
  final Mono&lt;String&gt; mono = Mono.just("hello "); <i class="conum" data-value="1"></i><b>(1)</b>

  Thread t = new Thread(() -&gt; mono
      .map(msg -&gt; msg + "thread ")
      .subscribe(v -&gt; <i class="conum" data-value="2"></i><b>(2)</b>
          System.out.println(v + Thread.currentThread().getName()) <i class="conum" data-value="3"></i><b>(3)</b>
      )
  )
  t.start();
  t.join();

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è¯¥Mono&lt;String&gt;ç»è£å¨çº¿ç¨main.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ä½æ¯ï¼å®æ¯å¨threadä¸­è®¢éçThread-0.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å æ­¤ï¼mapåonNextåè°å®éä¸é½å¨Thread-0</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>hello thread Thread-0</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In Reactor, the execution model and where the execution happens is determined by the
<code>Scheduler</code> that is used. A
<a href="https://projectreactor.io/docs/core/release/api/reactor/core/scheduler/Scheduler.html"><code>Scheduler</code></a>
has scheduling responsibilities similar to an <code>ExecutorService</code>, but having a
dedicated abstraction lets it do more, notably acting as a clock and enabling
a wider range of implementations (virtual time for tests, trampolining or
immediate scheduling, and so on).</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­ï¼æ§è¡æ¨¡åä»¥åæ§è¡çä½ç½®ç±æSchedulerä½¿ç¨æç¡®å®ç ã
Scheduler å·æä¸ExecutorServiceç¸ä¼¼çè°åº¦èè´£ï¼ä½æ¯å·æä¸ç¨çæ½è±¡ä½¿å¶å¯ä»¥åæ´å¤çäºæï¼
å°¤å¶æ¯åå½æ¶éå¹¶æ¯ææ´å¹¿æ³çå®ç°ï¼æµè¯çèææ¶é´ï¼è¹¦åºæå³æ¶è°åº¦ç­ï¼ã</p>
</div>
<div class="paragraph">
<p>The <a href="https://projectreactor.io/docs/core/release/api/reactor/core/scheduler/Schedulers.html"><code>Schedulers</code></a>
class has static methods that give access to the following execution contexts:
Schedulers ç±»æç»è®¿é®ä»¥ä¸æ§è¡ä¸ä¸æçéææ¹æ³ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No execution context (<code>Schedulers.immediate()</code>): at processing time, the submitted <code>Runnable</code>
will be directly executed, effectively running them on the current <code>Thread</code> (can be seen as a "null object" or no-op <code>Scheduler</code>).</p>
</li>
<li>
<p>A single, reusable thread (<code>Schedulers.single()</code>). Note that this method reuses the
same thread for all callers, until the Scheduler is disposed. If you want a per-call
dedicated thread, use <code>Schedulers.newSingle()</code> for each call.</p>
</li>
<li>
<p>An unbounded elastic thread pool (<code>Schedulers.elastic()</code>). This one is no longer preferred
with the introduction of <code>Schedulers.boundedElastic()</code>, as it has a tendency to hide backpressure
problems and lead to too many threads (see below).</p>
</li>
<li>
<p>A bounded elastic thread pool (<code>Schedulers.boundedElastic()</code>). Like its predecessor <code>elastic()</code>, it
creates new worker pools as needed and reuses idle ones. Worker pools that stay idle for too long (the default is 60s) are
also disposed. Unlike its <code>elastic()</code> predecessor, it has a cap on the number of backing threads it can create (default is number of CPU cores x 10).
Up to 100 000 tasks submitted after the cap has been reached are enqueued and will be re-scheduled when a thread becomes available
(when scheduling with a delay, the delay starts when the thread becomes available). This is a better choice for I/O blocking work.
<code>Schedulers.boundedElastic()</code> is a handy way to give a blocking process its own thread so that
it does not tie up other resources. See <a href="#faq.wrap-blocking">How Do I Wrap a Synchronous, Blocking Call? å¦ä½åè£åæ­¥é»å¡å¼å«?</a>, but doesn&#8217;t pressure the system too much with new threads.</p>
</li>
<li>
<p>A fixed pool of workers that is tuned for parallel work (<code>Schedulers.parallel()</code>). It
creates as many workers as you have CPU cores.</p>
</li>
<li>
<p>æ²¡ææ§è¡ä¸ä¸æï¼Schedulers.immediate()ï¼ï¼å¨å¤çæ¶ï¼æäº¤çæä»¶Runnable å°è¢«ç´æ¥æ§è¡ï¼ä»èææå°å¨å½åThreadä¸è¿è¡ï¼å¯ä»¥è§ä¸ºâç©ºå¯¹è±¡âæno-op Schedulerï¼ã</p>
</li>
<li>
<p>åä¸ªå¯éç¨çº¿ç¨ï¼Schedulers.single()ï¼ãè¯·æ³¨æï¼æ­¤æ¹æ³å¯¹ææè°ç¨æ¹é½ä½¿ç¨ç¸åççº¿ç¨ï¼ç´å°è°åº¦ç¨åºè¢«éæ¾ä¸ºæ­¢ãå¦ææ¨éè¦ä¸ä¸ªæ¯æ¬¡è°ç¨ä¸ç¨çº¿ç¨ï¼è¯·Schedulers.newSingle()ä¸ºæ¯ä¸ªè°ç¨ä½¿ç¨ã</p>
</li>
<li>
<p>æ éå¶çå¼¹æ§çº¿ç¨æ± ï¼Schedulers.elastic()ï¼ãå¼å¥æ¶Schedulers.boundedElastic()ï¼ä¸åé¦éè¯¥çº¿ç¨ï¼å ä¸ºå®å¾åäºéèèåé®é¢å¹¶å¯¼è´çº¿ç¨è¿å¤ï¼è¯·åè§ä¸æï¼ã</p>
</li>
<li>
<p>æççå¼¹æ§çº¿ç¨æ± ï¼Schedulers.boundedElastic()ï¼ãåå¶åèº«ä¸æ ·elastic()ï¼å®æ ¹æ®éè¦åå»ºæ°çå·¥ä½æ± ï¼å¹¶éç¨ç©ºé²çå·¥ä½æ± ãé²ç½®æ¶é´è¿é¿ï¼é»è®¤å¼ä¸º60sï¼çå·¥ä½æ± ä¹å°è¢«ä¸¢å¼ã
ä¸ä¹åçelastic()çæ¬ä¸åï¼å®å¯¹å¯ä»¥åå»ºçæ¯æçº¿ç¨æ°è¿è¡äºéå¶ï¼é»è®¤å¼ä¸ºCPUåæ ¸æ°x 10ï¼ãè¾¾å°ä¸éåï¼æå¤å¯æäº¤10ä¸ä¸ªä»»å¡ï¼å¹¶å¨çº¿ç¨å¯ç¨æ¶éæ°è°åº¦ï¼å½å»¶è¿è°åº¦æ¶ï¼å»¶è¿å¨çº¿ç¨å¯ç¨æ¶å¼å§ï¼ã
è¿æ¯I / Oé»æ­¢å·¥ä½çæ´å¥½éæ©ã Schedulers.boundedElastic()æ¯ä¸ç§ä¸ºé»å¡è¿ç¨åéèªå·±ççº¿ç¨çç®ä¾¿æ¹æ³ï¼è¿æ ·å®å°±ä¸ä¼å ç¨å¶ä»èµæºãè¯·åé<a href="#faq.wrap-blocking">How Do I Wrap a Synchronous, Blocking Call? å¦ä½åè£åæ­¥é»å¡å¼å«?</a>ï¼ä½ä½¿ç¨æ°çº¿ç¨ä¸ä¼å¯¹ç³»ç»é æå¤ªå¤§ååã</p>
</li>
<li>
<p>å·²è°æ´ä¸ºå¹¶è¡å·¥ä½çåºå®å·¥ä½æ± ï¼Schedulers.parallel()ï¼ãå®åå»ºçå·¥ä½çº¿ç¨æ°éä¸CPUåæ ¸æ°éä¸æ ·å¤ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, you can create a <code>Scheduler</code> out of any pre-existing <code>ExecutorService</code> by
using <code>Schedulers.fromExecutorService(ExecutorService)</code>. (You can also create one from an
<code>Executor</code>, although doing so is discouraged.)</p>
</div>
<div class="paragraph">
<p>æ­¤å¤ï¼æ¨å¯ä»¥åå»ºä¸ä¸ªSchedulerä¸å­å¨ExecutorServiceçå¯¹è±¡ä½¿ç¨Schedulers.fromExecutorService(ExecutorService)ã
ï¼Executorå°½ç®¡ä¸å»ºè®®è¿æ ·åï¼ä¹å¯ä»¥ä»ä¸­åå»ºä¸ä¸ª ãï¼</p>
</div>
<div class="paragraph">
<p>You can also create new instances of the various scheduler types by using the <code>newXXX</code>
methods. For example, <code>Schedulers.newParallel(yourScheduleName)</code> creates a new parallel
scheduler named <code>yourScheduleName</code>.</p>
</div>
<div class="paragraph">
<p>æ¨è¿å¯ä»¥ä½¿ç¨è¿äºnewXXX æ¹æ³æ¥åå»ºåç§è°åº¦ç¨åºç±»åçæ°å®ä¾ã
ä¾å¦ï¼Schedulers.newParallel(yourScheduleName)åå»ºä¸ä¸ªåä¸º yourScheduleName çæ°å¹¶è¡è°åº¦ç¨åºã</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While <code>boundedElastic</code> is made to help with legacy blocking code if it cannot be avoided,
<code>single</code> and <code>parallel</code> are not. As a consequence, the use of Reactor blocking APIs
(<code>block()</code>, <code>blockFirst()</code>, <code>blockLast()</code> (as well as iterating over <code>toIterable()</code>
or <code>toStream()</code>) inside the default single and parallel schedulers) results in
an <code>IllegalStateException</code> being thrown.</p>
</div>
<div class="paragraph">
<p>Custom <code>Schedulers</code> can also be marked as "non blocking only" by creating instances of <code>Thread</code>
that implement the <code>NonBlocking</code> marker interface.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>è½ç¶boundedElasticæ¯å¸®å©å¶é ä¸ä¼ ç»çé»å¡ä»£ç ï¼å¦ææ æ³é¿åï¼ singleèä¸parallelé½æ²¡æãå æ­¤ï¼ä½¿ç¨ååºå¨é»å¡çAPIï¼ ï¼block()ï¼blockFirst()ï¼blockLast()ä»¥åéåtoIterable() ætoStream()ï¼çé»è®¤ååå¹¶è¡è°åº¦å¨åï¼å¯¼è´å¨IllegalStateExceptionè¢«æåºã</p>
</div>
<div class="paragraph">
<p>Schedulerséè¿åå»ºThread å®ç°NonBlockingæ è®°æ¥å£çå®ä¾ï¼ä¹å¯ä»¥å°Custom æ è®°ä¸ºâä»éé»å¡â ã</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some operators use a specific scheduler from <code>Schedulers</code> by default (and usually give
you the option of providing a different one). For instance, calling the
<code>Flux.interval(Duration.ofMillis(300))</code> factory method produces a <code>Flux&lt;Long&gt;</code> that ticks every 300ms.
By default, this is enabled by <code>Schedulers.parallel()</code>. The following line changes the
Scheduler to a new instance similar to <code>Schedulers.single()</code>:</p>
</div>
<div class="paragraph">
<p>æäºæä½åSchedulersé»è®¤æåµä¸ä½¿ç¨ç¹å®çè°åº¦ç¨åºï¼éå¸¸ä¼ä¸ºæ¨æä¾æä¾å¶ä»è°åº¦ç¨åºçéé¡¹ï¼ã
ä¾å¦ï¼è°ç¨ Flux.interval(Duration.ofMillis(300))factoryæ¹æ³ä¼äº§çä¸ä¸ªFlux&lt;Long&gt;æ¯300æ¯«ç§æ»´ç­ä¸æ¬¡çæ»´ç­å£°ã
é»è®¤æåµä¸ï¼éè¿å¯ç¨Schedulers.parallel()ãä»¥ä¸è¡å°Scheduleræ´æ¹ä¸ºç±»ä¼¼äºSchedulers.single()çæ°å®ä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.interval(Duration.ofMillis(300), Schedulers.newSingle("test"))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Reactor offers two means of switching the execution context (or <code>Scheduler</code>) in a
reactive chain: <code>publishOn</code> and <code>subscribeOn</code>. Both take a <code>Scheduler</code> and let you switch
the execution context to that scheduler. But the placement of <code>publishOn</code> in the chain
matters, while the placement of <code>subscribeOn</code> does not. To understand that difference,
you first have to remember that <a href="#reactive.subscribe">nothing happens until you
subscribe</a>.</p>
</div>
<div class="paragraph">
<p>Reactoræä¾äºä¸¤ç§å¨ååºå¼é¾ä¸­åæ¢æ§è¡ä¸ä¸æï¼æ Schedulerï¼çæ¹å¼ï¼publishOnåsubscribeOnãä¸¤èé½ä½¿ç¨Schedulerï¼è®©æ¨å°æ§è¡ä¸ä¸æåæ¢å°è¯¥è°åº¦ç¨åºã
ä½æ¯publishOnå¨é¾ä¸­çä½ç½®å¾éè¦ï¼èå¨é¾ä¸­çä½ç½®subscribeOnå¹¶ä¸éè¦ãè¦äºè§£è¿ç§å·®å¼ï¼æ¨é¦åå¿é¡»è®°ä½ï¼<a href="#reactive.subscribe">nothing happens until yousubscribe</a>ã</p>
</div>
<div class="paragraph">
<p>In Reactor, when you chain operators, you can wrap as many <code>Flux</code> and <code>Mono</code>
implementations inside one another as you need. Once you subscribe, a chain of
<code>Subscriber</code> objects is created, backward (up the chain) to the first
publisher. This is effectively hidden from you. All you can see is the outer layer of
<code>Flux</code> (or <code>Mono</code>) and <code>Subscription</code>, but these intermediate operator-specific
subscribers are where the real work happens.</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­ï¼å½æ¨é¾æ¥è¿ç®ç¬¦æ¶ï¼å¯ä»¥æ ¹æ®éè¦å°è®¸å¤ å®ç°FluxåMonoå®ç°å½¼æ­¤åè£å¨ä¸èµ·ã
è®¢éåï¼ä¸ä¸ªSubscriberå¯¹è±¡é¾å°è¢«åå»º ï¼ååï¼åä¸ï¼å°ç¬¬ä¸ä¸ªåå¸èã
è¿å®éä¸å¯¹æ¨æ¯éèçãæ¨æçå°çåªæ¯Fluxï¼åMonoï¼å Subscriptionçå¤å±ï¼ä½æ¯è¿äºä¸­é´æä½åç¹å®çè®¢æ·ææ¯çæ­£å·¥ä½çå°æ¹ã</p>
</div>
<div class="paragraph">
<p>With that knowledge, we can have a closer look at the <code>publishOn</code> and <code>subscribeOn</code>
operators:</p>
</div>
<div class="paragraph">
<p>æäºè¿äºç¥è¯ï¼æä»¬å¯ä»¥æ´è¯¦ç»å°äºè§£publishOnand subscribeOn è¿ç®ç¬¦</p>
</div>
<div class="sect3">
<h4 id="_the_publishon_method"><a class="anchor" href="#_the_publishon_method"></a>4.5.1. The <code>publishOn</code> Method</h4>
<div class="paragraph">
<p><code>publishOn</code> applies in the same way as any other operator, in the middle of the
subscriber chain. It takes signals from upstream and replays them downstream while
executing the callback on a worker from the associated <code>Scheduler</code>. Consequently, it
<strong>affects where the subsequent operators execute</strong> (until another <code>publishOn</code> is
chained in), as follows:</p>
</div>
<div class="paragraph">
<p>publishOnå¨è®¢æ·é¾çä¸­é´ä»¥ä¸ä»»ä½å¶ä»è¿è¥åç¸åçæ¹å¼åºç¨ãå®ä»ä¸æ¸¸è·åä¿¡å·å¹¶å¨ä¸æ¸¸éæ­å®ä»¬ï¼åæ¶å¨å³èçä¸å¯¹workeræ§è¡åè°Schedulerã
å æ­¤ï¼å® ä¼å½±ååç»­è¿ç®ç¬¦çæ§è¡ä½ç½®ï¼ç´å°publishOné¾æ¥å¦ä¸ä¸ªè¿ç®ç¬¦ï¼ï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Changes the execution context to one <code>Thread</code> picked by the <code>Scheduler</code></p>
</li>
<li>
<p>as per the specification, <code>onNext</code> calls happen in sequence, so this uses up a single thread</p>
</li>
<li>
<p>unless they work on a specific <code>Scheduler</code>, operators after <code>publishOn</code> continue execution on that same thread</p>
</li>
<li>
<p>å°æ§è¡ä¸ä¸ææ´æ¹Threadä¸ºç±Scheduler</p>
</li>
<li>
<p>æ ¹æ®è§èï¼onNextè°ç¨æ¯æé¡ºåºåççï¼å æ­¤è¿ä¼å ç¨ä¸ä¸ªçº¿ç¨</p>
</li>
<li>
<p>é¤éä»ä»¬å¨ç¹å®çSchedulerï¼æ§è¡publishOnåå¨åä¸çº¿ç¨ä¸å·¥ä½</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example uses the <code>publishOn</code> method:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Scheduler s = Schedulers.newParallel("parallel-scheduler", 4); <i class="conum" data-value="1"></i><b>(1)</b>

final Flux&lt;String&gt; flux = Flux
    .range(1, 2)
    .map(i -&gt; 10 + i)  <i class="conum" data-value="2"></i><b>(2)</b>
    .publishOn(s)  <i class="conum" data-value="3"></i><b>(3)</b>
    .map(i -&gt; "value " + i);  <i class="conum" data-value="4"></i><b>(4)</b>

new Thread(() -&gt; flux.subscribe(System.out::println));  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>åå»ºä¸ä¸ªSchedulerç±åä¸ªThreadå®ä¾æ¯æçæ°å¯¹è±¡ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ç¬¬ä¸ä¸ªmapå¨&lt;5&gt;ä¸­çå¿åçº¿ç¨ä¸è¿è¡ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>publishOn åæ¢æ´ä¸ªåºåå°å¨ Thread&lt;1&gt;ä¸­ã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ç¬¬äºä¸ªmapå¨Thread&lt;1&gt; ä¸è¿è¡.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>è¿å¿åThreadæ¯è¿è¡è®¢éçå°æ¹ãæå°åçå¨ææ°çæ§è¡ä¸ä¸æä¸­ï¼æ¯ä»publishOnåå»ºåºæ¥ç</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_subscribeon_method"><a class="anchor" href="#_the_subscribeon_method"></a>4.5.2. The <code>subscribeOn</code> Method</h4>
<div class="paragraph">
<p><code>subscribeOn</code> applies to the subscription process, when that backward chain is
constructed. As a consequence, no matter where you place the <code>subscribeOn</code> in the chain,
<strong>it always affects the context of the source emission</strong>. However, this does not affect the
behavior of subsequent calls to <code>publishOn</code>&#8201;&#8212;&#8201;they still switch the execution context for
the part of the chain after them.</p>
</div>
<div class="paragraph">
<p>subscribeOnå½æé äºååé¾æ¶ï¼éç¨äºè®¢éè¿ç¨ãå æ­¤ï¼æ è®ºå°å¶æ¾ç½®subscribeOnå¨é¾ä¸­çä»ä¹ä½ç½®ï¼ å®å§ç»ä¼å½±åæºåå°çç¯å¢ã
ä½æ¯ï¼è¿ä¸ä¼å½±ååç»­è°ç¨çè¡ä¸ºï¼publishOnâå®ä»¬ä»ä¼å¨å¶åçé¨åé¾ä¸­åæ¢æ§è¡ä¸ä¸æã</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ä»å¨é¾çè®¢éä¸­æ´æ¹Thread</p>
</li>
<li>
<p>ä»Schedulerä¸­éæ©ä¸ä¸ªçº¿ç¨</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only the earliest <code>subscribeOn</code> call in the chain is actually taken into account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>subscribeOnå®éä¸ä»èèé¾ä¸­ ææ©çå¼å«ã</p>
</div>
<div class="paragraph">
<p>The following example uses the <code>subscribeOn</code> method:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Scheduler s = Schedulers.newParallel("parallel-scheduler", 4); <i class="conum" data-value="1"></i><b>(1)</b>

final Flux&lt;String&gt; flux = Flux
    .range(1, 2)
    .map(i -&gt; 10 + i)  <i class="conum" data-value="2"></i><b>(2)</b>
    .subscribeOn(s)  <i class="conum" data-value="3"></i><b>(3)</b>
    .map(i -&gt; "value " + i);  <i class="conum" data-value="4"></i><b>(4)</b>

new Thread(() -&gt; flux.subscribe(System.out::println));  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>åå»ºä¸ä¸ªSchedulerç±4ä¸ªThreadã.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ç¬¬ä¸ä¸ªmapè¿è¡å¨è¿åä¸ªçº¿ç¨ä¹ä¸ä¸</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å ä¸º subscribeOnä»è®¢éæ¶é´ï¼&lt;5&gt;ï¼çä½ç½®ï¼å°±å¼å§åæ¢äºæ´ä¸ªåºåççº¿ç¨</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ç¬¬äºä¸ªmapä¹è¿è¡å¨åä¸çº¿ç¨ä¸.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å¿åThreadæ¯æååçé¢è®¢çé£ä¸ªï¼ä½subscribeOnç«å³å°å¶è½¬ç§»å°åä¸ªè°åº¦ç¨åºçº¿ç¨ä¹ä¸ã</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="error.handling"><a class="anchor" href="#error.handling"></a>4.6. Handling Errors</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For a quick look at the available operators for error handling, see
<a href="#which.errors">the relevant operator decision tree</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Reactive Streams, errors are terminal events. As soon as an error occurs, it stops the
sequence and gets propagated down the chain of operators to the last step, the
<code>Subscriber</code> you defined and its <code>onError</code> method.</p>
</div>
<div class="paragraph">
<p>å¨ååºå¼æµä¸­ï¼éè¯¯æ¯ç»ç«¯äºä»¶ãä¸æ¦åçéè¯¯ï¼å®å°±ä¼åæ­¢åºåï¼å¹¶æ²¿æä½é¾ä¼ æ­å°æåä¸æ­¥Subscriberä¸ï¼ä½ å®ä¹çonErroræ¹æ³ã</p>
</div>
<div class="paragraph">
<p>Such errors should still be dealt with at the application level. For instance, you might
display an error notification in a UI or send a meaningful error payload in a REST
endpoint. For this reason, the subscriber&#8217;s <code>onError</code> method should always be defined.</p>
</div>
<div class="paragraph">
<p>æ­¤ç±»éè¯¯ä»åºå¨åºç¨ç¨åºçº§å«å¤çãä¾å¦ï¼æ¨å¯è½å¨UIä¸­æ¾ç¤ºéè¯¯éç¥ï¼æå¨RESTç«¯ç¹ä¸­åéææä¹çéè¯¯ææè´è½½ã
å æ­¤ï¼onErroråºå§ç»å®ä¹è®¢æ·çæ¹æ³ã</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If not defined, <code>onError</code> throws an <code>UnsupportedOperationException</code>. You can
further detect and triage it with the <code>Exceptions.isErrorCallbackNotImplemented</code> method.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
å¦ææªå®ä¹ï¼åonErroræåºUnsupportedOperationExceptionãæ¨å¯ä»¥ä½¿ç¨è¯¥Exceptions.isErrorCallbackNotImplementedæ¹æ³è¿ä¸æ­¥å¯¹å¶è¿è¡æ£æµååç±»ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reactor also offers alternative means of dealing with errors in the middle of the chain,
as error-handling operators. The following example shows how to do so:</p>
</div>
<div class="paragraph">
<p>ä½ä¸ºéè¯¯å¤çè¿ç®ç¬¦ï¼Reactorè¿æä¾äºå¤çé¾ä¸­é´éè¯¯çæ¿ä»£æ¹æ³ãä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½æ§è¡æ­¤æä½ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just(1, 2, 0)
    .map(i -&gt; "100 / " + i + " = " + (100 / i)) //this triggers an error with 0
    .onErrorReturn("Divided by zero :("); // error handling example</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Before you learn about error-handling operators, you must keep in mind that
<em>any error in a reactive sequence is a terminal event</em>. Even if an error-handling
operator is used, it does not let the original sequence continue. Rather, it
converts the <code>onError</code> signal into the start of a new sequence (the fallback one). In
other words, it replaces the terminated sequence <em>upstream</em> of it.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
å¨å­¦ä¹ éè¯¯å¤çè¿ç®ç¬¦ä¹åï¼å¿é¡»è®°ä½ï¼ååºåºåä¸­ç ä»»ä½éè¯¯é½æ¯ç»ç«¯äºä»¶ã
å³ä½¿ä½¿ç¨äºéè¯¯å¤çè¿ç®ç¬¦ï¼å®ä¹ä¸ä¼è®©åå§åºåç»§ç»­ãç¸åï¼å®å°onErrorä¿¡å·è½¬æ¢ä¸ºæ°åºåçå¼å§ï¼åå¤åºåï¼ã
æ¢å¥è¯è¯´ï¼å®å°æ¿æ¢å¶ä¸æ¸¸çç»æ­¢åºåã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can consider each means of error handling one-by-one. When relevant, we make a
parallel with imperative programming&#8217;s <code>try</code> patterns.</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼æä»¬å¯ä»¥èèåç§éè¯¯å¤çæ¹å¼ãæä»¬çåä¸å½ä»¤å¼ç¼ç¨çtryæ¨¡å¼ç¸å¹³è¡ã</p>
</div>
<div class="sect3">
<h4 id="_error_handling_operators"><a class="anchor" href="#_error_handling_operators"></a>4.6.1. Error Handling Operators</h4>
<div class="paragraph">
<p>You may be familiar with several ways of dealing with exceptions in a try-catch block.
Most notably, these include the following:</p>
</div>
<div class="paragraph">
<p>æ¨å¯è½çæå¨try-catchåä¸­å¤çå¼å¸¸çå ç§æ¹æ³ãæå¼å¾æ³¨æçæ¯ï¼è¿äºåå®¹åæ¬ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Catch and return a static default value.</p>
</li>
<li>
<p>Catch and execute an alternative path with a fallback method.</p>
</li>
<li>
<p>Catch and dynamically compute a fallback value.</p>
</li>
<li>
<p>Catch, wrap to a <code>BusinessException</code>, and re-throw.</p>
</li>
<li>
<p>Catch, log an error-specific message, and re-throw.</p>
</li>
<li>
<p>Use the <code>finally</code> block to clean up resources or a Java 7 &#8220;try-with-resource&#8221; construct.</p>
</li>
<li>
<p>æè·å¹¶è¿åéæé»è®¤å¼ã</p>
</li>
<li>
<p>ä½¿ç¨åå¤æ¹æ³æè·å¹¶æ§è¡æ¿ä»£è·¯å¾</p>
</li>
<li>
<p>æè·å¹¶å¨æè®¡ç®åå¤å¼</p>
</li>
<li>
<p>æ¥ä½ï¼åè£æBusinessExceptionï¼ç¶åéæ°æåºã</p>
</li>
<li>
<p>æè·ï¼è®°å½ç¹å®äºéè¯¯çæ¶æ¯ï¼ç¶åéæ°æåºã</p>
</li>
<li>
<p>ä½¿ç¨è¯¥finallyåæ¸é¤èµæºæJava 7â try-with-resourceâæé ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these have equivalents in Reactor, in the form of error-handling operators.
Before looking into these operators, we first want to establish a parallel between a reactive
chain and a try-catch block.</p>
</div>
<div class="paragraph">
<p>ææè¿äºé½ä»¥éè¯¯å¤çè¿ç®ç¬¦çå½¢å¼å¨Reactorä¸­å·æç­æé¡¹ãå¨ç ç©¶è¿äºè¿ç®ç¬¦ä¹åï¼æä»¬é¦åè¦å¨ååºé¾åtry-catchåä¹é´å»ºç«å¹¶è¡ã</p>
</div>
<div class="paragraph">
<p>When subscribing, the <code>onError</code> callback at the end of the chain is akin to a <code>catch</code>
block. There, execution skips to the catch in case an <code>Exception</code> is thrown, as the
following example shows:</p>
</div>
<div class="paragraph">
<p>è®¢éæ¶ï¼onErroré¾æ«å°¾çåè°ç±»ä¼¼äºä¸ä¸ªcatch åãExceptionå¦ä¸é¢çç¤ºä¾æç¤ºï¼å¨æ­¤æåµä¸ï¼æ§è¡ä¼è·³å°æè·å°çæåµï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; s = Flux.range(1, 10)
    .map(v -&gt; doSomethingDangerous(v)) <i class="conum" data-value="1"></i><b>(1)</b>
    .map(v -&gt; doSecondTransform(v)); <i class="conum" data-value="2"></i><b>(2)</b>
s.subscribe(value -&gt; System.out.println("RECEIVED " + value), <i class="conum" data-value="3"></i><b>(3)</b>
            error -&gt; System.err.println("CAUGHT " + error) <i class="conum" data-value="4"></i><b>(4)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æ§è¡äºå¯è½å¼åå¼å¸¸çè½¬æ¢</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦æä¸åé¡ºå©ï¼åæ§è¡ç¬¬äºæ¬¡è½¬æ¢</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>æ¯ä¸ªæåè½¬æ¢çå¼é½ä¼æå°åºæ¥</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>åçéè¯¯æ¶ï¼åºåç»æ­¢ï¼å¹¶æ¾ç¤ºéè¯¯æ¶æ¯</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example is conceptually similar to the following try-catch block:</p>
</div>
<div class="paragraph">
<p>åé¢çç¤ºä¾å¨æ¦å¿µä¸ç±»ä¼¼äºä»¥ä¸try-catchåï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
    for (int i = 1; i &lt; 11; i++) {
        String v1 = doSomethingDangerous(i); <i class="conum" data-value="1"></i><b>(1)</b>
        String v2 = doSecondTransform(v1); <i class="conum" data-value="2"></i><b>(2)</b>
        System.out.println("RECEIVED " + v2);
    }
} catch (Throwable t) {
    System.err.println("CAUGHT " + t); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If an exception is thrown here&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203;the rest of the loop is skipped&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; and the execution goes straight to here.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that we have established a parallel, we can look at the different error handling cases
and their equivalent operators.</p>
</div>
<div class="paragraph">
<p>æ¢ç¶æä»¬å·²ç»å»ºç«äºå¹¶è¡ï¼æä»¬å°±å¯ä»¥ç ç©¶ä¸åçéè¯¯å¤çæåµåå¶ç­æçè¿ç®ç¬¦</p>
</div>
<div class="sect4">
<h5 id="_static_fallback_value"><a class="anchor" href="#_static_fallback_value"></a>Static Fallback Value</h5>
<div class="paragraph">
<p>The equivalent of &#8220;Catch and return a static default value&#8221; is <code>onErrorReturn</code>.
The following example shows how to use it:</p>
</div>
<div class="paragraph">
<p>ç­æäºâæè·å¹¶è¿åéæé»è®¤å¼â onErrorReturnãä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½ä½¿ç¨å®ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
  return doSomethingDangerous(10);
}
catch (Throwable error) {
  return "RECOVERED";
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows the Reactor equivalent:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just(10)
    .map(this::doSomethingDangerous)
    .onErrorReturn("RECOVERED");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You also have the option of applying a <code>Predicate</code> on the exception to decided
whether or not to recover, as the folloiwng example shows:</p>
</div>
<div class="paragraph">
<p>ä½ è¿å¯ä»¥éæ©Predicateå¯¹å¼å¸¸åºç¨ï¼ä»¥å³å®æ¯å¦æ¢å¤ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just(10)
    .map(this::doSomethingDangerous)
    .onErrorReturn(e -&gt; e.getMessage().equals("boom10"), "recovered10"); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Recover only if the message of the exception is <code>"boom10"</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fallback_method"><a class="anchor" href="#_fallback_method"></a>Fallback Method</h5>
<div class="paragraph">
<p>If you want more than a single default value and you have an alternative (safer) way of
processing your data, you can use <code>onErrorResume</code>. This would be the equivalent of
&#8220;Catch and execute an alternative path with a fallback method&#8221;.</p>
</div>
<div class="paragraph">
<p>å¦ææ¨éè¦å¤ä¸ªé»è®¤å¼ï¼å¹¶ä¸æå¦ä¸ç§ï¼æ´å®å¨çï¼æ°æ®å¤çæ¹å¼ï¼åå¯ä»¥ä½¿ç¨onErrorResumeãè¿ç¸å½äºâä½¿ç¨åå¤æ¹æ³æè·å¹¶æ§è¡æ¿ä»£è·¯å¾âã</p>
</div>
<div class="paragraph">
<p>For example, if your nominal process is fetching data from an external and unreliable
service but you also keep a local cache of the same data that <em>can</em> be a bit more out of
date but is more reliable, you could do the following:</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼å¦ææ¨çæ ç§°è¿ç¨æ­£å¨ä»å¤é¨ä¸ä¸å¯é çæå¡ä¸­è·åæ°æ®ï¼ä½æ¯æ¨è¿ä¿çäºç¸åæ°æ®çæ¬å°ç¼å­ï¼è¯¥ç¼å­å¯è½ä¼è¿æ¶ä½æ´å¯é ï¼åå¯ä»¥æ§è¡ä»¥ä¸æä½ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String v1;
try {
  v1 = callExternalService("key1");
}
catch (Throwable error) {
  v1 = getFromCache("key1");
}

String v2;
try {
  v2 = callExternalService("key2");
}
catch (Throwable error) {
  v2 = getFromCache("key2");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows the Reactor equivalent:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just("key1", "key2")
    .flatMap(k -&gt; callExternalService(k) <i class="conum" data-value="1"></i><b>(1)</b>
        .onErrorResume(e -&gt; getFromCache(k)) <i class="conum" data-value="2"></i><b>(2)</b>
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>å¯¹äºæ¯ä¸ªé®ï¼å¼æ­¥è°ç¨å¤é¨æå¡ã.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦æå¤é¨æå¡è°ç¨å¤±è´¥ï¼åéåå°è¯¥å¯é¥çç¼å­ãè¯·æ³¨æï¼æ è®ºæºéè¯¯eæ¯ä»ä¹ï¼æä»¬æ»æ¯åºç¨ç¸åçåå¤.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Like <code>onErrorReturn</code>, <code>onErrorResume</code> has variants that let you filter which exceptions
to fall back on, based either on the exception&#8217;s class or on a <code>Predicate</code>. The fact that it
takes a <code>Function</code> also lets you choose a different fallback sequence to switch to,
depending on the error encountered. The following example shows how to do so:</p>
</div>
<div class="paragraph">
<p>å onErrorReturnï¼onErrorResume é£æ ·å·æåä½ï¼å¯è®©æ¨æ ¹æ®å¼å¸¸çç±»ææ¥è¿æ»¤è¦åéçå¼å¸¸ææ­è¨ã
äºå®ä¸åé¨æ¯æ§è¡äºä¸ä¸ªFunctionï¼ä½¿æ¨å¯ä»¥æ ¹æ®éå°çéè¯¯éæ©ä¸åçåå¤åºåæ¥åæ¢ãä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½æ§è¡æ­¤æä½ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just("timeout1", "unknown", "key2")
    .flatMap(k -&gt; callExternalService(k)
        .onErrorResume(error -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
            if (error instanceof TimeoutException) <i class="conum" data-value="2"></i><b>(2)</b>
                return getFromCache(k);
            else if (error instanceof UnknownKeyException)  <i class="conum" data-value="3"></i><b>(3)</b>
                return registerNewEntry(k, "DEFAULT");
            else
                return Flux.error(error); <i class="conum" data-value="4"></i><b>(4)</b>
        })
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>è¯¥åè½åè®¸å¨æéæ©å¦ä½ç»§ç»­.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¦ææºè¶æ¶ï¼è¯·è®¿é®æ¬å°ç¼å­.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¦ææºæ¾ç¤ºå¯é¥æªç¥ï¼è¯·åå»ºä¸ä¸ªæ°æ¡ç®.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>å¨ææå¶ä»æåµä¸ï¼âéæ°æåºâ.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dynamic_fallback_value"><a class="anchor" href="#_dynamic_fallback_value"></a>Dynamic Fallback Value</h5>
<div class="paragraph">
<p>Even if you do not have an alternative (safer) way of processing your data, you might want
to compute a fallback value out of the exception you received. This would be the
equivalent of &#8220;Catch and dynamically compute a fallback value&#8221;.</p>
</div>
<div class="paragraph">
<p>å³ä½¿æ²¡æå¶ä»ï¼æ´å®å¨ï¼çæ°æ®å¤çæ¹å¼ï¼æ¨ä¹å¯è½å¸ææ ¹æ®æ¶å°çå¼å¸¸æ¥è®¡ç®åéå¼ãè¿ç¸å½äºâæè·å¹¶å¨æè®¡ç®åå¤å¼âã</p>
</div>
<div class="paragraph">
<p>For instance, if your return type (<code>MyWrapper</code>) has a variant dedicated to holding an exception (think
<code>Future.complete(T success)</code> versus <code>Future.completeExceptionally(Throwable error)</code>), you
could instantiate the error-holding variant and pass the exception.</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼å¦ææ¨çè¿åç±»åï¼MyWrapperï¼å·æä¸ç¨äºä¿å­å¼å¸¸çåéï¼è®¤ä¸º Future.complete(T success)ä¸Future.completeExceptionally(Throwable error)ï¼ï¼åå¯ä»¥å®ä¾åéè¯¯ä¿å­åéå¹¶ä¼ éå¼å¸¸ã</p>
</div>
<div class="paragraph">
<p>An imperative example would look like the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
  Value v = erroringMethod();
  return MyWrapper.fromValue(v);
}
catch (Throwable error) {
  return MyWrapper.fromError(error);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can do this reactively in the same way as the fallback method solution,
by using <code>onErrorResume</code>, with a tiny bit of boilerplate, as follows:</p>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥éè¿ä½¿ç¨onErrorResumeï¼ä¸ä¸å°é¨åæ ·æ¿ç¨åºä¸æ ·ï¼ä»¥ä¸åå¤æ¹æ³è§£å³æ¹æ¡ç¸åçæ¹å¼è¿è¡ååºï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">erroringFlux.onErrorResume(error -&gt; Mono.just( <i class="conum" data-value="1"></i><b>(1)</b>
        MyWrapper.fromError(error) <i class="conum" data-value="2"></i><b>(2)</b>
));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ç±äºæ¨ææè¿åMyWrapperä¸ºéè¯¯çè¡¨ç¤ºå½¢å¼ï¼å æ­¤éè¦è·å¾ Mono&lt;MyWrapper&gt; ä» onErrorResume ä¸­ãæä»¬ç¨ Mono.just() æ¥å®æ.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬éè¦è®¡ç®å¼å¸¸å¼ãå¨è¿éï¼æä»¬éè¿ä½¿ç¨ç¸å³çMyWrapperå·¥åæ¹æ³åè£å¼å¸¸æ¥å®ç°è¿ä¸ç®æ ã</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_catch_and_rethrow"><a class="anchor" href="#_catch_and_rethrow"></a>Catch and Rethrow</h5>
<div class="paragraph">
<p>"Catch, wrap to a <code>BusinessException</code>, and re-throw" looks like the following in the
imperative world:</p>
</div>
<div class="paragraph">
<p>å¨å½ä»¤å¼ä¸çä¸­ï¼âæè· BusinessException åè£å¹¶éæ°æåºâ çèµ·æ¥åä»¥ä¸åå®¹ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
  return callExternalService(k);
}
catch (Throwable error) {
  throw new BusinessException("oops, SLA exceeded", error);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the &#8220;fallback method&#8221; example, the last line inside the <code>flatMap</code> gives us a hint
at achieving the same reactively, as follows:</p>
</div>
<div class="paragraph">
<p>å¨âåå¤æ¹æ³âç¤ºä¾ä¸­ï¼åçæåä¸è¡ä¸ºflatMapæä»¬æä¾äºä¸ä¸ªæç¤ºï¼ä»¥æç¤ºæ¨ä»¥è¢«å¨æ¹å¼å®ç°ç¸åç®æ ï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just("timeout1")
    .flatMap(k -&gt; callExternalService(k))
    .onErrorResume(original -&gt; Flux.error(
            new BusinessException("oops, SLA exceeded", original))
    );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>However, there is a more straightforward way of achieving the same effect with <code>onErrorMap</code>:</p>
</div>
<div class="paragraph">
<p>ä½æ¯ï¼è¿æä¸ç§æ´ç®åçæ¹æ³å¯ä»¥è¾¾å°ä»¥ä¸ææonErrorMapï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just("timeout1")
    .flatMap(k -&gt; callExternalService(k))
    .onErrorMap(original -&gt; new BusinessException("oops, SLA exceeded", original));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_log_or_react_on_the_side"><a class="anchor" href="#_log_or_react_on_the_side"></a>Log or React on the Side</h5>
<div class="paragraph">
<p>For cases where you want the error to continue propagating but still want to react to
it without modifying the sequence (logging it, for instance), you can use the <code>doOnError</code>
operator. This is the equivalent of &#8220;Catch, log an error-specific message, and re-throw&#8221;
pattern, as the following example shows:</p>
</div>
<div class="paragraph">
<p>å¯¹äºå¸æéè¯¯ç»§ç»­ä¼ æ­ä½ä»å¸æå¯¹éè¯¯ååºååºèåä¸ä¿®æ¹é¡ºåºï¼ä¾å¦è®°å½éè¯¯ï¼çæåµï¼å¯ä»¥ä½¿ç¨doOnError è¿ç®ç¬¦ãè¿ç­æäºâæè·ï¼è®°å½ç¹å®äºéè¯¯çæ¶æ¯å¹¶éæ°æåºâæ¨¡å¼ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
  return callExternalService(k);
}
catch (RuntimeException error) {
  //make a record of the error
  log("uh oh, falling back, service failed for key " + k);
  throw error;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>doOnError</code> operator, as well as all operators prefixed with <code>doOn</code> , are sometimes
referred to as having a &#8220;side-effect&#8221;. They let you peek inside the sequence&#8217;s events without
modifying them.</p>
</div>
<div class="paragraph">
<p>doOnErroræä½èï¼ä»¥åä¸ææåç¼ä¸ºdoOnçæä½ç¬¦ï¼ææ¶è¢«ç§°ä¸ºå·æâå¯ä½ç¨âãå®ä»¬ä½¿æ¨å¯ä»¥æ¥çåºåçäºä»¶èæ éä¿®æ¹å®ä»¬ã</p>
</div>
<div class="paragraph">
<p>Like the imperative example shown earlier, the following example still propagates the error yet
ensures that we at least log that the external service had a failure:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">LongAdder failureStat = new LongAdder();
Flux&lt;String&gt; flux =
Flux.just("unknown")
    .flatMap(k -&gt; callExternalService(k) <i class="conum" data-value="1"></i><b>(1)</b>
        .doOnError(e -&gt; {
            failureStat.increment();
            log("uh oh, falling back, service failed for key " + k); <i class="conum" data-value="2"></i><b>(2)</b>
        })
        <i class="conum" data-value="3"></i><b>(3)</b>
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>å¯è½å¤±è´¥çå¤é¨æå¡è°ç¨.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å·ææ¥å¿åç»è®¡æ¹é¢çå¯ä½ç¨</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ä¹åï¼å®ä»ç¶ä¼ä»¥éè¯¯ç»æ­¢ï¼é¤éæä»¬å¨æ­¤å¤ä½¿ç¨éè¯¯æ¢å¤æä½ç¬¦ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>We can also imagine we have statistic counters to increment as a second error side-effect.</p>
</div>
<div class="paragraph">
<p>æä»¬è¿å¯ä»¥æ³è±¡ï¼æä»¬æç»è®¡è®¡æ°å¨ä¼å¢å ï¼è¿æ¯ç¬¬äºä¸ªéè¯¯å¯ä½ç¨ã</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_resources_and_the_finally_block"><a class="anchor" href="#_using_resources_and_the_finally_block"></a>Using Resources and the Finally Block</h5>
<div class="paragraph">
<p>The last parallel to draw with imperative programming is the cleaning up that can be done
either by using a &#8220;Use of the <code>finally</code> block to clean up resources&#8221; or by using a
&#8220;Java 7 try-with-resource construct&#8221;, both shown below:</p>
</div>
<div class="paragraph">
<p>å½ä»¤å¼ç¼ç¨çæåä¸ä¸ªå¹¶è¡å¤çæ¯æ¸çï¼å¯ä»¥éè¿ä½¿ç¨âä½¿ç¨finallyåæ¸çèµæºâæéè¿ä½¿ç¨â Java 7 try-with-resourceæé âæ¥å®æï¼ä¸¤èåæ¾ç¤ºå¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Imperative use of finally</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Stats stats = new Stats();
stats.startTimer();
try {
  doSomethingDangerous();
}
finally {
  stats.stopTimerAndRecordTiming();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 14. Imperative use of try-with-resource</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try (SomeAutoCloseable disposableInstance = new SomeAutoCloseable()) {
  return disposableInstance.toString();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Both have their Reactor equivalents: <code>doFinally</code> and <code>using</code>.</p>
</div>
<div class="paragraph">
<p>ä¸¤èé½æå¶Reactorç­ææ¹æ³ï¼doFinallyåusingã</p>
</div>
<div class="paragraph">
<p><code>doFinally</code> is about side-effects that you want to be executed whenever the
sequence terminates (with <code>onComplete</code> or <code>onError</code>) or is cancelled.
It gives you a hint as to what kind of termination triggered the side-effect.
The following example shows how to use <code>doFinally</code>:</p>
</div>
<div class="paragraph">
<p>doFinallyä¸åºåç»æ­¢ï¼ç¨onCompleteæonErroræåæ¶ï¼æ¶è¦æ§è¡çå¯ä½ç¨æå³ãå®æç¤ºæ¨åªç§ç»æ­¢æ¹å¼ä¼å¼èµ·å¯ä½ç¨ãä»¥ä¸ç¤ºä¾æ¾ç¤ºå¦ä½ä½¿ç¨doFinallyï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Reactive finally: <code>doFinally()</code></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Stats stats = new Stats();
LongAdder statsCancel = new LongAdder();

Flux&lt;String&gt; flux =
Flux.just("foo", "bar")
    .doOnSubscribe(s -&gt; stats.startTimer())
    .doFinally(type -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
        stats.stopTimerAndRecordTiming();<i class="conum" data-value="2"></i><b>(2)</b>
        if (type == SignalType.CANCEL) <i class="conum" data-value="3"></i><b>(3)</b>
          statsCancel.increment();
    })
    .take(1); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>doFinally</code> consumes a <code>SignalType</code> for the type of termination. 	doFinallyä½¿ç¨ç»æ­¢ç±»åçSignalTypeã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Similarly to <code>finally</code> blocks, we always record the timing.  ä¸â finallyâåç±»ä¼¼ï¼æä»¬æ»æ¯è®°å½æ¶é´ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we also increment statistics in case of cancellation only.  å¨è¿éï¼æä»¬è¿ä»å¨åæ¶çæåµä¸å¢å ç»è®¡ä¿¡æ¯ã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>take(1)</code> cancels after one item is emitted. <code>takeï¼1ï¼</code> è¡¨ç¤º ååºä¸é¡¹åå³åæ¶ï¼</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>On the other hand, <code>using</code> handles the case where a <code>Flux</code> is derived from a
resource and that resource must be acted upon whenever processing is done.
In the following example, we replace the <code>AutoCloseable</code> interface of &#8220;try-with-resource&#8221; with a
<code>Disposable</code>:</p>
</div>
<div class="paragraph">
<p>å¦ä¸æ¹é¢ï¼âusingâå¤çäºâFluxâæ¥èªäºèµæºï¼å¹¶ä¸æ¯å½å¤çå®ææ¶é½å¿é¡»å¯¹èµæºè¿è¡æä½ã
å¨ä»¥ä¸ç¤ºä¾ä¸­ï¼æä»¬å°â try-with-resourceâçâ AutoCloseableâçé¢æ¿æ¢ä¸º
<code>ä¸æ¬¡æ§</code>ï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. The Disposable resource</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AtomicBoolean isDisposed = new AtomicBoolean();
Disposable disposableInstance = new Disposable() {
    @Override
    public void dispose() {
        isDisposed.set(true); <i class="conum" data-value="4"></i><b>(4)</b>
    }

    @Override
    public String toString() {
        return "DISPOSABLE";
    }
};</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we can do the reactive equivalent of &#8220;try-with-resource&#8221; on it, which looks
like the following:</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼æä»¬å¯ä»¥å¨å¶ä¸æ§è¡ä¸â try-with-resourceâç­æçææï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Reactive try-with-resource: <code>using()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux =
Flux.using(
        () -&gt; disposableInstance, <i class="conum" data-value="1"></i><b>(1)</b>
        disposable -&gt; Flux.just(disposable.toString()), <i class="conum" data-value="2"></i><b>(2)</b>
        Disposable::dispose <i class="conum" data-value="3"></i><b>(3)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first lambda generates the resource. Here, we return our mock <code>Disposable</code>. 	ç¬¬ä¸ä¸ªlambdaçæèµæºãå¨è¿éï¼æä»¬è¿åæä»¬çæ¨¡æDisposable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The second lambda processes the resource, returning a <code>Flux&lt;T&gt;</code>. ç¬¬äºä¸ªlambdaå¤çèµæºï¼è¿åFlux&lt;T&gt;ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The third lambda is called when the <code>Flux</code> from &lt;2&gt; terminates or is cancelled, to
clean up resources. å½Fluxfrom &lt;2&gt;ç»æ­¢æåæ¶æ¶ï¼å°è°ç¨ç¬¬ä¸ä¸ªlambda ä»¥æ¸çèµæºã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After subscription and execution of the sequence, the <code>isDisposed</code> atomic boolean
becomes <code>true</code>. è®¢éå¹¶æ§è¡åºååï¼isDisposedåå­å¸å°å¼åä¸ºtrueã</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_demonstrating_the_terminal_aspect_of_onerror"><a class="anchor" href="#_demonstrating_the_terminal_aspect_of_onerror"></a>Demonstrating the Terminal Aspect of <code>onError</code></h5>
<div class="paragraph">
<p>In order to demonstrate that all these operators cause the upstream original sequence to
terminate when an error happens, we can use a more visual example with a
<code>Flux.interval</code>. The <code>interval</code> operator ticks every x units of time with an increasing
<code>Long</code> value. The following example uses an <code>interval</code> operator:</p>
</div>
<div class="paragraph">
<p>ä¸ºäºè¯æææè¿äºè¿ç®ç¬¦é½ä¼å¨åçéè¯¯æ¶ä½¿ä¸æ¸¸åå§åºåç»æ­¢ï¼æä»¬å¯ä»¥ä½¿ç¨å¸¦æçæ´ç´è§çç¤ºä¾ Flux.intervalã
è¯¥intervalè¿ç®ç¬¦æ¯éxåä½æ¶é´æ»´ç­ä¸æ¬¡ï¼éå¢Longå¼ãä»¥ä¸ç¤ºä¾ä½¿ç¨intervalè¿ç®ç¬¦ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux =
Flux.interval(Duration.ofMillis(250))
    .map(input -&gt; {
        if (input &lt; 3) return "tick " + input;
        throw new RuntimeException("boom");
    })
    .onErrorReturn("Uh oh");

flux.subscribe(System.out::println);
Thread.sleep(2100); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that <code>interval</code> executes on a <strong>timer</strong> <code>Scheduler</code> by default. If we want
to run that example in a main class, we would need to add a <code>sleep</code> call here so that the
application does not exit immediately without any value being produced.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼é»è®¤æåµä¸intervalä¼å¨è®¡æ¶å¨ä¸æ§è¡Schedulerãå¦æè¦å¨ä¸»ç±»ä¸­è¿è¡è¯¥ç¤ºä¾ï¼åéè¦å¨sleepæ­¤å¤æ·»å ä¸ä¸ªè°ç¨ï¼ä»¥ä¾¿åºç¨ç¨åºä¸ä¼ç«å³éåºèä¸ä¼äº§çä»»ä½å¼ã</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example prints out one line every 250ms, as follows:</p>
</div>
<div class="paragraph">
<p>åé¢çç¤ºä¾æ¯250msæå°åºä¸è¡ï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tick 0
tick 1
tick 2
Uh oh</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even with one extra second of runtime, no more tick comes in from the <code>interval</code>. The
sequence was indeed terminated by the error.</p>
</div>
<div class="paragraph">
<p>å³ä½¿åå¤ä¸ç§çè¿è¡æ¶é´ï¼ä¹ä¸ä¼ååºç°æ»´ç­å£°intervalãéè¯¯ç¡®å®ç»æ­¢äºè¯¥åºåã</p>
</div>
</div>
<div class="sect4">
<h5 id="_retrying"><a class="anchor" href="#_retrying"></a>Retrying</h5>
<div class="paragraph">
<p>There is another operator of interest with regards to error handling, and you might be
tempted to use it in the case described in the previous section. <code>retry</code>, as its name
indicates, lets you retry an error-producing sequence.</p>
</div>
<div class="paragraph">
<p>å³äºéè¯¯å¤çï¼è¿æå¦ä¸ä¸ªæè¶£çè¿ç®ç¬¦ï¼å¨ä¸ä¸èä¸­æè¿°çæåµä¸ï¼æ¨å¯è½ä¼æ³ä½¿ç¨å®ãretryé¡¾åæä¹ï¼å¯è®©æ¨éè¯äº§çéè¯¯çåºåã</p>
</div>
<div class="paragraph">
<p>The thing to keep in mind is that it works by <strong>re-subscribing</strong> to the upstream <code>Flux</code>.
This is really a different sequence, and the original one is still terminated.
To verify that, we can re-use the previous example and append a <code>retry(1)</code> to
retry once instead of using <code>onErrorReturn</code>. The following example shows how to do sl:</p>
</div>
<div class="paragraph">
<p>è¦è®°ä½çæ¯ï¼å®éè¿éæ°è®¢éä¸æ¸¸çFluxèèµ·ä½ç¨ãè¿å®éä¸æ¯ä¸ä¸ªä¸åçåºåï¼åå§åºåä»ç¶ç»æ­¢ãä¸ºäºéªè¯è¿ä¸ç¹ï¼æä»¬å¯ä»¥éç¨åé¢çç¤ºä¾ï¼å¹¶å¨å¶ä¸­éå ä¸ä¸ª`retryï¼1ï¼<code>ã
éè¯ä¸æ¬¡ï¼èä¸è¦ä½¿ç¨`onErrorReturn</code>ã ä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½æ§è¡slï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.interval(Duration.ofMillis(250))
    .map(input -&gt; {
        if (input &lt; 3) return "tick " + input;
        throw new RuntimeException("boom");
    })
    .retry(1)
    .elapsed() <i class="conum" data-value="1"></i><b>(1)</b>
    .subscribe(System.out::println, System.err::println); <i class="conum" data-value="2"></i><b>(2)</b>

Thread.sleep(2100); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>elapsed</code> associates each value with the duration since previous value was emitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We also want to see when there is an <code>onError</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ensure we have enough time for our 4x2 ticks.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>259,tick 0
249,tick 1
251,tick 2
506,tick 0 <i class="conum" data-value="1"></i><b>(1)</b>
248,tick 1
253,tick 2
java.lang.RuntimeException: boom</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A new <code>interval</code> started, from tick 0. The additional 250ms duration is
coming from the 4th tick, the one that causes the exception and subsequent
retry. 	ä»æ»´ç­0å¼å§ä¸ä¸ªæ°çintervalãé¢å¤ç250æ¯«ç§æç»­æ¶é´æ¥èªç¬¬4ä¸ªæ»´ç­ï¼å®å¼èµ·å¼å¸¸å¹¶éåéè¯ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see from the preceding example, <code>retry(1)</code> merely re-subscribed to the original <code>interval</code>
once, restarting the tick from 0. The second time around, since the exception
still occurs, it gives up and propagates the error downstream.</p>
</div>
<div class="paragraph">
<p>ä»åé¢çç¤ºä¾ä¸­å¯ä»¥çå°ï¼retry(1)åªéæ°è®¢éäºinterval ä¸æ¬¡ï¼ä»0éæ°å¼å§äºæ»´ç­ãç¬¬äºæ¬¡ï¼ç±äºä»ç¶åçå¼å¸¸ï¼å®æ¾å¼å¹¶åä¸æ¸¸ä¼ æ­éè¯¯ã</p>
</div>
<div class="paragraph">
<p>There is a more advanced version of <code>retry</code> (called <code>retryWhen</code>) that uses a &#8220;companion&#8221;
<code>Flux</code> to tell whether or not a particular failure should retry. This companion <code>Flux</code> is
created by the operator but decorated by the user, in order to customize the retry
condition.</p>
</div>
<div class="paragraph">
<p>æä¸ä¸ªæ´é«çº§ççæ¬retryï¼ç§°ä¸ºretryWhenï¼ï¼å®ä½¿ç¨âcompanionâ Fluxæ¥åç¥æ¯å¦åºéè¯ç¹å®çæéã
è¯¥åä¼´Fluxç±æä½ååå»ºä½ç±ç¨æ·ä¿®é¥°ï¼ä»¥èªå®ä¹éè¯æ¡ä»¶ã</p>
</div>
<div class="paragraph">
<p>The companion <code>Flux</code> is a <code>Flux&lt;Throwable&gt;</code> that gets passed to a <code>Function</code>, the sole
parameter of <code>retryWhen</code>. As the user, you define that function and make it return a new
<code>Publisher&lt;?&gt;</code>. Retry cycles go as follows:</p>
</div>
<div class="paragraph">
<p>CompaniondçFluxæ¯Flux&lt;Throwable&gt;ï¼å®ä¼ éç»retryWhençå¯ä¸åæ°Functionã
ä½ä¸ºä½¿ç¨èï¼æ¨å¯ä»¥å®ä¹è¯¥å½æ°å¹¶ä½¿å®è¿ånew Publisher&lt;?&gt;ãéè¯å¨æå¦ä¸ï¼</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each time an error happens (giving potential for a retry), the error is emitted into the
companion <code>Flux</code>, which has been decorated by your function. Having a <code>Flux</code> here
gives a bird eye&#8217;s view of all the attempts so far.</p>
</li>
<li>
<p>If the companion <code>Flux</code> emits a value, a retry happens.</p>
</li>
<li>
<p>If the companion <code>Flux</code> completes, the error is swallowed, the retry cycle stops,
and the resulting sequence completes, too.</p>
</li>
<li>
<p>If the companion <code>Flux</code> produces an error (<code>e</code>), the retry cycle stops and the
resulting sequence errors with <code>e</code>.</p>
</li>
<li>
<p>æ¯æ¬¡åçéè¯¯ï¼éè¯çå¯è½æ§ï¼æ¶ï¼éè¯¯å°±ä¼è¢«åéå°ä¼´éFluxå½æ°ä¸­ï¼è¯¥ä¼´éå½æ°å·²ç±æ¨çå½æ°ä¿®é¥°ãå¨Fluxè¿éæä¸ä¸ªé¸ç°å¾ï¼å¯ä»¥çå°å°ç®åä¸ºæ­¢çææå°è¯ã</p>
</li>
<li>
<p>æåä¼´Fluxååºä¸ä¸ªå¼ï¼åéè¯ã</p>
</li>
<li>
<p>å¦æä¼´éç¨åºFluxå®æï¼åéè¯¯å°è¢«åæ²¡ï¼éè¯å¨æå°åæ­¢ï¼å¹¶ä¸æçæçåºåä¹å°å®æã</p>
</li>
<li>
<p>å¦æécompanion Fluxäº§çéè¯¯ï¼eï¼ï¼åéè¯å¨æåæ­¢ï¼å¹¶ä¸äº§ççåºåéè¯¯ä¸ºeã</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The distinction between the previous two cases is important. Simply completing the
companion would effectively swallow an error. Consider the following way of emulating
<code>retry(3)</code> by using <code>retryWhen</code>:</p>
</div>
<div class="paragraph">
<p>åä¸¤ç§æåµä¹é´çåºå«å¾éè¦ãåªéå®æcompanion å³å¯ææå°åä¸ä¸ä¸ªéè¯¯ãèèä½¿ç¨retryWhen ä»¥æ¨¡æ retry(3)æ¹æ³ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux
    .&lt;String&gt;error(new IllegalArgumentException()) <i class="conum" data-value="1"></i><b>(1)</b>
    .doOnError(System.out::println) <i class="conum" data-value="2"></i><b>(2)</b>
    .retryWhen(companion -&gt; companion.take(3)); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This continuously produces errors, calling for retry attempts.è¿ä¼ä¸æ­äº§çéè¯¯ï¼è¦æ±éè¯ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>doOnError</code> before the retry lets us log and see all failures. 	doOnError éè¯ä¹åï¼è®©æä»¬è®°å½å¹¶æ¥çææå¤±è´¥</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here, we consider the first three errors as retry-able (<code>take(3)</code>) and then give up. å¨è¿éï¼æä»¬å°åä¸ä¸ªéè¯¯è§ä¸ºå¯éè¯ï¼take(3)ï¼ï¼ç¶åæ¾å¼ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In effect, the preceding example results in an empty <code>Flux</code>, but it completes successfully. Since
<code>retry(3)</code> on the same <code>Flux</code> would have terminated with the latest error, this
<code>retryWhen</code> example is not exactly the same as a <code>retry(3)</code>.</p>
</div>
<div class="paragraph">
<p>å®éä¸ï¼åé¢çç¤ºä¾å¯¼è´ä¸ºç©ºFluxï¼ä½å®æåå®æã
ç±äº retry(3)åä¸Fluxéè¯¯ä¼å ææ°éè¯¯èç»æ­¢ï¼å æ­¤æ­¤retryWhenç¤ºä¾ä¸å¹¶ä¸å®å¨ä¸retry(3)ç¸åã</p>
</div>
<div class="paragraph">
<p>Getting to the same behavior involves a few additional tricks:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux =
Flux.&lt;String&gt;error(new IllegalArgumentException())
    .retryWhen(companion -&gt; companion
    .zipWith(Flux.range(1, 4), <i class="conum" data-value="1"></i><b>(1)</b>
          (error, index) -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            if (index &lt; 4) return index; <i class="conum" data-value="3"></i><b>(3)</b>
            else throw Exceptions.propagate(error); <i class="conum" data-value="4"></i><b>(4)</b>
          })
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Trick one: use <code>zip</code> and a <code>range</code> of "number of acceptable retries + 1".	æå·§ä¸ï¼ä½¿ç¨zipårangeâå¯æ¥åçéè¯æ¬¡æ°+ 1â</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>zip</code> function lets you count the retries while keeping track of the original
error.	è¯¥zipåè½å¯è®©æ¨è®¡ç®éè¯æ¬¡æ°ï¼åæ¶è·è¸ªåå§éè¯¯</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To allow for three retries, indexes before 4 return a value to emit.ä¸ºäºåè®¸è¿è¡ä¸æ¬¡éè¯ï¼4ä¹åçç´¢å¼å°è¿åä¸ä¸ªè¦ååºçå¼</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In order to terminate the sequence in error, we throw the original exception after
these three retries. ä¸ºäºç»æ­¢éè¯¯çåºåï¼æä»¬å¨è¿ä¸ä¸ªéè¯ä¹åæåºäºåå§å¼å¸¸</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>è¾¾å°ç¸åçè¡ä¸ºè¿æ¶åå¶ä»ä¸äºæå·§ï¼</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use similar code to implement an &#8220;exponential backoff and retry&#8221; pattern,
as shown in the <a href="#faq.exponentialBackoff">FAQ</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥ä½¿ç¨ç±»ä¼¼çä»£ç æ¥å®ç°âææ°éé¿åéè¯âæ¨¡å¼ï¼å¦FAQä¸­æç¤ºã</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_handling_exceptions_in_operators_or_functions"><a class="anchor" href="#_handling_exceptions_in_operators_or_functions"></a>4.6.2. Handling Exceptions in Operators or Functions</h4>
<div class="paragraph">
<p>In general, all operators can themselves contain code that potentially trigger an
exception or calls to a user-defined callback that can similarly fail, so they all
contain some form of error handling.</p>
</div>
<div class="paragraph">
<p>éå¸¸ï¼ææè¿ç®ç¬¦é½å¯ä»¥èªå·±åå«å¯è½è§¦åå¼å¸¸çä»£ç æå¯¹ç¨æ·å®ä¹çåè°çè°ç¨ï¼åæ ·å¯è½å¤±è´¥ï¼ï¼å æ­¤å®ä»¬é½åå«æç§å½¢å¼çéè¯¯å¤çã</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, an unchecked exception is always propagated through <code>onError</code>. For
instance, throwing a <code>RuntimeException</code> inside a <code>map</code> function translates to an
<code>onError</code> event, as the following code shows:</p>
</div>
<div class="paragraph">
<p>æ ¹æ®ç»éªï¼å§ç»ä¼éè¿ä¼ æ­æªç»æ£æ¥çå¼å¸¸onErrorã
ä¾å¦ï¼å°å½æ°RuntimeExceptionåé¨çåå®¹mapè½¬æ¢ä¸º onErroräºä»¶ï¼å¦ä»¥ä¸ä»£ç æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.just("foo")
    .map(s -&gt; { throw new IllegalArgumentException(s); })
    .subscribe(v -&gt; System.out.println("GOT VALUE"),
               e -&gt; System.out.println("ERROR: " + e));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code prints out the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ERROR: java.lang.IllegalArgumentException: foo</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can tune the <code>Exception</code> before it is passed to <code>onError</code>, through the use of a
<a href="#hooks-internal">hook</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥ä½¿ç¨ <a href="#hooks-internal">hook</a> æ¥è°æ´Exceptionä¼ éç»å®ä¹åçç¶æã onError</p>
</div>
<div class="paragraph">
<p>Reactor, however, defines a set of exceptions (such as <code>OutOfMemoryError</code>) that are
always deemed to be fatal. See the <code>Exceptions.throwIfFatal</code> method. These errors mean that
Reactor cannot keep operating and are thrown rather than propagated.</p>
</div>
<div class="paragraph">
<p>ä½æ¯ï¼Reactorå®ä¹äºä¸ç»OutOfMemoryErroræ»æ¯è¢«è®¤ä¸ºæ¯è´å½çå¼å¸¸ï¼ä¾å¦ï¼ã
åè§Exceptions.throwIfFatalæ¹æ³ãè¿äºéè¯¯æå³çReactoræ æ³ç»§ç»­è¿è¡ï¼å¹¶ä¸ä¼è¢«æåºèä¸æ¯ä¼ æ­ã</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Internally, there are also cases where an unchecked exception still cannot be
propagated (most notably during the subscribe and request phases), due to concurrency
races that could lead to double <code>onError</code> or <code>onComplete</code> conditions. When these races
happen, the error that cannot be propagated is &#8220;dropped&#8221;. These cases can still be
managed to some extent by using customizable hooks. See <a href="#hooks-dropping">Dropping Hooks</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
å¨åé¨ï¼ç±äºå¹¶åç«äºå¯è½å¯¼è´éå¤onErroræonCompleteæåµï¼å æ­¤å¨æäºæåµä¸ä»æ æ³ä¼ æ­æªç»æ£æ¥çå¼å¸¸ï¼æå¼å¾æ³¨æçæ¯å¨è®¢éåè¯·æ±é¶æ®µï¼ã
å½åçè¿äºç«äºæ¶ï¼æ æ³ä¼ æ­çéè¯¯å°è¢«âä¸¢å¼âãéè¿ä½¿ç¨å¯å®å¶çæé©ï¼ä»å¯ä»¥å¨æç§ç¨åº¦ä¸ç®¡çè¿äºæåµãè¯·åé <a href="#hooks-dropping">Dropping Hooks</a>ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may ask: &#8220;What about checked exceptions?&#8221;</p>
</div>
<div class="paragraph">
<p>æ¨å¯è½ä¼é®ï¼âå¦ä½æ£æ¥å¼å¸¸ï¼â</p>
</div>
<div class="paragraph">
<p>If, for example, you need to call some method that declares it <code>throws</code> exceptions, you
still have to deal with those exceptions in a <code>try-catch</code> block. You have several
options, though:</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼å¦ææ¨éè¦è°ç¨æä¸ªå£°æå¶throwså¼å¸¸çæ¹æ³ï¼åä»å¿é¡»å¨ä¸ä¸ªtry-catchåä¸­å¤çè¿äºå¼å¸¸ãä¸è¿ï¼æ¨æå ç§éæ©ï¼</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Catch the exception and recover from it. The sequence continues normally.</p>
</li>
<li>
<p>Catch the exception, wrap it into an <em>unchecked</em> exception, and then throw it
(interrupting the sequence). The <code>Exceptions</code> utility class can help you with that (we
get to that next).</p>
</li>
<li>
<p>If you need to return a <code>Flux</code> (for example, you are in a <code>flatMap</code>), wrap the
exception in an error-producing <code>Flux</code>, as follows: <code>return Flux.error(checkedException)</code>. (The
sequence also terminates.)</p>
</li>
<li>
<p>è·å¼å¸¸å¹¶ä»ä¸­æ¢å¤ãè¯¥åºåæ­£å¸¸ç»§ç»­ã</p>
</li>
<li>
<p>æè·å¼å¸¸ï¼å°å¶åè£ä¸ºæªç»æ£æ¥çå¼å¸¸ï¼ç¶åå°å¶æåºï¼ä¸­æ­åºåï¼ãè¯¥Exceptionså®ç¨å·¥å·ç±»å¯ä»¥å¸®ä½ </p>
</li>
<li>
<p>å¦æéè¦è¿åFluxï¼ä¾å¦ï¼ä½ å¨ä¸­flatMapï¼ï¼åå°å¼å¸¸åè£å¨ä¸ä¸ªéè¯¯çäº§å¨ç`Flux`ä¸­ï¼å¦ä¸æç¤ºï¼return Flux.error(checkedException)ãï¼è¯¥åºåä¹ç»æ­¢ãï¼</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Reactor has an <code>Exceptions</code> utility class that you can use to ensure that exceptions are
wrapped only if they are checked exceptions:</p>
</div>
<div class="paragraph">
<p>Reactoræä¸ä¸ªExceptionså®ç¨ç¨åºç±»ï¼æ¨å¯ä»¥ä½¿ç¨å®æ¥ç¡®ä¿ä»æ¯æ£æ¥å¼å¸¸çæåµä¸åè£è¿äºå¼å¸¸ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>Exceptions.propagate</code> method to wrap exceptions, if necessary. It also calls
<code>throwIfFatal</code> first and does not wrap <code>RuntimeException</code>.</p>
</li>
<li>
<p>Use the <code>Exceptions.unwrap</code> method to get the original unwrapped exception (going back
to the root cause of a hierarchy of reactor-specific exceptions).</p>
</li>
<li>
<p>Exceptions.propagateå¦æå¿è¦ï¼ä½¿ç¨è¯¥æ¹æ³åè£å¼å¸¸ãå®è¿throwIfFatalåè°ç¨ ï¼å¹¶ä¸ä¸åè£RuntimeExceptionã</p>
</li>
<li>
<p>ä½¿ç¨è¯¥Exceptions.unwrapæ¹æ³æ¥è·ååå§çæªåè£çå¼å¸¸ï¼è¿åå°å·ä½äºreactorçå¼å¸¸çå±æ¬¡ç»æçæ ¹æ¬åå ï¼ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the following example of a <code>map</code> that uses a conversion method that can throw an
<code>IOException</code>:</p>
</div>
<div class="paragraph">
<p>èèä»¥ä¸ç¤ºä¾ï¼è¯¥ç¤ºä¾mapä½¿ç¨å¯ä»¥å¼åçè½¬æ¢æ¹æ³ IOExceptionï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public String convert(int i) throws IOException {
    if (i &gt; 3) {
        throw new IOException("boom " + i);
    }
    return "OK " + i;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now imagine that you want to use that method in a <code>map</code>. You must now explicitly catch
the exception, and your map function cannot re-throw it. So you can propagate it to the
map&#8217;s <code>onError</code> method as a <code>RuntimeException</code>, as follows:</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼åè®¾æ¨è¦å¨ä¸­ä½¿ç¨è¯¥æ¹æ³mapãç°å¨ï¼æ¨å¿é¡»æ¾å¼æè·å¼å¸¸ï¼å¹¶ä¸æ¨çmapå½æ°æ æ³å°å¶éæ°å¼åã
å æ­¤ï¼æ¨å¯ä»¥å°å¶å RuntimeException ä¼ æ­å°MapçonErroræ¹æ³ï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; converted = Flux
    .range(1, 10)
    .map(i -&gt; {
        try { return convert(i); }
        catch (IOException e) { throw Exceptions.propagate(e); }
    });</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Later on, when subscribing to the preceding <code>Flux</code> and reacting to errors (such as in the
UI), you could revert back to the original exception if you want to do something
special for IOExceptions. The following example shows how to do so:</p>
</div>
<div class="paragraph">
<p>ç¨åï¼å¨è®¢éä¸è¿°åå®¹Fluxå¹¶å¯¹éè¯¯ååºååºæ¶ï¼ä¾å¦å¨UIä¸­ï¼ï¼å¦ææ¨æ³å¯¹IOExceptionsåä¸äºç¹æ®çäºæï¼åå¯ä»¥æ¢å¤å°åå§å¼å¸¸ã
ä»¥ä¸ç¤ºä¾æ¾ç¤ºäºå¦ä½æ§è¡æ­¤æä½ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">converted.subscribe(
    v -&gt; System.out.println("RECEIVED: " + v),
    e -&gt; {
        if (Exceptions.unwrap(e) instanceof IOException) {
            System.out.println("Something bad happened with I/O");
        } else {
            System.out.println("Something bad happened");
        }
    }
);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="processors"><a class="anchor" href="#processors"></a>4.7. Processors</h3>
<div class="paragraph">
<p>Processors are a special kind of <code>Publisher</code> that are also a <code>Subscriber</code>. That means
that you can <code>subscribe</code> to a <code>Processor</code> (generally, they implement <code>Flux</code>), but you can
also call methods to manually inject data into the sequence or terminate it.</p>
</div>
<div class="paragraph">
<p>å¤çå¨æ¯ä¸ç§ç¹æ®çPublisherï¼åæ¶ä¹æ¯ä¸ä¸ªSubscriberã
è¿æå³çä½ å¯ä»¥subscribeå°Processorï¼éå¸¸ï¼ä»ä»¬å®æ½Fluxï¼ï¼ä½ä½ ä¹å¯ä»¥æå¨è°ç¨æ¹æ³æ¥æ³¨å¥æ°æ®çåºåæç»æ­¢å®ã</p>
</div>
<div class="paragraph">
<p>There are several kinds of Processors, each with a few particular semantics, but before
you start looking into these, you need to ask yourself the following question:</p>
</div>
<div class="paragraph">
<p>å¤çå¨æå ç§ï¼æ¯ç§é½æä¸äºç¹æ®çè¯­ä¹ï¼ä½æ¯å¨å¼å§ç ç©¶å®ä»¬ä¹åï¼æ¨éè¦é®èªå·±ä»¥ä¸é®é¢ï¼</p>
</div>
<div class="sect3">
<h4 id="_do_i_need_a_processor"><a class="anchor" href="#_do_i_need_a_processor"></a>4.7.1. Do I Need a Processor?</h4>
<div class="paragraph">
<p>Most of the time, you should try to avoid using a <code>Processor</code>. They are harder to use
correctly and prone to some corner cases.</p>
</div>
<div class="paragraph">
<p>å¤§å¤æ°æ¶åï¼æ¨åºè¯¥é¿åä½¿ç¨Processorãå®ä»¬å¾é¾æ­£ç¡®ä½¿ç¨ï¼å¹¶ä¸å®¹æåºç°æç«¯æåµã</p>
</div>
<div class="paragraph">
<p>If you think a <code>Processor</code> could be a good match for your use case, ask yourself if you
have tried these two alternatives:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Could an operator or combination of operators fit the bill? (See <a href="#which-operator">Which operator do I need?</a>.)</p>
</li>
<li>
<p>Could a <a href="#producing">&#8220;generator&#8221;</a> operator work instead? (Generally, these operators
are made to bridge APIs that are not reactive, providing a &#8220;sink&#8221; that is similar in
concept to a <code>Processor</code>, in the sense that it lets you manually populate the sequence
with data or terminate it).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If, after exploring the above alternatives, you still think you need a <code>Processor</code>, read
the <a href="#processor-overview">Overview of Available Processors</a> section to learn about the different implementations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_safely_produce_from_multiple_threads_by_using_the_sink_facade"><a class="anchor" href="#_safely_produce_from_multiple_threads_by_using_the_sink_facade"></a>4.7.2. Safely Produce from Multiple Threads by Using the <code>Sink</code> Facade</h4>
<div class="paragraph">
<p>Rather than directly using Reactor <code>Processors</code>, it is a good practice to obtain a <code>Sink</code>
for the <code>Processor</code> by calling <code>sink()</code> <strong>once</strong>.</p>
</div>
<div class="paragraph">
<p><code>FluxProcessor</code> sinks safely gate multi-threaded producers and can be used by
applications that generate data from multiple threads concurrently. For example, you can create a
thread-safe serialized sink for <code>UnicastProcessor</code> by doing the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">UnicastProcessor&lt;Integer&gt; processor = UnicastProcessor.create();
FluxSink&lt;Integer&gt; sink = processor.sink(overflowStrategy);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Multiple producer threads may concurrently generate data on the following serialized
sink by doing the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">sink.next(n);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Despite the <code>FluxSink</code> being adapted for multi-threaded <strong>manual</strong> feeding
of the <code>Processor</code>, it is not possible to mix the subscriber approach with the
sink approach: You have to either subscribe your <code>FluxProcessor</code> to a source
<code>Publisher</code> or feed it manually though its <code>FluxSink</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Overflow from <code>next</code> behaves in two possible ways, depending on the <code>Processor</code> and its
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An unbounded processor handles the overflow itself by dropping or buffering.</p>
</li>
<li>
<p>A bounded processor blocks or &#8220;spins&#8221; on the <code>IGNORE</code> strategy or applies the
<code>overflowStrategy</code> behavior specified for the <code>sink</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="processor-overview"><a class="anchor" href="#processor-overview"></a>4.7.3. Overview of Available Processors</h4>
<div class="paragraph">
<p>Reactor Core comes with several flavors of <code>Processor</code>. Not all processors have the same
semantics, but they are roughly split into three categories. The following list briefly
describes the three kinds of processors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>direct</strong> (<code>DirectProcessor</code> and <code>UnicastProcessor</code>): These processors can push
data only through direct user action (calling their methods of their <code>Sink</code> directly).</p>
</li>
<li>
<p><strong>synchronous</strong> (<code>EmitterProcessor</code> and <code>ReplayProcessor</code>): These processors can either push data
through user interaction or by subscribing to an upstream <code>Publisher</code> and synchronously
draining it.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
One way of publishing events onto different threads is to use the <code>EmitterProcessor</code>
combined with <code>publishOn(Scheduler)</code>. This can for example replace the former <code>TopicProcessor</code>,
which was using <code>Unsafe</code> operations and has been moved to
<a href="https://github.com/reactor/reactor-addons/tree/master/reactor-extra/src/main/java/reactor/extra/processor">reactor-extra</a>
in 3.3.0.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_direct_processor"><a class="anchor" href="#_direct_processor"></a>Direct Processor</h5>
<div class="paragraph">
<p>A direct <code>Processor</code> is a processor that can dispatch signals to zero or more
<code>Subscribers</code>. It is the simplest one to instantiate, with a single <code>DirectProcessor#create()</code> static
factory method. On the other hand, <strong>it has the limitation of not handling backpressure</strong>.
As a consequence, a <code>DirectProcessor</code> signals an <code>IllegalStateException</code> to its
subscribers if you push N elements through it but at least one of its subscribers has
requested less than N.</p>
</div>
<div class="paragraph">
<p>Once the <code>Processor</code> has terminated (usually through its sink&#8217;s <code>error(Throwable)</code> or
<code>complete()</code> methods being called), it lets more subscribers subscribe but replays the
termination signal to them immediately.</p>
</div>
</div>
<div class="sect4">
<h5 id="_unicast_processor"><a class="anchor" href="#_unicast_processor"></a>Unicast Processor</h5>
<div class="paragraph">
<p>A unicast <code>Processor</code> can deal with backpressure by using an internal buffer. The trade-off
is that it can have <em>at most one</em> <code>Subscriber</code>.</p>
</div>
<div class="paragraph">
<p>A <code>UnicastProcessor</code> has a few more options than a direct processor, reflected by the existence of a few <code>create</code> static factory
methods. For instance, by default, it is unbounded: If you push any amount of
data through it while its <code>Subscriber</code> has not yet requested data, it buffers all of
the data.</p>
</div>
<div class="paragraph">
<p>You can change this by providing a custom <code>Queue</code> implementation for the internal
buffering in the <code>create</code> factory method. If that queue is bounded, the processor could
reject the push of a value when the buffer is full and not enough requests from
downstream have been received.</p>
</div>
<div class="paragraph">
<p>In that <em>bounded</em> case, you can also build the processor with a callback that is invoked
on each rejected element, allowing for cleanup of these rejected elements.</p>
</div>
</div>
<div class="sect4">
<h5 id="_emitter_processor"><a class="anchor" href="#_emitter_processor"></a>Emitter Processor</h5>
<div class="paragraph">
<p>An emitter <code>Processor</code> can emit to several subscribers while honoring
backpressure for each of its subscribers. It can also subscribe to a <code>Publisher</code> and
relay its signals synchronously.</p>
</div>
<div class="paragraph">
<p>Initially, when it has no subscriber, it can still accept a few data pushes up to a
configurable <code>bufferSize</code>. After that point, if no <code>Subscriber</code> has come in and consumed
the data, calls to <code>onNext</code> block until the processor is drained (which can happen only
concurrently by then).</p>
</div>
<div class="paragraph">
<p>Thus, the first <code>Subscriber</code> to subscribe receives up to <code>bufferSize</code> elements upon
subscribing. However, after that, the processor stops replaying signals to additional
subscribers. These subsequent subscribers instead receive only the signals pushed through
the processor after they have subscribed. The internal buffer is still used for
backpressure purposes.</p>
</div>
<div class="paragraph">
<p>By default, if all of its subscribers are cancelled (which basically means they have all
un-subscribed), it clears its internal buffer and stops accepting new subscribers.
You can tune this by using the <code>autoCancel</code> parameter in the <code>create</code> static factory methods.</p>
</div>
</div>
<div class="sect4">
<h5 id="_replay_processor"><a class="anchor" href="#_replay_processor"></a>Replay Processor</h5>
<div class="paragraph">
<p>A replay <code>Processor</code> caches elements that are either pushed directly through its <code>sink()</code>
or elements from an upstream <code>Publisher</code> and replays them to late subscribers.</p>
</div>
<div class="paragraph">
<p>It can be created in multiple configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Caching a single element (<code>cacheLast</code>).</p>
</li>
<li>
<p>Caching a limited history (<code>create(int)</code>) or an unbounded history (<code>create()</code>).</p>
</li>
<li>
<p>Caching a time-based replay window (<code>createTimeout(Duration)</code>).</p>
</li>
<li>
<p>Caching a combination of history size and time window
(<code>createSizeOrTimeout(int, Duration)</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/coreFeatures.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#core-features">Reactor Core Features</a>"</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kotlin"><a class="anchor" href="#kotlin"></a>5. Kotlin support</h2>
<div class="sectionbody">
<div id="kotlin-introduction" class="paragraph">
<p><a href="https://kotlinlang.org">Kotlin</a> is a statically-typed language targeting the JVM (and other platforms),
which allows writing concise and elegant code while providing very good
<a href="https://kotlinlang.org/docs/reference/java-interop.html">interoperability</a> with
existing libraries written in Java.</p>
</div>
<div class="paragraph">
<p>This section describes Reactor&#8217;s support for Kotlin.</p>
</div>
<div class="sect2">
<h3 id="kotlin-requirements"><a class="anchor" href="#kotlin-requirements"></a>5.1. Requirements</h3>
<div class="paragraph">
<p>Reactor supports Kotlin 1.1+ and requires
<a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-stdlib"><code>kotlin-stdlib</code></a>
(or one of its <a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-stdlib-jre7"><code>kotlin-stdlib-jre7</code></a>
or <a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-stdlib-jre8"><code>kotlin-stdlib-jre8</code></a> variants).</p>
</div>
</div>
<div class="sect2">
<h3 id="kotlin-extensions"><a class="anchor" href="#kotlin-extensions"></a>5.2. Extensions</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of <code>Dysprosium-M1</code> (ie. <code>reactor-core 3.3.0.M1</code>), Kotlin extensions are moved to a
dedicated <a href="https://github.com/reactor/reactor-kotlin-extensions"><code>reactor-kotlin-extensions</code></a>
module with new package names that start with <code>reactor.kotlin</code> instead of simply <code>reactor</code>.</p>
</div>
<div class="paragraph">
<p>As a consequence, Kotlin extensions in <code>reactor-core</code> module are deprecated.
The new dependency&#8217;s groupId and artifactId are:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-gradle" data-lang="gradle">io.projectreactor.kotlin:reactor-kotlin-extensions</code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thanks to its great <a href="https://kotlinlang.org/docs/reference/java-interop.html">Java interoperability</a>
and to <a href="https://kotlinlang.org/docs/reference/extensions.html">Kotlin extensions</a>, Reactor
Kotlin APIs leverage regular Java APIs and are additionally enhanced by a few Kotlin-specific APIs
that are available out of the box within Reactor artifacts.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Keep in mind that Kotlin extensions need to be imported to be used. This means
for example that the <code>Throwable.toFlux</code> Kotlin extension
is available only if <code>import reactor.kotlin.core.publisher.toFlux</code> is imported.
That said, similar to static imports, an IDE should automatically suggest the import in most cases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, <a href="https://kotlinlang.org/docs/reference/inline-functions.html#reified-type-parameters">Kotlin reified type parameters</a>
provide a workaround for JVM <a href="https://docs.oracle.com/javase/tutorial/java/generics/erasure.html">generics type erasure</a>,
and Reactor provides some extensions to take advantage of this feature.</p>
</div>
<div class="paragraph">
<p>The following table compares Reactor with Java against Reactor with Kotlin and extensions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin with extensions</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mono.just("foo")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"foo".toMono()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flux.fromIterable(list)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list.toFlux()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mono.error(new RuntimeException())</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RuntimeException().toMono()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flux.error(new RuntimeException())</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RuntimeException().toFlux()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flux.ofType(Foo.class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flux.ofType&lt;Foo&gt;()</code> or <code>flux.ofType(Foo::class)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepVerifier.create(flux).verifyComplete()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flux.test().verifyComplete()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <a href="https://projectreactor.io/docs/kotlin/release/kdoc-api/">Reactor KDoc API</a> lists and documents
all the available Kotlin extensions.</p>
</div>
</div>
<div class="sect2">
<h3 id="kotlin-null-safety"><a class="anchor" href="#kotlin-null-safety"></a>5.3. Null Safety</h3>
<div class="paragraph">
<p>One of Kotlin&#8217;s key features is <a href="https://kotlinlang.org/docs/reference/null-safety.html">null safety</a>,
which cleanly deals with <code>null</code> values at compile time rather than bumping into the famous
<code>NullPointerException</code> at runtime. This makes applications safer through nullability
declarations and expressive &#8220;value or no value&#8221; semantics without paying the cost of wrappers such as <code>Optional</code>.
(Kotlin allows using functional constructs with nullable values. See this
<a href="https://www.baeldung.com/kotlin-null-safety">comprehensive guide to Kotlin null-safety</a>.)</p>
</div>
<div class="paragraph">
<p>Although Java does not let one express null safety in its type-system, Reactor <a href="#null-safety">now
provides null safety</a> of the whole Reactor API through tooling-friendly annotations declared
in the <code>reactor.util.annotation</code> package.
By default, types from Java APIs used in Kotlin are recognized as
<a href="https://kotlinlang.org/docs/reference/java-interop.html#null-safety-and-platform-types">platform types</a>
for which null-checks are relaxed.
<a href="https://github.com/Kotlin/KEEP/blob/jsr-305/proposals/jsr-305-custom-nullability-qualifiers.md">Kotlin support for JSR 305 annotations</a>
and Reactor nullability annotations provide null-safety for the whole Reactor API to Kotlin developers,
with the advantage of dealing with <code>null</code>-related issues at compile time.</p>
</div>
<div class="paragraph">
<p>You can configure the JSR 305 checks by adding the <code>-Xjsr305</code> compiler flag with the following
options: <code>-Xjsr305={strict|warn|ignore}</code>.</p>
</div>
<div class="paragraph">
<p>For kotlin versions 1.1.50+, the default behavior is the same as <code>-Xjsr305=warn</code>.
The <code>strict</code> value is required to have the Reactor API full null-safety taken into account
but should be considered experimental, since the Reactor API nullability declaration could evolve
even between minor releases, as more checks may be added in the future).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nullability for generic type arguments, variable arguments, and array elements is not supported yet,
but itshould be in an upcoming release. See <a href="https://github.com/Kotlin/KEEP/issues/79">this dicussion</a>
for up-to-date information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/kotlin.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#kotlin">Kotlin support</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>6. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whether you have written a simple chain of Reactor operators or your own operator,
automated testing is always a good idea.</p>
</div>
<div class="paragraph">
<p>Reactor comes with a few elements dedicated to testing, gathered into their own
artifact: <code>reactor-test</code>. You can find that project
<a href="https://github.com/reactor/reactor-core/tree/master/reactor-test/src">on Github</a>,
inside of the <code>reactor-core</code> repository.</p>
</div>
<div class="paragraph">
<p>To use it in your tests, you must add it as a test dependency.
The following example shows how to add <code>reactor-test</code> as a dependency in Maven:</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. reactor-test in Maven, in <code>&lt;dependencies&gt;</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
    &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
    <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If you use the <a href="#getting">BOM</a>, you do not need to specify a <code>&lt;version&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to add <code>reactor-test</code> as a dependency in Gradle:</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. reactor-test in Gradle, amend the <code>dependencies</code> block</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
   testCompile 'io.projectreactor:reactor-test'
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The three main uses of <code>reactor-test</code> are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Testing that a sequence follows a given scenario, step-by-step, with <code>StepVerifier</code>.</p>
</li>
<li>
<p>Producing data in order to test the behavior of downstream operators (including you own
operators) with <code>TestPublisher</code>.</p>
</li>
<li>
<p>In sequences that can go through several alternative <code>Publisher</code> (for example, a chain that uses
<code>switchIfEmpty</code>, probing such a <code>Publisher</code> to ensure it was used (that is, subscribed to).</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_testing_a_scenario_with_stepverifier"><a class="anchor" href="#_testing_a_scenario_with_stepverifier"></a>6.1. Testing a Scenario with <code>StepVerifier</code></h3>
<div class="paragraph">
<p>The most common case for testing a Reactor sequence is to have a <code>Flux</code> or a <code>Mono</code> defined
in your code (for example, it might be returned by a method) and to want to test how it
behaves when subscribed to.</p>
</div>
<div class="paragraph">
<p>This situation translates well to defining a &#8220;test scenario,&#8221; where you define your
expectations in terms of events, step-by-step. You can ask and answer questions such as
the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What is the next expected event?</p>
</li>
<li>
<p>Do you expect the <code>Flux</code> to emit a particular value?</p>
</li>
<li>
<p>Or maybe to do nothing for the next 300ms?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can express all of that through the <code>StepVerifier</code> API.</p>
</div>
<div class="paragraph">
<p>For instance, you could have the following utility method in your codebase that
decorates a <code>Flux</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public &lt;T&gt; Flux&lt;T&gt; appendBoomError(Flux&lt;T&gt; source) {
  return source.concatWith(Mono.error(new IllegalArgumentException("boom")));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In order to test it, you want to verify the following scenario:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I expect this <code>Flux</code> to first emit <code>thing1</code>, then emit <code>thing2</code>, and then <strong>produce an
error</strong> with the message, <code>boom</code>. Subscribe and <strong>verify</strong> these expectations.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In the <code>StepVerifier</code> API, this translates to the following test:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void testAppendBoomError() {
  Flux&lt;String&gt; source = Flux.just("thing1", "thing2"); <i class="conum" data-value="1"></i><b>(1)</b>

  StepVerifier.create( <i class="conum" data-value="2"></i><b>(2)</b>
    appendBoomError(source)) <i class="conum" data-value="3"></i><b>(3)</b>
    .expectNext("thing1") <i class="conum" data-value="4"></i><b>(4)</b>
    .expectNext("thing2")
    .expectErrorMessage("boom") <i class="conum" data-value="5"></i><b>(5)</b>
    .verify(); <i class="conum" data-value="6"></i><b>(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Since our method needs a source <code>Flux</code>, define a simple one for testing purposes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>StepVerifier</code> builder that wraps and verifies a <code>Flux</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the <code>Flux</code> to be tested (the result of calling our utility method).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The first signal we expect to happen upon subscription is an <code>onNext</code>, with a value
of <code>thing1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The last signal we expect to happen is a termination of the sequence with an
<code>onError</code>. The exception should have <code>boom</code> as a message.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>It is important to trigger the test by calling <code>verify()</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The API is a builder. You start by creating a <code>StepVerifier</code> and passing the
sequence to be tested. This offers a choice of methods that let you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Express expectations about the next signals to occur. If any other signal is received
(or the content of the signal does not match the expectation), the whole test fails with
a meaningful <code>AssertionError</code>. For example, you might use <code>expectNext(T&#8230;&#8203;)</code> and
<code>expectNextCount(long)</code>.</p>
</li>
<li>
<p>Consume the next signal. This is used when you want to skip part of the sequence or
when you want to apply a custom <code>assertion</code> on the content of the signal (for example, to
check that there is an <code>onNext</code> event and assert that the emitted item is a list of size
5). For example, you might use <code>consumeNextWith(Consumer&lt;T&gt;)</code>.</p>
</li>
<li>
<p>Take miscellaneous actions such as pausing or running arbitrary code. For example, if
you want to manipulate a test-specific state or context. To that effect, you might use
<code>thenAwait(Duration)</code> and <code>then(Runnable)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For terminal events, the corresponding expectation methods (<code>expectComplete()</code> and
<code>expectError()</code> and all their variants) switch to an API where you cannot express
expectations anymore. In that last step, all you can do is perform some additional
configuration on the <code>StepVerifier</code> and then trigger the verification, often
with <code>verify()</code> or one of its variants.</p>
</div>
<div class="paragraph">
<p>What happens at this point is that the <code>StepVerifier</code> subscribes to the tested <code>Flux</code> or
<code>Mono</code> and plays the sequence, comparing each new signal with the next step in the
scenario. As long as these match, the test is considered a success. As soon as there is a
discrepancy, an <code>AssertionError</code> is thrown.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Remember the <code>verify()</code> step, which triggers the verification. To
help, the API includes a few shortcut methods that combine the terminal expectations with
a call to <code>verify()</code>: <code>verifyComplete()</code>, <code>verifyError()</code>, <code>verifyErrorMessage(String)</code>,
and others.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that, if one of the lambda-based expectations throws an <code>AssertionError</code>, it is
reported as is, failing the test. This is useful for custom assertions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
By default, the <code>verify()</code> method and derived shortcut methods (<code>verifyThenAssertThat</code>,
<code>verifyComplete()</code>, and so on) have no timeout. They can block indefinitely. You can use
<code>StepVerifier.setDefaultTimeout(Duration)</code> to globally set a timeout for these methods,
or specify one on a per-call basis with <code>verify(Duration)</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_better_identifying_test_failures"><a class="anchor" href="#_better_identifying_test_failures"></a>6.1.1. Better Identifying Test Failures</h4>
<div class="paragraph">
<p><code>StepVerifier</code> provides two options to better identify exactly which expectation step caused
a test to fail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>as(String)</code>: Used after most <code>expect*</code> methods to give a description
to the preceding expectation. If the expectation fails, its error message contains the
description. Terminal expectations and <code>verify</code> cannot be described that way.</p>
</li>
<li>
<p><code>StepVerifierOptions.create().scenarioName(String)</code>: By using <code>StepVerifierOptions</code> to create
your <code>StepVerifier</code>, you can use the <code>scenarioName</code> method to give the whole scenario a
name, which is also used in assertion error messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, in both cases, the use of the description or name in messages is only guaranteed for
<code>StepVerifier</code> methods that produce their own <code>AssertionError</code> (for example, throwing an exception
manually or through an assertion library in <code>assertNext</code> does not add the description or name to
the error&#8217;s message).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_manipulating_time"><a class="anchor" href="#_manipulating_time"></a>6.2. Manipulating Time</h3>
<div class="paragraph">
<p>You can use <code>StepVerifier</code> with time-based operators to avoid long run times for
corresponding tests. You can do so through the <code>StepVerifier.withVirtualTime</code> builder.</p>
</div>
<div class="paragraph">
<p>It looks like the following example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.withVirtualTime(() -&gt; Mono.delay(Duration.ofDays(1)))
//... continue expectations here</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This virtual time feature plugs in a custom <code>Scheduler</code> in Reactor&#8217;s <code>Schedulers</code>
factory. Since these timed operators usually use the default <code>Schedulers.parallel()</code>
scheduler, replacing it with a <code>VirtualTimeScheduler</code> does the trick. However, an
important prerequisite is that the operator be instantiated after the virtual time
scheduler has been activated.</p>
</div>
<div class="paragraph">
<p>To increase the chances that this happens correctly, the <code>StepVerifier</code> does not take
a simple <code>Flux</code> as input. <code>withVirtualTime</code> takes a <code>Supplier</code>, which guides you into lazily
creating the instance of the tested flux <em>after</em> having done the scheduler set up.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Take extra care to ensure the <code>Supplier&lt;Publisher&lt;T&gt;&gt;</code> can be used in a lazy
fashion. Otherwise, virtual time is not guaranteed. Especially avoid instantiating the
<code>Flux</code> earlier in the test code and having the <code>Supplier</code> return that variable. Instead,
always instantiate the <code>Flux</code> inside the lambda.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two expectation methods that deal with time, and they are both valid with or
without virtual time:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>thenAwait(Duration)</code>: Pauses the evaluation of steps (allowing a few signals to occur
or delays to run out).</p>
</li>
<li>
<p><code>expectNoEvent(Duration)</code>: Also lets the sequence play out for a given duration but
fails the test if <em>any</em> signal occurs during that time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both methods pause the thread for the given duration in classic mode and advance the
virtual clock instead in virtual mode.</p>
</div>
<div id="tip-expectNoEvent" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>expectNoEvent</code> also considers the <code>subscription</code> as an event. If you use it as a
first step, it usually fails because the subscription signal is detected. Use
<code>expectSubscription().expectNoEvent(duration)</code> instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to quickly evaluate the behavior of our <code>Mono.delay</code> above, we can finish
writing our code as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.withVirtualTime(() -&gt; Mono.delay(Duration.ofDays(1)))
    .expectSubscription() <i class="conum" data-value="1"></i><b>(1)</b>
    .expectNoEvent(Duration.ofDays(1)) <i class="conum" data-value="2"></i><b>(2)</b>
    .expectNext(0L) <i class="conum" data-value="3"></i><b>(3)</b>
    .verifyComplete(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>See the preceding <a href="#tip-expectNoEvent">tip</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Expect nothing to happen for a full day.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then expect a delay that emits <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Then expect completion (and trigger the verification).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>We could have used <code>thenAwait(Duration.ofDays(1))</code> above, but <code>expectNoEvent</code> has the
benefit of guaranteeing that nothing happened earlier than it should have.</p>
</div>
<div class="paragraph">
<p>Note that <code>verify()</code> returns a <code>Duration</code> value. This is the real-time duration of the
entire test.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Virtual time is not a silver bullet. All <code>Schedulers</code> are
replaced with the same <code>VirtualTimeScheduler</code>. In some cases, you can lock the
verification process because the virtual clock has not moved forward before an
expectation is expressed, resulting in the expectation waiting on data that can only be
produced by advancing time. In most cases, you need to advance the virtual clock for
sequences to emit. Virtual time also gets very limited with infinite sequences, which
might hog the thread on which both the sequence and its verification run.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_performing_post_execution_assertions_with_stepverifier"><a class="anchor" href="#_performing_post_execution_assertions_with_stepverifier"></a>6.3. Performing Post-execution Assertions with <code>StepVerifier</code></h3>
<div class="paragraph">
<p>After having described the final expectation of your scenario, you can switch to a
complementary assertion API instead of triggering <code>verify()</code>. To do so, use
<code>verifyThenAssertThat()</code> instead.</p>
</div>
<div class="paragraph">
<p><code>verifyThenAssertThat()</code> returns a <code>StepVerifier.Assertions</code> object, which you can use to
assert a few elements of state once the whole scenario has played out successfully
(because it also calls <code>verify()</code>). Typical (albeit advanced) usage is to capture
elements that have been dropped by some operator and assert them (see the section on
<a href="#hooks">Hooks</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_context"><a class="anchor" href="#_testing_the_context"></a>6.4. Testing the <code>Context</code></h3>
<div class="paragraph">
<p>For more information about the <code>Context</code>, see <a href="#context">Adding a Context to a Reactive Sequence</a>.</p>
</div>
<div class="paragraph">
<p><code>StepVerifier</code> comes with a couple of expectations around the propagation of a <code>Context</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>expectAccessibleContext</code>: Returns a <code>ContextExpectations</code> object that you can use
to set up expectations on the propagated <code>Context</code>. Be sure to call <code>then()</code> to return
to the set of sequence expectations.</p>
</li>
<li>
<p><code>expectNoAccessibleContext</code>: Sets up an expectation that NO <code>Context</code> can be propagated
up the chain of operators under test. This most likely occurs when the <code>Publisher</code> under
test is not a Reactor one or does not have any operator that can propagate the <code>Context</code>
(for example, a generator source).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, you can associate a test-specific initial <code>Context</code> to a <code>StepVerifier</code> by
using <code>StepVerifierOptions</code> to create the verifier.</p>
</div>
<div class="paragraph">
<p>These features are demonstrated in the following snippet:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(Mono.just(1).map(i -&gt; i + 10),
				StepVerifierOptions.create().withInitialContext(Context.of("thing1", "thing2"))) <i class="conum" data-value="1"></i><b>(1)</b>
		            .expectAccessibleContext() <i class="conum" data-value="2"></i><b>(2)</b>
		            .contains("foo", "bar") <i class="conum" data-value="3"></i><b>(3)</b>
		            .then() <i class="conum" data-value="4"></i><b>(4)</b>
		            .expectNext(11)
		            .verifyComplete(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>StepVerifier</code> by using <code>StepVerifierOptions</code> and pass in an initial <code>Context</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start setting up expectations about <code>Context</code> propagation. This alone ensures that a
<code>Context</code> was propagated.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An example of a <code>Context</code>-specific expectation. It must contain value "thing2" for key "thing1".</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We <code>then()</code> switch back to setting up normal expectations on the data.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Let us not forget to <code>verify()</code> the whole set of expectations.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_manually_emitting_with_testpublisher"><a class="anchor" href="#_manually_emitting_with_testpublisher"></a>6.5. Manually Emitting with <code>TestPublisher</code></h3>
<div class="paragraph">
<p>For more advanced test cases, it might be useful to have complete mastery over the source
of data, to trigger finely chosen signals that closely match the particular
situation you want to test.</p>
</div>
<div class="paragraph">
<p>Another situation is when you have implemented your own operator and you want to verify
how it behaves with regards to the Reactive Streams specification, especially if its
source is not well behaved.</p>
</div>
<div class="paragraph">
<p>For both cases, <code>reactor-test</code> offers the <code>TestPublisher</code> class. This is a <code>Publisher&lt;T&gt;</code>
that lets you programmatically trigger various signals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>next(T)</code> and <code>next(T, T&#8230;&#8203;)</code> triggers 1-n <code>onNext</code> signals.</p>
</li>
<li>
<p><code>emit(T&#8230;&#8203;)</code> triggers 1-n <code>onNext</code> signals and does <code>complete()</code>.</p>
</li>
<li>
<p><code>complete()</code> terminates with an <code>onComplete</code> signal.</p>
</li>
<li>
<p><code>error(Throwable)</code> terminates with an <code>onError</code> signal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can get a well behaved <code>TestPublisher</code> through the <code>create</code> factory method. Also,
you can create a misbehaving <code>TestPublisher</code> by using the <code>createNonCompliant</code> factory
method. The latter takes a value or multiple values from the <code>TestPublisher.Violation</code>
enum. The values define which parts of the specification the publisher can overlook.
These enum values include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>REQUEST_OVERFLOW</code>: Allows <code>next</code> calls to be made despite an insufficient request,
without triggering an <code>IllegalStateException</code>.</p>
</li>
<li>
<p><code>ALLOW_NULL</code>: Allows <code>next</code> calls to be made with a <code>null</code> value without triggering a
<code>NullPointerException</code>.</p>
</li>
<li>
<p><code>CLEANUP_ON_TERMINATE</code>: Allows termination signals to be sent several times in a row.
This includes <code>complete()</code>, <code>error()</code>, and <code>emit()</code>.</p>
</li>
<li>
<p><code>DEFER_CANCELLATION</code>: Allows the <code>TestPublisher</code> to ignore cancellation signals and continue
emitting signals as if the cancellation lost the race against said signals.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the <code>TestPublisher</code> keeps track of internal state after subscription, which can
be asserted through its various <code>assert*</code> methods.</p>
</div>
<div class="paragraph">
<p>You can use it as a <code>Flux</code> or <code>Mono</code> by using the conversion methods, <code>flux()</code> and
<code>mono()</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_checking_the_execution_path_with_publisherprobe"><a class="anchor" href="#_checking_the_execution_path_with_publisherprobe"></a>6.6. Checking the Execution Path with <code>PublisherProbe</code></h3>
<div class="paragraph">
<p>When building complex chains of operators, you could come across cases where
there are several possible execution paths, materialized by distinct sub-sequences.</p>
</div>
<div class="paragraph">
<p>Most of the time, these sub-sequences produce a specific-enough <code>onNext</code> signal
that you can assert that it was executed by looking at the end result.</p>
</div>
<div class="paragraph">
<p>For instance, consider the following method, which builds a chain of operators from a
source and uses a <code>switchIfEmpty</code> to fall back to a particular alternative if the source
is empty:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Flux&lt;String&gt; processOrFallback(Mono&lt;String&gt; source, Publisher&lt;String&gt; fallback) {
    return source
            .flatMapMany(phrase -&gt; Flux.fromArray(phrase.split("\\s+")))
            .switchIfEmpty(fallback);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can test which logical branch of the switchIfEmpty was used, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void testSplitPathIsUsed() {
    StepVerifier.create(processOrFallback(Mono.just("just a  phrase with    tabs!"),
            Mono.just("EMPTY_PHRASE")))
                .expectNext("just", "a", "phrase", "with", "tabs!")
                .verifyComplete();
}

@Test
public void testEmptyPathIsUsed() {
    StepVerifier.create(processOrFallback(Mono.empty(), Mono.just("EMPTY_PHRASE")))
                .expectNext("EMPTY_PHRASE")
                .verifyComplete();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>However, think about an example where the method produces a <code>Mono&lt;Void&gt;</code> instead. It waits
for the source to complete, performs an additional task, and completes. If the source
is empty, a fallback <code>Runnable</code>-like task must be performed instead. The following example
shows such a case:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Mono&lt;String&gt; executeCommand(String command) {
    return Mono.just(command + " DONE");
}

public Mono&lt;Void&gt; processOrFallback(Mono&lt;String&gt; commandSource, Mono&lt;Void&gt; doWhenEmpty) {
    return commandSource
            .flatMap(command -&gt; executeCommand(command).then()) <i class="conum" data-value="1"></i><b>(1)</b>
            .switchIfEmpty(doWhenEmpty); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>then()</code> forgets about the command result. It cares only that it was completed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>How to distinguish between two cases that are both empty sequences?</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>To verify that your <code>processOrFallback</code> method does indeed go through the <code>doWhenEmpty</code> path,
you need to write a bit of boilerplate. Namely you need a <code>Mono&lt;Void&gt;</code> that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Captures the fact that it has been subscribed to.</p>
</li>
<li>
<p>Lets you assert that fact <em>after</em> the whole process has terminated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before version 3.1, you would need to manually maintain one <code>AtomicBoolean</code> per state you
wanted to assert and attach a corresponding <code>doOn*</code> callback to the publisher you wanted
to evaluate. This could be a lot of boilerplate when having to apply this pattern
regularly. Fortunately, 3.1.0 introduced an alternative with <code>PublisherProbe</code>. The
following example shows how to use it:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void testCommandEmptyPathIsUsed() {
    PublisherProbe&lt;Void&gt; probe = PublisherProbe.empty(); <i class="conum" data-value="1"></i><b>(1)</b>

    StepVerifier.create(processOrFallback(Mono.empty(), probe.mono())) <i class="conum" data-value="2"></i><b>(2)</b>
                .verifyComplete();

    probe.assertWasSubscribed(); <i class="conum" data-value="3"></i><b>(3)</b>
    probe.assertWasRequested(); <i class="conum" data-value="4"></i><b>(4)</b>
    probe.assertWasNotCancelled(); <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a probe that translates to an empty sequence.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the probe in place of <code>Mono&lt;Void&gt;</code> by calling <code>probe.mono()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>After completion of the sequence, the probe lets you assert that it was used. You
can check that is was subscribed to&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203;as well as actually requested data&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&#8230;&#8203;and whether or not it was cancelled.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also use the probe in place of a <code>Flux&lt;T&gt;</code> by calling <code>.flux()</code> instead of
<code>.mono()</code>. For cases where you need to probe an execution path but also need the
probe to emit data, you can wrap any <code>Publisher&lt;T&gt;</code> by using <code>PublisherProbe.of(Publisher)</code>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/testing.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#testing">Testing</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging"><a class="anchor" href="#debugging"></a>7. Debugging Reactor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Switching from an imperative and synchronous programming paradigm to a reactive and
asynchronous one can sometimes be daunting. One of the steepest steps in the learning
curve is how to analyze and debug when something goes wrong.</p>
</div>
<div class="paragraph">
<p>ä»å½ä»¤å¼ååæ­¥ç¼ç¨èä¾åæ¢å°è¢«å¨åå¼æ­¥ç¼ç¨èä¾ææ¶ä¼ä»¤äººççã
å­¦ä¹ æ²çº¿ä¸­æé¡å³­çæ­¥éª¤ä¹ä¸æ¯åºç°é®é¢æ¶å¦ä½è¿è¡åæåè°è¯ã</p>
</div>
<div class="paragraph">
<p>In the imperative world, debugging is usually pretty straightforward. You can read the
stacktrace and see where the problem originated. Was it entirely a failure
of your code? Did the failure occur in some library code? If so, what part of your code
called the library, potentially passing in improper parameters that ultimately caused the
failure?</p>
</div>
<div class="paragraph">
<p>å¨å½ä»¤å¼ä¸çä¸­ï¼è°è¯éå¸¸éå¸¸ç®åãæ¨å¯ä»¥éè¯»stacktraceå¹¶æ¥çé®é¢çæ ¹æºãè¿å®å¨æ¯æ¨çä»£ç å¤±è´¥åï¼
æéæ¯å¦åçå¨æäºåºä»£ç ä¸­ï¼å¦ææ¯è¿æ ·ï¼æ¨çä»£ç çåªä¸é¨åè°ç¨äºåºï¼å¯è½ä¼ä¼ å¥ä¸æ­£ç¡®çåæ°ï¼æç»å¯¼è´å¤±è´¥ï¼</p>
</div>
<div class="sect2">
<h3 id="_the_typical_reactor_stack_trace"><a class="anchor" href="#_the_typical_reactor_stack_trace"></a>7.1. The Typical Reactor Stack Trace</h3>
<div class="paragraph">
<p>When you shift to asynchronous code, things can get much more complicated.</p>
</div>
<div class="paragraph">
<p>å½æ¨è½¬åå¼æ­¥ä»£ç æ¶ï¼äºæä¼åå¾æ´å å¤æã</p>
</div>
<div class="paragraph">
<p>Consider the following stack trace:</p>
</div>
<div class="paragraph">
<p>èèä»¥ä¸å æ è·è¸ªï¼</p>
</div>
<div class="paragraph">
<div class="title">A typical Reactor stack trace</div>
<p>å¸åçReactorå æ è·è¸ª</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">java.lang.IndexOutOfBoundsException: Source emitted more than one item
	at reactor.core.publisher.MonoSingle$SingleSubscriber.onNext(MonoSingle.java:129)
	at reactor.core.publisher.FluxFlatMap$FlatMapMain.tryEmitScalar(FluxFlatMap.java:445)
	at reactor.core.publisher.FluxFlatMap$FlatMapMain.onNext(FluxFlatMap.java:379)
	at reactor.core.publisher.FluxMapFuseable$MapFuseableSubscriber.onNext(FluxMapFuseable.java:121)
	at reactor.core.publisher.FluxRange$RangeSubscription.slowPath(FluxRange.java:154)
	at reactor.core.publisher.FluxRange$RangeSubscription.request(FluxRange.java:109)
	at reactor.core.publisher.FluxMapFuseable$MapFuseableSubscriber.request(FluxMapFuseable.java:162)
	at reactor.core.publisher.FluxFlatMap$FlatMapMain.onSubscribe(FluxFlatMap.java:332)
	at reactor.core.publisher.FluxMapFuseable$MapFuseableSubscriber.onSubscribe(FluxMapFuseable.java:90)
	at reactor.core.publisher.FluxRange.subscribe(FluxRange.java:68)
	at reactor.core.publisher.FluxMapFuseable.subscribe(FluxMapFuseable.java:63)
	at reactor.core.publisher.FluxFlatMap.subscribe(FluxFlatMap.java:97)
	at reactor.core.publisher.MonoSingle.subscribe(MonoSingle.java:58)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3096)
	at reactor.core.publisher.Mono.subscribeWith(Mono.java:3204)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3090)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3057)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3029)
	at reactor.guide.GuideTests.debuggingCommonStacktrace(GuideTests.java:995)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There is a lot going on there. We get an <code>IndexOutOfBoundsException</code>, which tells us that
a <code>source emitted more than one item</code>.</p>
</div>
<div class="paragraph">
<p>é£éåçäºå¾å¤äºæãæä»¬å¾å°ä¸ä¸ªIndexOutOfBoundsExceptionï¼åè¯æä»¬ä¸ä¸ª`source emitted more than one item`.</p>
</div>
<div class="paragraph">
<p>We can probably quickly come to assume that this source is a Flux or a Mono, as confirmed by
the next line, which mentions <code>MonoSingle</code>. So it appears to be some sort of complaint
from a <code>single</code> operator.</p>
</div>
<div class="paragraph">
<p>æ­£å¦ä¸ä¸è¡æå°çæç¤ºï¼æä»¬å¯è½å¾å¿«å°±å¯ä»¥åå®æ­¤æºæ¯FluxæMono MonoSingleãå æ­¤ï¼è¿ä¼¼ä¹æ¯singleæä½åçæç§æ±æ¨ã</p>
</div>
<div class="paragraph">
<p>Referring to the Javadoc for the <code>Mono#single</code> operator, we see that <code>single</code> has a contract:
The source must emit exactly one element. It appears we had a source that emitted more
than one and thus violated that contract.</p>
</div>
<div class="paragraph">
<p>åèMono#singleæä½ç¬¦çJavadocæ¶ï¼æä»¬çå°singleæä¸ä¸ªçº¦å®ï¼æºå¿é¡»ç¡®åå°ååºä¸ä¸ªåç´ ãçæ¥æä»¬æä¸ä¸ªææ¾æºä¸æ­¢ä¸ä¸ªï¼å æ­¤è¿åäºè¯¥ååã</p>
</div>
<div class="paragraph">
<p>Can we dig deeper and identify that source? The following rows are not very helpful. They
take us through the internals of what seems to be a reactive chain, through
multiple calls to <code>subscribe</code> and <code>request</code>.</p>
</div>
<div class="paragraph">
<p>æä»¬å¯ä»¥æ´æ·±å¥å°ææå¹¶ç¡®å®æ¥æºåï¼ä»¥ä¸å è¡ä¸æ¯å¾æå¸®å©ã
å¸¦æä»¬è¿å¥ä¼¼ä¹æ¯ä¸ä¸ªreactive é¾çåé¨ãè¿è¿äºå¤æ¬¡è°ç¨subscribeårequestï¼</p>
</div>
<div class="paragraph">
<p>By skimming over these rows, we can at least start to form a picture of the kind of chain
that went wrong: It seems to involve a <code>MonoSingle</code>, a <code>FluxFlatMap</code>, and a <code>FluxRange</code>
(each gets several rows in the trace, but overall these three classes are involved). So a
<code>range().flatMap().single()</code> chain maybe?</p>
</div>
<div class="paragraph">
<p>éè¿ç¥è¯»è¿äºè¡ï¼æä»¬è³å°å¯ä»¥å¼å§å½¢æä¸æ¡éè¯¯é¾çå¾ï¼ä¼¼ä¹æ¶åå°MonoSingleï¼a FluxFlatMapåa FluxRange ï¼æ¯ä¸ªé½å¨è·è¸ªä¸­å¾å°å è¡ï¼ä½æ»ä½ä¸æ¶åè¿ä¸ä¸ªç±»ï¼ã
é£ä¹range().flatMap().single()ä¹è®¸æ¯ä¸ä¸ªè°ç¨é¾ï¼</p>
</div>
<div class="paragraph">
<p>But what if we use that pattern a lot in our application? This still does not tell us
much, and simply searching for <code>single</code> is not going to find the problem. Then the last
line refers to some of our code. Finally, we are getting close.</p>
</div>
<div class="paragraph">
<p>ä½æ¯ï¼å¦ææä»¬å¨åºç¨ç¨åºä¸­é¢ç¹ä½¿ç¨è¯¥æ¨¡å¼æä¹åï¼è¿ä»ç¶ä¸è½åè¯æä»¬å¤ªå¤ï¼ä»æç´¢singleæ¯ä¸ä¼åç°é®é¢çã
ç¶åï¼æåä¸è¡å¼ç¨äºæä»¬çä¸äºä»£ç ãæåï¼æä»¬è¶æ¥è¶è¿äºã</p>
</div>
<div class="paragraph">
<p>Hold on, though. When we go to the source file, all we see is that a
pre-existing <code>Flux</code> is subscribed to, as follows:</p>
</div>
<div class="paragraph">
<p>ç­ä¸ä¸ãè½¬å°æºæä»¶æ¶ï¼æä»¬çå° ä¹åçéåºçFlux æ¯å·²è¢«é¢è®¢äºï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">toDebug.subscribe(System.out::println, Throwable::printStackTrace);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>All of this happened at subscription time, but the <code>Flux</code> itself was not
declared there. Worse, when we go to where the variable is declared, we see the following:</p>
</div>
<div class="paragraph">
<p>ææè¿äºé½æ¯å¨è®¢éæ¶åççï¼ä½Fluxæ¬èº«å¹¶æªå¨æ­¤å¤å£°æãæ´ç³ç³çæ¯ï¼å½æä»¬è½¬å°å£°æåéçä½ç½®æ¶ï¼ä¼çå°ä»¥ä¸åå®¹ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Mono&lt;String&gt; toDebug; //please overlook the public class attribute</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The variable is not instantiated where it is declared. We must assume a worst-case
scenario where we find out that there could be a few different code paths that set it in
the application. We remain unsure of which one caused the issue.</p>
</div>
<div class="paragraph">
<p>åéæªå¨å£°æçå°æ¹å®ä¾åã
æä»¬å¿é¡»åè®¾å¨æåçæåµä¸ï¼æä»¬åç°å¯è½å¨åºç¨ç¨åºä¸­è®¾ç½®äºä¸äºä¸åçä»£ç è·¯å¾ãæä»¬ä»ç¶ä¸ç¡®å®æ¯åªä¸ä¸ªå¼èµ·äºé®é¢ã</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is kind of the Reactor equivalent of a runtime error, as opposed to a
compilation error.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What we want to find out more easily is where the operator was added into the chain -
that is,  where the <code>Flux</code> was declared. We usually refer to that as the &#8220;assembly&#8221; of
the <code>Flux</code>.</p>
</div>
<div class="paragraph">
<p>æä»¬æ³è¦æ´å®¹æåç°çæ¯å°è¿ç®ç¬¦æ·»å å°é¾ä¸­çä½ç½®-å³Fluxå£°æçä½ç½®ãæä»¬éå¸¸å°å¶ç§°ä¸ºFluxçâassemblyâ ã</p>
</div>
</div>
<div class="sect2">
<h3 id="debug-activate"><a class="anchor" href="#debug-activate"></a>7.2. Activating Debug Mode - aka tracebacks</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
this section describes the easiest but also the slowest way to enable
the debugging capabitilies due to the fact that it captures the stacktrace on every operator.
See <a href="#checkpoint-alternative">The <code>checkpoint()</code> Alternative</a> for a more fine grained way of debugging,
and <a href="#reactor-tools-debug">Production-ready Global Debugging</a> for a more advanced and performant global option.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
æ¬èä»ç»äºå¯ç¨è°è¯åè½çæç®åä½ä¹æ¯ææ¢çæ¹æ³ï¼å ä¸ºå®æè·äºæ¯ä¸ªè¿ç®ç¬¦ä¸çstacktraceã
æå³æ´ç»ç²åº¦çè°è¯æ¹æ³ï¼è¯·åè§<a href="#checkpoint-alternative">The <code>checkpoint()</code> Alternative</a>ï¼æå³æ´é«çº§åé«æ§è½çå¨å±éé¡¹ï¼è¯·åè§ <a href="#reactor-tools-debug">Production-ready Global Debugging</a>ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Even though the stacktrace was still able to convey some information for someone with a
bit of experience, we can see that it is not ideal by itself in more advanced cases.</p>
</div>
<div class="paragraph">
<p>å³ä½¿stacktraceä»ç¶è½å¤ä¸ºæç»éªçäººä¼ è¾¾ä¸äºä¿¡æ¯ï¼ä½æä»¬å¯ä»¥çå°ï¼å¨æ´é«çº§çæåµä¸ï¼å®æ¬èº«å¹¶ä¸çæ³ã</p>
</div>
<div class="paragraph">
<p>Fortunately, Reactor comes with  assembly-time instrumentation that is designed for debugging.</p>
</div>
<div class="paragraph">
<p>å¹¸è¿çæ¯ï¼Reactorå¸¦æä¸ä¸ºè°è¯èè®¾è®¡çç»è£æ¶å·¥å·ã</p>
</div>
<div class="paragraph">
<p>This is done by customizing the <code>Hooks.onOperator</code> hook at application start (or at
least before the incriminated <code>Flux</code> or <code>Mono</code> can be instantiated), as follows:</p>
</div>
<div class="paragraph">
<p>è¿æ¯éè¿Hooks.onOperatorå¨åºç¨ç¨åºå¯å¨æ¶ï¼æè³å°å¨åå«FluxæMonoå¯å®ä¾åä¹åï¼èªå®ä¹é©å­æ¥å®æçï¼å¦ä¸æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Hooks.onOperatorDebug();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This starts instrumenting the calls to the <code>Flux</code> (and <code>Mono</code>) operator  methods (where
they are assembled into the chain) by wrapping the construction of the operator and
capturing a stack trace there. Since this is done when the operator chain is declared, the
hook should be activated before that, so the safest way is to activate it right at the
start of your application.</p>
</div>
<div class="paragraph">
<p>éè¿åè£æä½ç¬¦çç»æå¹¶æè·å¶ä¸­çå æ è·è¸ªä¿¡æ¯ï¼å¼å§å¯¹Fluxï¼åMonoï¼æä½ç¬¦æ¹æ³ï¼å°å®ä»¬ç»è£å°é¾ä¸­ï¼çè°ç¨è¿è¡æ£æµã
ç±äºæ­¤æä½æ¯å¨å£°ææä½åé¾æ¶å®æçï¼å æ­¤åºå¨æ­¤ä¹åå°é©å­æ¿æ´»ï¼å æ­¤æå®å¨çæ¹æ³æ¯å¨åºç¨ç¨åºå¼å§æ¶ç«å³å°å¶æ¿æ´»ã</p>
</div>
<div class="paragraph">
<p>Later on, if an exception occurs, the failing operator is able to refer to that capture
and append it to the stack trace. We call this captured assembly information a <strong>traceback</strong>.</p>
</div>
<div class="paragraph">
<p>ç¨åï¼å¦æåçå¼å¸¸ï¼åå¤±è´¥çè¿ç®ç¬¦å¯ä»¥å¼ç¨è¯¥æè·å¹¶å°å¶éå å°å æ è·è¸ªä¸­ãæä»¬å°æ­¤æè·çç¨åºéä¿¡æ¯ç§°ä¸ºåæº¯ã</p>
</div>
<div class="paragraph">
<p>In the next section, we see how the stack trace differs and how to interpret
that new information.</p>
</div>
<div class="paragraph">
<p>å¨ä¸ä¸èä¸­ï¼æä»¬å°äºè§£å æ è·è¸ªçä¸åä¹å¤ä»¥åå¦ä½è§£éè¯¥æ°ä¿¡æ¯ã</p>
</div>
</div>
<div class="sect2">
<h3 id="_reading_a_stack_trace_in_debug_mode"><a class="anchor" href="#_reading_a_stack_trace_in_debug_mode"></a>7.3. Reading a Stack Trace in Debug Mode</h3>
<div class="paragraph">
<p>When we reuse our initial example but activate the <code>operatorStacktrace</code> debug feature,
the stack trace is as follows:</p>
</div>
<div class="paragraph">
<p>å½æä»¬éç¨æåçç¤ºä¾ä½æ¿æ´»operatorStacktraceè°è¯åè½æ¶ï¼å æ è·è¸ªå¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">java.lang.IndexOutOfBoundsException: Source emitted more than one item
	at reactor.core.publisher.MonoSingle$SingleSubscriber.onNext(MonoSingle.java:129)
	at reactor.core.publisher.FluxOnAssembly$OnAssemblySubscriber.onNext(FluxOnAssembly.java:375) <i class="conum" data-value="1"></i><b>(1)</b>
...
<i class="conum" data-value="2"></i><b>(2)</b>
...
	at reactor.core.publisher.Mono.subscribeWith(Mono.java:3204)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3090)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3057)
	at reactor.core.publisher.Mono.subscribe(Mono.java:3029)
	at reactor.guide.GuideTests.debuggingActivated(GuideTests.java:1000)
	Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: <i class="conum" data-value="3"></i><b>(3)</b>
Assembly trace from producer [reactor.core.publisher.MonoSingle] : <i class="conum" data-value="4"></i><b>(4)</b>
	reactor.core.publisher.Flux.single(Flux.java:6676)
	reactor.guide.GuideTests.scatterAndGather(GuideTests.java:949)
	reactor.guide.GuideTests.populateDebug(GuideTests.java:962)
	org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	org.junit.rules.RunRules.evaluate(RunRules.java:20)
Error has been observed by the following operator(s): <i class="conum" data-value="5"></i><b>(5)</b>
	|_	Flux.single â¢ reactor.guide.GuideTests.scatterAndGather(GuideTests.java:949) <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬çå°åè£æä½ç¬¦æè·å æ ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>é¤æ­¤ä¹å¤ï¼å æ è·è¸ªçç¬¬ä¸é¨åå¨å¤§å¤æ°æåµä¸ä»ç¶ç¸åï¼æ¾ç¤ºäºæä½ååé¨çä¸äºåå®¹ï¼å æ­¤æä»¬å¨æ­¤å¤å é¤äºä¸äºä»£ç æ®µï¼.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>è¿æ¯åæº¯å¼å§åºç°çå°æ¹.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>é¦åï¼æä»¬è·å¾ä¸äºæå³æä½åç»è£ä½ç½®çè¯¦ç»ä¿¡æ¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å½éè¯¯éè¿æä½åé¾ä»å¤´å°å°¾ï¼éè¯¯ç«ç¹å°è®¢éç«ç¹ï¼ä¼ æ­æ¶ï¼æä»¬è¿å¯ä»¥è¿½æº¯å°è¯¥éè¯¯.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>æåéè¯¯çæ¯ä¸ªæä½ç¬¦åä¼ä¸ç¨æ·ç±»å«åä½¿ç¨éè¯¯çè¡ä¸èµ·æå</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The captured stack trace is appended to the original error as a
suppressed <code>OnAssemblyException</code>. There are two parts to it, but the first section is the
most interesting. It shows the path of construction for the operator that triggered the
exception. Here, it shows that the <code>single</code> that caused our issue was created in the
<code>scatterAndGather</code> method, itself called from a <code>populateDebug</code> method that got executed
through JUnit.</p>
</div>
<div class="paragraph">
<p>æè·çå æ è·è¸ªå°è¢«æå¶åéå å°åå§éè¯¯OnAssemblyExceptionãå®æä¸¤ä¸ªé¨åï¼ä½æ¯ç¬¬ä¸é¨åæ¯ææè¶£çãå®æ¾ç¤ºäºè§¦åå¼å¸¸çæä½åçæé è·¯å¾ã
å¨è¿éï¼å®è¡¨æsingleå¯¼è´æä»¬é®é¢çæ¯å¨scatterAndGatheræ¹æ³ä¸­åå»ºçï¼è¯¥ æ¹æ³æ¬èº«æ¯populateDebugéè¿JUnitæ§è¡çæ¹æ³è°ç¨çã</p>
</div>
<div class="paragraph">
<p>Now that we are armed with enough information to find the culprit, we can have
a meaningful look at that <code>scatterAndGather</code> method:</p>
</div>
<div class="paragraph">
<p>æ¢ç¶æä»¬å·²ç»ææ¡äºè¶³å¤çä¿¡æ¯æ¥æ¾å°ç½ªé­ç¥¸é¦ï¼æä»¬å°±å¯ä»¥å¯¹è¯¥scatterAndGatheræ¹æ³è¿è¡æèªä¿¡çææ¥ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Mono&lt;String&gt; scatterAndGather(Flux&lt;String&gt; urls) {
    return urls.flatMap(url -&gt; doRequest(url))
           .single(); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sure enough, here is our <code>single</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we can see what the root cause of the error was a <code>flatMap</code> that performs
several HTTP calls to a few URLs but that is chained with <code>single</code>, which is too
restrictive. After a short <code>git blame</code> and a quick discussion with the author of
that line, we find out he meant to use the less restrictive <code>take(1)</code> instead.</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼æä»¬å¯ä»¥çå°éè¯¯çæ ¹æ¬åå æ¯flatMapå®å¯¹å ä¸ªURLæ§è¡äºå æ¬¡HTTPè°ç¨ï¼ä½æ¯ä¸é¾æ¥å¨ä¸èµ·singleï¼è¿å¤ªè¿ä¸¥æ ¼äºã
å¨git blameä¸è¯¥è¡çä½èè¿è¡ç®ç­ç®ç­çè®¨è®ºä¹åï¼æä»¬åç°ä»çæææ¯ä½¿ç¨éå¶æ§è¾å°çtake(1)æ ç­¾ã</p>
</div>
<div class="paragraph">
<p>We have solved our problem.</p>
</div>
<div class="paragraph">
<p>æä»¬å·²ç»è§£å³äºæä»¬çé®é¢ã</p>
</div>
<div class="paragraph">
<p>Now consider the following line in the stack trace:</p>
</div>
<div class="paragraph">
<p>ç°å¨èèå æ è·è¸ªä¸­çä»¥ä¸è¡ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Error has been observed by the following operator(s):</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That second part of the debug stack trace was not necessarily interesting in
this particular example, because the error was actually happening in the last
operator in the chain (the one closest to <code>subscribe</code>). Considering another
example might make it more clear:</p>
</div>
<div class="paragraph">
<p>å¨æ­¤ç¹å®ç¤ºä¾ä¸­ï¼è°è¯å æ è·è¸ªçç¬¬äºé¨åä¸ä¸å®æ¯æè¶£çï¼å ä¸ºè¯¥éè¯¯å®éä¸åçå¨é¾ä¸­çæåä¸ä¸ªè¿ç®ç¬¦ä¸­ï¼ææ¥è¿çé£ä¸ªsubscribeï¼ã
èèå¦ä¸ä¸ªç¤ºä¾å¯è½ä¼æ´æ¸æ¥ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">FakeRepository.findAllUserByName(Flux.just("pedro", "simon", "stephane"))
              .transform(FakeUtils1.applyFilters)
              .transform(FakeUtils2.enrichUser)
              .blockLast();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now imagine that, inside <code>findAllUserByName</code>, there is a <code>map</code> that fails. Here,
we would see the following final traceback:</p>
</div>
<div class="paragraph">
<p>ç°å¨æ³è±¡ä¸ä¸ï¼å¨åé¨findAllUserByNameï¼æä¸ä¸ªmapå¤±è´¥ãå¨è¿éï¼æä»¬å°çå°ä»¥ä¸æç»åæº¯ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Error has been observed by the following operator(s):
	|_	Flux.map â¢ reactor.guide.FakeRepository.findAllUserByName(FakeRepository.java:27)
	|_	Flux.map â¢ reactor.guide.FakeRepository.findAllUserByName(FakeRepository.java:28)
	|_	Flux.filter â¢ reactor.guide.FakeUtils1.lambda$static$1(FakeUtils1.java:29)
	|_	Flux.transform â¢ reactor.guide.GuideDebuggingExtraTests.debuggingActivatedWithDeepTraceback(GuideDebuggingExtraTests.java:40)
	|_	Flux.elapsed â¢ reactor.guide.FakeUtils2.lambda$static$0(FakeUtils2.java:30)
	|_	Flux.transform â¢ reactor.guide.GuideDebuggingExtraTests.debuggingActivatedWithDeepTraceback(GuideDebuggingExtraTests.java:41)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This corresponds to the section of the chain of operators that gets notified of the error:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The exception originates in the first <code>map</code>.</p>
</li>
<li>
<p>It is seen by a second <code>map</code> (both in fact correspond to the <code>findAllUserByName</code>
method).</p>
</li>
<li>
<p>It is then seen by a <code>filter</code> and a <code>transform</code>, which indicate that part of the chain
is constructed by a reusable transformation function (here, the <code>applyFilters</code> utility
method).</p>
</li>
<li>
<p>Finally, it is seen by an <code>elapsed</code> and a <code>transform</code>. Once again, <code>elapsed</code> is applied
by the transformation function of that second transform.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>è¿å¯¹åºäºæä½åé¾ä¸­è·å¾è¯¥éè¯¯éç¥çé¨åï¼</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¼å¸¸èµ·æºäºç¬¬ä¸ä¸ªmapã</p>
</li>
<li>
<p>ä¸ç§éå°±å¯ä»¥çå°å®mapï¼ä¸¤èå®éä¸é½å¯¹åºäºè¯¥findAllUserByName æ¹æ³ï¼ã</p>
</li>
<li>
<p>ç¶åéè¿a filteråa çå°transformï¼è¿è¡¨æé¾çä¸é¨åæ¯ç±å¯éç¨çè½¬æ¢å½æ°ï¼æ­¤å¤ä¸ºapplyFiltersUtilityæ¹æ³ï¼æé çã</p>
</li>
<li>
<p>æåï¼ç±elapsedåçå°transformãåæ¬¡elapsedç±ç¬¬äºä¸ªè½¬æ¢çè½¬æ¢å½æ°åºç¨ã</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As tracebacks are appended to original errors as suppressed exceptions, this can somewhat
interfere with another type of exception that uses this mechanism: composite exceptions.
Such exceptions can be created directly via <code>Exceptions.multiple(Throwable&#8230;&#8203;)</code>, or by some
operators that might join multiple erroring sources (like <code>Flux#flatMapDelayError</code>). They
can be unwrapped into a <code>List</code> via <code>Exceptions.unwrapMultiple(Throwable)</code>, in which case the traceback
would be considered a component of the composite and be part of the returned <code>List</code>.
If that is somehow not desirable, tracebacks can be identified thanks to <code>Exceptions.isTraceback(Throwable)</code>
check, and excluded from such an unwrap by using <code>Exceptions.unwrapMultipleExcludingTracebacks(Throwable)</code>
instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We deal with a form of instrumentation here, and creating a stack trace is costly. That
is why this debugging feature should only be activated in a controlled manner, as a last
resort.</p>
</div>
<div class="paragraph">
<p>æä»¬å¨è¿éå¤çä¸ç§å½¢å¼çæ£æµï¼å¹¶ä¸åå»ºå æ è·è¸ªéå¸¸æè´µãè¿å°±æ¯ä¸ºä»ä¹åªè½ä»¥å¯æ§å¶çæ¹å¼æ¿æ´»æ­¤è°è¯åè½çåå ã</p>
</div>
<div class="sect3">
<h4 id="checkpoint-alternative"><a class="anchor" href="#checkpoint-alternative"></a>7.3.1. The <code>checkpoint()</code> Alternative</h4>
<div class="paragraph">
<p>The debug mode is global and affects every single operator assembled into a <code>Flux</code> or a
<code>Mono</code> inside the application. This has the benefit of allowing after-the-fact
debugging: Whatever the error, we can obtain additional information to debug it.</p>
</div>
<div class="paragraph">
<p>è°è¯æ¨¡å¼æ¯å¨å±çï¼ä¼å½±åç»è£å°åºç¨ç¨åºåé¨Fluxæ Monoåé¨çæ¯ä¸ªæä½åã
è¿æ ·åçå¥½å¤æ¯å¯ä»¥è¿è¡äºåè°è¯ï¼æ è®ºåçä»ä¹éè¯¯ï¼æä»¬é½å¯ä»¥è·åå¶ä»ä¿¡æ¯æ¥å¯¹å¶è¿è¡è°è¯ã</p>
</div>
<div class="paragraph">
<p>As we saw earlier, this global knowledge comes at the cost of an impact on performance
(due to the number of populated stack traces). That cost can be reduced if we have an
idea of likely problematic operators. However, we usually do not know which operators are
likely to be problematic unless we observed an error in the wild, saw we were missing
assembly information, and then modified the code to activate assembly tracking, hoping to
observe the same error again.</p>
</div>
<div class="paragraph">
<p>æ­£å¦æä»¬åé¢æçå°çï¼è¿ç§å¨å±æ§ç¥è¯æ¯ä»¥å½±åæ§è½ä¸ºä»£ä»·çï¼ç±äºå¡«åçå æ è·è¸ªçæ°éï¼ãå¦ææä»¬ç¥éæé®é¢çæä½ç¬¦ï¼æå¯è½éä½æ¶èææ¬ã
ä½æ¯ï¼éå¸¸æä»¬ä¸ç¥éåªä¸ªè¿ç®ç¬¦å¯è½æé®é¢ï¼é¤éæä»¬å¨éå¤è§å¯å°éè¯¯ï¼çå°æä»¬ç¼ºå°ç¨åºéä¿¡æ¯ï¼ç¶åä¿®æ¹ä»£ç ä»¥æ¿æ´»ç¨åºéè·è¸ªï¼å¸æåæ¬¡è§å¯å°ç¸åçéè¯¯ã</p>
</div>
<div class="paragraph">
<p>In that scenario, we have to switch into debugging mode and make preparations in order to
better observe a second occurrence of the error, this time capturing all the additional
information.</p>
</div>
<div class="paragraph">
<p>å¨è¿ç§æåµä¸ï¼æä»¬å¿é¡»åæ¢å°è°è¯æ¨¡å¼å¹¶è¿è¡åå¤ï¼ä»¥ä¾¿æ´å¥½å°è§å¯ç¬¬äºæ¬¡åºç°éè¯¯ï¼è¿æ¬¡æè·äºææå¶ä»ä¿¡æ¯ã</p>
</div>
<div class="paragraph">
<p>If you can identify reactive chains that you assemble in your application for which
serviceability is critical, you can achieve a mix of both techniques with the
<code>checkpoint()</code> operator.</p>
</div>
<div class="paragraph">
<p>å¦ææ¨å¯ä»¥ç¡®å®å¨åºç¨ç¨åºä¸­ç»è£çå¯¹å¯ç»´æ¤æ§è³å³éè¦çååºå¼é¾ï¼åå¯ä»¥ä¸checkpoint()æä½åä¸èµ·å®ç°è¿ä¸¤ç§ææ¯çæ··å ã</p>
</div>
<div class="paragraph">
<p>You can chain this operator into a method chain. The <code>checkpoint</code> operator works like the
hook version but only for its link of that particular chain.</p>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥å°æ­¤è¿ç®ç¬¦é¾æ¥å°æ¹æ³é¾ä¸­ãè¯¥checkpointè¿ç®ç¬¦çå·¥ä½æ¹å¼ç±»ä¼¼äºé©çæ¬ï¼ä½ä»éå¯¹å¶ç¹å®é¾çé¾æ¥</p>
</div>
<div class="paragraph">
<p>There is also a <code>checkpoint(String)</code> variant that lets you add a unique <code>String</code> identifier
to the assembly traceback. This way, the stack trace is omitted and you rely on the
description to identify the assembly site. <code>checkpoint(String)</code> imposes less processing
cost than a regular <code>checkpoint</code>.</p>
</div>
<div class="paragraph">
<p>è¿æä¸ä¸ªcheckpoint(String)åä½ï¼å¯è®©æ¨Stringåç¨åºéè¿½æº¯æ·»å å¯ä¸æ è¯ç¬¦ã
è¿æ ·ï¼å°å¿½ç¥å æ è·è¸ªï¼èæ¨ä¾é æè¿°æ¥æ è¯ç»è£ä½ç½®ãcheckpoint(String)æ¯æ®éçcheckpointå¤çææ¬æ´ä½ã</p>
</div>
<div class="paragraph">
<p><code>checkpoint(String)</code> includes &#8220;light&#8221; in its output (which can be handy when
searching), as shown in the following example:</p>
</div>
<div class="paragraph">
<p>checkpoint(String) å¨å¶è¾åºä¸­åæ¬âlightâï¼å¨æç´¢æ¶å¯ä»¥æ¹ä¾¿ä½¿ç¨ï¼ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>...
	Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException:
Assembly site of producer [reactor.core.publisher.ParallelSource] is identified by light checkpoint [light checkpoint identifier].</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Last but not least, if you want to add a more generic description to the checkpoint but
still rely on the stack trace mechanism to identify the assembly site, you can force that
behavior by using the <code>checkpoint("description", true)</code> version. We are now back to the
initial message for the traceback, augmented with a <code>description</code>, as shown in the
following example:</p>
</div>
<div class="paragraph">
<p>æåä½å¹¶éæä¸éè¦çä¸ç¹æ¯ï¼å¦ææ¨æ³åæ£æ¥ç¹æ·»å æ´éç¨çæè¿°ï¼ä½ä»ä¾é å æ è·è¸ªæºå¶æ¥æ è¯ç»è£ç«ç¹ï¼åå¯ä»¥éè¿ä½¿ç¨checkpoint("description", true)çæ¬æ¥å¼ºå¶æ§è¡è¯¥è¡ä¸ºã
ç°å¨ï¼æä»¬è¿åå°ç¨äºè¿½æº¯çåå§æ¶æ¯ï¼å¹¶ä»¥è¿è¡äºæ©å±descriptionï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Assembly trace from producer [reactor.core.publisher.ParallelSource], described as [descriptionCorrelation1234] : <i class="conum" data-value="1"></i><b>(1)</b>
	reactor.core.publisher.ParallelFlux.checkpoint(ParallelFlux.java:215)
	reactor.core.publisher.FluxOnAssemblyTest.parallelFluxCheckpointDescriptionAndForceStack(FluxOnAssemblyTest.java:225)
Error has been observed by the following operator(s):
	|_	ParallelFlux.checkpoint â¢ reactor.core.publisher.FluxOnAssemblyTest.parallelFluxCheckpointDescriptionAndForceStack(FluxOnAssemblyTest.java:225)</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>descriptionCorrelation1234</code> is the description provided in the <code>checkpoint</code>. 	descriptionCorrelation1234æ¯ä¸­æä¾çè¯´æcheckpointã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The description could be a static identifier or user-readable description or a wider
correlation ID (for instance, coming from a header in the case of an HTTP request).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When both global debugging and local <code>checkpoint()</code> are enabled, checkpointed
snapshot stacks are appended as suppressed error output after the observing operator
graph and following the same declarative order.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactor-tools-debug"><a class="anchor" href="#reactor-tools-debug"></a>7.4. Production-ready Global Debugging</h3>
<div class="paragraph">
<p>Project Reactor comes with a separate Java Agent that instruments your code and adds
debugging info without paying the cost of capturing the stacktrace on every operator call.
The behaviour is very similar to <a href="#debug-activate">Activating Debug Mode - aka tracebacks</a>, but without the runtime performance overhead.</p>
</div>
<div class="paragraph">
<p>Project Reactorå¸¦æä¸ä¸ªåç¬çJavaä»£çï¼å¯å¯¹æ¨çä»£ç è¿è¡æ£æµå¹¶æ·»å è°è¯ä¿¡æ¯ï¼èæ éè¯è´¹æ¯æ¬¡æä½è°ç¨æ¶æè·stacktraceçæ¶èã
è¯¥è¡ä¸ºä¸ <a href="#debug-activate">Activating Debug Mode - aka tracebacks</a>ï¼ä¹ç§°ä¸ºåæº¯ï¼éå¸¸ç¸ä¼¼ï¼ä½æ²¡æè¿è¡æ¶æ§è½å¼éã</p>
</div>
<div class="paragraph">
<p>To use it in your app, you must add it as a dependency.</p>
</div>
<div class="paragraph">
<p>è¦å¨æ¨çåºç¨ç¨åºä¸­ä½¿ç¨å®ï¼å¿é¡»å°å¶æ·»å ä¸ºä¾èµé¡¹ã</p>
</div>
<div class="paragraph">
<p>The following example shows how to add <code>reactor-tools</code> as a dependency in Maven:</p>
</div>
<div class="paragraph">
<p>ä¸é¢çç¤ºä¾æ¾ç¤ºå¦ä½reactor-toolså¨Mavenä¸­æ·»å ä¸ºä¾èµé¡¹ï¼</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. reactor-tools in Maven, in <code>&lt;dependencies&gt;</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
    &lt;artifactId&gt;reactor-tools&lt;/artifactId&gt;
    <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If you use the <a href="#getting">BOM</a>, you do not need to specify a <code>&lt;version&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to add <code>reactor-tools</code> as a dependency in Gradle:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. reactor-tools in Gradle, amend the <code>dependencies</code> block</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
   compile 'io.projectreactor:reactor-tools'
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It also needs to be explicitly initialized with:</p>
</div>
<div class="paragraph">
<p>è¿éè¦ä½¿ç¨ä»¥ä¸å½ä»¤æ¾å¼åå§åå®ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReactorDebugAgent.init();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since the implementation will instrument your classes when they are loaded,
the best place to put it is before everything else in your main(String[]) methood:
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ç±äºè¯¥å®ç°å°å¨å è½½ç±»æ¶å¯¹å®ä»¬è¿è¡æ£æµï¼å æ­¤æ¾ç½®å®çæä½³ä½ç½®æ¯å¨mainï¼String []ï¼æ¹æ³ä¸­çææå¶ä»åå®¹ä¹åï¼
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void main(String[] args) {
    ReactorDebugAgent.init();
    SpringApplication.run(Application.class, args);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You may also re-process existing classes if you cannot run the init eagerly (e.g. in the tests):</p>
</div>
<div class="paragraph">
<p>å¦ææ¨ä¸è½æ¥äºè¿è¡initï¼ä¾å¦å¨æµè¯ä¸­ï¼ï¼ä¹å¯ä»¥éæ°å¤çç°æçç±»ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReactorDebugAgent.init();
ReactorDebugAgent.processExistingClasses();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Be aware that the re-processing takes a couple of seconds due to the need to iterate over
all loaded classes and apply the transformation.
Use it only if you see that some call-sites are not instrumented.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
è¯·æ³¨æï¼ç±äºéè¦éåææå·²å è½½çç±»å¹¶åºç¨è½¬æ¢ï¼å æ­¤éæ°å¤çéè¦è±è´¹å ç§éçæ¶é´ãä»å½çå°æäºå¼å«ç«ç¹æ²¡ææ£æµå°æ¶ï¼æä½¿ç¨å®ã
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_limitations"><a class="anchor" href="#_limitations"></a>7.4.1. Limitations</h4>
<div class="paragraph">
<p><code>ReactorDebugAgent</code> is implemented as a Java Agent and uses <a href="https://bytebuddy.net/#/">ByteBuddy</a>
to perform the self-attach.
Self-attach may not work on some JVMs, please refer to ByteBuddy&#8217;s documentation for more details.</p>
</div>
<div class="paragraph">
<p>ReactorDebugAgentä½ä¸ºJavaä»£çå®ç°ï¼å¹¶ä½¿ç¨ByteBuddy è¿è¡èªæéå ãèªè¿æ¥å¯è½ä¸éç¨äºæäºJVMï¼è¯·åéByteBuddyçææ¡£ä»¥è·åæ´å¤è¯¦ç»ä¿¡æ¯ã</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_a_sequence"><a class="anchor" href="#_logging_a_sequence"></a>7.5. Logging a Sequence</h3>
<div class="paragraph">
<p>In addition to stack trace debugging and analysis, another powerful tool to have in your
toolkit is the ability to trace and log events in an asynchronous sequence.</p>
</div>
<div class="paragraph">
<p>é¤äºå æ è·è¸ªè°è¯ååæä¹å¤ï¼å·¥å·åä¸­å¦ä¸ä¸ªå¼ºå¤§çå·¥å·æ¯è½å¤ä»¥å¼æ­¥é¡ºåºè·è¸ªåè®°å½äºä»¶ã</p>
</div>
<div class="paragraph">
<p>The <code>log()</code> operator can do just that. Chained inside a sequence, it peeks at every
event of the <code>Flux</code> or <code>Mono</code> upstream of it (including <code>onNext</code>, <code>onError</code>, and
<code>onComplete</code> as well as subscriptions, cancellations, and requests).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>log()æä½ç¬¦å¯ä»¥åå°è¿ä¸ç¹ãåºååé¨é¾çï¼å®å¨å·çª¥çæ¯ä¸ªå¨FluxæMonoäºä»¶ä¸æ¸¸çäºä»¶ï¼åæ¬onNextï¼onErrorï¼å onCompleteä»¥åè®¢éï¼åæ¶åè¯·æ±ï¼ã</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A note on logging implementation</div>
<div class="paragraph">
<p>The <code>log</code> operator uses the <code>Loggers</code> utility class, which picks up common logging
frameworks such as Log4J and Logback through <code>SLF4J</code> and defaults to logging to the
console if SLF4J is unavailable.</p>
</div>
<div class="paragraph">
<p>è¿ä¸ªlogæä½èä½¿ç¨Loggerså·¥å·ç±»ï¼å¶æ¾åéè¿å±åæ¥å¿æ¡æ¶å¦Log4Jçåçlogback SLF4Jï¼ç¼ºçå¼ä¸ºç»å½å°æ§å¶å°å¦æSLF4Jä¸å¯ç¨ã</p>
</div>
<div class="paragraph">
<p>The console fallback uses <code>System.err</code> for the <code>WARN</code> and <code>ERROR</code> log levels and
<code>System.out</code> for everything else.</p>
</div>
<div class="paragraph">
<p>æ§å¶å°åè°System.errç¨äºWARNåERRORæ¥å¿çº§å«ä»¥å System.outå¶ä»æææåµã</p>
</div>
<div class="paragraph">
<p>If you prefer a JDK <code>java.util.logging</code> fallback, as in 3.0.x, you can get it by setting
the <code>reactor.logging.fallback</code> system property to <code>JDK</code>.</p>
</div>
<div class="paragraph">
<p>å¦ææ¨åæ¬¢java.util.loggingå¨JDK3.0.xä¸­ä½¿ç¨ï¼åå¯ä»¥éè¿å°reactor.logging.fallbacksy JDK stemå±æ§è®¾ç½®ä¸ºæ¥è·å¾å®ã</p>
</div>
<div class="paragraph">
<p>In all cases, when logging in production <strong>you should take care to configure the
underlying logging framework to use its most asynchronous and non-blocking approach</strong>&#8201;&#8212;&#8201;for instance, an <code>AsyncAppender</code> in Logback or <code>AsyncLogger</code> in Log4j 2.</p>
</div>
<div class="paragraph">
<p>å¨æææåµä¸ï¼å¨çäº§ç¯å¢ä¸­ç»å½æ¶ï¼é½åºè°¨æéç½®åºå±æ¥å¿è®°å½æ¡æ¶ï¼ä»¥ä½¿ç¨å¶æå¼æ­¥åéé»å¡çæ¹æ³ âï¼
ä¾å¦ï¼AsyncAppenderå¨Logback æ AsyncLogger å¨ Log4j2ä¸­ã</p>
</div>
</div>
</div>
<div class="paragraph">
<p>For instance, suppose we have Logback activated and configured and a chain like
<code>range(1,10).take(3)</code>. By placing a <code>log()</code> before the <code>take</code>, we can get some
insight into how it works and what kind of events it propagates upstream to the range,
as the following example shows:</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼åè®¾æä»¬å·²æ¿æ´»å¹¶éç½®äºLogbackä»¥åç±»ä¼¼çé¾ range(1,10).take(3)ã
éè¿å¨takeä¹åæ¾ç½®log()ï¼æä»¬å¯ä»¥æ·±å¥äºè§£å¶å·¥ä½åçä»¥åå®å°åä¸æ¸¸ä¼ æ­å°èå´çäºä»¶çç§ç±»ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; flux = Flux.range(1, 10)
                         .log()
                         .take(3);
flux.subscribe();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This prints out the following (through the logger&#8217;s console appender):</p>
</div>
<div class="paragraph">
<p>è¿å°æå°åºä»¥ä¸åå®¹ï¼éè¿è®°å½å¨çæ§å¶å°éå ï¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>10:45:20.200 [main] INFO  reactor.Flux.Range.1 - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription) <i class="conum" data-value="1"></i><b>(1)</b>
10:45:20.205 [main] INFO  reactor.Flux.Range.1 - | request(unbounded) <i class="conum" data-value="2"></i><b>(2)</b>
10:45:20.205 [main] INFO  reactor.Flux.Range.1 - | onNext(1) <i class="conum" data-value="3"></i><b>(3)</b>
10:45:20.205 [main] INFO  reactor.Flux.Range.1 - | onNext(2)
10:45:20.205 [main] INFO  reactor.Flux.Range.1 - | onNext(3)
10:45:20.205 [main] INFO  reactor.Flux.Range.1 - | cancel() <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="paragraph">
<p>Here, in addition to the logger&#8217;s own formatter (time, thread, level, message), the
<code>log()</code> operator outputs a few things in its own format:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>reactor.Flux.Range.1</code> is an automatic category for the log, in case you use the
operator several times in a chain. It lets you distinguish which operator&#8217;s events
are logged (in this case, the <code>range</code>). You can overwrite the identifier with your own
custom category by using the <code>log(String)</code> method signature. After a few separating
characters, the actual event gets printed. Here, we get an <code>onSubscribe</code> call, a
<code>request</code> call, three <code>onNext</code> calls, and a <code>cancel</code> call. For the first line,
<code>onSubscribe</code>, we get the implementation of the <code>Subscriber</code>, which usually corresponds
to the operator-specific implementation. Between square brackets, we get additional
information, including whether the operator can be automatically optimized through
synchronous or asynchronous fusion.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On the second line, we can see that an unbounded request was propagated up from
downstream.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then the range sends three values in a row.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>On the last line, we see <code>cancel()</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The last line, (4), is the most interesting. We can see the <code>take</code> in action there. It
operates by cutting the sequence short after it has seen enough elements emitted. In
short, <code>take()</code> causes the source to <code>cancel()</code> once it has emitted the user-requested
amount.</p>
</div>
<div class="paragraph">
<p>æåä¸è¡ï¼4ï¼æ¯ææè¶£çãæä»¬å¯ä»¥takeå¨é£éçå°å®éçææã
å¨çå°è¶³å¤å¤çåç´ åå°ä¹åï¼å®ä¼éè¿ç¼©ç­åºåæ¥è¿è¡æä½ãç®èè¨ä¹ï¼take()ä½¿æºè½¬åä¸ºcancel()çåå æ¯è®©æºåéå®ä¸æ¬¡ç¨æ·è¯·æ±çæ°éã</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/debugging.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#debugging">Debugging Reactor</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="metrics"><a class="anchor" href="#metrics"></a>8. Exposing Reactor metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Project Reactor is a library designed for performance and better utilization of resources.
But to truly understand the performance of a system, it is best to be able to monitor its various components.</p>
</div>
<div class="paragraph">
<p>This is why Reactor provides a built-in integration with <a href="https://micrometer.io">Micrometer</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If Micrometer is not on the classpath, metrics will be a no-op.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_scheduler_metrics"><a class="anchor" href="#_scheduler_metrics"></a>8.1. Scheduler metrics</h3>
<div class="paragraph">
<p>Every async operation in Reactor is done via the Scheduler abstraction described in <a href="#schedulers">Threading and Schedulers</a>.
This is why it is important to monitor your schedulers, watch out for key metrics that start to look suspicious and react accordingly.</p>
</div>
<div class="paragraph">
<p>To enable scheduler metrics, you will need to use the following method:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Schedulers.enableMetrics();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The instrumentation is performed when a scheduler is created. It is recommended to call this method as early as possible.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you&#8217;re using Spring Boot, it is a good idea to place the invocation before <code>SpringApplication.run(Application.class, args)</code> call.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once scheduler metrics are enabled and provided it is on the classpath, Reactor will use Micrometer&#8217;s support for instrumenting the executors that back most schedulers.</p>
</div>
<div class="paragraph">
<p>Please refer to <a href="http://micrometer.io/docs/ref/jvm">Micrometer&#8217;s documentation</a> for the exposed metrics, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>executor_active_threads</p>
</li>
<li>
<p>executor_completed_tasks_total</p>
</li>
<li>
<p>executor_pool_size_threads</p>
</li>
<li>
<p>executor_queued_tasks</p>
</li>
<li>
<p>executor_secounds_{count, max, sum}</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since one scheduler may have multiple executors, every executor metric has a <code>reactor_scheduler_id</code> tag.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Grafana + Prometheus users can use <a href="https://raw.githubusercontent.com/reactor/reactor-monitoring-demo/master/dashboards/schedulers.json">a pre-built dashboard</a> which includes panels for threads, completed tasks, task queues and other handy metrics.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_publisher_metrics"><a class="anchor" href="#_publisher_metrics"></a>8.2. Publisher metrics</h3>
<div class="paragraph">
<p>Sometimes it is useful to be able to record metrics at some stage in your reactive pipeline.</p>
</div>
<div class="paragraph">
<p>One way to do it would be to manually push the values to your metrics backend of choice.
Another option would be to use Reactor&#8217;s built-in metrics integration for <code>Flux</code>/<code>Mono</code> and interpret them.</p>
</div>
<div class="paragraph">
<p>Consider the following pipeline:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">listenToEvents()
    .doOnNext(event -&gt; log.info("Received {}", event))
    .delayUntil(this::processEvent)
    .retry()
    .subscribe();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To enable the metrics for this source <code>Flux</code> (returned from <code>listenToEvents()</code>), we need to give it a name and turn on the metrics collecting:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">listenToEvents()
    .name("events") <i class="conum" data-value="1"></i><b>(1)</b>
    .metrics() <i class="conum" data-value="2"></i><b>(2)</b>
    .doOnNext(event -&gt; log.info("Received {}", event))
    .delayUntil(this::processEvent)
    .retry()
    .subscribe();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Every metric at this stage will be identified as "events".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Flux#metrics</code> operator enables the reporting of metrics and uses the last known name up in the pipeline.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Just adding these two operators will expose a whole bunch of useful metrics!</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">metric name</th>
<th class="tableblock halign-left valign-top">type</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reactor.subscribed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts how many Reactor sequences have been subscribed to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reactor.malformed.source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of events received from a malformed source (ie an onNext after an onComplete)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reactor.requested</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DistributionSummary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the amount requested to a named Flux by all subscribers, until at least one requests an unbounded amount</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reactor.onNext.delay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Measures delays between onNext signals (or between onSubscribe and first onNext)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reactor.flow.duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Times the duration elapsed between a subscription and the termination or cancellation of the sequence. A status tag is added to specify what event caused the timer to end (<code>onComplete</code>, <code>onError</code>, <code>cancel</code>).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Want to know how many times your event processing has restarted due to some error? Read <code>reactor.subscribed</code>, because <code>retry()</code> operator will re-subscribe to the source publisher on error.</p>
</div>
<div class="paragraph">
<p>Interested in "events per second" metric? Measure the rate of <code>reactor.onNext.delay</code> 's count.</p>
</div>
<div class="paragraph">
<p>Want to be alerted when the listener throws an error? <code>reactor.flow.duration</code> with <code>status=error</code> tag is your friend.</p>
</div>
<div class="sect3">
<h4 id="_common_tags"><a class="anchor" href="#_common_tags"></a>8.2.1. Common tags</h4>
<div class="paragraph">
<p>Every metric will have the following tags in common:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">tag name</th>
<th class="tableblock halign-left valign-top">description</th>
<th class="tableblock halign-left valign-top">example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Publisher&#8217;s type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mono"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">current flow&#8217;s name, set by <code>.name()</code> operator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"events"</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_custom_tags"><a class="anchor" href="#_custom_tags"></a>8.2.2. Custom tags</h4>
<div class="paragraph">
<p>Users are allowed to add custom tags to their reactive chains:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">listenToEvents()
    .tag("source", "kafka") <i class="conum" data-value="1"></i><b>(1)</b>
    .name("events")
    .metrics() <i class="conum" data-value="2"></i><b>(2)</b>
    .doOnNext(event -&gt; log.info("Received {}", event))
    .delayUntil(this::processEvent)
    .retry()
    .subscribe();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a custom tag "source" to value "kafka".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All reported metrics will have <code>source=kafka</code> tag assigned in addition to the common tags described above.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/metrics.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#metrics">Exposing Reactor metrics</a>"</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced"><a class="anchor" href="#advanced"></a>9. Advanced Features and Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter covers advanced features and concepts of Reactor, including the following:</p>
</div>
<div class="paragraph">
<p>æ¬ç« ä»ç»äºReactorçé«çº§åè½åæ¦å¿µï¼å¶ä¸­åæ¬ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#advanced-mutualizing-operator-usage">Mutualizing Operator Usage</a></p>
</li>
<li>
<p><a href="#reactor.hotCold">Hot Versus Cold</a></p>
</li>
<li>
<p><a href="#advanced-broadcast-multiple-subscribers-connectableflux">Broadcasting to Multiple Subscribers with <code>ConnectableFlux</code></a></p>
</li>
<li>
<p><a href="#advanced-three-sorts-batching">Three Sorts of Batching</a></p>
</li>
<li>
<p><a href="#advanced-parallelizing-parralelflux">Parallelizing Work with <code>ParallelFlux</code></a></p>
</li>
<li>
<p><a href="#scheduler-factory">Replacing Default <code>Schedulers</code></a></p>
</li>
<li>
<p><a href="#hooks">Using Global Hooks</a></p>
</li>
<li>
<p><a href="#context">Adding a Context to a Reactive Sequence</a></p>
</li>
<li>
<p><a href="#null-safety">Null Safety</a></p>
</li>
<li>
<p><a href="#cleanup">Dealing with Objects that Need Cleanup</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="advanced-mutualizing-operator-usage"><a class="anchor" href="#advanced-mutualizing-operator-usage"></a>9.1. Mutualizing Operator Usage</h3>
<div class="paragraph">
<p>From a clean-code perspective, code reuse is generally a good thing. Reactor offers a few
patterns that can help you reuse and mutualize code, notably for operators or combinations
of operators that you might want to apply regularly in your codebase. If you think of a
chain of operators as a recipe, you can create a &#8220;cookbook&#8221; of operator recipes.</p>
</div>
<div class="paragraph">
<p>ä»å¹²åä»£ç çè§åº¦æ¥çï¼ä»£ç éç¨éå¸¸æ¯ä¸ä»¶å¥½äºãReactoræä¾äºä¸äºæ¨¡å¼ï¼å¯ä»¥å¸®å©æ¨éç¨åäºç¨ä»£ç ï¼ç¹å«æ¯å¯¹äºæ¨å¯è½å¸æå¨ä»£ç åºä¸­å®æåºç¨çè¿ç®ç¬¦æè¿ç®ç¬¦ç»åã
å¦ææ¨å°ä¸è¿ä¸²çæä½ç¬¦è§ä¸ºéæ¹ï¼åå¯ä»¥åå»ºä¸ä¸ªâèè°±âæä½ç¬¦éæ¹ã</p>
</div>
<div class="sect3">
<h4 id="_using_the_transform_operator"><a class="anchor" href="#_using_the_transform_operator"></a>9.1.1. Using the <code>transform</code> Operator</h4>
<div class="paragraph">
<p>The <code>transform</code> operator lets you encapsulate a piece of an operator chain into a
function. That function is applied to an original operator chain at assembly time to
augment it with the encapsulated operators. Doing so applies the same operations to all
the subscribers of a sequence and is basically equivalent to chaining the operators
directly. The following code shows an example:</p>
</div>
<div class="paragraph">
<p>è¿ä¸ªtransformæä½å¯è®©æ¨å°è£äºä¸åæä½é¾æä¸ä¸ªå½æ°ãè¯¥åè½å¨ç»è£æ¶åºç¨äºåå§è¿ç®ç¬¦é¾ï¼ä»¥ä½¿ç¨å°è£çè¿ç®ç¬¦è¿è¡æ©åãè¿æ ·åä¼å°ç¸åçæä½åºç¨äºåºåçææè®¢æ·ï¼å¹¶ä¸åºæ¬ä¸ç­æäºç´æ¥é¾æ¥è¿ç®ç¬¦ãä»¥ä¸ä»£ç æ¾ç¤ºäºä¸ä¸ªç¤ºä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Function&lt;Flux&lt;String&gt;, Flux&lt;String&gt;&gt; filterAndMap =
f -&gt; f.filter(color -&gt; !color.equals("orange"))
      .map(String::toUpperCase);

Flux.fromIterable(Arrays.asList("blue", "green", "orange", "purple"))
	.doOnNext(System.out::println)
	.transform(filterAndMap)
	.subscribe(d -&gt; System.out.println("Subscriber to Transformed MapAndFilter: "+d));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following image shows how the <code>transform</code> operator encapsulates flows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/gs-transform.png" alt="Transform Operator : encapsulate flows">
</div>
</div>
<div class="paragraph">
<p>The preceding example produces the following output:</p>
</div>
<div class="paragraph">
<p>åé¢çç¤ºä¾äº§çä»¥ä¸è¾åºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>blue
Subscriber to Transformed MapAndFilter: BLUE
green
Subscriber to Transformed MapAndFilter: GREEN
orange
purple
Subscriber to Transformed MapAndFilter: PURPLE</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_transformdeferred_operator"><a class="anchor" href="#_using_the_transformdeferred_operator"></a>9.1.2. Using the <code>transformDeferred</code> Operator</h4>
<div class="paragraph">
<p>The <code>transformDeferred</code> operator is similar to <code>transform</code> and also lets you encapsulate operators
in a function. The major difference is that this function is applied to the original
sequence <em>on a per-subscriber basis</em>. It means that the function can actually produce a
different operator chain for each subscription (by maintaining some state). The
following code shows an example:</p>
</div>
<div class="paragraph">
<p>transformDeferredè¿ç®ç¬¦ä¸transformç±»ä¼¼ï¼èä¸ä¹å¯ä»¥è®©ä½ å¨ä¸ä¸ªå½æ°åå°è£è¿ç®ç¬¦ãä¸»è¦åºå«å¨äºï¼æ­¤åè½ææ¯ä¸ªè®¢éèåºç¨äºåå§åºåã
è¿æå³çè¯¥å½æ°å®éä¸å¯ä»¥ä¸ºæ¯ä¸ªè®¢éèçæä¸ä¸ªä¸åçè¿ç®ç¬¦é¾ï¼éè¿ç»´æ¤æç§ç¶æï¼ãä»¥ä¸ä»£ç æ¾ç¤ºäºä¸ä¸ªç¤ºä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AtomicInteger ai = new AtomicInteger();
Function&lt;Flux&lt;String&gt;, Flux&lt;String&gt;&gt; filterAndMap = f -&gt; {
	if (ai.incrementAndGet() == 1) {
return f.filter(color -&gt; !color.equals("orange"))
        .map(String::toUpperCase);
	}
	return f.filter(color -&gt; !color.equals("purple"))
	        .map(String::toUpperCase);
};

Flux&lt;String&gt; composedFlux =
Flux.fromIterable(Arrays.asList("blue", "green", "orange", "purple"))
    .doOnNext(System.out::println)
    .transformDeferred(filterAndMap);

composedFlux.subscribe(d -&gt; System.out.println("Subscriber 1 to Composed MapAndFilter :"+d));
composedFlux.subscribe(d -&gt; System.out.println("Subscriber 2 to Composed MapAndFilter: "+d));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following image shows how the <code>transformDeferred</code> operator works with per-subscriber transformations:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/gs-compose.png" alt="Compose Operator : Per Subscriber transformation">
</div>
</div>
<div class="paragraph">
<p>The preceding example produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>blue
Subscriber 1 to Composed MapAndFilter :BLUE
green
Subscriber 1 to Composed MapAndFilter :GREEN
orange
purple
Subscriber 1 to Composed MapAndFilter :PURPLE
blue
Subscriber 2 to Composed MapAndFilter: BLUE
green
Subscriber 2 to Composed MapAndFilter: GREEN
orange
Subscriber 2 to Composed MapAndFilter: ORANGE
purple</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactor.hotCold"><a class="anchor" href="#reactor.hotCold"></a>9.2. Hot Versus Cold</h3>
<div class="paragraph">
<p>So far, we have considered that all <code>Flux</code> (and <code>Mono</code>) are the same: They all represent
an asynchronous sequence of data, and nothing happens before you subscribe.</p>
</div>
<div class="paragraph">
<p>å°ç®åä¸ºæ­¢ï¼æä»¬å·²ç»èèå°ææFluxï¼åMonoï¼é½æ¯ç¸åçï¼å®ä»¬é½ä»£è¡¨å¼æ­¥çæ°æ®åºåï¼å¨æ¨è®¢éä¹åä»ä¹ä¹æ²¡æåçã</p>
</div>
<div class="paragraph">
<p>Really, though, there are two broad families of publishers: hot and cold.</p>
</div>
<div class="paragraph">
<p>ä¸è¿ï¼å®éä¸ï¼æä¸¤ä¸ªå¹¿æ³çåå¸èå®¶æï¼ç­é¨åå·é¨ã</p>
</div>
<div class="paragraph">
<p>The earlier description applies to the cold family of publishers. They generate data anew
for each subscription. If no subscription is created, data never gets generated.</p>
</div>
<div class="paragraph">
<p>è¾æ©çæè¿°éç¨äºå·é¨çåå¸èç³»åãå®ä»¬ä¸ºæ¯ä¸ªè®¢ééæ°çææ°æ®ãå¦ææ²¡æåå»ºè®¢éï¼åæ°¸è¿ä¸ä¼çææ°æ®ã</p>
</div>
<div class="paragraph">
<p>Think of an HTTP request: Each new subscriber triggers an HTTP call, but no call is
made if no one is interested in the result.</p>
</div>
<div class="paragraph">
<p>èèä¸ä¸HTTPè¯·æ±ï¼æ¯ä¸ªæ°è®¢æ·é½ä¼è§¦åHTTPè°ç¨ï¼ä½æ¯å¦ææ²¡æäººå¯¹ç»ææå´è¶£ï¼åä¸ä¼è¿è¡ä»»ä½è°ç¨ã</p>
</div>
<div class="paragraph">
<p>Hot publishers, on the other hand, do not depend on any number of subscribers. They
might start publishing data right away and would continue doing so whenever a new
<code>Subscriber</code> comes in (in which case, the subscriber would see only new elements emitted
<em>after</em> it subscribed). For hot publishers, <em>something</em> does indeed happen before you
subscribe.</p>
</div>
<div class="paragraph">
<p>å¦ä¸æ¹é¢ï¼ç­é¨åå¸èä¸ä¾èµä»»ä½æ°éçè®¢éèãä»ä»¬å¯è½ä¼å¼å§åå¸æ°æ®çæ¶åäºï¼å¹¶ä¼ç»§ç»­è¿æ ·åï¼æ¯å½ææ° Subscriberè¿æ¥ï¼å¨è¿ç§æåµä¸ï¼ç¨æ·ä¼çå°å¶é¢çº¦ååå°çæ°åç´ ï¼ã
å¯¹äºç­é¨åå¸èï¼å¨æ¨è®¢éä¹åç¡®å®åçäºæäºäºæã</p>
</div>
<div class="paragraph">
<p>One example of the few hot operators in Reactor is <code>just</code>: It directly captures the value
at assembly time and replays it to anybody subscribing to it later. To re-use the HTTP
call analogy, if the captured data is the result of an HTTP call, then only one network
call is made, when instantiating <code>just</code>.</p>
</div>
<div class="paragraph">
<p>å¨Reactorä¸­ä¸ºæ°ä¸å¤çç­é¨è¿ç®ç¬¦çä¸ä¸ªç¤ºä¾æ¯justï¼å®ç´æ¥å¨æ±ç¼æ¶æè·å¼ï¼ç¶åå°å¶éæ­ç»ä»¥åè®¢éè¯¥å¼çä»»ä½äººã
ä¸ºäºéç¨HTTPè°ç¨ç±»æ¯ï¼å¦ææè·çæ°æ®æ¯HTTPè°ç¨çç»æï¼åå¨å®ä¾åæ¶ä»è¿è¡ä¸ä¸ªç½ç»è°ç¨justã</p>
</div>
<div class="paragraph">
<p>To transform <code>just</code> into a cold publisher, you can use <code>defer</code>. It defers the HTTP
request in our example to subscription time (and would result in a separate network call
for each new subscription).</p>
</div>
<div class="paragraph">
<p>è¦è½¬åjustä¸ºå·åè¡åï¼æ¨å¯ä»¥ä½¿ç¨deferãå®å¨æä»¬çç¤ºä¾ä¸­å°HTTPè¯·æ±å»¶è¿äºè®¢éæ¶é´ï¼å¹¶ä¼ä¸ºæ¯ä¸ªæ°è®¢éå¯¼è´åç¬çç½ç»è°ç¨ï¼ã</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most other hot publishers in Reactor extend <code>Processor</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reactorä¸­çå¤§å¤æ°å¶ä»ç­é¨åè¡åé½å¨æ©å±Processorã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider two other examples. The following code shows the first example:</p>
</div>
<div class="paragraph">
<p>èèå¦å¤ä¸¤ä¸ªä¾å­ãä»¥ä¸ä»£ç æ¾ç¤ºäºç¬¬ä¸ä¸ªç¤ºä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; source = Flux.fromIterable(Arrays.asList("blue", "green", "orange", "purple"))
                          .map(String::toUpperCase);

source.subscribe(d -&gt; System.out.println("Subscriber 1: "+d));
source.subscribe(d -&gt; System.out.println("Subscriber 2: "+d));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This first example produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Subscriber 1: BLUE
Subscriber 1: GREEN
Subscriber 1: ORANGE
Subscriber 1: PURPLE
Subscriber 2: BLUE
Subscriber 2: GREEN
Subscriber 2: ORANGE
Subscriber 2: PURPLE</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following image shows the replay behavior:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/gs-cold.png" alt="Replaying behavior">
</div>
</div>
<div class="paragraph">
<p>Both subscribers catch all four colors, because each subscriber causes the
process defined by the operators on the <code>Flux</code> to run.</p>
</div>
<div class="paragraph">
<p>ä¸¤ä¸ªè®¢æ·é½æè·å¨é¨åç§é¢è²ï¼å ä¸ºæ¯ä¸ªè®¢æ·é½ä¼å¯¼è´Fluxè¿è¡ç±æä½ç¬¦å®ä¹çè¿ç¨ã</p>
</div>
<div class="paragraph">
<p>Compare the first example to the second example, shown in the following code:</p>
</div>
<div class="paragraph">
<p>å°ç¬¬ä¸ä¸ªç¤ºä¾ä¸ç¬¬äºä¸ªç¤ºä¾è¿è¡æ¯è¾ï¼å¦ä»¥ä¸ä»£ç æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">DirectProcessor&lt;String&gt; hotSource = DirectProcessor.create();

Flux&lt;String&gt; hotFlux = hotSource.map(String::toUpperCase);


hotFlux.subscribe(d -&gt; System.out.println("Subscriber 1 to Hot Source: "+d));

hotSource.onNext("blue");
hotSource.onNext("green");

hotFlux.subscribe(d -&gt; System.out.println("Subscriber 2 to Hot Source: "+d));

hotSource.onNext("orange");
hotSource.onNext("purple");
hotSource.onComplete();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The second example produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Subscriber 1 to Hot Source: BLUE
Subscriber 1 to Hot Source: GREEN
Subscriber 1 to Hot Source: ORANGE
Subscriber 2 to Hot Source: ORANGE
Subscriber 1 to Hot Source: PURPLE
Subscriber 2 to Hot Source: PURPLE</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following image shows how a subscription is broadcast:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/reactor/reactor-core/v3.0.7.RELEASE/src/docs/marble/gs-hot.png" alt="Broadcasting a subscription">
</div>
</div>
<div class="paragraph">
<p>Subscriber 1 catches all four colors. Subscriber 2, having been created after the first
two colors were produced, catches only the last two colors. This difference accounts for
the doubling of <code>ORANGE</code> and <code>PURPLE</code> in the output. The process described by the
operators on this Flux runs regardless of when subscriptions have been attached.</p>
</div>
<div class="paragraph">
<p>è®¢æ·1æè·ææåç§é¢è²ãå¨çæåä¸¤ç§é¢è²ä¹ååå»ºçè®¢æ·2ï¼ä»æè·åä¸¤ç§é¢è²ã
è¿ç§å·®å¼å¯¼è´è¾åºORANGEåçå åPURPLEãæ è®ºä½æ¶éå è®¢éï¼è¿è¥åå¨æ­¤Fluxä¸æè¿°çè¿ç¨é½å°è¿è¡ã</p>
</div>
</div>
<div class="sect2">
<h3 id="advanced-broadcast-multiple-subscribers-connectableflux"><a class="anchor" href="#advanced-broadcast-multiple-subscribers-connectableflux"></a>9.3. Broadcasting to Multiple Subscribers with <code>ConnectableFlux</code></h3>
<div class="paragraph">
<p>Sometimes, you may want to not defer only some processing to the subscription time of one
subscriber, but you might actually want for several of them to rendezvous and then
trigger the subscription and data generation.</p>
</div>
<div class="paragraph">
<p>ææ¶ï¼æ¨å¯è½ä¸å¸æä»å°æäºå¤çæ¨è¿å°ä¸ä¸ªè®¢æ·çè®¢éæ¶é´ï¼ä½å®éä¸æ¨å¯è½å¸æå¶ä¸­çå ä¸ªä¼åï¼ç¶åè§¦åè®¢éåæ°æ®çæã</p>
</div>
<div class="paragraph">
<p>This is what <code>ConnectableFlux</code> is made for. Two main patterns are covered in the <code>Flux</code>
API that return a <code>ConnectableFlux</code>: <code>publish</code> and <code>replay</code>.</p>
</div>
<div class="paragraph">
<p>è¿æ¯ConnectableFluxè½åçãFlux API ä¸­æ¶µçäºä¸¤ä¸ªä¸»è¦æ¨¡å¼ï¼è¿äºæ¨¡å¼è¿åConnectableFluxï¼publishåreplayã</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>publish</code> dynamically tries to respect the demand from its various subscribers, in
terms of backpressure, by forwarding these requests to the source. Most notably, if any
subscriber has a pending demand of <code>0</code>, publish pauses its requesting to the source.</p>
</li>
<li>
<p><code>replay</code> buffers data seen through the first subscription, up to configurable limits
(in time and buffer size). It replays the data to subsequent subscribers.</p>
</li>
<li>
<p>publishéè¿å°è¿äºè¯·æ±è½¬åå°æºï¼å¨æå°å°è¯å¨èåæ¹é¢å°éå¶åä¸ªè®¢æ·çéæ±ãæå¼å¾æ³¨æçæ¯ï¼å¦æä»»ä½è®¢éèçéæ±å¾å®0ï¼åå¸ä¼æåå¶å¯¹æºçè¯·æ±</p>
</li>
<li>
<p>replayç¼å²éè¿ç¬¬ä¸ä¸ªè®¢éèçå°çæ°æ®ï¼ç´è³å¯éç½®çéå¶ï¼æ¶é´åç¼å²åºå¤§å°ï¼ãå®å°æ°æ®éæ¾ç»åç»­çè®¢æ·ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>ConnectableFlux</code> offers additional methods to manage subscriptions downstream
versus subscriptions to the original source. These additional methods include the
following:</p>
</div>
<div class="paragraph">
<p>ConnectableFluxæä¾äºå¶ä»æ¹æ³æ¥ç®¡çä¸æ¸¸è®¢éï¼èä¸æ¯åå§æ¥æºçè®¢éãè¿äºå¶ä»æ¹æ³åæ¬ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connect()</code> can be called manually once you reach enough subscriptions to the <code>Flux</code>. That
triggers the subscription to the upstream source.</p>
</li>
<li>
<p><code>autoConnect(n)</code> can do the same job automatically once <code>n</code> subscriptions have been
made.</p>
</li>
<li>
<p><code>refCount(n)</code> not only automatically tracks incoming subscriptions but also detects
when these subscriptions are cancelled. If not enough subscribers are tracked, the source
is &#8220;disconnected&#8221;, causing a new subscription to the source later if additional
subscribers appear.</p>
</li>
<li>
<p><code>refCount(int, Duration)</code> adds a &#8220;grace period.&#8221; Once the number of tracked subscribers
becomes too low, it waits for the <code>Duration</code> before disconnecting the source, potentially
allowing for enough new subscribers to come in and cross the connection threshold again.</p>
</li>
<li>
<p>connect() åªè¦æ¨è®¢éäºè¶³å¤çè®¢éï¼ä¾¿å¯ä»¥æå¨è°ç¨Fluxãè¿å°è§¦åå¯¹ä¸æ¸¸æºçè®¢éã</p>
</li>
<li>
<p>autoConnect(n) è¿è¡næ¬¡è®¢éåï¼å¯ä»¥èªå¨æ§è¡ç¸åçå·¥ä½ã</p>
</li>
<li>
<p>refCount(n)ä¸ä»ä¼èªå¨è·è¸ªä¼ å¥çè®¢éï¼è¿ä¼æ£æµä½æ¶åæ¶è¿äºè®¢éãå¦æè·è¸ªçè®¢æ·ä¸è¶³ï¼åæºå°âæ­å¼è¿æ¥âï¼å¦æåºç°å¶ä»è®¢æ·ï¼åä¼å¨ä»¥åå¯¼è´å¯¹è¯¥æºçæ°è®¢éã</p>
</li>
<li>
<p>refCount(int, Duration)æ·»å äºâå®½éæâãä¸æ¦è¢«è·è¸ªçè®¢æ·æ°éåå¾å¤ªå°ï¼å®å°Durationå¨æ­å¼æºè¿æ¥ä¹åç­å¾ï¼å¯è½åè®¸è¶³å¤çæ°è®¢æ·è¿å¥å¹¶åæ¬¡è¶è¿è¿æ¥éå¼ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; source = Flux.range(1, 3)
                           .doOnSubscribe(s -&gt; System.out.println("subscribed to source"));

ConnectableFlux&lt;Integer&gt; co = source.publish();

co.subscribe(System.out::println, e -&gt; {}, () -&gt; {});
co.subscribe(System.out::println, e -&gt; {}, () -&gt; {});

System.out.println("done subscribing");
Thread.sleep(500);
System.out.println("will now connect");

co.connect();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>done subscribing
will now connect
subscribed to source
1
1
2
2
3
3</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following code uses <code>autoConnect</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; source = Flux.range(1, 3)
                           .doOnSubscribe(s -&gt; System.out.println("subscribed to source"));

Flux&lt;Integer&gt; autoCo = source.publish().autoConnect(2);

autoCo.subscribe(System.out::println, e -&gt; {}, () -&gt; {});
System.out.println("subscribed first");
Thread.sleep(500);
System.out.println("subscribing second");
autoCo.subscribe(System.out::println, e -&gt; {}, () -&gt; {});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>subscribed first
subscribing second
subscribed to source
1
1
2
2
3
3</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-three-sorts-batching"><a class="anchor" href="#advanced-three-sorts-batching"></a>9.4. Three Sorts of Batching</h3>
<div class="paragraph">
<p>When you have lots of elements and you want to separate them into batches, you have three
broad solutions in Reactor: grouping, windowing, and buffering. These three are
conceptually close, because they redistribute a <code>Flux&lt;T&gt;</code> into an aggregate. Grouping and
windowing create a <code>Flux&lt;Flux&lt;T&gt;&gt;</code>, while buffering aggregates into a <code>Collection&lt;T&gt;</code>.</p>
</div>
<div class="paragraph">
<p>å½æ¨æå¾å¤åç´ å¹¶ä¸æ³è¦å°å®ä»¬åææ¹å¤çæ¶ï¼Reactorä¸­æä¾äºä¸ç§å¹¿æ³çè§£å³æ¹æ¡ï¼åç»ï¼çªå£ååç¼å²ãè¿ä¸ä¸ªå¨æ¦å¿µä¸å¾æ¥è¿ï¼å ä¸ºå®ä»¬å°éæ°åéFlux&lt;T&gt;ä¸ºä¸ä¸ªéåã
åç»åå¼çªåå»ºä¸ä¸ªFlux&lt;Flux&lt;T&gt;&gt;ï¼åæ¶å°èåç¼å²å°ä¸ä¸ªCollection&lt;T&gt;ã</p>
</div>
<div class="sect3">
<h4 id="_grouping_with_fluxgroupedfluxt"><a class="anchor" href="#_grouping_with_fluxgroupedfluxt"></a>9.4.1. Grouping with <code>Flux&lt;GroupedFlux&lt;T&gt;&gt;</code></h4>
<div class="paragraph">
<p>Grouping is the act of splitting the source <code>Flux&lt;T&gt;</code> into multiple batches, each of which
matches a key.</p>
</div>
<div class="paragraph">
<p>åç»æ¯å°æºFlux&lt;T&gt;åæå¤ä¸ªæ¹æ¬¡çæä½ï¼æ¯ä¸ªæ¹æ¬¡ä¸ä¸ä¸ªå¯é¥å¹éã</p>
</div>
<div class="paragraph">
<p>The associated operator is <code>groupBy</code>.</p>
</div>
<div class="paragraph">
<p>å³èçè¿ç®ç¬¦ä¸ºgroupByã</p>
</div>
<div class="paragraph">
<p>Each group is represented as a <code>GroupedFlux&lt;T&gt;</code>, which lets you retrieve the key by calling its
<code>key()</code> method.</p>
</div>
<div class="paragraph">
<p>æ¯ä¸ªç»åä»¥è¡¨ç¤ºGroupedFlux&lt;T&gt;ï¼æ¨å¯ä»¥éè¿è°ç¨å¶key()æ¹æ³æ¥æ£ç´¢å¯é¥ ã</p>
</div>
<div class="paragraph">
<p>There is no necessary continuity in the content of the groups. Once a source element
produces a new key, the group for this key is opened and elements that match the key end
up in the group (several groups could be open at the same time).</p>
</div>
<div class="paragraph">
<p>ç»çåå®¹æ²¡æå¿è¦çè¿ç»­æ§ãä¸æ¦æºåç´ çææ°å¯é¥ï¼å°±ä¼æå¼è¯¥å¯é¥çç»ï¼å¹¶ä¸ä¸è¯¥å¯é¥å¹éçåç´ æç»åºç°å¨è¯¥ç»ä¸­ï¼å¯ä»¥åæ¶æå¼å ä¸ªç»ï¼ã</p>
</div>
<div class="paragraph">
<p>This means that groups:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Are always disjoint (a source element belongs to one and only one group).ç»ä¸ç¸äº¤ï¼æºåç´ å±äºä¸ä¸ªä¸ä»å±äºä¸ç»ï¼ã</p>
</li>
<li>
<p>Can contain elements from different places in the original sequence.å¯ä»¥åå«åå§åºåä¸­ä¸åä½ç½®çåç´ ã</p>
</li>
<li>
<p>Are never empty.æ°¸è¿ä¸ä¼ç©ºçã</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example groups values by whether they are even or odd:</p>
</div>
<div class="paragraph">
<p>ä¸é¢çç¤ºä¾æå¼æ¯å¶æ°è¿æ¯å¥æ°å¯¹å¼è¿è¡åç»ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(
	Flux.just(1, 3, 5, 2, 4, 6, 11, 12, 13)
		.groupBy(i -&gt; i % 2 == 0 ? "even" : "odd")
		.concatMap(g -&gt; g.defaultIfEmpty(-1) //if empty groups, show them
				.map(String::valueOf) //map to string
				.startWith(g.key())) //start with the group's key
	)
	.expectNext("odd", "1", "3", "5", "11", "13")
	.expectNext("even", "2", "4", "6", "12")
	.verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Grouping is best suited for when you have a medium to low number of groups. The
groups must also imperatively be consumed (such as by a <code>flatMap</code>) so that <code>groupBy</code>
continues fetching data from upstream and feeding more groups. Sometimes, these two
constraints multiply and lead to hangs, such as when you have a high cardinality and the
concurrency of the <code>flatMap</code> consuming the groups is too low.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
åç»æéåä¸­å°æ°éçç»ãè¿å¿é¡»å¼ºå¶ä½¿ç¨ç»ï¼ä¾å¦éè¿flatMapï¼ï¼ä»¥ä¾¿groupBy ç»§ç»­ä»ä¸æ¸¸è·åæ°æ®å¹¶æä¾æ´å¤ç»ã
ææ¶ï¼è¿ä¸¤ä¸ªçº¦æä¼åå¢å¹¶å¯¼è´æèµ·ï¼ä¾å¦ï¼å½æ¨å·æé«åºæ°å¹¶ä¸flatMapä½¿ç¨ç»çå¹¶åæ§å¤ªä½æ¶ã
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_windowing_with_fluxfluxt"><a class="anchor" href="#_windowing_with_fluxfluxt"></a>9.4.2. Windowing with <code>Flux&lt;Flux&lt;T&gt;&gt;</code></h4>
<div class="paragraph">
<p>Windowing is the act of splitting the source <code>Flux&lt;T&gt;</code> into <em>windows</em>, by criteria of
size, time, boundary-defining predicates, or boundary-defining <code>Publisher</code>.</p>
</div>
<div class="paragraph">
<p>çªå£åæ¯æ ¹æ®å¤§å°ï¼æ¶é´ï¼è¾¹çå®ä¹æè¾¹çå®ä¹çæ åå°æºåå²Flux&lt;T&gt;ä¸ºçªå£çè¡ä¸ºçPublisherã</p>
</div>
<div class="paragraph">
<p>The associated operators are <code>window</code>, <code>windowTimeout</code>, <code>windowUntil</code>, <code>windowWhile</code>, and
<code>windowWhen</code>.</p>
</div>
<div class="paragraph">
<p>ç¸å³çæä½ç¬¦æ¯ windowï¼windowTimeoutï¼windowUntilï¼windowWhileï¼å windowWhenã</p>
</div>
<div class="paragraph">
<p>Contrary to <code>groupBy</code>, which randomly overlaps according to incoming keys,
windows are (most of the time) opened sequentially.</p>
</div>
<div class="paragraph">
<p>ä¸ç¸å¯¹groupByï¼æ ¹æ®è¾å¥é®éæºéå ãçªå£ï¼å¤§é¨åæ¶é´ï¼æ¯æé¡ºåºæå¼çã</p>
</div>
<div class="paragraph">
<p>Some variants can still overlap, though. For instance, in <code>window(int maxSize, int skip)</code>
the <code>maxSize</code> parameter is the number of elements after which a window
closes, and the <code>skip</code> parameter is the number of elements in the source after which a
new window is opened. So if <code>maxSize &gt; skip</code>, a new window opens before the previous one
closes and the two windows overlap.</p>
</div>
<div class="paragraph">
<p>ä½æ¯ï¼æäºåä½ä»ç¶å¯ä»¥éå ãä¾å¦ï¼å¨window(int maxSize, int skip) è¯¥maxSizeåæ°æ¯çªå£è¾¾å°åä»¶çæ°éä¹åå³é­ï¼å¹¶ä¸æè¿°skipåæ°æ¯æºåä»¶çæ°éè¾¾å°åå¨æå¼ä¸ä¸ªæ°ççªå£ã
å æ­¤ï¼å¦æmaxSize &gt; skipæå¼ä¸ä¸ªæ°çªå£ï¼åå¨åä¸ä¸ªçªå£å³é­ä¹åï¼è¿ä¸¤ä¸ªçªå£ä¼éå ã</p>
</div>
<div class="paragraph">
<p>The following example shows overlapping windows:</p>
</div>
<div class="paragraph">
<p>ä»¥ä¸ç¤ºä¾æ¾ç¤ºäºéå ççªå£ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(
	Flux.range(1, 10)
		.window(5, 3) //overlapping windows
		.concatMap(g -&gt; g.defaultIfEmpty(-1)) //show empty windows as -1
	)
		.expectNext(1, 2, 3, 4, 5)
		.expectNext(4, 5, 6, 7, 8)
		.expectNext(7, 8, 9, 10)
		.expectNext(10)
		.verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
With the reverse configuration (<code>maxSize</code> &lt; <code>skip</code>), some elements from
the source are dropped and are not part of any window.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
å¦æä½¿ç¨ç¸åçéç½®ï¼maxSize&lt; skipï¼ï¼åä¼å é¤æºä¸­çæäºåç´ ï¼å®ä»¬ä¸å±äºä»»ä½çªå£ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the case of predicate-based windowing through <code>windowUntil</code> and <code>windowWhile</code>,
having subsequent source elements that do not match the predicate can also lead
to empty windows, as demonstrated in the following example:</p>
</div>
<div class="paragraph">
<p>å¨éè¿â windowUntilâåâ windowWhileâè¿è¡åºäºè°è¯ççªå£åçæåµä¸ï¼
åç»­æºåç´ ä¸æ­è¨ä¸å¹éä¹å¯è½å¯¼è´
å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼å³é­ç©ºçªå£ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(
	Flux.just(1, 3, 5, 2, 4, 6, 11, 12, 13)
		.windowWhile(i -&gt; i % 2 == 0)
		.concatMap(g -&gt; g.defaultIfEmpty(-1))
	)
		.expectNext(-1, -1, -1) //respectively triggered by odd 1 3 5
		.expectNext(2, 4, 6) // triggered by 11
		.expectNext(12) // triggered by 13
		// however, no empty completion window is emitted (would contain extra matching elements)
		.verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_buffering_with_fluxlistt"><a class="anchor" href="#_buffering_with_fluxlistt"></a>9.4.3. Buffering with <code>Flux&lt;List&lt;T&gt;&gt;</code></h4>
<div class="paragraph">
<p>Buffering is similar to windowing, with the following twist: Instead of emitting
<em>windows</em> (each of which is each a <code>Flux&lt;T&gt;</code>), it emits <em>buffers</em> (which are <code>Collection&lt;T&gt;</code>&#8201;&#8212;&#8201;by default, <code>List&lt;T&gt;</code>).</p>
</div>
<div class="paragraph">
<p>ç¼å²ç±»ä¼¼äºå çªï¼ä½æä»¥ä¸ä¸åï¼èä¸æ¯ååº çªå£ï¼æ¯ä¸ªçªå£é½æ¯ Flux&lt;T&gt;ï¼ï¼èæ¯ååºç¼å²åºï¼Collection&lt;T&gt;âé»è®¤ä¸ºList&lt;T&gt;ï¼ã</p>
</div>
<div class="paragraph">
<p>The operators for buffering mirror those for windowing: <code>buffer</code>, <code>bufferTimeout</code>,
<code>bufferUntil</code>, <code>bufferWhile</code>, and <code>bufferWhen</code>.</p>
</div>
<div class="paragraph">
<p>ç¨äºç¼å²çæä½ç¬¦åæ åºåçªå£çæ§è´¨ï¼æ¯å¦ï¼bufferï¼bufferTimeoutï¼ bufferUntilï¼bufferWhileï¼åbufferWhenã</p>
</div>
<div class="paragraph">
<p>Where the corresponding windowing operator opens a window, a buffering operator creates a
new collection and starts adding elements to it. Where a window closes, the buffering
operator emits the collection.</p>
</div>
<div class="paragraph">
<p>å¨ç¸åºççªå£è¿ç®ç¬¦æå¼ä¸ä¸ªçªå£çå°æ¹ï¼ä¸ä¸ªç¼å²è¿ç®ç¬¦åå»ºä¸ä¸ªæ°çéåå¹¶å¼å§åå¶ä¸­æ·»å åç´ ã
å¨çªå£å³é­çå°æ¹ï¼ç¼å²è¿ç®ç¬¦ååºéåã</p>
</div>
<div class="paragraph">
<p>Buffering can also lead to dropping source elements or having overlapping buffers, as
the following example shows:</p>
</div>
<div class="paragraph">
<p>ç¼å²è¿ä¼å¯¼è´æºåç´ ä¸¢å¤±æç¼å²åºéå ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(
	Flux.range(1, 10)
		.buffer(5, 3) //overlapping buffers
	)
		.expectNext(Arrays.asList(1, 2, 3, 4, 5))
		.expectNext(Arrays.asList(4, 5, 6, 7, 8))
		.expectNext(Arrays.asList(7, 8, 9, 10))
		.expectNext(Collections.singletonList(10))
		.verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Unlike in windowing, <code>bufferUntil</code> and <code>bufferWhile</code> do not emit an empty buffer, as
the following example shows:</p>
</div>
<div class="paragraph">
<p>ä¸åäºå¨çªå£ä¸­ï¼bufferUntilå¹¶ä¸bufferWhileä¸ååºç©ºç¼å²åºï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StepVerifier.create(
	Flux.just(1, 3, 5, 2, 4, 6, 11, 12, 13)
		.bufferWhile(i -&gt; i % 2 == 0)
	)
	.expectNext(Arrays.asList(2, 4, 6)) // triggered by 11
	.expectNext(Collections.singletonList(12)) // triggered by 13
	.verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-parallelizing-parralelflux"><a class="anchor" href="#advanced-parallelizing-parralelflux"></a>9.5. Parallelizing Work with <code>ParallelFlux</code></h3>
<div class="paragraph">
<p>With multi-core architectures being a commodity nowadays, being able to easily
parallelize work is important. Reactor helps with that by providing a special type,
<code>ParallelFlux</code>, that exposes operators that are optimized for parallelized work.</p>
</div>
<div class="paragraph">
<p>å¦ä»ï¼éçå¤æ ¸ä½ç³»ç»ææä¸ºä¸ç§ååï¼è½å¤è½»æ¾å¹¶è¡åå·¥ä½éå¸¸éè¦ã
Reactoréè¿æä¾ä¸ç§ç¹æ®ç±»åæ¥å¸®å©å®ç°è¿ä¸ç¹ï¼è¯¥ç±»å ParallelFluxå¬å¼äºéå¯¹å¹¶è¡å·¥ä½è¿è¡äºä¼åçè¿ç®ç¬¦ã</p>
</div>
<div class="paragraph">
<p>To obtain a <code>ParallelFlux</code>, you can use the <code>parallel()</code> operator on any <code>Flux</code>.
By itself, this method does not parallelize the work. Rather, it divides
the workload into &#8220;rails&#8221; (by default, as many rails as there are CPU cores).</p>
</div>
<div class="paragraph">
<p>è¦è·å ParallelFluxï¼æ¨å¯ä»¥parallel()å¨ä»»æä½ç½®ä½¿ç¨è¿ç®ç¬¦Fluxãå°±å¶æ¬èº«èè¨ï¼æ­¤æ¹æ³ä¸ä¼ä½¿å·¥ä½å¹¶è¡åã
ç¸åï¼å®å°å·¥ä½è´è½½ååä¸ºâ railsâï¼é»è®¤æåµä¸ï¼ä¸CPUåæ ¸ä¸æ ·å¤çrailsï¼ã</p>
</div>
<div class="paragraph">
<p>In order to tell the resulting <code>ParallelFlux</code> where to run each rail (and, by
extension, to run rails in parallel) you have to use <code>runOn(Scheduler)</code>. Note that
there is a recommended dedicated <code>Scheduler</code> for parallel work: <code>Schedulers.parallel()</code>.</p>
</div>
<div class="paragraph">
<p>ä¸ºäºåè¯æç»ç»æParallelFluxï¼æ¯ä¸ªå¯¼è½¨é½å¨åªéè¿è¡ï¼å¹¶æ©å±ä¸ºå¹¶è¡è¿è¡å¯¼è½¨ï¼ï¼æ¨å¿é¡»ä½¿ç¨runOn(Scheduler)ã
éè¦æ³¨æçæ¯æä¸ä¸ªæ¨èçä¸ç¨Schedulerå¹¶è¡å·¥ä½ï¼Schedulers.parallel()ã</p>
</div>
<div class="paragraph">
<p>Compare the next two examples:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.range(1, 10)
    .parallel(2) <i class="conum" data-value="1"></i><b>(1)</b>
    .subscribe(i -&gt; System.out.println(Thread.currentThread().getName() + " -&gt; " + i));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We force a number of rails instead of relying on the number of CPU cores. æä»¬å¼ºå¶ä½¿ç¨å¤ä¸ªå¯¼è½¨ï¼èä¸æ¯ä¾èµäºCPUåæ ¸çæ°éã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.range(1, 10)
    .parallel(2)
    .runOn(Schedulers.parallel())
    .subscribe(i -&gt; System.out.println(Thread.currentThread().getName() + " -&gt; " + i));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first example produces the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>main -&gt; 1
main -&gt; 2
main -&gt; 3
main -&gt; 4
main -&gt; 5
main -&gt; 6
main -&gt; 7
main -&gt; 8
main -&gt; 9
main -&gt; 10</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The second correctly parallelizes on two threads, as shown in the following output:</p>
</div>
<div class="paragraph">
<p>ç¬¬äºä¸ªå¨ä¸¤ä¸ªçº¿ç¨ä¸æ­£ç¡®å¹¶è¡åï¼å¦ä»¥ä¸è¾åºæç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>parallel-1 -&gt; 1
parallel-2 -&gt; 2
parallel-1 -&gt; 3
parallel-2 -&gt; 4
parallel-1 -&gt; 5
parallel-2 -&gt; 6
parallel-1 -&gt; 7
parallel-1 -&gt; 9
parallel-2 -&gt; 8
parallel-2 -&gt; 10</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If, once you process your sequence in parallel, you want to revert back to a &#8220;normal&#8221;
<code>Flux</code> and apply the rest of the operator chain in a sequential manner, you can use the
<code>sequential()</code> method on <code>ParallelFlux</code>.</p>
</div>
<div class="paragraph">
<p>å¦æå¨å¹¶è¡å¤çåºååæ³è¦æ¢å¤ä¸ºâæ­£å¸¸â Fluxå¹¶ä»¥é¡ºåºæ¹å¼åºç¨å¶ä½è¿ç®ç¬¦é¾ï¼åå¯ä»¥å¨ParallelFluxä¸ä½¿ç¨sequential()æ¹æ³ã</p>
</div>
<div class="paragraph">
<p>Note that <code>sequential()</code> is implicitly applied if you <code>subscribe</code> to the <code>ParallelFlux</code>
with a <code>Subscriber</code> but not when using the lambda-based variants of <code>subscribe</code>.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼sequential()æ¯éå¼åºç¨ï¼å¦æä½ subscribeå°ParallelFlux äºSubscriberä½¿ç¨åºäºlambdaæ¶ï¼ä½ä¸æ¯subscribeã</p>
</div>
<div class="paragraph">
<p>Note also that <code>subscribe(Subscriber&lt;T&gt;)</code> merges all the rails, while
<code>subscribe(Consumer&lt;T&gt;)</code> runs all the rails. If the <code>subscribe()</code> method has a lambda,
each lambda is executed as many times as there are rails.</p>
</div>
<div class="paragraph">
<p>è¿è¦æ³¨æï¼subscribe(Subscriber&lt;T&gt;)åå¹¶ææå¯¼è½¨ï¼åæ¶ subscribe(Consumer&lt;T&gt;)è¿è¡ææå¯¼è½¨ã
å¦æè¯¥subscribe()æ¹æ³å·ælambdaï¼åæ¯ä¸ªlambdaçæ§è¡æ¬¡æ°å°ä¸railsä¸æ ·å¤ã</p>
</div>
<div class="paragraph">
<p>You can also access individual rails or &#8220;groups&#8221; as a <code>Flux&lt;GroupedFlux&lt;T&gt;&gt;</code> through the
<code>groups()</code> method and apply additional operators to them through the <code>composeGroup()</code>
method.</p>
</div>
<div class="paragraph">
<p>æ¨ä¹å¯ä»¥Flux&lt;GroupedFlux&lt;T&gt;&gt;éè¿groups()æ¹æ³è®¿é®åä¸ªå¯¼è½¨æâç»âï¼å¹¶éè¿è¯¥ æ¹æ³åå®ä»¬åºç¨å¶ä»è¿ç®ç¬¦composeGroup() ã</p>
</div>
</div>
<div class="sect2">
<h3 id="scheduler-factory"><a class="anchor" href="#scheduler-factory"></a>9.6. Replacing Default <code>Schedulers</code></h3>
<div class="paragraph">
<p>As we described in the <a href="#schedulers">Threading and Schedulers</a> section, Reactor Core comes with several
<code>Scheduler</code> implementations. While you can always create new instances through the <code>new*</code>
factory methods, each <code>Scheduler</code> flavor also has a default singleton instance that is
accessible through the direct factory method (such as <code>Schedulers.boundedElastic()</code> versus
<code>Schedulers.newBoundedElastic(&#8230;&#8203;)</code>).</p>
</div>
<div class="paragraph">
<p>å¦æä»¬å¨â çº¿ç¨åè°åº¦ç¨åºâé¨åæè¿°ï¼Reactor Coreéå¸¦äºå ç§ Schedulerå®ç°ã
å°½ç®¡æ¨å§ç»å¯ä»¥éè¿new* å·¥åæ¹æ³åå»ºæ°å®ä¾ï¼ä½æ¯æ¯ä¸ªScheduleré£å³è¿å·æé»è®¤çåä¾å®ä¾ï¼å¯éè¿ç´æ¥å·¥åæ¹æ³ï¼ä¾å¦Schedulers.boundedElastic()vs Schedulers.newBoundedElastic(â¦â)ï¼è¿è¡è®¿é®ã</p>
</div>
<div class="paragraph">
<p>These default instances are the ones used by operators that need a <code>Scheduler</code> to work
when you do not explicitly specify one. For example, <code>Flux#delayElements(Duration)</code> uses
the <code>Schedulers.parallel()</code> instance.</p>
</div>
<div class="paragraph">
<p>è¿äºé»è®¤å®ä¾æ¯Scheduleræªæç¡®æå®å®ä¾æ¶éè¦å·¥ä½çè¿ç®ç¬¦æä½¿ç¨çå®ä¾ã
ä¾å¦ï¼Flux#delayElements(Duration)ä½¿ç¨Schedulers.parallel()å®ä¾ã</p>
</div>
<div class="paragraph">
<p>In some cases, however, you might need to change these default instances with something
else in a cross-cutting way, without having to make sure every single operator you call
has your specific <code>Scheduler</code> as a parameter. An example is measuring the time every
single scheduled task takes by wrapping the real schedulers, for instrumentation
purposes. In other words, you might want to change the default <code>Schedulers</code>.</p>
</div>
<div class="paragraph">
<p>ä½æ¯ï¼å¨æäºæåµä¸ï¼æ¨å¯è½éè¦ä»¥äº¤åæ¹å¼ä½¿ç¨å¶ä»é»è®¤å¼æ¥æ´æ¹è¿äºé»è®¤å®ä¾ï¼èä¸å¿ç¡®ä¿è°ç¨çæ¯ä¸ªè¿ç®ç¬¦é½å°èªå·±çç¹å®Scheduleråæ°ä½ä¸ºåæ°ã
ä¸ä¸ªç¤ºä¾æ¯éè¿åè£å®éçè®¡åç¨åºæ¥æµéæ¯ä¸ªè®¡åçä»»å¡æè±è´¹çæ¶é´ï¼ä»¥è¿è¡æ£æµãæ¢å¥è¯è¯´ï¼æ¨å¯è½æ³è¦æ´æ¹é»è®¤çSchedulersã</p>
</div>
<div class="paragraph">
<p>Changing the default schedulers is possible through the <code>Schedulers.Factory</code> class. By
default, a <code>Factory</code> creates all the standard <code>Scheduler</code> through similarly named
methods. You can override each of these with your custom implementation.</p>
</div>
<div class="paragraph">
<p>éè¿Schedulers.Factoryè¯¥ç±»å¯ä»¥æ´æ¹é»è®¤è°åº¦ç¨åºã
é»è®¤æåµä¸ï¼<code>Factory</code> éè¿ç¸ä¼¼å½åçæ¹æ³åå»ºæææ åSchedulerãæ¨å¯ä»¥ä½¿ç¨èªå®ä¹å®ç°è¦çå¶ä¸­çæ¯ä¸ä¸ªã</p>
</div>
<div class="paragraph">
<p>Additionally, the factory exposes one additional customization method:
<code>decorateExecutorService</code>. It is invoked during the creation of every Reactor Core
<code>Scheduler</code> that is backed by a <code>ScheduledExecutorService</code> (even non-default instances,
such as those created by calls to <code>Schedulers.newParallel()</code>).</p>
</div>
<div class="paragraph">
<p>æ­¤å¤ï¼å·¥åè¿å¬å¼äºå¦ä¸ç§èªå®ä¹æ¹æ³ï¼ decorateExecutorServiceã
å¨åå»ºæ¯ä¸ªSchedulerç±ScheduledExecutorServiceï¼ä½ä¸ºéé»è®¤å®ä¾ï¼ä¾å¦éè¿è°ç¨åå»ºçå®ä¾ï¼æ¯æçReactor Coreçè¿ç¨ä¸­è°ç¨å® Schedulers.newParallel()ã</p>
</div>
<div class="paragraph">
<p>This lets you tune the <code>ScheduledExecutorService</code> to be used: The default one is exposed
as a <code>Supplier</code> and, depending on the type of <code>Scheduler</code> being configured, you can choose
to entirely bypass that supplier and return your own instance or you can <code>get()</code> the
default instance and wrap it.</p>
</div>
<div class="paragraph">
<p>è¿ä½¿æ¨å¯ä»¥è°æ´ScheduledExecutorServiceè¦ä½¿ç¨çï¼é»è®¤å®ä¾æ¾ç¤ºä¸ºä¸ä¸ªSupplierå¹¶ä¸æ ¹æ®Scheduleréç½®çç±»åï¼
æ¨å¯ä»¥éæ©å®å¨ç»è¿è¯¥æä¾å¹¶è¿åèªå·±çå®ä¾ï¼ä¹å¯ä»¥ä¸ºget()å°éæ©çé»è®¤å®ä¾åè£å¹¶å°å¶è¿åã</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Once you create a <code>Factory</code> that fits your needs, you must install it by calling
<code>Schedulers.setFactory(Factory)</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
åå»ºFactoryéåæ¨éæ±çè½¯ä»¶åï¼æ¨å¿é¡»éè¿è°ç¨è¿è¡å®è£ Schedulers.setFactory(Factory)ã
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, there is a last customizable hook in <code>Schedulers</code>: <code>onHandleError</code>. This hook is
invoked whenever a <code>Runnable</code> task submitted to a <code>Scheduler</code> throws an <code>Exception</code> (note
that if there is an <code>UncaughtExceptionHandler</code> set for the <code>Thread</code> that ran the task,
both the handler and the hook are invoked).</p>
</div>
<div class="paragraph">
<p>æåï¼è¿ææåä¸ä¸ªå¯å®å¶çé©å­Schedulersï¼onHandleErrorã
æ¯å½Runnableæäº¤ç»Schedulerå¼åä»»å¡çä»»å¡æåºå¼å¸¸æ¶ï¼é½ä¼è°ç¨æ­¤æé©Exceptionï¼è¯·æ³¨æï¼å¦ææè¿è¡è¯¥ä»»å¡çUncaughtExceptionHandleréåï¼åå°Threadåæ¶è°ç¨å¤çç¨åºåæé©ï¼ã</p>
</div>
</div>
<div class="sect2">
<h3 id="hooks"><a class="anchor" href="#hooks"></a>9.7. Using Global Hooks</h3>
<div class="paragraph">
<p>Reactor has another category of configurable callbacks that are invoked by Reactor
operators in various situations. They are all set in the <code>Hooks</code> class, and they fall into
three categories:</p>
</div>
<div class="paragraph">
<p>Reactorå·æå¦ä¸ç±»å¯éç½®çåè°ï¼å¯å¨åç§æåµä¸ç±Reactorè¿ç®ç¬¦è°ç¨ãå®ä»¬å¨é½è®¾ç½®å¨Hooks ç±»ä¸­ï¼åä¸ºä¸ç±»ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#hooks-dropping">Dropping Hooks</a></p>
</li>
<li>
<p><a href="#hooks-internal">Internal Error Hook</a></p>
</li>
<li>
<p><a href="#hooks-assembly">Assembly Hooks</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="hooks-dropping"><a class="anchor" href="#hooks-dropping"></a>9.7.1. Dropping Hooks</h4>
<div class="paragraph">
<p>Dropping hooks are invoked when the source of an operator does not comply with the
Reactive Streams specification. These kind of errors are outside of the normal execution
path (that is, they cannot be propagated through <code>onError</code>).</p>
</div>
<div class="paragraph">
<p>å½æä½åçæ¥æºä¸ç¬¦åReactive Streamsè§èæ¶ï¼å°è°ç¨åé©ãè¿äºç±»åçéè¯¯ä¸å¨æ­£å¸¸çæ§è¡è·¯å¾ä¹åï¼ä¹å°±æ¯è¯´ï¼å®ä»¬ä¸è½éè¿ä¼ æ­onErrorï¼ã</p>
</div>
<div class="paragraph">
<p>Typically, a <code>Publisher</code> calls <code>onNext</code> on the operator despite having already called
<code>onCompleted</code> on it previously. In that case, the <code>onNext</code> value is dropped. The same
is true for an extraneous <code>onError</code> signal.</p>
</div>
<div class="paragraph">
<p>éå¸¸ï¼å°½ç®¡ååå·²ç»å¨è¿ç®ç¬¦ä¸è¿è¡äºPublisherè°ç¨onNextï¼ä½ä»å¨å¯¹è¿ç®ç¬¦è¿è¡è°ç¨ onCompletedã
å¨è¿ç§æåµä¸ï¼è¯¥onNextå¼å°è¢«å é¤ãå¤é¨onErrorä¿¡å·ä¹æ¯å¦æ­¤ã</p>
</div>
<div class="paragraph">
<p>The corresponding hooks, <code>onNextDropped</code> and <code>onErrorDropped</code>, let you provide a global
<code>Consumer</code> for these drops. For example, you can use it to log the drop and clean up
resources associated with a value if needed (as it never makes it to the rest of the
reactive chain).</p>
</div>
<div class="paragraph">
<p>ç¸åºçé©å­onNextDroppedåonErrorDroppedåè®¸æ¨Consumerä¸ºè¿äºæ¾ç½®æä¾å¨å± åéã
ä¾å¦ï¼æ¨å¯ä»¥ä½¿ç¨å®æ¥è®°å½å é¤æä½ï¼å¹¶å¨éè¦æ¶æ¸çä¸æä¸ªå¼å³èçèµæºï¼å ä¸ºå®æ°¸è¿ä¸ä¼å°è¾¾ååºé¾çå¶ä½é¨åï¼ã</p>
</div>
<div class="paragraph">
<p>Setting the hooks twice in a row is additive: every consumer you provide is invoked. The
hooks can be fully reset to their defaults by using the <code>Hooks.resetOn*Dropped()</code> methods.</p>
</div>
<div class="paragraph">
<p>è¿ç»­ä¸¤æ¬¡è®¾ç½®é©å­æ¯éå çï¼æ¨æä¾çæ¯ä¸ªä½¿ç¨èé½å°è¢«è°ç¨ã
å¯ä»¥ä½¿ç¨è¿äºHooks.resetOn*Dropped()æ¹æ³å°æé©å®å¨éç½®ä¸ºé»è®¤å¼ã</p>
</div>
</div>
<div class="sect3">
<h4 id="hooks-internal"><a class="anchor" href="#hooks-internal"></a>9.7.2. Internal Error Hook</h4>
<div class="paragraph">
<p>One hook, <code>onOperatorError</code>, is invoked by operators when an unexpected <code>Exception</code> is
thrown during the execution of their <code>onNext</code>, <code>onError</code>, and <code>onComplete</code> methods.</p>
</div>
<div class="paragraph">
<p>ä¸ä¸ªé©ï¼onOperatorErroræ¯ç±æä½åå½ä¸æå¤çè°ç¨Exceptionå¶æ§è¡æé´è¢«æåºonNextï¼onErroråonCompleteæ¹æ³ã</p>
</div>
<div class="paragraph">
<p>Unlike the previous category, this is still within the normal execution path. A typical
example is the <code>map</code> operator with a map function that throws an <code>Exception</code> (such as
division by zero). It is still possible at this point to go through the usual channel of
<code>onError</code>, and that is what the operator does.</p>
</div>
<div class="paragraph">
<p>ä¸ä¹åçç±»å«ä¸åï¼è¿ä»ç¶å¨å¸¸è§æ§è¡è·¯å¾ä¹åãä¸ä¸ªå¸åçä¾å­æ¯mapå¸¦æä¸ä¸ªæ å°å½æ°çè¿ç®ç¬¦ï¼è¯¥è¿ç®ç¬¦æåºä¸ä¸ªExceptionï¼ä¾å¦è¢«é¶é¤ï¼ã
å¨è¿ä¸ç¹ä¸ï¼ä»ç¶æå¯è½éè¿çå¸¸è§æ¸ éå¨ onErrorï¼èè¿æ­£æ¯æä½åæè¦åçã</p>
</div>
<div class="paragraph">
<p>First, it passes the <code>Exception</code> through <code>onOperatorError</code>. The hook lets you inspect the
error (and the incriminating value, if relevant) and change the <code>Exception</code>. Of course,
you can also do something on the side, such as log and return the original <code>Exception</code>.</p>
</div>
<div class="paragraph">
<p>é¦åï¼å®åè®¸Exceptionéè¿onOperatorErrorãè¯¥æé©å¯è®©æ¨æ£æ¥éè¯¯ï¼ä»¥åç¸å³å¼ï¼ï¼å¹¶æ´æ¹Exceptionã
å½ç¶ï¼æ¨ä¹å¯ä»¥å¨ä¾§é¢æ§è¡ä¸äºæä½ï¼ä¾å¦logå¹¶è¿åoriginal Exceptionã</p>
</div>
<div class="paragraph">
<p>Note that you can set the <code>onOperatorError</code> hook multiple times. You can provide a
<code>String</code> identifier for a particular <code>BiFunction</code> and subsequent calls with different
keys concatenates the functions, which are all executed. On the other hand, reusing the
same key twice lets you replace a function you previously set.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼æ¨å¯ä»¥onOperatorErrorå¤æ¬¡è®¾ç½®æé©ãæ¨å¯ä»¥Stringä¸ºä¸ä¸ªç¹å®çæ è¯ç¬¦æä¾ æ è¯ç¬¦BiFunctionï¼éåçè°ç¨å°ä½¿ç¨ä¸åçé®å°è¿äºå½æ°ä¸²èèµ·æ¥ï¼è¿äºå½æ°å°å¨é¨æ§è¡ã
å¦ä¸æ¹é¢ï¼éå¤ä½¿ç¨åä¸é®ä¸¤æ¬¡å¯è®©æ¨æ¿æ¢ä»¥åè®¾ç½®çåè½ã</p>
</div>
<div class="paragraph">
<p>As a consequence, the default hook behavior can be both fully reset (by using
<code>Hooks.resetOnOperatorError()</code>) or partially reset for a specific <code>key</code> only (by using
<code>Hooks.resetOnOperatorError(String)</code>).</p>
</div>
<div class="paragraph">
<p>å æ­¤ï¼é»è®¤æé©è¡ä¸ºæ¢å¯ä»¥å®å¨éç½®ï¼éè¿ä½¿ç¨Hooks.resetOnOperatorError()ï¼ï¼ä¹å¯ä»¥ keyä»éå¯¹ç¹å®çé¨åéç½®ï¼éè¿ä½¿ç¨ Hooks.resetOnOperatorError(String)ï¼ã</p>
</div>
</div>
<div class="sect3">
<h4 id="hooks-assembly"><a class="anchor" href="#hooks-assembly"></a>9.7.3. Assembly Hooks</h4>
<div class="paragraph">
<p>These hooks tie in the lifecycle of operators. They are invoked when a chain of operators
is assembled (that is, instantiated). <code>onEachOperator</code> lets you dynamically change each
operator as it is assembled in the chain, by returning a different <code>Publisher</code>.
<code>onLastOperator</code> is similar, except that it is invoked only on the last operator in the
chain before the <code>subscribe</code> call.</p>
</div>
<div class="paragraph">
<p>è¿äºæé©å³ç³»å°æä½ç¬¦ççå½å¨æãå¨ç»è£ï¼å³å®ä¾åï¼ä¸ç³»åæä½ç¬¦æ¶è°ç¨å®ä»¬ãonEachOperatoréè¿è¿åä¸åçï¼å¯ä»¥å¨ææ´æ¹é¾ä¸­ç»è£çæ¯ä¸ªè¿ç®ç¬¦Publisherã
 onLastOperatorä¸ä¹ç±»ä¼¼ï¼é¤äºå®ä»å¨è°ç¨subscribeä¹åå¨é¾ä¸­çæåä¸ä¸ªè¿ç®ç¬¦ä¸ææ§è¡ã</p>
</div>
<div class="paragraph">
<p>If you want to decorate all operators with a cross-cutting <code>Subscriber</code> implementation,
you can look into the <code>Operators#lift*</code> methods to help you deal with the various
types of Reactor <code>Publishers</code> out there (<code>Flux</code>, <code>Mono</code>, <code>ParallelFlux</code>, <code>GroupedFlux</code>, and <code>ConnectableFlux</code>),
as well as their <code>Fuseable</code> versions.</p>
</div>
<div class="paragraph">
<p>å¦ææ¨æ³ä½¿ç¨è·¨é¢åçSubscriberå®ç°æ¥è£é¥°ææè¿ç®ç¬¦ï¼æ¨å¯ä»¥æ¥çâ Operatorsï¼lift *âæ¹æ³æ¥å¸®å©æ¨å¤çåç§
é£éçååºå âPublishersâçç±»åï¼âFluxâï¼âMonoâï¼âParallelFluxâï¼âGroupedFluxâåâConnectableFluxâï¼ï¼
ä»¥åå®ä»¬çâFuseableâçæ¬ã</p>
</div>
<div class="paragraph">
<p>Like <code>onOperatorError</code>, these hooks are cumulative and can be identified with a key. They
can also be reset partially or totally.</p>
</div>
<div class="paragraph">
<p>åä¸æ ·onOperatorErrorï¼è¿äºé©å­æ¯ç´¯ç§¯çï¼å¯ä»¥ç¨ä¸ä¸ªå¯é¥æ è¯ãå®ä»¬ä¹å¯ä»¥é¨åæå¨é¨éç½®ã</p>
</div>
</div>
<div class="sect3">
<h4 id="_hook_presets"><a class="anchor" href="#_hook_presets"></a>9.7.4. Hook Presets</h4>
<div class="paragraph">
<p>The <code>Hooks</code> utility class provides two preset hooks. These are alternatives to
the default behaviors that you can use by calling their corresponding method, rather than
coming up with the hook yourself:</p>
</div>
<div class="paragraph">
<p>è¿ Hookså·¥å·ç±»æä¾ä¸¤ä¸ªé¢ç½®é©ãè¿äºæ¯é»è®¤è¡ä¸ºçæ¿ä»£æ¹æ³ï¼æ¨å¯ä»¥éè¿è°ç¨å®ä»¬çç¸åºæ¹æ³æ¥ä½¿ç¨è¿äºé»è®¤è¡ä¸ºï¼èä¸ç¨äº²èªå®ç°è¯¥é©å­ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onNextDroppedFail()</code>: <code>onNextDropped</code> used to throw a <code>Exceptions.failWithCancel()</code>
exception. It now defaults to logging the dropped value at the DEBUG level. To go back to
the old default behavior of throwing, use <code>onNextDroppedFail()</code>.</p>
</li>
<li>
<p><code>onOperatorDebug()</code>: This method activates <a href="#debug-activate">debug mode</a>. It ties into
the <code>onOperatorError</code> hook, so calling <code>resetOnOperatorError()</code> also resets it. You can
independently reset it by using  <code>resetOnOperatorDebug()</code>, as it uses a specific key internally.</p>
</li>
<li>
<p>onNextDroppedFail()ï¼onNextDroppedç¨äºå¼åExceptions.failWithCancel() å¼å¸¸ãç°å¨ï¼å®é»è®¤å¨DEBUGçº§å«è®°å½ä¸éçå¼ãè¦è¿ååæ¥çé»è®¤æåºè¡ä¸ºï¼è¯·ä½¿ç¨onNextDroppedFail()ã</p>
</li>
<li>
<p>onOperatorDebug()ï¼æ­¤æ¹æ³æ¿æ´»è°è¯æ¨¡å¼ãå®ä¸onOperatorErroræé©ç¸å³ï¼å æ­¤è°ç¨resetOnOperatorError()ä¹å°å¶éç½®ãæ¨å¯ä»¥ä½¿ç¨æ¥ç¬ç«éç½®å® resetOnOperatorDebug()ï¼å ä¸ºå®å¨åé¨ä½¿ç¨äºç¹å®çå¯é¥ã</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="context"><a class="anchor" href="#context"></a>9.8. Adding a Context to a Reactive Sequence</h3>
<div class="paragraph">
<p>One of the big technical challenges encountered when switching from an imperative
programming perspective to a reactive programming mindset lies in how you deal with
threading.</p>
</div>
<div class="paragraph">
<p>ä»å½ä»¤å¼ç¼ç¨è§è§è½¬æ¢ä¸ºååºå¼ç¼ç¨æç»´æ¹å¼æ¶éå°çéå¤§ææ¯ææä¹ä¸æ¯å¦ä½å¤ççº¿ç¨ã</p>
</div>
<div class="paragraph">
<p>Contrary to what you might be used to, in reactive programming, you can use a <code>Thread</code>
to process several asynchronous sequences that run at roughly the same time (actually, in
non-blocking locksteps). The execution can also easily and often jump from one thread to
another.</p>
</div>
<div class="paragraph">
<p>ä¸æ¨ä¹ æ¯çååºå¼ç¼ç¨ç¸åï¼æ¨å¯ä»¥ä½¿ç¨`Thread`å¤çå ä¸ªå¤§è´åæ¶è¿è¡çå¼æ­¥åºåï¼å®éä¸ï¼éé»å¡çéæ­¥ï¼ã
æ§è¡ä¹å¯ä»¥è½»æ¾ä¸ç»å¸¸ä»ä¸ä¸ªçº¿ç¨è·³è½¬å°å¦ä¸ä¸ªã</p>
</div>
<div class="paragraph">
<p>This arrangement is especially hard for developers that use features dependent on the
threading model being more &#8220;stable,&#8221; such as <code>ThreadLocal</code>. As it lets you associate
data with a thread, it becomes tricky to use in a reactive context. As a result,
libraries that rely on <code>ThreadLocal</code> at least introduce new challenges when used with
Reactor. At worst, they work badly or even fail. Using the MDC of Logback to store and
log correlation IDs is a prime example of such a situation.</p>
</div>
<div class="paragraph">
<p>å¯¹äºä½¿ç¨ä¾èµäºçº¿ç¨æ¨¡åä¸å¼åæ´âç¨³å®âçåè½è¿ç§å®æå°¤å¶å°é¾ãæ¯å¦ThreadLocalãå ä¸ºå®ä½¿æ¨å¯ä»¥å°æ°æ®ä¸çº¿ç¨ç¸å³èï¼æä»¥å¨ååºå¼ä¸ä¸æä¸­ä½¿ç¨å®åå¾æ£æã
ThreadLocalä¸Reactorä¸èµ·ä½¿ç¨æ¶ï¼è³å°ä¾èµçåºä¼å¸¦æ¥æ°çææãå¨æåçæåµä¸ï¼å®ä»¬ä¼è¡¨ç°ä¸ä½³çè³å¤±è´¥ã
ä½¿ç¨LogbackçMDCå­å¨åè®°å½ç¸å³IDæ¯è¿ç§æåµçä¸»è¦ç¤ºä¾ã</p>
</div>
<div class="paragraph">
<p>The usual workaround for <code>ThreadLocal</code> usage is to move the contextual data, <code>C</code>, along
your business data, <code>T</code>, in the sequence, by using (for instance) <code>Tuple2&lt;T, C&gt;</code>. This does
not look good and leaks an orthogonal concern (the contextual data) into your method and
<code>Flux</code> signatures.</p>
</div>
<div class="paragraph">
<p>ä½¿ç¨çéå¸¸è§£å³æ¹æ³ThreadLocalæ¯ä½¿ç¨ï¼ä¾å¦ï¼æé¡ºåºç§»å¨ä¸ä¸ææ°æ®Cåä¸å¡æ°æ®ãè¿çèµ·æ¥ä¸å¥½ï¼å¹¶ä¸å°æ­£äº¤å³æ³¨ç¹ï¼ä¸ä¸ææ°æ®ï¼æ³æ¼å°æ¨çæ¹æ³å ç­¾åä¸­ãTTuple2&lt;T, C&gt;Flux</p>
</div>
<div class="paragraph">
<p>Since version <code>3.1.0</code>, Reactor comes with an advanced feature that is somewhat comparable
to <code>ThreadLocal</code> but can be applied to a <code>Flux</code> or a <code>Mono</code> instead of a <code>Thread</code>.
This feature is called <code>Context</code>.</p>
</div>
<div class="paragraph">
<p>ä»çæ¬å¼å§3.1.0ï¼Reactorå¸¦æä¸é¡¹åè¿çåè½ï¼å¨æç§ç¨åº¦ä¸å¯ä»¥ä¸ThreadLocalåª²ç¾ï¼ä½å¯ä»¥åºç¨äºFluxæMonoä»£æ¿Threadãæ­¤åè½ç§°ä¸ºContextã</p>
</div>
<div class="paragraph">
<p>As an illustration of what it looks like, the following example both writes from and
writes to <code>Context</code>:</p>
</div>
<div class="paragraph">
<p>ä¸ºäºè¯´æå¶å¤è§ï¼ä»¥ä¸ç¤ºä¾åæ¶åå¥ååå¥Contextï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r = Mono.just("Hello")
                .flatMap( s -&gt; Mono.subscriberContext()
                                   .map( ctx -&gt; s + " " + ctx.get(key)))
                .subscriberContext(ctx -&gt; ctx.put(key, "World"));

StepVerifier.create(r)
            .expectNext("Hello World")
            .verifyComplete();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the following sections, we cover <code>Context</code> and how to use it, so that you
can eventually understand the preceding example.</p>
</div>
<div class="paragraph">
<p>å¨ä»¥ä¸åèä¸­ï¼æä»¬ä»ç»Contextäºå®ä»¥åå¦ä½ä½¿ç¨å®ï¼ä»¥ä¾¿æ¨æç»å¯ä»¥çè§£åé¢çç¤ºä¾ã</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is an advanced feature that is more targeted at library developers. It
requires good understanding of the lifecycle of a <code>Subscription</code> and is intended for
libraries that are responsible for the subscriptions.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
è¿æ¯ä¸é¡¹é«çº§åè½ï¼æ´é¢ååºå¼åäººåãå®éè¦å¯¹Subscriptionççå½å¨ææå¾å¥½çäºè§£ï¼å¹¶ä¸éç¨äºè´è´£è®¢éçåºã
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="context.api"><a class="anchor" href="#context.api"></a>9.8.1. The <code>Context</code> API</h4>
<div class="paragraph">
<p><code>Context</code> is an interface reminiscent of <code>Map</code>.It stores key-value pairs and lets you
fetch a value you stored by its key. More specifically:</p>
</div>
<div class="paragraph">
<p>Contextæ¯ä¸ä¸ªè®©äººæ³èµ·çæ¥å£ãMapå®å­å¨é®å¼å¯¹ï¼å¹¶åè®¸æ¨è·åéè¿å¶é®å­å¨çå¼ãè¿ä¸æ­¥æ¥è¯´ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Both key and values are of type <code>Object</code>, so a <code>Context</code> instance can contain any number of
highly divergent values from different libraries and sources.</p>
</li>
<li>
<p>A <code>Context</code> is immutable.</p>
</li>
<li>
<p>Use <code>put(Object key, Object value)</code> to store a key-value pair, returning a new
<code>Context</code> instance. You can also merge two contexts into a new one by using
<code>putAll(Context)</code>.</p>
</li>
<li>
<p>You can check whether the key is present with <code>hasKey(Object key)</code>.</p>
</li>
<li>
<p>Use <code>getOrDefault(Object key, T defaultValue)</code> to retrieve a value (cast to a <code>T</code>) or
fall back to a default one if the <code>Context</code> instance does not have that key.</p>
</li>
<li>
<p>Use <code>getOrEmpty(Object key)</code> to get an <code>Optional&lt;T&gt;</code> (the <code>Context</code> instance attempts to cast the
stored value to <code>T</code>).</p>
</li>
<li>
<p>Use <code>delete(Object key)</code> to remove the value associated to a key, returning a new
<code>Context</code>.</p>
</li>
<li>
<p>é®åå¼é½æ¯ç±»åObjectï¼å æ­¤Contextå®ä¾å¯ä»¥åå«æ¥èªä¸ååºåæºçä»»ææ°éçé«åº¦ä¸åçå¼ã</p>
</li>
<li>
<p>Contextæ¯ä¸å¯åçã</p>
</li>
<li>
<p>ä½¿ç¨put(Object key, Object value)å­å¨ä¸ä¸ªé®å¼å¯¹ï¼è¿åä¸ä¸ªæ°ç Contextå®ä¾ãæ¨è¿å¯ä»¥ä½¿ç¨å°ä¸¤ä¸ªä¸ä¸æåå¹¶å°ä¸ä¸ªæ°çä¸ä¸æä¸­ putAll(Context)ã</p>
</li>
<li>
<p>æ¨å¯ä»¥æ£æ¥å¯é¥æ¯å¦å­å¨hasKey(Object key)ã</p>
</li>
<li>
<p>ä½¿ç¨getOrDefault(Object key, T defaultValue)æ£ç´¢å¼ï¼å¼ºå¶è½¬æ¢ä¸ºTï¼ï¼æéåå°ä¸ä¸ªé»è®¤çï¼å¦æContextå®ä¾æ²¡æè¿æé¥åã</p>
</li>
<li>
<p>ä½¿ç¨getOrEmpty(Object key)å¾å°çOptional&lt;T&gt;ï¼è¯¥Contextå®ä¾å°è¯æçå­å¨å¼Tï¼ã</p>
</li>
<li>
<p>ä½¿ç¨delete(Object key)å é¤å³èå°ä¸ä¸ªé®çå¼ï¼è¿åä¸ä¸ªæ°ç Contextã</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you create a <code>Context</code>, you can create pre-valued <code>Context</code> instances with up to five
key-value pairs by using the static <code>Context.of</code> methods. They take 2, 4, 6, 8 or 10
<code>Object</code> instances, each couple of <code>Object</code> instances being a key-value pair to add to
the <code>Context</code>.</p>
</div>
<div class="paragraph">
<p>åå»ºæ¶Contextï¼æ¨å¯ä»¥Contextä½¿ç¨éæContext.ofæ¹æ³åå»ºæå¤åå«äºä¸ªé®å¼å¯¹çé¢å¼å®ä¾ã
å®ä»¬éè¦2ã4ã6ã8æ10ä¸ª Objectå®ä¾ï¼æ¯å¯¹Objectå®ä¾é½æ¯è¦æ·»å å°çé®å¼å¯¹Contextã</p>
</div>
<div class="paragraph">
<p>Alternatively you can also create an empty <code>Context</code> by using <code>Context.empty()</code>.</p>
</div>
<div class="paragraph">
<p>æèï¼æ¨ä¹å¯ä»¥Contextä½¿ç¨åå»ºç©ºç½Context.empty()ã</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="context.write"><a class="anchor" href="#context.write"></a>9.8.2. Tying a <code>Context</code> to a <code>Flux</code> and Writing</h4>
<div class="paragraph">
<p>To make a <code>Context</code> be useful, it must be tied to a specific sequence and be accessible by
each operator in a chain. Note that the operator must be a Reactor-native operator, as
<code>Context</code> is specific to Reactor.</p>
</div>
<div class="paragraph">
<p>ä¸ºäºä½¿å®Contextæç¨ï¼å®å¿é¡»ç»å®å°ç¹å®çåºåï¼å¹¶ä¸é¾ä¸­çæ¯ä¸ªæä½åé½å¯ä»¥è®¿é®ã
è¯·æ³¨æï¼è¿ç®ç¬¦å¿é¡»æ¯Reactoræ¬æºè¿ç®ç¬¦ï¼è¿ Contextæ¯ç¹å®äºReactorçã</p>
</div>
<div class="paragraph">
<p>Actually, a <code>Context</code> is tied to each <code>Subscriber</code> in a chain. It uses the <code>Subscription</code>
propagation mechanism to make itself available to each operator, starting with the final
<code>subscribe</code> and moving up the chain.</p>
</div>
<div class="paragraph">
<p>å®éä¸ï¼Contextæ¯ç»å®å¨é¾ä¸­çæ¯ä¸ä¸ªSubscriberãå®ä½¿ç¨Subscription ä¼ æ­æºå¶ä½¿æ¯ä¸ªæä½åé½å¯ä»¥ä½¿ç¨ï¼ä»æç»æä½å¼å§ï¼ subscribeç¶ååä¸ç§»å¨ã</p>
</div>
<div class="paragraph">
<p>In order to populate the <code>Context</code>, which can only be done at subscription time, you need
to use the <code>subscriberContext</code> operator.</p>
</div>
<div class="paragraph">
<p>ä¸ºäºå¡«åContextåªè½å¨è®¢éè¿è¡æ¶å»å®æï¼æ¨éè¦ä½¿ç¨subscriberContextè¿ç®ç¬¦ã</p>
</div>
<div class="paragraph">
<p><code>subscriberContext(Context)</code> merges the <code>Context</code> you provide and the
<code>Context</code> from downstream (remember, the <code>Context</code> is propagated from the bottom of the
chain towards the top). This is done through a call to <code>putAll</code>, resulting in a new
<code>Context</code> for upstream.</p>
</div>
<div class="paragraph">
<p>subscriberContext(Context)åå¹¶Contextæ¨æä¾çåå®¹å Contextæ¥èªä¸æ¸¸çåå®¹ï¼è¯·è®°ä½ï¼Contextæ¯ä»é¾çåºé¨åé¡¶é¨ä¼ æ­çï¼ã
è¿æ¯éè¿è°ç¨æ¥å®æçputAllï¼ä»èä¸ºä¸æ¸¸åå»ºäºä¸ä¸ªæ°ç Contextã</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the more advanced <code>subscriberContext(Function&lt;Context, Context&gt;)</code>.
It receives the state of the <code>Context</code> from downstream, lets you put or delete values
as you see fit, and returns the new <code>Context</code> to use. You can even decide to return a
completely different instance, although it is really not recommended (doing so might
impact third-party libraries that depend on the <code>Context</code>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
æ¨ä¹å¯ä»¥ä½¿ç¨æ´é«çº§çsubscriberContext(Function&lt;Context, Context&gt;)ã
å®Contextä»ä¸æ¸¸æ¥æ¶çç¶æï¼è®©æ¨æ ¹æ®éè¦æ¾ç½®æå é¤å¼ï¼å¹¶è¿åContextè¦ä½¿ç¨çæ°å¼ãæ¨çè³å¯ä»¥å³å®è¿åä¸ä¸ªå®å¨ä¸åçå®ä¾ï¼å°½ç®¡å®éä¸ä¸å»ºè®®è¿æ ·åï¼è¿æ ·åå¯è½ä¼å½±åä¾èµçç¬¬ä¸æ¹åºContextï¼ã
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="context.read"><a class="anchor" href="#context.read"></a>9.8.3. Reading a <code>Context</code></h4>
<div class="paragraph">
<p>Once you haved populated a <code>Context</code>, you can retrieve that data.
Most of the time, the responsibility of putting information into the <code>Context</code>
is on the end user&#8217;s side, while exploiting that information is on the third-party library&#8217;s side,
as such libraries are usually upstream of the client code.</p>
</div>
<div class="paragraph">
<p>å¡«ååContextï¼æ¨å¯ä»¥æ£ç´¢è¯¥æ°æ®ãå¨å¤§å¤æ°æåµä¸ï¼å°ä¿¡æ¯æ¾å¥çè´£ä»»Context å¨æç»ç¨æ·ä¸æ¹ï¼èå©ç¨ä¿¡æ¯çè´£ä»»å¨ç¬¬ä¸æ¹åºçä¸æ¹ï¼å ä¸ºæ­¤ç±»åºéå¸¸ä½äºå®¢æ·ç«¯ä»£ç çä¸æ¸¸ã</p>
</div>
<div class="paragraph">
<p>The tool for reading data from the context is the static <code>Mono.subscriberContext()</code>
method.</p>
</div>
<div class="paragraph">
<p>ä»ä¸ä¸æè¯»åæ°æ®çå·¥å·çéææ¹æ³æ¯ Mono.subscriberContext() ã</p>
</div>
</div>
<div class="sect3">
<h4 id="_simple_context_examples"><a class="anchor" href="#_simple_context_examples"></a>9.8.4. Simple <code>Context</code> Examples</h4>
<div class="paragraph">
<p>The examples in this section are meant as ways to better understand some of the caveats of
using a <code>Context</code>.</p>
</div>
<div class="paragraph">
<p>æ¬èä¸­çç¤ºä¾æ¨å¨æ´å¥½å°çè§£ä½¿ç¨Contextã</p>
</div>
<div class="paragraph">
<p>We first look back at our simple example from the introduction in a bit more detail, as
the following example shows:</p>
</div>
<div class="paragraph">
<p>é¦åï¼æä»¬å°æ´è¯¦ç»å°åé¡¾ä¸ä¸å¼è¨ä¸­çç®åç¤ºä¾ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r = Mono.just("Hello")
                .flatMap( s -&gt; Mono.subscriberContext() <i class="conum" data-value="2"></i><b>(2)</b>
                                   .map( ctx -&gt; s + " " + ctx.get(key))) <i class="conum" data-value="3"></i><b>(3)</b>
                .subscriberContext(ctx -&gt; ctx.put(key, "World")); <i class="conum" data-value="1"></i><b>(1)</b>

StepVerifier.create(r)
            .expectNext("Hello World") <i class="conum" data-value="4"></i><b>(4)</b>
            .verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The chain of operators ends with a call to <code>subscriberContext(Function)</code> that puts
<code>"World"</code> into the <code>Context</code> under a key of <code>"message"</code>. 	è¿ç®ç¬¦é¾çç»å°¾æ¯å¯¹çè°ç¨ï¼subscriberContext(Function)è¯¥ è°ç¨"World"æ¾å¥çContextå¯é¥ä¸"message"ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We <code>flatMap</code> on the source element, materializing the <code>Context</code> with <code>Mono.subscriberContext()</code>. æä»¬flatMapå¨æºåç´ ä¸ï¼Contextç¨ Mono.subscriberContext()å®ç°ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We then use <code>map</code> to extract the data associated to <code>"message"</code> and concatenate that with
the original word. ç¶åmapï¼æä»¬ç¨äºæå"message"ä¸åå§åè¯ç¸å³èçæ°æ®å¹¶å°å¶ä¸åå§åè¯è¿æ¥ã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The resulting <code>Mono&lt;String&gt;</code> emits <code>"Hello World"</code>. ç»æMono&lt;String&gt;ååº"Hello World"ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The numbering above versus the actual line order is not a mistake. It represents
the execution order. Even though <code>subscriberContext</code> is the last piece of the chain, it is
the one that gets executed first (due to its subscription-time nature and the fact that
the subscription signal flows from bottom to top).
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
ä¸é¢çç¼å·ä¸å®éçè¡é¡ºåºæ²¡æå³ç³»ãå®ä»£è¡¨æ§è¡é¡ºåºãå³ä½¿subscriberContextæ¯é¾çæåä¸é¨åï¼å®ä¹æ¯ç¬¬ä¸ä¸ªè¢«æ§è¡çï¼ç±äºå¶è®¢éæ¶é´çæ§è´¨ä»¥åè®¢éä¿¡å·ä»ä¸å°ä¸æµå¨çäºå®ï¼ã
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In your chain of operators, the relative positions of where you write to the
<code>Context</code> and where you read from it matters. The <code>Context</code>
is immutable and its content can only be seen by operators above it, as demonstrated in
the following example:
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
å¨æ¨çé¾ä¸­ï¼æ¨åé¾ä¸­åå¥ä½ç½®çContextåä»ä¸­è¯»åçä½ç½®çç¸å¯¹ä½ç½®å¾éè¦ãå ä¸ºContext æ¯ä¸å¯åçï¼å®çåå®¹åªè½ç±ä¸é¢è¿ç®ç¬¦çåºï¼å¦å¨ä¸é¢çä¾å­æç¤ºï¼
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r = Mono.just("Hello")
                     .subscriberContext(ctx -&gt; ctx.put(key, "World")) <i class="conum" data-value="1"></i><b>(1)</b>
                     .flatMap( s -&gt; Mono.subscriberContext()
                                        .map( ctx -&gt; s + " " + ctx.getOrDefault(key, "Stranger")));  <i class="conum" data-value="2"></i><b>(2)</b>

StepVerifier.create(r)
            .expectNext("Hello Stranger") <i class="conum" data-value="3"></i><b>(3)</b>
            .verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Context</code> is written to too high in the chain. 	å¨Contextè¢«åå¥é¾å¤ªé«ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As a result, in the <code>flatMap</code>, there is no value associated with our key. A default value
is used instead. ç»æï¼å¨ä¸­flatMapï¼æ²¡æä¸æä»¬çå¯é¥å³èçå¼ãèæ¯ä½¿ç¨é»è®¤å¼ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The resulting <code>Mono&lt;String&gt;</code> thus emits <code>"Hello Stranger"</code>. ç»æMono&lt;String&gt;ç±æ­¤ååº"Hello Stranger"ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example also demonstrates the immutable nature of the <code>Context</code>, and how
<code>Mono.subscriberContext()</code> always returns the <code>Context</code> set by <code>subscriberContext</code> calls:</p>
</div>
<div class="paragraph">
<p>ä»¥ä¸ç¤ºä¾è¿æ¼ç¤ºäºçä¸åæ§è´¨Contextï¼ä»¥å Mono.subscriberContext()å¦ä½å§ç»éè¿subscriberContextè°ç¨è¿åContextéåï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";

Mono&lt;String&gt; r = Mono.subscriberContext() <i class="conum" data-value="1"></i><b>(1)</b>
	.map( ctx -&gt; ctx.put(key, "Hello")) <i class="conum" data-value="2"></i><b>(2)</b>
	.flatMap( ctx -&gt; Mono.subscriberContext()) <i class="conum" data-value="3"></i><b>(3)</b>
	.map( ctx -&gt; ctx.getOrDefault(key,"Default")); <i class="conum" data-value="4"></i><b>(4)</b>

StepVerifier.create(r)
	.expectNext("Default") <i class="conum" data-value="5"></i><b>(5)</b>
	.verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We materialize the <code>Context</code> æä»¬å®ç° Context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In a <code>map</code> we attempt to mutate it å¨mapæä»¬å°è¯æ´æ°å®</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We re-materialize the <code>Context</code> in a <code>flatMap</code> 	æä»¬éæ°å®ç°ContextäºflatMap</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We read the attempted key in the <code>Context</code> æä»¬è¯»åContextä¸­çå¼</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The key was never set to <code>"Hello"</code>. å¯é¥ä»æªè®¾ç½®ä¸º"Hello"ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, in the case of several attempts to write the same key to the <code>Context</code>, the
relative order of the writes matters, too. Operators that read the <code>Context</code> see
the value that was set closest to being under them, as demonstrated in the following example:</p>
</div>
<div class="paragraph">
<p>åæ ·ï¼å¨å¤æ¬¡å°è¯ååå¥ç¸åå¯é¥çæåµä¸ï¼åå¥Contextçç¸å¯¹é¡ºåºä¹å¾éè¦ã
è¯»åContextseeçè¿ç®ç¬¦å°çå°è®¾ç½®ä¸ºææ¥è¿å¶å¼çå¼ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r = Mono.just("Hello")
                .flatMap( s -&gt; Mono.subscriberContext()
                                   .map( ctx -&gt; s + " " + ctx.get(key)))
                .subscriberContext(ctx -&gt; ctx.put(key, "Reactor")) <i class="conum" data-value="1"></i><b>(1)</b>
                .subscriberContext(ctx -&gt; ctx.put(key, "World")); <i class="conum" data-value="2"></i><b>(2)</b>

StepVerifier.create(r)
            .expectNext("Hello Reactor") <i class="conum" data-value="3"></i><b>(3)</b>
            .verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A write attempt on key <code>"message"</code>. å¯¹keyçåå°è¯"message"ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Another write attempt on key <code>"message"</code>. å¯¹keyçå¦ä¸æ¬¡åå°è¯"message"ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>map</code> only saw the value set closest to it (and below it): <code>"Reactor"</code>. è¯¥mapåªçè§å¼ææ¥è¿çè®¾ç½®ä¸ºå®ï¼åå®ä¸é¢ï¼"Reactor"ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, the <code>Context</code> is populated with <code>"World"</code> during subscription.
Then the subscription signal moves upstream and another write happens. This produces a
second immutable <code>Context</code> with a value of <code>"Reactor"</code>. After that, data starts flowing.
The <code>flatMap</code> sees the <code>Context</code> closest to it, which is our second <code>Context</code> with the
<code>"Reactor"</code> value.</p>
</div>
<div class="paragraph">
<p>å¨åé¢çç¤ºä¾ä¸­ï¼å¨è®¢éæé´Contextå¡«å"World"ãç¶åï¼è®¢éä¿¡å·åä¸æ¸¸ç§»å¨ï¼å¹¶åçå¦ä¸æ¬¡åæä½ãè¿å°äº§çç¬¬äºä¸ªä¸å¯åContextå¼"Reactor"ã
ä¹åï¼æ°æ®å¼å§æµå¨ãå¨flatMapçå°Contextææ¥è¿äºå®ï¼è¿æ¯æä»¬ç¬¬äºæ¬¡Contextä¸ "Reactor"ä»·å¼ã</p>
</div>
<div class="paragraph">
<p>You might wonder if the <code>Context</code> is propagated along with the data signal. If that was
the case, putting another <code>flatMap</code> between these two writes would use the value from
the top <code>Context</code>. But this is not the case, as demonstrated by the following example:</p>
</div>
<div class="paragraph">
<p>æ¨å¯è½æ³ç¥éContextæ¯å¦éæ°æ®ä¿¡å·ä¸èµ·ä¼ æ­ãå¦ææ¯è¿ç§æåµï¼flatMapå¨è¿ä¸¤æ¬¡åå¥ä¹é´æ¾ç½®å¦ä¸ä¸ªå°ä½¿ç¨æé¡¶ä¸çContextå¼ã
ä½è¿ä¸æ¯äºå®ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r = Mono.just("Hello")
                     .flatMap( s -&gt; Mono.subscriberContext()
                                        .map( ctx -&gt; s + " " + ctx.get(key))) <i class="conum" data-value="3"></i><b>(3)</b>
                     .subscriberContext(ctx -&gt; ctx.put(key, "Reactor")) <i class="conum" data-value="2"></i><b>(2)</b>
                     .flatMap( s -&gt; Mono.subscriberContext()
                                        .map( ctx -&gt; s + " " + ctx.get(key))) <i class="conum" data-value="4"></i><b>(4)</b>
                     .subscriberContext(ctx -&gt; ctx.put(key, "World")); <i class="conum" data-value="1"></i><b>(1)</b>

StepVerifier.create(r)
            .expectNext("Hello Reactor World") <i class="conum" data-value="5"></i><b>(5)</b>
            .verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the first write to happen. è¿æ¯ç¬¬ä¸æ¬¡åå¥ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the second write to happen. è¿æ¯ç¬¬äºæ¬¡åå¥ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first <code>flatMap</code> sees second write. 	ç¬¬ä¸ä¸ªflatMapçå°ç¬¬äºä¸ªå</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The second <code>flatMap</code> concatenates the result from first one with the value from the first write. ç¬¬äºä¸ªflatMapå°ç¬¬ä¸ä¸ªç»æä¸ç¬¬ä¸æ¬¡åå¥çå¼è¿æ¥å¨ä¸èµ·ã</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>Mono</code> emits <code>"Hello Reactor World"</code>. è¯¥Monoåå°"Hello Reactor World"ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The reason is that the <code>Context</code> is associated to the <code>Subscriber</code> and each operator
accesses the <code>Context</code> by requesting it from its downstream <code>Subscriber</code>.</p>
</div>
<div class="paragraph">
<p>åå æ¯âContextâä¸âSubscriberâåæ¯ä¸ªè¿ç®ç¬¦ç¸å³èï¼éè¿ä»å¶ä¸æ¸¸çâSubscriberâä¸­è¯·æ±æ¥è®¿é®âContextâã</p>
</div>
<div class="paragraph">
<p>One last interesting propagation case is the one where the <code>Context</code> is also written to
inside a <code>flatMap</code>, as in the following example:</p>
</div>
<div class="paragraph">
<p>æåä¸ç§æè¶£çä¼ æ­æåµæ¯å°âContextâä¹åå¥å¶ä¸­çæåµå¨â flatMapâä¸­ï¼å¦ä»¥ä¸ç¤ºä¾æç¤ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String key = "message";
Mono&lt;String&gt; r =
        Mono.just("Hello")
            .flatMap( s -&gt; Mono.subscriberContext()
                               .map( ctx -&gt; s + " " + ctx.get(key))
            )
            .flatMap( s -&gt; Mono.subscriberContext()
                               .map( ctx -&gt; s + " " + ctx.get(key))
                               .subscriberContext(ctx -&gt; ctx.put(key, "Reactor")) <i class="conum" data-value="1"></i><b>(1)</b>
            )
            .subscriberContext(ctx -&gt; ctx.put(key, "World")); <i class="conum" data-value="2"></i><b>(2)</b>

StepVerifier.create(r)
            .expectNext("Hello World Reactor")
            .verifyComplete();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This <code>subscriberContext</code> does not impact anything outside of its <code>flatMap</code>. è¿ä¸ªâ subscriberContextâä¸ä¼å½±åå¶â flatMapâä¹å¤çä»»ä½åå®¹ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This <code>subscriberContext</code> impacts the main sequence&#8217;s <code>Context</code>. è¿ä¸ªâ subscriberContextâä¼å½±åä¸»åºåçâ Contextâã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, the final emitted value is <code>"Hello World Reactor"</code> and not "Hello
Reactor World", because the <code>subscriberContext</code> that writes <code>"Reactor"</code> does so as part of
the inner sequence of the second <code>flatMap</code>. As a consequence, it is not visible or propagated
through the main sequence and the first <code>flatMap</code> does not see it. Propagation and immutability
isolate the <code>Context</code> in operators that create intermediate inner sequences such as <code>flatMap</code>.</p>
</div>
<div class="paragraph">
<p>å¨åé¢çç¤ºä¾ä¸­ï¼æç»ååºçå¼ä¸ºâHello World Reactorâï¼èä¸æ¯â Hello Reactor Worldâï¼å ä¸ºåæâ Reactorâçâ subscriberContextâæ¯ä½ä¸ºç¬¬äºä¸ªâflatMapâçåé¨åºåçä¸é¨åã
ç»æï¼å®ä¸å¯è§æä¼ æ­éè¿ä¸»åºåï¼ç¬¬ä¸ä¸ª`flatMap`çä¸å°å®ã ä¼ æ­åä¸åæ§å°âContextâéç¦»å¨åå»ºä¸­é´åé¨åºåï¼ä¾å¦â flatMapâï¼çè¿ç®ç¬¦ä¸­ã</p>
</div>
</div>
<div class="sect3">
<h4 id="_full_example"><a class="anchor" href="#_full_example"></a>9.8.5. Full Example</h4>
<div class="paragraph">
<p>Now we can consider a more real life example of a library reading information from the <code>Context</code>:
a reactive HTTP client that takes a <code>Mono&lt;String&gt;</code> as the source of data for a <code>PUT</code> but
also looks for a particular Context key to add a correlation ID to the request&#8217;s headers.</p>
</div>
<div class="paragraph">
<p>ç°å¨ï¼æä»¬å¯ä»¥èèä¸ä¸ªæ´ç°å®çä¾å­ï¼è¯¥å¾ä¹¦é¦ä»ä¸­è¯»åä¿¡æ¯Contextï¼
ä¸ä¸ªååºæ§HTTPå®¢æ·ç«¯ï¼è¯¥å®¢æ·ç«¯å° Mono&lt;String&gt;ä½ä¸ºçæ°æ®æºï¼PUTåæ¶è¿å¯»æ¾ä¸ä¸ªç¹å®çContexté®ï¼ä»¥å°ç¸å³IDæ·»å å°è¯·æ±çæ å¤´ä¸­ã</p>
</div>
<div class="paragraph">
<p>From the user perspective, it is called as follows:</p>
</div>
<div class="paragraph">
<p>ä»ç¨æ·çè§åº¦æ¥çï¼å®ç§°ä¸ºï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">doPut("www.example.com", Mono.just("Walter"))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In order to propagate a correlation ID, it would be called as follows:</p>
</div>
<div class="paragraph">
<p>ä¸ºäºä¼ æ­ç¸å³æ§IDï¼å°å¶ç§°ä¸ºå¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">doPut("www.example.com", Mono.just("Walter"))
	.subscriberContext(Context.of(HTTP_CORRELATION_ID, "2-j3r9afaf92j-afkaf"))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As the preceding snippets show, the user code uses <code>subscriberContext</code> to populate
a <code>Context</code> with an <code>HTTP_CORRELATION_ID</code> key-value pair. The upstream of the operator is
a <code>Mono&lt;Tuple2&lt;Integer, String&gt;&gt;</code> (a simplistic representation of an HTTP response)
returned by the HTTP client library. So it effectively passes information from the
user code to the library code.</p>
</div>
<div class="paragraph">
<p>å¦åé¢ççæ®µæç¤ºï¼ç¨æ·ä»£ç ä½¿ç¨`subscriberContext`è¿è¡å¡«åå·æâ HTTP_CORRELATION_IDâé®å¼å¯¹çâContextâã æä½åçä¸æ¸¸æ¯
ä¸ä¸ªMono &lt;Tuple2 &lt;Integerï¼String &gt;&gt;`ï¼HTTPååºçç®åè¡¨ç¤ºï¼
ç±HTTPå®¢æ·ç«¯åºè¿åã å æ­¤å®ææå°ä¼ éäºæ¥èªç¨æ·ä»£ç å°åºä»£ç ã</p>
</div>
<div class="paragraph">
<p>The following example shows mock code from the library&#8217;s perspective that reads the
context and &#8220;augments the request&#8221; if it can find the correlation ID:</p>
</div>
<div class="paragraph">
<p>ä»¥ä¸ç¤ºä¾ä»åºçè§åº¦æ¾ç¤ºäºæ¨¡æä»£ç ï¼è¯¥ä»£ç è¯»åäºcontextåâ<code>augments the request</code>âï¼å¦æå¯ä»¥æ¾å°ç¸å³IDï¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">static final String HTTP_CORRELATION_ID = "reactive.http.library.correlationId";

Mono&lt;Tuple2&lt;Integer, String&gt;&gt; doPut(String url, Mono&lt;String&gt; data) {
	Mono&lt;Tuple2&lt;String, Optional&lt;Object&gt;&gt;&gt; dataAndContext =
			data.zipWith(Mono.subscriberContext() <i class="conum" data-value="1"></i><b>(1)</b>
			                 .map(c -&gt; c.getOrEmpty(HTTP_CORRELATION_ID))); <i class="conum" data-value="2"></i><b>(2)</b>

	return dataAndContext
			.&lt;String&gt;handle((dac, sink) -&gt; {
				if (dac.getT2().isPresent()) { <i class="conum" data-value="3"></i><b>(3)</b>
					sink.next("PUT &lt;" + dac.getT1() + "&gt; sent to " + url + " with header X-Correlation-ID = " + dac.getT2().get());
				}
				else {
					sink.next("PUT &lt;" + dac.getT1() + "&gt; sent to " + url);
				}
				sink.complete();
			})
			.map(msg -&gt; Tuples.of(200, msg));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Materialize the <code>Context</code> through <code>Mono.subscriberContext()</code>. éè¿ Mono.subscriberContext() å®ç°Context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extract a value for a the correlation ID key, as an <code>Optional</code>. æåç¸å³æ§IDå¯é¥çå¼ï¼ä½ä¸ºOptionalã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the key was present in the context, use the correlation ID as a header. 	å¦æå¯é¥å­å¨äºcontextä¸­ï¼åå°ç¸å³æ§IDç¨ä½æ é¢ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The library snippet zips the data <code>Mono</code> with
<code>Mono.subscriberContext()</code>. This gives the library a <code>Tuple2&lt;String, Context&gt;</code>, and that
context contains the <code>HTTP_CORRELATION_ID</code> entry from downstream (as it is on the direct
path to the subscriber).</p>
</div>
<div class="paragraph">
<p>åºçæ®µå°æ°æ®`Mono`åç¼©ä¸º`Mono.subscriberContextï¼ï¼<code>ã è¿ç»åºä¸ä¸ª`Tuple2 &lt;Stringï¼Context&gt;</code>ï¼å¹¶ä¸
ä¸ä¸æåå«æ¥èªä¸æ¸¸çHTTP_CORRELATION_IDæ¡ç®ï¼å ä¸ºå®ä½äºç´æ¥è®¢æ·çè·¯å¾ï¼ã</p>
</div>
<div class="paragraph">
<p>The library code then uses <code>map</code> to extract an <code>Optional&lt;String&gt;</code> for that key, and, if
the entry is present, it uses the passed correlation ID as a <code>X-Correlation-ID</code> header.
That last part is simulated by the <code>handle</code>.</p>
</div>
<div class="paragraph">
<p>ç¶åï¼åºä»£ç mapç¨äºæåOptional&lt;String&gt;è¯¥å¯é¥çï¼å¹¶ä¸ï¼å¦æå­å¨è¯¥æ¡ç®ï¼å®å°ä½¿ç¨ä¼ éçç¸å³IDä½ä¸ºX-Correlation-IDæ å¤´ãæåä¸é¨åç±è¿è¡æ¨¡æhandleã</p>
</div>
<div class="paragraph">
<p>The whole test that validates the library code used the correlation ID can be written as
follows:</p>
</div>
<div class="paragraph">
<p>éªè¯ä½¿ç¨ç¸å³IDçåºä»£ç çæ´ä¸ªæµè¯å¯ä»¥ç¼åå¦ä¸ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void contextForLibraryReactivePut() {
	Mono&lt;String&gt; put = doPut("www.example.com", Mono.just("Walter"))
			.subscriberContext(Context.of(HTTP_CORRELATION_ID, "2-j3r9afaf92j-afkaf"))
			.filter(t -&gt; t.getT1() &lt; 300)
			.map(Tuple2::getT2);

	StepVerifier.create(put)
	            .expectNext("PUT &lt;Walter&gt; sent to www.example.com with header X-Correlation-ID = 2-j3r9afaf92j-afkaf")
	            .verifyComplete();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cleanup"><a class="anchor" href="#cleanup"></a>9.9. Dealing with Objects that Need Cleanup</h3>
<div class="paragraph">
<p>In very specific cases, your application may deal with types that necessitate some form of cleanup once they are no longer in use.
This is an advanced scenario&#8201;&#8212;&#8201;for, example when you have reference-counted objects or when you deal with off-heap objects.
Netty&#8217;s <code>ByteBuf</code> is a prime example of both.</p>
</div>
<div class="paragraph">
<p>å¨éå¸¸ç¹å®çæåµä¸ï¼æ¨çåºç¨ç¨åºå¯è½ä¼å¤çä¸åéè¦ä½¿ç¨æç§å½¢å¼çæ¸ççç±»åãè¿æ¯ä¸ç§é«çº§æ¹æ¡ï¼ä¾å¦ï¼å½æ¨æå¼ç¨è®¡æ°çå¯¹è±¡æå¤çå å¤å¯¹è±¡æ¶ãNetty ByteBufæ¯è¿ä¸¤èçå¸åä¾å­ã</p>
</div>
<div class="paragraph">
<p>In order to ensure proper cleanup of such objects, you need to account for it on a <code>Flux</code>-by-<code>Flux</code> basis, as well as in several of the global hooks (see <a href="#hooks">Using Global Hooks</a>):</p>
</div>
<div class="paragraph">
<p>ä¸ºäºç¡®ä¿æ­£ç¡®æ¸çæ­¤ç±»å¯¹è±¡ï¼æ¨éè¦åºäºâ Fluxâï¼éä¸ªï¼â Fluxâä»¥åå¤ä¸ªå¨å±æé©ï¼see <a href="#hooks">Using Global Hooks</a>ï¼è¿è¡èèï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>doOnDiscard</code> <code>Flux</code>/<code>Mono</code> operator</p>
</li>
<li>
<p>The <code>onOperatorError</code> hook</p>
</li>
<li>
<p>The <code>onNextDropped</code> hook</p>
</li>
<li>
<p>Operator-specific handlers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is needed because each hook is made with a specific subset of cleanup in mind, and users might want (for example) to implement specific error-handling logic in addition to cleanup logic within <code>onOperatorError</code>.</p>
</div>
<div class="paragraph">
<p>ä¹æä»¥éè¦è¿æ ·åï¼æ¯å ä¸ºæ¯ä¸ªæé©é½æ¯æ ¹æ®ç¹å®çæ¸çå­éæ¥è¿è¡çï¼å¹¶ä¸ç¨æ·å¯è½å¸æï¼ä¾å¦ï¼é¤ä¸­çæ¸çé»è¾ä¹å¤è¿å®ç°ç¹å®çéè¯¯å¤çé»è¾onOperatorErrorã</p>
</div>
<div class="paragraph">
<p>Note that some operators are less adapted to dealing with objects that need cleanup.
For example, <code>bufferWhen</code> can introduce overlapping buffers, and that means that the discard &#8220;local hook&#8221; we used earlier might see a first buffer as being discarded and cleanup an element in it that is in a second buffer, where it is still valid.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼æäºè¿ç®ç¬¦ä¸å¤ªéåå¤çéè¦æ¸é¤çå¯¹è±¡ã
ä¾å¦ï¼â bufferWhenâå¯ä»¥å¼å¥éå çç¼å²åºï¼è¿æå³çæä»¬åé¢ä½¿ç¨çä¸¢å¼â local hookâå¯è½ä¼çå°ç¬¬ä¸ä¸ªç¼å²åºè¢«ä¸¢å¼ï¼å¹¶æ¸çå¶ä¸­ç¬¬äºä¸ªç¼å²åºä¸­çåç´ ã ä»ç¶ææã</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For the purpose of cleaning up, <strong>all these hooks MUST be IDEMPOTENT</strong>.
They might on some occasions get applied several times to the same object.
Unlike the <code>doOnDiscard</code> operator, which performs a class-level <code>instanceOf</code> check, the global hooks are also dealing with instances that can be any <code>Object</code>. It is up to the user&#8217;s implementation to distinguish between which instances need cleanup and which do not.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
ä¸ºäºæ¸çèµ·è§ï¼<strong>ææè¿äºé©å­å¿é¡»æ¯ç¡®å®ç</strong>ã
å¨æäºæåµä¸ï¼å®ä»¬å¯è½ä¼å¤æ¬¡åºç¨äºåä¸å¯¹è±¡ã
ä¸æ§è¡ç±»çº§å«çinstanceOfæ£æ¥çdoOnDiscardè¿ç®ç¬¦ä¸åï¼å¨å±æé©ä¹å¤çå¯ä»¥æ¯ä»»ä½Objectçå®ä¾ã ç±ç¨æ·çå®ç°æ¥åºååªäºå®ä¾éè¦æ¸é¤ï¼åªäºä¸éè¦ã
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_the_doondiscard_operator_or_local_hook"><a class="anchor" href="#_the_doondiscard_operator_or_local_hook"></a>9.9.1. The <code>doOnDiscard</code> Operator or Local Hook</h4>
<div class="paragraph">
<p>This hook has been specifically put in place for cleanup of objects that would otherwise never be exposed to user code.
It is intended as a cleanup hook for flows that operate under normal circumstances (not malformed sources that push too many items, which is covered by <code>onNextDropped</code>).</p>
</div>
<div class="paragraph">
<p>è¯¥æé©ä¸é¨ç¨äºæ¸çå¯¹è±¡ï¼å¦åè¿äºå¯¹è±¡å°æ°¸è¿ä¸ä¼æ´é²ç»ç¨æ·ä»£ç ã
å®æ¨å¨ç¨ä½å¨æ­£å¸¸æåµä¸è¿è¡çæµçæ¸çé©å­ï¼ä¸æ¯æ ¼å¼éè¯¯çæºï¼ç¨äºæ¨éè¿å¤çé¡¹ç®ï¼è¿ç±`onNextDropped`è¦çï¼ã</p>
</div>
<div class="paragraph">
<p>It is local, in the sense that it is activated through an operator and applies only to a given <code>Flux</code> or <code>Mono</code>.</p>
</div>
<div class="paragraph">
<p>å®æ¯æ¬å°çï¼ä»æç§æä¹ä¸è¯´ï¼å®æ¯éè¿æ¿æ´»æä½ç¬¦ï¼å¹¶ä¸ä»éç¨äºç»å®çFluxæMonoã</p>
</div>
<div class="paragraph">
<p>Obvious cases include operators that filter elements from upstream.
These elements never reach the next operator (or final subscriber), but this is part of the normal path of execution.
As such, they are passed to the <code>doOnDiscard</code> hook.
Examples of when you might use the <code>doOnDiscard</code> hook include the following:</p>
</div>
<div class="paragraph">
<p>ææ¾çæåµåæ¬ä»ä¸æ¸¸è¿æ»¤åç´ çè¿ç®ç¬¦ãè¿äºåç´ æ°¸è¿ä¸ä¼å°è¾¾ä¸ä¸ä¸ªè¿ç®ç¬¦ï¼ææç»è®¢æ·ï¼ï¼ä½è¿æ¯æ­£å¸¸æ§è¡è·¯å¾çä¸é¨åã
è¿æ ·ï¼å®ä»¬å°±ä¼ éç»äºdoOnDiscardé©å­ãä½æ¶ä½¿ç¨doOnDiscardæé©çç¤ºä¾åæ¬ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>filter</code>: Items that do not match the filter are considered to be &#8220;discarded.&#8221; ä¸è¿æ»¤å¨ä¸å¹éçé¡¹ç®è¢«è§ä¸ºâå·²ä¸¢å¼âã</p>
</li>
<li>
<p><code>skip</code>: Skipped items are discarded. è·³è¿çé¡¹ç®å°è¢«ä¸¢å¼</p>
</li>
<li>
<p><code>buffer(maxSize, skip)</code> with <code>maxSize &lt; skip</code>: A &#8220;dropping buffer&#8221;&#8201;&#8212;&#8201;items in between buffers are discarded. ä¸ä¸ªâä¸¢å¼ç¼å²åºâ âç¼å²åºä¹é´çé¡¹ç®è¢«ä¸¢å¼ã</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But <code>doOnDiscard</code> is not limited to filtering operators, and is also used by operators that internally queue data for backpressure purposes.
More specifically, most of the time, this is important during cancellation. An operator that prefetches data from its source and later drains to its subscriber upon demand could have un-emitted data when it gets cancelled.
Such operators use the <code>doOnDiscard</code> hook during cancellation to clear up their internal backpressure <code>Queue</code>.</p>
</div>
<div class="paragraph">
<p>ä½æ¯`doOnDiscard`ä¸ä»éäºè¿æ»¤è¿ç®ç¬¦ï¼è¿è¢«åé¨æéæ°æ®ä»¥ç¨äºååç®ççè¿ç®ç¬¦ä½¿ç¨ã
æ´å·ä½å°è¯´ï¼å¨å¤§å¤æ°æåµä¸ï¼è¿å¨åæ¶æé´å¾éè¦ã ä»å¶æºä¸­é¢åæ°æ®ï¼ç¶åæ ¹æ®éè¦æå°å¶è®¢éèä¸çæä½ç¬¦å¨åæ¶æ°æ®æ¶å¯è½ä¼æ¶å°æªåå°çæ°æ®ã
è¿æ ·çæä½åå¨åæ¶æä½æé´ä½¿ç¨`doOnDiscard`æé©æ¥æ¸é¤å¶åé¨èå`Queue'ã</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Each call to <code>doOnDiscard(Class, Consumer)</code> is additive with the others, to the extent that it is visible and used by only operators upstream of it.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
æ¯æ¬¡å¯¹doOnDiscardï¼Classï¼Consumerï¼çè°ç¨é½ä¼ä¸å¶ä»è°ç¨ç¸å ï¼ä»¥ä½¿å¶åªè½è¢«å¶ä¸æ¸¸çæä½åçå°å¹¶ä½¿ç¨ã
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_onoperatorerror_hook"><a class="anchor" href="#_the_onoperatorerror_hook"></a>9.9.2. The <code>onOperatorError</code> hook</h4>
<div class="paragraph">
<p>The <code>onOperatorError</code> hook is intended to modify errors in a transverse manner (similar to an AOP catch-and-rethrow).</p>
</div>
<div class="paragraph">
<p>onOperatorErroré©å­æ¨å¨ä»¥æ¨ªåæ¹å¼ä¿®æ¹éè¯¯ï¼ç±»ä¼¼äºAOPçææåæåºï¼ã</p>
</div>
<div class="paragraph">
<p>When the error happens during the processing of an <code>onNext</code> signal, the element that was being emitted is passed to <code>onOperatorError</code>.</p>
</div>
<div class="paragraph">
<p>å½å¨å¤çonNextä¿¡å·æé´åçéè¯¯æ¶ï¼å°è¦ååºçåç´ ä¼ éç»onOperatorErrorã</p>
</div>
<div class="paragraph">
<p>If that type of element needs cleanup, you need to implement it in the <code>onOperatorError</code> hook, possibly on top of error-rewriting code.</p>
</div>
<div class="paragraph">
<p>å¦æéè¦æ¸é¤è¯¥ç±»åçåç´ ï¼åéè¦å¨onOperatorErroré©å­ä¸­å®ç°å®ï¼å¯è½å¨éè¯¯éåä»£ç çé¡¶é¨ã</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_onnextdropped_hook"><a class="anchor" href="#_the_onnextdropped_hook"></a>9.9.3. The <code>onNextDropped</code> Hook</h4>
<div class="paragraph">
<p>With malformed <code>Publishers</code>, there could be cases where an operator receives an element when it expected none (typically, after having received the <code>onError</code> or <code>onComplete</code> signals).
In such cases, the unexpected element is &#8220;dropped&#8221;&#8201;&#8212;&#8201;that is, passed to the <code>onNextDropped</code> hook.
If you have types that need cleanup, you must detect these in the <code>onNextDropped</code> hook and implement cleanup code there as well.</p>
</div>
<div class="paragraph">
<p>å¯¹äºæ ¼å¼éè¯¯çåå¸èï¼å¨æäºæåµä¸ï¼æä½åå¯è½ä¼å¨åç´ é¢ææ²¡æåç´ æ¶æ¶å°è¯¥åç´ ï¼éå¸¸æ¯å¨æ¶å°onErroræonCompleteä¿¡å·ä¹åï¼ã
å¨è¿ç§æåµä¸ï¼æå¤åç´ å°è¢«âä¸¢å¼âï¼å³ä¼ éç»onNextDroppedæé©ã å¦ææ¨æéè¦æ¸é¤çç±»åï¼åå¿é¡»å¨onNextDroppedæé©ä¸­æ£æµå°å®ä»¬ï¼å¹¶å¨å¶ä¸­ä¹æ§è¡æ¸é¤ä»£ç ã</p>
</div>
</div>
<div class="sect3">
<h4 id="_operator_specific_handlers"><a class="anchor" href="#_operator_specific_handlers"></a>9.9.4. Operator-specific Handlers</h4>
<div class="paragraph">
<p>Some operators that deal with buffers or collect values as part of their operations have specific handlers for cases where collected data is not propagated downstream.
If you use such operators with the type(s) that need cleanup, you need to perform cleanup in these handlers.</p>
</div>
<div class="paragraph">
<p>ä¸äºå¤çç¼å²åºæå¨å¶æä½è¿ç¨ä¸­æ¶éå¼çè¿ç®ç¬¦å·æç¹å®çå¤çç¨åºï¼ç¨äºæ¶éçæ°æ®ä¸åä¸æ¸¸ä¼ æ­çæåµã
å¦æå°æ­¤ç±»è¿ç®ç¬¦ä¸éè¦æ¸é¤çç±»åä¸èµ·ä½¿ç¨ï¼åéè¦å¨è¿äºå¤çç¨åºä¸­æ§è¡æ¸é¤ã</p>
</div>
<div class="paragraph">
<p>For example, <code>distinct</code> has such a callback that is invoked when the operator terminates (or is cancelled) in order to clear the collection it uses to judge whether an element is distinct or not.
By default, the collection is a <code>HashSet</code>, and the cleanup callback is a <code>HashSet::clear</code>.
However, if you deal with reference-counted objects, you might want to change that to a more involved handler that would <code>release</code> each element in the set before calling <code>clear()</code> on it.</p>
</div>
<div class="paragraph">
<p>ä¾å¦ï¼distinctå·æè¿æ ·çåè°ï¼å½æä½åç»æ­¢ï¼æåæ¶ï¼æ¶ï¼å°è°ç¨è¯¥åè°ï¼ä»¥æ¸é¤å¶ç¨äºå¤æ­åç´ æ¯å¦ä¸ä¼ä¸åçéåã
é»è®¤æåµä¸ï¼éåæ¯HashSetï¼æ¸çåè°æ¯HashSet :: clearã
ä½æ¯ï¼å¦æå¤çå¼ç¨è®¡æ°çå¯¹è±¡ï¼åå¯è½éè¦å°å¶æ´æ¹ä¸ºæ¶åæ´å¤çå¤çç¨åºï¼è¯¥å¤çç¨åºå¨è°ç¨clearï¼ï¼ä¹åä¼éæ¾éåä¸­çæ¯ä¸ªåç´ ã</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="null-safety"><a class="anchor" href="#null-safety"></a>9.10. Null Safety</h3>
<div class="paragraph">
<p>Although Java does not allow expressing null-safety with its type system, Reactor
now provides annotations to declare nullability of APIs, similar to those provided by
Spring Framework 5.</p>
</div>
<div class="paragraph">
<p>å°½ç®¡Javaä¸åè®¸ä½¿ç¨å¶ç±»åç³»ç»è¡¨ç¤ºç©ºå®å¨æ§ï¼ä½æ¯Reactorç°å¨æä¾äºæ³¨éæ¥å£°æAPIçç©ºæ§ï¼ç±»ä¼¼äºSpring Framework 5æä¾çæ³¨éã</p>
</div>
<div class="paragraph">
<p>Reactor uses these annotations, but they can also be used in any Reactor-based
Java project to declare null-safe APIs. Nullability of the types used inside method bodies
is outside of the scope of this feature.</p>
</div>
<div class="paragraph">
<p>Reactorä½¿ç¨è¿äºæ³¨éï¼ä½ä¹å¯ä»¥å¨ä»»ä½åºäºReactorçJavaé¡¹ç®ä¸­ä½¿ç¨å®ä»¬æ¥å£°æç©ºå®å¨çAPIã
æ¹æ³ä¸»ä½åä½¿ç¨çç±»åçå¯ç©ºæ§è¶åºäºæ­¤åè½çèå´ã</p>
</div>
<div class="paragraph">
<p>These annotations are meta-annotated with <a href="https://jcp.org/en/jsr/detail?id=305">JSR 305</a>
annotations (a dormant JSR that is supported by tools such as IntelliJ IDEA) to provide
useful warnings to Java developers related to null-safety in order to avoid
<code>NullPointerException</code> at runtime. JSR 305 meta-annotations let tooling vendors
provide null safety support in a generic way, without having to hard-code support for Reactor annotations.</p>
</div>
<div class="paragraph">
<p>è¿äºæ³¨éç¨JSR 305æ³¨éï¼ç±IntelliJ IDEAä¹ç±»çå·¥å·æ¯æçä¼ç JSRï¼è¿è¡åæ³¨éï¼ä»¥åJavaå¼åäººåæä¾æå³ç©ºå®å¨æ§çæç¨è­¦åï¼ä»¥é¿åå¨è¿è¡æ¶åºç°NullPointerExceptionã
JSR 305åæ³¨éä½¿å·¥å·ä¾åºåè½å¤ä»¥éç¨æ¹å¼æä¾ç©ºå®å¨æ¯æï¼èä¸å¿å¯¹Reactoræ³¨éè¿è¡ç¡¬ç¼ç æ¯æã</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is not necessary nor recommended with Kotlin 1.1.5+ to have a dependency on JSR 305 in
your project classpath.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>They are also used by Kotlin, which natively supports
<a href="https://kotlinlang.org/docs/reference/null-safety.html">null safety</a>. See
<a href="#kotlin-null-safety">this dedicated section</a> for more details.</p>
</div>
<div class="paragraph">
<p>The following annotations are provided in the <code>reactor.util.annotation</code> package:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://projectreactor.io/docs/core/release/api/reactor/util/annotation/NonNull.html"><code>@NonNull</code></a>:
Indicates that a specific parameter, return value, or field cannot be <code>null</code>.
(It is not needed on parameters and return values where <code>@NonNullApi</code> applies) .</p>
</li>
<li>
<p><a href="https://projectreactor.io/docs/core/release/api/reactor/util/annotation/Nullable.html"><code>@Nullable</code></a>:
Indicates that a parameter, return value, or field can be <code>null</code>.</p>
</li>
<li>
<p><a href="https://projectreactor.io/docs/core/release/api/reactor/util/annotation/NonNullApi.html"><code>@NonNullApi</code></a>:
Package-level annotation that indicates non-null is the default behavior for
parameters and return values.</p>
</li>
<li>
<p>æç¤ºç¹å®çåæ°ï¼è¿åå¼æå­æ®µä¸è½ä¸ºnullã ï¼å¨@NonNullApiéç¨çåæ°åè¿åå¼ä¸ä¸éè¦ï¼ã</p>
</li>
<li>
<p>è¡¨ç¤ºåæ°ï¼è¿åå¼æå­æ®µå¯ä»¥ä¸ºnullã</p>
</li>
<li>
<p>æç¤ºéç©ºçç¨åºåçº§æ³¨éæ¯åæ°åè¿åå¼çé»è®¤è¡ä¸ºã</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nullability for generic type arguments, variable arguments, and array elements is not yet supported.
See <a href="https://github.com/reactor/reactor-core/issues/878">issue #878</a> for up-to-date
information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/advancedFeatures.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#advanced">Advanced Features and Concepts</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="which-operator"><a class="anchor" href="#which-operator"></a>Appendix A: Which operator do I need?</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In this section, if an operator is specific to <code>Flux</code> or <code>Mono</code>, it is
prefixed accordingly. Common operators have no prefix. When a specific use case
is covered by a combination of operators, it is presented as a method call, with
leading dot and parameters in parentheses, as follows: <code>.methodCall(parameter)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I want to deal with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#which.create">Creating a New Sequence&#8230;&#8203;</a></p>
</li>
<li>
<p><a href="#which.values">Transforming an Existing Sequence</a></p>
</li>
<li>
<p><a href="#which.filtering">Filtering a Sequence</a></p>
</li>
<li>
<p><a href="#which.peeking">Peeking into a Sequence</a></p>
</li>
<li>
<p><a href="#which.errors">Handling Errors</a></p>
</li>
<li>
<p><a href="#which.time">Working with Time</a></p>
</li>
<li>
<p><a href="#which.window">Splitting a <code>Flux</code></a></p>
</li>
<li>
<p><a href="#which.blocking">Going Back to the Synchronous World</a></p>
</li>
<li>
<p><a href="#which.multicasting">Multicasting a <code>Flux</code> to several <code>Subscribers</code></a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="which.create"><a class="anchor" href="#which.create"></a>A.1. Creating a New Sequence&#8230;&#8203;</h3>
<div class="ulist">
<ul>
<li>
<p>that emits a <code>T</code>, and I already have: <code>just</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;from an <code>Optional&lt;T&gt;</code>: <code>Mono#justOrEmpty(Optional&lt;T&gt;)</code></p>
</li>
<li>
<p>&#8230;&#8203;from a potentially <code>null</code> T: <code>Mono#justOrEmpty(T)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>that emits a <code>T</code> returned by a method: <code>just</code> as well</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;but lazily captured: use <code>Mono#fromSupplier</code> or wrap <code>just</code> inside <code>defer</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>that emits several <code>T</code> I can explicitly enumerate: <code>Flux#just(T&#8230;&#8203;)</code></p>
</li>
<li>
<p>that iterates over:</p>
<div class="ulist">
<ul>
<li>
<p>an array: <code>Flux#fromArray</code></p>
</li>
<li>
<p>a collection or iterable: <code>Flux#fromIterable</code></p>
</li>
<li>
<p>a range of integers: <code>Flux#range</code></p>
</li>
<li>
<p>a <code>Stream</code> supplied for each Subscription: <code>Flux#fromStream(Supplier&lt;Stream&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>that emits from various single-valued sources such as:</p>
<div class="ulist">
<ul>
<li>
<p>a <code>Supplier&lt;T&gt;</code>: <code>Mono#fromSupplier</code></p>
</li>
<li>
<p>a task: <code>Mono#fromCallable</code>, <code>Mono#fromRunnable</code></p>
</li>
<li>
<p>a <code>CompletableFuture&lt;T&gt;</code>: <code>Mono#fromFuture</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>that completes: <code>empty</code></p>
</li>
<li>
<p>that errors immediately: <code>error</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;but lazily build the <code>Throwable</code>: <code>error(Supplier&lt;Throwable&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>that never does anything: <code>never</code></p>
</li>
<li>
<p>that is decided at subscription: <code>defer</code></p>
</li>
<li>
<p>that depends on a disposable resource: <code>using</code></p>
</li>
<li>
<p>that generates events programmatically (can use state):</p>
<div class="ulist">
<ul>
<li>
<p>synchronously and one-by-one: <code>Flux#generate</code></p>
</li>
<li>
<p>asynchronously (can also be sync), multiple emissions possible in one pass: <code>Flux#create</code>
(<code>Mono#create</code> as well, without the multiple emission aspect)</p>
</li>
</ul>
</div>
</li>
<li>
<p>åå° <code>T</code>, å·²ç»æäº: <code>just</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;è·åä¸ä¸ª <code>Optional&lt;T&gt;</code>: <code>Mono#justOrEmpty(Optional&lt;T&gt;)</code></p>
</li>
<li>
<p>&#8230;&#8203;è·åä¸ä¸ªå¯è½ä¸º <code>null</code> çTå¼: <code>Mono#justOrEmpty(T)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿æ¹æ³è¿åä¸ä¸ª`T`å¹¶è¿è¡åå°`T`: <code>just</code> as well</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ä¸ºäºå»¶è¿å è½½: ä½¿ç¨ <code>Mono#fromSupplier</code> or å¨å®ä¹çåé¨è¿åä¸ä¸ªåè£çjust</p>
</li>
</ul>
</div>
</li>
<li>
<p>åå°å ä¸ªå¯ä»¥æç¡®åä¸¾ç <code>T</code> : <code>Flux#just(T&#8230;&#8203;)</code></p>
</li>
<li>
<p>éå:</p>
<div class="ulist">
<ul>
<li>
<p>ä¸ä¸ªæ°ç»: <code>Flux#fromArray</code></p>
</li>
<li>
<p>ä¸ä¸ª collection æè iterable: <code>Flux#fromIterable</code></p>
</li>
<li>
<p>ä¸ä¸ªæ´æ°èå´: <code>Flux#range</code></p>
</li>
<li>
<p>ä¸ºæ¯ä¸ªè®¢éæä¾äºä¸ä¸ªâStreamâ: <code>Flux#fromStream(Supplier&lt;Stream&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ä»åç§åå¼æ¥æºååºï¼ä¾å¦:</p>
<div class="ulist">
<ul>
<li>
<p>ä¸ä¸ª <code>Supplier&lt;T&gt;</code>: <code>Mono#fromSupplier</code></p>
</li>
<li>
<p>ä¸ä¸ªä»»å¡: <code>Mono#fromCallable</code>, <code>Mono#fromRunnable</code></p>
</li>
<li>
<p>ä¸ä¸ª <code>CompletableFuture&lt;T&gt;</code>: <code>Mono#fromFuture</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å®æä¸ä¸ªç©ºå¼: <code>empty</code></p>
</li>
<li>
<p>ç«å³éè¯¯: <code>error</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ä¹å¯ä»¥å»¶è¿æå»º <code>Throwable</code>: <code>error(Supplier&lt;Throwable&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ä¸åå¦ä½äºæ: <code>never</code></p>
</li>
<li>
<p>å¨è®¢éæ¶å®ä¹: <code>defer</code></p>
</li>
<li>
<p>åå³äºå¯ç¨èµæº: <code>using</code></p>
</li>
<li>
<p>ä»¥ç¼ç¨æ¹å¼çæäºä»¶ (å¯ä½¿ç¨ç¶æ):</p>
<div class="ulist">
<ul>
<li>
<p>åæ­¥ç: <code>Flux#generate</code></p>
</li>
<li>
<p>å¼æ­¥å° (ä¹å¯ä»¥åæ­¥), ä¸æ¬¡éè¿å¯è½äº§çå¤ç§åå°: <code>Flux#create</code>
(<code>Mono#create</code> as well, without the multiple emission aspect)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.values"><a class="anchor" href="#which.values"></a>A.2. Transforming an Existing Sequence</h3>
<div class="ulist">
<ul>
<li>
<p>I want to transform existing data:</p>
<div class="ulist">
<ul>
<li>
<p>on a 1-to-1 basis (eg. strings to their length): <code>map</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;by just casting it: <code>cast</code></p>
</li>
<li>
<p>&#8230;&#8203;in order to materialize each source value&#8217;s index: <code>Flux#index</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>on a 1-to-n basis (eg. strings to their characters): <code>flatMap</code> + use a factory method</p>
</li>
<li>
<p>on a 1-to-n basis with programmatic behavior for each source element and/or state: <code>handle</code></p>
</li>
<li>
<p>running an asynchronous task for each source item (eg. urls to http request): <code>flatMap</code> + an async <code>Publisher</code>-returning method</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ignoring some data: conditionally return a <code>Mono.empty()</code> in the flatMap lambda</p>
</li>
<li>
<p>&#8230;&#8203;retaining the original sequence order: <code>Flux#flatMapSequential</code> (this triggers the async processes immediately but reorders the results)</p>
</li>
<li>
<p>&#8230;&#8203;where the async task can return multiple values, from a <code>Mono</code> source: <code>Mono#flatMapMany</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>I want to add pre-set elements to an existing sequence:</p>
<div class="ulist">
<ul>
<li>
<p>at the start: <code>Flux#startWith(T&#8230;&#8203;)</code></p>
</li>
<li>
<p>at the end: <code>Flux#concatWith(T&#8230;&#8203;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>I want to aggregate a <code>Flux</code>: (the <code>Flux#</code> prefix is assumed below)</p>
<div class="ulist">
<ul>
<li>
<p>into a List: <code>collectList</code>, <code>collectSortedList</code></p>
</li>
<li>
<p>into a Map: <code>collectMap</code>, <code>collectMultiMap</code></p>
</li>
<li>
<p>into an arbitrary container: <code>collect</code></p>
</li>
<li>
<p>into the size of the sequence: <code>count</code></p>
</li>
<li>
<p>by applying a function between each element (eg. running sum): <code>reduce</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;but emitting each intermediary value: <code>scan</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>into a boolean value from a predicate:</p>
<div class="ulist">
<ul>
<li>
<p>applied to all values (AND): <code>all</code></p>
</li>
<li>
<p>applied to at least one value (OR): <code>any</code></p>
</li>
<li>
<p>testing the presence of any value: <code>hasElements</code></p>
</li>
<li>
<p>testing the presence of a specific value: <code>hasElement</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³è½¬æ¢ç°ææ°æ®</p>
<div class="ulist">
<ul>
<li>
<p>åºäºä¸å¯¹ä¸ (ä¾å¦. å­ç¬¦ä¸²é¿åº¦): <code>map</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;åªéæå°å®: <code>cast</code></p>
</li>
<li>
<p>&#8230;&#8203;ä¸ºäºå®ç°æ¯ä¸ªæºå¼çç´¢å¼: <code>Flux#index</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å¨1-nçåºç¡ä¸ï¼ä¾å¦ï¼å°å­ç¬¦ä¸²è½¬æ¢ä¸ºå­ç¬¦ï¼: <code>flatMap</code> + ä½¿ç¨å·¥åæ¹æ³</p>
</li>
<li>
<p>å¨ä¸å¯¹ä¸çåºç¡ä¸ï¼éå¯¹æ¯ä¸ªæºåç´ å/æç¶æè¿è¡ç¼ç¨è¡ä¸º: <code>handle</code></p>
</li>
<li>
<p>ä¸ºæ¯ä¸ªæºé¡¹ç®è¿è¡å¼æ­¥ä»»å¡ï¼ä¾å¦ï¼httpè¯·æ±çç½åï¼: <code>flatMap</code> + å¼æ­¥ <code>Publisher</code> è¿åæ¹æ³</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;å¿½ç¥ä¸äºæ°æ®ï¼å¨flatMap lambdaä¸­ææ¡ä»¶å°è¿å`Mono.emptyï¼ï¼`</p>
</li>
<li>
<p>&#8230;&#8203;ä¿çåå§é¡ºåºï¼<code>Fluxï¼flatMapSequential</code>ï¼è¿ä¼ç«å³è§¦åå¼æ­¥è¿ç¨ï¼ä½ä¼å¯¹ç»æéæ°æåºï¼</p>
</li>
<li>
<p>&#8230;&#8203;å¼æ­¥ä»»å¡å¯ä»¥ä»â Monoâæºè¿åå¤ä¸ªå¼ï¼â Monoï¼flatMapManyâ</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³å°é¢è®¾åç´ æ·»å å°ç°æåºåä¸­ï¼</p>
<div class="ulist">
<ul>
<li>
<p>å¨å¼å¤´: <code>Flux#startWith(T&#8230;&#8203;)</code></p>
</li>
<li>
<p>å¨ç»å°¾: <code>Flux#concatWith(T&#8230;&#8203;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³è¦èåä¸ä¸ª <code>Flux</code>: (the <code>Flux#</code> prefix is assumed below)</p>
<div class="ulist">
<ul>
<li>
<p>è½¬æ¢ä¸ä¸ª List: <code>collectList</code>, <code>collectSortedList</code></p>
</li>
<li>
<p>è½¬æ¢ä¸ä¸ª Map: <code>collectMap</code>, <code>collectMultiMap</code></p>
</li>
<li>
<p>æ¾å¥ä»»æå®¹å¨ä¸­: <code>collect</code></p>
</li>
<li>
<p>è½¬æ¢ä¸ºåºåçå¤§å°: <code>count</code></p>
</li>
<li>
<p>éè¿å¨æ¯ä¸ªåç´ ä¹é´åºç¨å½æ°ï¼ä¾å¦ï¼è¿è¡æ»åï¼: <code>reduce</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;æ£ååºæ¯ä¸ªä¸­ä»ä»·å¼: <code>scan</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>æ­è¨è½¬æ¢æå¸å°å¼:</p>
<div class="ulist">
<ul>
<li>
<p>åºç¨äºææå¼ï¼ANDï¼ï¼ all</p>
</li>
<li>
<p>åºç¨äºè³å°ä¸ä¸ªå¼ï¼ORï¼ï¼ any</p>
</li>
<li>
<p>æµè¯æ¯å¦å­å¨ä»»ä½å¼ï¼ hasElements</p>
</li>
<li>
<p>æµè¯ç¹å®å¼çå­å¨ï¼ hasElement</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>æè¦åå¹¶åå¸è&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>æé¡ºåºï¼Flux#concatæ.concatWith(other)</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ä¼å»¶è¿ä»»ä½éè¯¯ï¼ç´å°ååºå©ä½çåå¸èä¸ºæ­¢ï¼<code>Fluxï¼concatDelayError</code></p>
</li>
<li>
<p>&#8230;&#8203;ç­åå°è®¢éåç»­çåå¸èï¼<code>Fluxï¼mergeSequential</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>æææ¾é¡ºåºï¼åå¹¶çé¡¹ç®éå¶åå°èæ¥ï¼ï¼<code>Fluxï¼merge</code> /<code>.mergeWithï¼otherï¼</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;å·æä¸åç±»åçãï¼è½¬æ¢åå¹¶ï¼ï¼<code>Fluxï¼zip</code> /<code>Fluxï¼zipWith</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿éå¯¹å¼:</p>
<div class="ulist">
<ul>
<li>
<p>ä»2ä¸ªMonosåæä¸ä¸ª`Tuple2`ï¼<code>Monoï¼zipWith</code></p>
</li>
<li>
<p>å¨é¨å®ææ¶ä»nä¸ªMonosä¸­è·åï¼<code>Monoï¼zip</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿åè°å¶ç»æ­¢ï¼</p>
<div class="ulist">
<ul>
<li>
<p>ä»1ä¸ªMonoåä»»ä½æºå°ä¸ä¸ªMono &lt;Void&gt;`ï¼<code>Monoï¼and</code></p>
</li>
<li>
<p>å½å®ä»¬å¨é¨å®ææ¶ï¼ä»nä¸ªæ¥æºä¸­è·åï¼<code>Monoï¼when</code></p>
</li>
<li>
<p>è½¬æ¢ä¸ºä»»æå®¹å¨ç±»åï¼</p>
<div class="ulist">
<ul>
<li>
<p>æ¯æ¬¡åå°åºææä¿¡å·æ¶ï¼<code>Fluxï¼zip</code>ï¼ç´è³æå°åºæ°ï¼</p>
</li>
<li>
<p>æ¯å½ææ°å¼å°è¾¾ä»»ä¸ä¾§æ¶ï¼<code>Fluxï¼combineLatest</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>åªèèåååºçåºåï¼<code>Fluxï¼first</code>ï¼<code>Monoï¼first</code>ï¼<code>mono.or
ï¼otherMonoï¼.orï¼thirdMonoï¼</code>ï¼<code>flux.orï¼otherFluxï¼.orï¼thirdFluxï¼</code></p>
</li>
<li>
<p>ç±æºåºåä¸­çåç´ è§¦åï¼<code>switchMap</code>ï¼æ¯ä¸ªæºåç´ é½æ å°å°åå¸èï¼</p>
</li>
<li>
<p>ç±åå¸èåºåä¸­çä¸ä¸ä¸ªåå¸èçå¼å§è§¦åï¼<code>switchOnNext</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³éå¤ä¸ä¸ªç°æçåºåï¼ repeat</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;æ¯éä¸æ®µæ¶é´: <code>Flux.interval(duration).flatMap(tick &#8594; myExistingPublisher)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææä¸ä¸ªç©ºåºåï¼ä½æ¯&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>ææ³è¦ä¸ä¸ªå¼: <code>defaultIfEmpty</code></p>
</li>
<li>
<p>ææ³è¦å¦ä¸ä¸ªåºå: <code>switchIfEmpty</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææä¸ä¸ªåºåï¼ä½å¯¹å¼ä¸æå´è¶£: <code>ignoreElements</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;æå¸æå°å®æè¡¨ç¤ºä¸º <code>Mono</code>: <code>then</code></p>
</li>
<li>
<p>&#8230;&#8203;ææ³ç­å°æåä¸ä¸ªä»»å¡å®æ: <code>thenEmpty</code></p>
</li>
<li>
<p>&#8230;&#8203;æåææ³åæ¢å°å¦ä¸ä¸ª`Mono`: <code>Mono#then(mono)</code></p>
</li>
<li>
<p>&#8230;&#8203;ææåæ³ååºä¸ä¸ªå¼: <code>Mono#thenReturn(T)</code></p>
</li>
<li>
<p>&#8230;&#8203;æåææ³åæ¢å° Flux: <code>thenMany</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææä¸ä¸ªMonoï¼ææ³æ¨è¿å®æ&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ç´å°ä»è¯¥å¼æ´¾ççå¦ä¸ä¸ªåå¸èå®æä¸ºæ­¢: <code>Mono#delayUntil(Function)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³è¦éå½å°å°åç´ å±å¼æåºåå¾ï¼å¹¶ååºç»åâ¦&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;é¦åæ©å±å¾çå®½åº¦: <code>expand(Function)</code></p>
</li>
<li>
<p>&#8230;&#8203;é¦åæ©å±å¾å½¢æ·±åº¦: <code>expandDeep(Function)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.peeking"><a class="anchor" href="#which.peeking"></a>A.3. Peeking into a Sequence</h3>
<div class="ulist">
<ul>
<li>
<p>å¨ä¸ä¿®æ¹æç»é¡ºåºçæåµä¸ï¼ææ³:</p>
<div class="ulist">
<ul>
<li>
<p>å¾å°éç¥/æ§è¡éå è¡ä¸º(ææ¶ç§°ä¸ºâå¯ä½ç¨â):</p>
<div class="ulist">
<ul>
<li>
<p>åå°: <code>doOnNext</code></p>
</li>
<li>
<p>å®æ: <code>Flux#doOnComplete</code>, <code>Mono#doOnSuccess</code> (åå«ç»æï¼å¦ææçè¯)</p>
</li>
<li>
<p>éè¯¯ç»æ­¢: <code>doOnError</code></p>
</li>
<li>
<p>æ¶é¤: <code>doOnCancel</code></p>
</li>
<li>
<p>åºåçâå¼å§â: <code>doFirst</code></p>
<div class="ulist">
<ul>
<li>
<p>å¯¹åº <code>Publisher#subscribe(Subscriber)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>è®¢éå : <code>doOnSubscribe</code></p>
<div class="ulist">
<ul>
<li>
<p>å°±åå¨ <code>Subscription</code> <code>subscribe</code> ç¡®è®¤ä¹å</p>
</li>
<li>
<p>å¯¹åº`Subscriber#onSubscribe(Subscription)`</p>
</li>
</ul>
</div>
</li>
<li>
<p>è¯·æ±: <code>doOnRequest</code></p>
</li>
<li>
<p>å®ææéè¯¯: <code>doOnTerminate</code> (Mono çæ¬åå«ç»æ)</p>
<div class="ulist">
<ul>
<li>
<p>ä½æ¯ <strong>after</strong> ä¼è¢«ä¼ æ­å°ä¸æ¸¸: <code>doAfterTerminate</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ä»»ä½ç±»åçä¿¡å·ï¼è¡¨ç¤ºä¸º <code>Signal</code>: <code>Flux#doOnEach</code></p>
</li>
<li>
<p>ä»»ä½ç»æ­¢æ¡ä»¶ (complete, error, cancel): <code>doFinally</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>è®°å½åé¨åççæåµ: <code>log</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³ç¥éææäºä»¶:</p>
<div class="ulist">
<ul>
<li>
<p>æ¯ä¸ªè¡¨ç¤ºä¸ºSignalå¯¹è±¡:</p>
<div class="ulist">
<ul>
<li>
<p>å¨åºåå¤çåè°ä¸­: <code>doOnEach</code></p>
</li>
<li>
<p>èä¸æ¯åå§çonNextåå°: <code>materialize</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;åå°onNexts: <code>dematerialize</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ä½ä¸ºæ¥å¿ä¸­çä¸è¡: <code>log</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.filtering"><a class="anchor" href="#which.filtering"></a>A.4. Filtering a Sequence</h3>
<div class="ulist">
<ul>
<li>
<p>ææ³è¿æ»¤ä¸ä¸ªåºå:</p>
<div class="ulist">
<ul>
<li>
<p>åºäºä»»ææ å: <code>filter</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;æ¯å¼æ­¥è®¡ç®ç: <code>filterWhen</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éå¶åå°å¯¹è±¡çç±»å: <code>ofType</code></p>
</li>
<li>
<p>éè¿å®å¨å¿½ç¥è¿äºå¼: <code>ignoreElements</code></p>
</li>
<li>
<p>éè¿å¿½ç¥éå¤é¡¹:</p>
<div class="ulist">
<ul>
<li>
<p>å¨æ´ä¸ªåºåï¼é»è¾éåï¼ä¸­: <code>Flux#distinct</code></p>
</li>
<li>
<p>å¨åç»­åå°çé¡¹ç®ä¹é´ï¼éå¤æ°æ®å é¤ï¼: <code>Flux#distinctUntilChanged</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>æåªæ³ä¿çåºåçä¸ä¸ªå­é:</p>
<div class="ulist">
<ul>
<li>
<p>éè¿åNä¸ªåç´ :</p>
<div class="ulist">
<ul>
<li>
<p>å¨åºåçå¼å¤´: <code>Flux#take(long)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;åºäºæç»­æ¶é´: <code>Flux#take(Duration)</code></p>
</li>
<li>
<p>&#8230;&#8203;ä»ç¬¬ä¸ä¸ªåç´ , å¦ <code>Mono</code>: <code>Flux#next()</code></p>
</li>
<li>
<p>&#8230;&#8203;ä½¿ç¨request(N)èä¸æ¯åæ¶: <code>Flux#limitRequest(long)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å¨åºåçæ«å°¾: <code>Flux#takeLast</code></p>
</li>
<li>
<p>uç´å°æ»¡è¶³æ åï¼åæ¬ï¼ä¸ºæ­¢: <code>Flux#takeUntil</code> (predicate-based), <code>Flux#takeUntilOther</code> (companion publisher-based)</p>
</li>
<li>
<p>ç¬¦åæ¡ä»¶ï¼ä¸åæ¬ï¼æ¶: <code>Flux#takeWhile</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>æå¤éç¨1ä¸ªåç´ :</p>
<div class="ulist">
<ul>
<li>
<p>å¨ç¹å®ä½ç½®: <code>Flux#elementAt</code></p>
</li>
<li>
<p>å¨æ«å°¾: <code>.takeLast(1)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;å¹¶ä¸å¦æä¸ºç©ºåååºéè¯¯: <code>Flux#last()</code></p>
</li>
<li>
<p>&#8230;&#8203;å¹¶ååºé»è®¤å¼ï¼å¦æä¸ºç©º: <code>Flux#last(T)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿è·³è¿åç´ :</p>
<div class="ulist">
<ul>
<li>
<p>å¨åºåçå¼å¤´: <code>Flux#skip(long)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;åºäºæç»­æ¶é´: <code>Flux#skip(Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å¨åºåçæ«å°¾: <code>Flux#skipLast</code></p>
</li>
<li>
<p>ç´å°æ»¡è¶³æ åï¼åæ¬ï¼ä¸ºæ­¢: <code>Flux#skipUntil</code> (predicate-based), <code>Flux#skipUntilOther</code> (companion publisher-based)</p>
</li>
<li>
<p>ç¬¦åæ¡ä»¶ï¼ä¸åæ¬ï¼æ¶: <code>Flux#skipWhile</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿æ½æ ·é¡¹ç®:</p>
<div class="ulist">
<ul>
<li>
<p>ææç»­æ¶é´: <code>Flux#sample(Duration)</code></p>
<div class="ulist">
<ul>
<li>
<p>ä½æ¯å°ç¬¬ä¸ä¸ªåç´ èä¸æ¯æåä¸ä¸ªåç´ ä¿çå¨éæ ·çªå£ä¸­: <code>sampleFirst</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿åºäºåå¸èççªå£: <code>Flux#sample(Publisher)</code></p>
</li>
<li>
<p>åºäºåå¸èçâå®æ¶â : <code>Flux#sampleTimeout</code> (æ¯ä¸ªåç´ è§¦åä¸ä¸ªåå¸èï¼å¦æè¯¥åå¸èä¸ä¸ä¸ä¸ªä¸éå åååº)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ææææå¤1ä¸ªåç´ ï¼å¦æè¶è¿ä¸ä¸ªåç´ åä¼åºéï¼&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>å¦æåºåä¸ºç©ºï¼ææ³è¦ä¸ä¸ªéè¯¯: <code>Flux#single()</code></p>
</li>
<li>
<p>å¦æåºåä¸ºç©ºï¼ææ³è¦ä¸ä¸ªé»è®¤å¼: <code>Flux#single(T)</code></p>
</li>
<li>
<p>æä¹æ¥åä¸ä¸ªç©ºåºå: <code>Flux#singleOrEmpty</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.errors"><a class="anchor" href="#which.errors"></a>A.5. Handling Errors</h3>
<div class="ulist">
<ul>
<li>
<p>ææ³åå»ºä¸ä¸ªéè¯¯çåºå: <code>error</code>&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ä»£æ¿æåçå®æ <code>Flux</code>: <code>.concat(Flux.error(e))</code></p>
</li>
<li>
<p>&#8230;&#8203;ä»£æ¿æååå°ç <code>Mono</code>: <code>.then(Mono.error(e))</code></p>
</li>
<li>
<p>&#8230;&#8203;å¦æä¸¤æ¬¡onNextsä¹é´çæ¶é´è¿é¿: <code>timeout</code></p>
</li>
<li>
<p>&#8230;&#8203;å¼æ­¥: <code>error(Supplier&lt;Throwable&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³è¦ç­æçtry / catch:</p>
<div class="ulist">
<ul>
<li>
<p>throwing: <code>error</code></p>
</li>
<li>
<p>æè·å¼å¸¸:</p>
<div class="ulist">
<ul>
<li>
<p>å¹¶éåå°é»è®¤å¼: <code>onErrorReturn</code></p>
</li>
<li>
<p>ç¶åæè½å°å¦ä¸ä¸ªFluxæMono: <code>onErrorResume</code></p>
</li>
<li>
<p>å¹¶åè£å¹¶éæ°æåº: <code>.onErrorMap(t &#8594; new RuntimeException(t))</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>the finally block: <code>doFinally</code></p>
</li>
<li>
<p>Java 7ä¸­çä½¿ç¨æ¨¡å¼: <code>using</code> factory method</p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³ä»éè¯¯ä¸­æ¢å¤&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>éè¿åé:</p>
<div class="ulist">
<ul>
<li>
<p>å¼: <code>onErrorReturn</code></p>
</li>
<li>
<p>è½¬æ¢å° <code>Publisher</code> or <code>Mono</code>, å¯è½æ¯ä¸åçï¼è¿åå³äºä¸åéè¯¯: <code>Flux#onErrorResume</code> and <code>Mono#onErrorResume</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¯: <code>retry</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ä»ç®åçç­ç¥ï¼å°è¯çæå¤§æ°é: retry(), retry(long)</p>
</li>
<li>
<p>&#8230;&#8203;ç±åä¼´æ§ä»¶Fluxè§¦å: <code>retryWhen</code></p>
</li>
<li>
<p>&#8230;&#8203; ä½¿ç¨æ åçåéç­ç¥(å¸¦æå¨çææ°åé):retryWhen(Retry.backoff(â¦))(è¯·åééè¯ä¸­çå¶ä»å·¥åæ¹æ³)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³å¤çèå``éè¯¯''ï¼æ¥èªä¸æ¸¸çæå¤§è¯·æ±æ°ï¼å¹¶å¨ä¸æ¸¸æ²¡æäº§çè¶³å¤çè¯·æ±æ¶åºç¨è¯¥ç­ç¥ï¼&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>éè¿æåºä¸ä¸ªç¹æ®ç <code>IllegalStateException</code>: <code>Flux#onBackpressureError</code></p>
</li>
<li>
<p>éè¿å é¤å¤ä½çå¼: <code>Flux#onBackpressureDrop</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;é¤äºæåçå°çä¸ä¸ª: <code>Flux#onBackpressureLatest</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿ç¼å²å¤ä½çå¼ï¼æçææ ç: <code>Flux#onBackpressureBuffer</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;å¨æçç¼å²åºä¹æº¢åºæ¶åºç¨ç­ç¥: <code>Flux#onBackpressureBuffer</code> with a <code>BufferOverflowStrategy</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.time"><a class="anchor" href="#which.time"></a>A.6. Working with Time</h3>
<div class="ulist">
<ul>
<li>
<p>ææ³å°åå°ä¸æ¶é´ç¸èç³»èµ·æ¥ (<code>Tuple2&lt;Long, T&gt;</code>) æµé&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>èªè®¢éä»¥æ¥: <code>elapsed</code></p>
</li>
<li>
<p>ä»æ¶é´çå¼ç«¯ (well, è®¡ç®æºçæ¶é´): <code>timestamp</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å¦æåå°ä¹é´çå»¶è¿å¤ªé¿ï¼æå¸æä¸­æ­æçåºå: <code>timeout</code></p>
</li>
<li>
<p>ææ³ä»ä¸ä¸ªæ¶éä¸å¾å°æ»´ç­å£°ï¼æè§å¾çæ¶é´é´é: <code>Flux#interval</code></p>
</li>
<li>
<p>ææ³å¨åå§å»¶è¿åååºä¸ä¸ª0 : static <code>Mono.delay</code>.</p>
</li>
<li>
<p>ææ³å¼è¿ä¸ä¸ªå»¶è¿:
**æ¯ä¸ªonNextä¿¡å·ä¹é´: <code>Mono#delayElement</code>, <code>Flux#delayElements</code></p>
<div class="ulist">
<ul>
<li>
<p>è®¢éåçä¹å: <code>delaySubscription</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.window"><a class="anchor" href="#which.window"></a>A.7. Splitting a <code>Flux</code></h3>
<div class="ulist">
<ul>
<li>
<p>ææ³éè¿è¾¹çæ¡ä»¶å° Flux&lt;T&gt;ååä¸ºFlux&lt;Flux&lt;T&gt;&gt;ï¼</p>
<div class="ulist">
<ul>
<li>
<p>å¤§å°: <code>window(int)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;çªå£éå ææè½: <code>window(int, int)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>æ¶é´ç <code>window(æç»­)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;éå ææè½ççªæ·: <code>window(Duration, Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>å¤§å°æèæ¶é´ (è¾¾å°è®¡æ°æè¶æ¶åçªå£å³é­): <code>windowTimeout(int, Duration)</code></p>
</li>
<li>
<p>åºäºåç´ çåå°: <code>windowUntil</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;â¦å¨ä¸ä¸ä¸ªçªå£ä¸­ååºè§¦åè¾¹ççåç´  (<code>cutBefore</code> variant): <code>.windowUntil(predicate, true)</code></p>
</li>
<li>
<p>&#8230;&#8203;åç´ ä¸æ­è¨å¹éæ¶ä¿æçªå£æå¼: <code>windowWhile</code> (æ²¡æå¹éçåç´ ä¸åå°)</p>
</li>
</ul>
</div>
</li>
<li>
<p>ç±æ§ä»¶åå¸å¨ä¸­çONEXTSå¯ä»¥é©±å¨ä»»æè¾¹ç: <code>window(Publisher)</code>, <code>windowWhen</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³å°ä¸ä¸ª Flux&lt;T&gt;åç´  åç¼å²åºä¸­çåç´ åå²å¨ä¸èµ·</p>
<div class="ulist">
<ul>
<li>
<p>è½¬æ¢å° <code>List</code>:</p>
<div class="ulist">
<ul>
<li>
<p>éè¿å¤§å°è¾¹ç: <code>buffer(int)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ç¼å²åºéå æä¸¢å¼: <code>buffer(int, int)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿æç»­æ¶é´è¾¹ç: <code>buffer(Duration)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;ç¼å²åºéå æä¸¢å¼: <code>buffer(Duration, Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>éè¿å¤§å°ææç»­æ¶é´è¾¹ç: <code>bufferTimeout(int, Duration)</code></p>
</li>
<li>
<p>éè¿ä»»ææ åè¾¹ç: <code>bufferUntil(Predicate)</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;å°è§¦åè¾¹ççåç´ æ¾å¥ä¸ä¸ä¸ªç¼å²åº: <code>.bufferUntil(predicate, true)</code></p>
</li>
<li>
<p>&#8230;&#8203;å¨æ­è¨å¹éæ¶ç¼å²å¹¶ä¸¢å¼è§¦åè¾¹ççåç´  <code>bufferWhile(Predicate)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ç±æ§ä»¶åå¸å¨ä¸­çONEXTSå¯ä»¥é©±å¨ä»»æè¾¹ç: <code>buffer(Publisher)</code>, <code>bufferWhen</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>åæä»»æçâéåâç±»åCï¼ä½¿ç¨åä½ï¼å¦ <code>buffer(int, Supplier&lt;C&gt;)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³åè£ä¸ä¸ª`Flux&lt;T&gt;` è¿æ ·ä¸ä¸ªå·æç¸åç¹æ§çåç´ å°±ä¼å¨åä¸ä¸ªå­fluxä¸­ç»æ: <code>groupBy(Function&lt;T,K&gt;)</code>
æç¤ºï¼è¯·æ³¨æï¼è¿å°è¿åä¸ä¸ª Flux&lt;GroupedFlux&lt;K, T&gt;&gt;ï¼æ¯ä¸ªåé¨GroupedFluxå±äº«Kå¯éè¿è®¿é®çç¸åçæ¹æ³key().</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.blocking"><a class="anchor" href="#which.blocking"></a>A.8. Going Back to the Synchronous World</h3>
<div class="paragraph">
<p>æ³¨æï¼å¨ä¸ä¸ª"éå µå¡"ç`Scheduler` (by default <code>parallel()</code> and <code>single()</code>) ä¸è°ç¨ææè¿äºæ¹æ³ï¼
é¤äº `Mono#toFuture`é½ä¼æåºä¸ä¸ª`UnsupportedOperatorException`çå¼å¸¸ï¼</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ææä¸ä¸ª <code>Flux&lt;T&gt;</code> ææ³è¦:</p>
<div class="ulist">
<ul>
<li>
<p>é»å¡ï¼ç´å°æå¾å°ç¬¬ä¸ä¸ªåç´ : <code>Flux#blockFirst</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;è¶æ¶: <code>Flux#blockFirst(Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>é»å¡ï¼ç´å°æå¯ä»¥è·åæåä¸ä¸ªåç´ ï¼å¦æä¸ºç©ºï¼åè¿ånullï¼: <code>Flux#blockLast</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;è¶æ¶: <code>Flux#blockLast(Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>åæ­¥åæ¢å° <code>Iterable&lt;T&gt;</code>: <code>Flux#toIterable</code></p>
</li>
<li>
<p>åæ­¥åæ¢å°Java 8 <code>Stream&lt;T&gt;</code>: <code>Flux#toStream</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ææä¸ä¸ª <code>Mono&lt;T&gt;</code> and ææ³è¦:</p>
<div class="ulist">
<ul>
<li>
<p>é»å¡ç´å°æå¯ä»¥å¾å°å¼: <code>Mono#block</code></p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;è¶æ¶: <code>Mono#block(Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>a <code>CompletableFuture&lt;T&gt;</code>: <code>Mono#toFuture</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which.multicasting"><a class="anchor" href="#which.multicasting"></a>A.9. Multicasting a <code>Flux</code> to several <code>Subscribers</code></h3>
<div class="ulist">
<ul>
<li>
<p>ææ³å°å¤ä¸ª <code>Subscriber</code> é¾æ¥å° <code>Flux</code>:</p>
<div class="ulist">
<ul>
<li>
<p>å³å®ä½æ¶è§¦åæºï¼ä½¿ç¨`connect()<code>: `publish()</code> (returns a <code>ConnectableFlux</code>)</p>
</li>
<li>
<p>å¹¶ç«å³è§¦åæºï¼åæè®¢éèå¯ä»¥æ¥çä»¥åçæ°æ®ï¼: <code>share()</code></p>
</li>
<li>
<p>å½æè¶³å¤çç¨æ·æ³¨åæ¶ï¼æ°¸ä¹è¿æ¥æº: <code>.publish().autoConnect(n)</code></p>
</li>
<li>
<p>å½ç»ç»èè¶è¿/ä½äºéå¼æ¶ï¼èªå¨è¿æ¥ååæ¶æº: <code>.publish().refCount(n)</code></p>
<div class="ulist">
<ul>
<li>
<p>..âè®©æ°çæ³¨åèææºä¼å¨åæ¶åè¿æ¥ï¼ <code>.publish().refCountGrace(n, Duration)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ææ³ä»åå¸æå¡å¨ç¼å­æ°æ®å¹¶å°å¶éæ¾ç»ä»¥åçè®¢éè:</p>
<div class="ulist">
<ul>
<li>
<p>åå³äºnåç´ : <code>cache(int)</code></p>
</li>
<li>
<p>ç¼å­Durationï¼çå­æ¶é´ï¼ä¸­çå°çææ°åç´  (Time-To-Live): <code>cache(Duration)</code></p>
<div class="ulist">
<ul>
<li>
<p>..åªä¿çä»¥ä¸nåç´ : <code>cache(int, Duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ä½ä¸ç«å³è§¦åæ¥æº: <code>Flux#replay</code> (returns a <code>ConnectableFlux</code>)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/apdx-operatorChoice.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#which-operator">Which operator do I need?</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="anchor" href="#faq"></a>Appendix B: FAQ, Best Practices, and "How do I&#8230;&#8203;?"</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers the following content:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#faq.wrap-blocking">How Do I Wrap a Synchronous, Blocking Call? å¦ä½åè£åæ­¥é»å¡å¼å«?</a></p>
</li>
<li>
<p><a href="#faq.chain">I Used an Operator on my <code>Flux</code> but it Doesn&#8217;t Seem to Apply. What Gives?</a></p>
</li>
<li>
<p><a href="#faq.monoThen">[faq.monoThen]</a></p>
</li>
<li>
<p><a href="#faq.retryWhen">How to Use <code>retryWhen</code> to Emulate <code>retry(3)</code>?</a></p>
</li>
<li>
<p><a href="#faq.exponentialBackoff">How can I use <code>retryWhen</code> for Exponential Backoff?</a></p>
</li>
<li>
<p><a href="#faq.thread-affinity-publishon">How Do I Ensure Thread Affinity when I Use <code>publishOn()</code>?</a></p>
</li>
<li>
<p><a href="#faq.mdc">What Is a Good Pattern for Contextual Logging? (MDC)</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="faq.wrap-blocking"><a class="anchor" href="#faq.wrap-blocking"></a>B.1. How Do I Wrap a Synchronous, Blocking Call? å¦ä½åè£åæ­¥é»å¡å¼å«?</h3>
<div class="paragraph">
<p>éå¸¸æåµä¸ï¼ä¿¡æ¯æºæ¯åæ­¥åé»å¡çã è¥è¦å¤çååºå åºç¨ç¨åºä¸­çæ­¤ç±»æºï¼è¯·åºç¨ä»¥ä¸æ¨¡å¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Mono blockingWrapper = Mono.fromCallable(() -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    return /* make a remote synchronous call */ <i class="conum" data-value="2"></i><b>(2)</b>
});
blockingWrapper = blockingWrapper.subscribeOn(Schedulers.boundedElastic()); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ä½¿ç¨fromCallableåå»ºä¸ä¸ªæ°Monoçã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>è¿åå¼æ­¥çé»å¡èµæº.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ç¡®ä¿æ¯ä¸ªè®¢éé½åçå¨æ¥èª`Schedulers.boundedElastic()`çä¸ç¨åçº¿ç¨ä¸è¿è¡</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You should use a <code>Mono</code>, because the source returns one value. You should use
<code>Schedulers.boundedElastic</code>, because it creates a dedicated thread to wait for the
blocking resource without impacting other non-blocking processing, while also ensuring
that there is a limit to the amount of threads that can be created, and blocking tasks
that can be enqueued and deferred during a spike.</p>
</div>
<div class="paragraph">
<p>æ¨åºè¯¥ä½¿ç¨ Monoï¼å ä¸ºæºè¿åä¸ä¸ªå¼ã æ¨åºè¯¥ä½¿ç¨`Schedulers.boundedElastic`ï¼å ä¸ºå®åå»ºäºä¸ä¸ªä¸ç¨çº¿ç¨æ¥ç­å¾é»å¡èµæºï¼èä¸ä¼å½±åå¶ä»éé»å¡å¤çï¼
åæ¶è¿ç¡®ä¿å¯ä»¥åå»ºççº¿ç¨æ°éæéå¶ï¼ä»¥åå¯ä»¥å¨å°å³°æé´æéåå»¶è¿çé»å¡ä»»å¡ã</p>
</div>
<div class="paragraph">
<p>Note that <code>subscribeOn</code> does not subscribe to the <code>Mono</code>. It specifies what
kind of <code>Scheduler</code> to use when a subscribe call happens.</p>
</div>
<div class="paragraph">
<p>è¯·æ³¨æï¼<code>subscribeOn</code> ä¸è®¢éMonoã å®æå®å¨åçè®¢éè°ç¨æ¶ä½¿ç¨åªç§è°åº¦å¨ã</p>
</div>
</div>
<div class="sect2">
<h3 id="faq.chain"><a class="anchor" href="#faq.chain"></a>B.2. I Used an Operator on my <code>Flux</code> but it Doesn&#8217;t Seem to Apply. What Gives?</h3>
<div class="paragraph">
<p>Make sure that the variable you <code>.subscribe()</code> to has been affected by the
operators you think should have been applied to it.</p>
</div>
<div class="paragraph">
<p>ç¡®ä¿ä½ `subscribe()`çåéå·²ç»åå°æ¨è®¤ä¸ºåºè¯¥åºç¨äºå®çè¿ç®ç¬¦çå½±åã</p>
</div>
<div class="paragraph">
<p>Reactor operators are decorators. They return a different instance that wraps
the source sequence and add behavior. That is why the preferred way of using
operators is to <em>chain</em> the calls.</p>
</div>
<div class="paragraph">
<p>Reactoræä½ç¬¦æ¯è£é¥°ã å®ä»¬è¿åä¸ä¸ªä¸åçå®ä¾ï¼è¯¥å®ä¾åè£¹æºåºåå¹¶æ·»å è¡ä¸ºã
è¿å°±æ¯ä¸ºä»ä¹ä½¿ç¨è¿ç®ç¬¦çé¦éæ¹æ³æ¯å°éè¿è°ç¨é¾æ¥èµ·æ¥ã</p>
</div>
<div class="paragraph">
<p>Compare the following two examples:</p>
</div>
<div class="paragraph">
<p>æ¯è¾ä»¥ä¸ä¸¤ä¸ªç¤ºä¾ï¼</p>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux.just("something", "chain");
flux.map(secret -&gt; secret.replaceAll(".", "*")); <i class="conum" data-value="1"></i><b>(1)</b>
flux.subscribe(next -&gt; System.out.println("Received: " + next));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The mistake is here. The result is not attached to the <code>flux</code> variable. éè¯¯å°±å¨è¿éãç»ææªéå å°fluxåéã</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="exampleblock">
<div class="title">Example 21. without chaining (correct) æ²¡æé¾æ¥ï¼æ­£ç¡®ï¼</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux = Flux.just("something", "chain");
flux = flux.map(secret -&gt; secret.replaceAll(".", "*"));
flux.subscribe(next -&gt; System.out.println("Received: " + next));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following sample is even better (because it is simpler):
ä»¥ä¸ç¤ºä¾çè³æ´å¥½ï¼å ä¸ºå®æ´ç®åï¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; secrets = Flux
  .just("something", "chain")
  .map(secret -&gt; secret.replaceAll(".", "*"))
  .subscribe(next -&gt; System.out.println("Received: " + next));</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The first version outputs the following:
ç¬¬ä¸ä¸ªçæ¬è¾åºä»¥ä¸åå®¹ï¼</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Received: something
Received: chain</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The two other versions output the expected values, as follows:
å¶ä»ä¸¤ä¸ªçæ¬è¾åºææå¼ï¼å¦ä¸æç¤ºï¼</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Received: *********
Received: *****</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="faq.monoThen" class="paragraph">
<p>== My <code>Mono</code> <code>zipWith</code> or <code>zipWhen</code> is never called</p>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">myMethod.process("a") // this method returns Mono&lt;Void&gt;
        .zipWith(myMethod.process("b"), combinator) //this is never called
        .subscribe();</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If the source <code>Mono</code> is either <code>empty</code> or a <code>Mono&lt;Void&gt;</code> (a <code>Mono&lt;Void&gt;</code> is
empty for all intents and purposes), some combinations are never called.</p>
</div>
<div class="paragraph">
<p>This is the typical case for any transformer such as the <code>zip</code> static method or
the <code>zipWith</code> <code>zipWhen</code> operators, which (by definition) need an element from each
source to produce their output.</p>
</div>
<div class="paragraph">
<p>Using data-suppressing operators on sources of <code>zip</code> is thus problematic.
Examples of data-suppressing operators include <code>then()</code>, <code>thenEmpty(Publisher&lt;Void&gt;)</code>,
<code>ignoreElements()</code> and <code>ignoreElement()</code>, and <code>when(Publisher&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>Similarly, operators that use a <code>Function&lt;T,?&gt;</code> to tune their behavior, such as <code>flatMap</code>,
need at least one element to be emitted for the <code>Function</code> to have a chance
to apply. Applying these on an empty (or <code>&lt;Void&gt;</code>) sequence nevers produce an element.</p>
</div>
<div class="paragraph">
<p>You can use <code>.defaultIfEmpty(T)</code> and <code>.switchIfEmpty(Publisher&lt;T&gt;)</code> to
replace an empty sequence of <code>T</code> with a default value or a fallback <code>Publisher&lt;T&gt;</code> (respectively),
which could help avoid some of these situations. Note that this does not apply to
<code>Flux&lt;Void&gt;</code>/<code>Mono&lt;Void&gt;</code> sources, as you can only switch to another <code>Publisher&lt;Void&gt;</code>,
which is still guaranteed to be empty. The following example uses <code>defaultIfEmpty</code>:</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 22. use <code>defaultIfEmpty</code> before <code>zipWhen</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">myMethod.emptySequenceForKey("a") // this method returns empty Mono&lt;String&gt;
        .defaultIfEmpty("") // this converts empty sequence to just the empty String
        .zipWhen(aString -&gt; myMethod.process("b")) //this is called with the empty String
        .subscribe();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="faq.retryWhen"><a class="anchor" href="#faq.retryWhen"></a>B.3. How to Use <code>retryWhen</code> to Emulate <code>retry(3)</code>?</h3>
<div class="paragraph">
<p>The <code>retryWhen</code> operator can be quite complex. Hopefully the following snippet of code
can help you understand how it works by attempting to emulate a simpler
<code>retry(3)</code>:</p>
</div>
<div class="paragraph">
<p>retryWhenè¿ç®ç¬¦å¯è½ä¼ç¸å½å¤æãå¸æä»¥ä¸ä»£ç çæ®µå¯ä»¥éè¿å°è¯æ¨¡ææ´ç®åçä»£ç æ¥å¸®å©æ¨äºè§£å¶å·¥ä½åç retry(3)ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;String&gt; flux =
Flux.&lt;String&gt;error(new IllegalArgumentException())
    .retryWhen(companion -&gt; companion
    .zipWith(Flux.range(1, 4), <i class="conum" data-value="1"></i><b>(1)</b>
          (error, index) -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            if (index &lt; 4) return index; <i class="conum" data-value="3"></i><b>(3)</b>
            else throw Exceptions.propagate(error); <i class="conum" data-value="4"></i><b>(4)</b>
          })
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Trick one: use <code>zip</code> and a <code>range</code> of "number of acceptable retries + 1".	æå·§ä¸ï¼ä½¿ç¨zipårangeâå¯æ¥åçéè¯æ¬¡æ°+ 1â</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>zip</code> function lets you count the retries while keeping track of the original
error.	è¯¥zipåè½å¯è®©æ¨è®¡ç®éè¯æ¬¡æ°ï¼åæ¶è·è¸ªåå§éè¯¯</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To allow for three retries, indexes before 4 return a value to emit.ä¸ºäºåè®¸è¿è¡ä¸æ¬¡éè¯ï¼4ä¹åçç´¢å¼å°è¿åä¸ä¸ªè¦ååºçå¼</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In order to terminate the sequence in error, we throw the original exception after
these three retries. ä¸ºäºç»æ­¢éè¯¯çåºåï¼æä»¬å¨è¿ä¸ä¸ªéè¯ä¹åæåºäºåå§å¼å¸¸</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="faq.exponentialBackoff"><a class="anchor" href="#faq.exponentialBackoff"></a>B.4. How can I use <code>retryWhen</code> for Exponential Backoff?</h3>
<div class="paragraph">
<p>ææ°è¡¥å¿äº§çéè¯å°è¯ï¼æ¯æ¬¡å°è¯ä¹é´çå»¶è¿è¶æ¥è¶å¤§ï¼ä»¥é¿åä½¿æºç³»ç»è¿è½½ï¼å¹¶åå¨é¢å´©æºçé£é©ã
çç±æ¯ï¼å¦ææºäº§çéè¯¯ï¼å®å·²ç»å¤äºä¸ç¨³å®ç¶æï¼ä¸å¤ªå¯è½ç«å³ä»ä¸­æ¢å¤ã å æ­¤ï¼ç²ç®å°ç«å³éè¯å¯è½ä¼äº§çå¦ä¸ä¸ªéè¯¯ï¼å¹¶å¢å ä¸ç¨³å®æ§ã</p>
</div>
<div class="paragraph">
<p>Since <code>3.2.0.RELEASE</code>, Reactor comes with such a retry baked in: <code>Flux.retryBackoff</code>.</p>
</div>
<div class="paragraph">
<p>ä»3.3.4å¼å§ã ååºå éå¤äºä¸ä¸ªæå»ºå¨æ¥è¿è¡è¿æ ·çéè¯ï¼<code>Flux.retryBackoff</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to implement an exponential backoff with <code>retryWhen</code>.
It delays retries and increases the delay between each attempt (pseudocode:
delay = attempt number * 100 milliseconds):</p>
</div>
<div class="paragraph">
<p>ä¸é¢çç¤ºä¾å±ç¤ºäºæå»ºå¨çç®åä½¿ç¨ï¼å¨éè¯å°è¯å»¶è¿ä¹ååä¹åé½æé©å­æ¥å¿æ¶æ¯ã
å®å»¶è¿éè¯å¹¶å¢å æ¯æ¬¡å°è¯ä¹é´çå»¶è¿ï¼ä¼ªä»£ç ï¼å»¶è¿=å°è¯æ°*100æ¯«ç§ï¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AtomicInteger errorCount = new AtomicInteger();
Flux&lt;String&gt; flux =
Flux.&lt;String&gt;error(new IllegalStateException("boom"))
		.doOnError(e -&gt; {  <i class="conum" data-value="1"></i><b>(1)</b>
			errorCount.incrementAndGet();
			System.out.println(e + " at " + LocalTime.now());
		})
		.retryWhen(Retry
				.backoff(3, Duration.ofMillis(100)).jitter(0d) <i class="conum" data-value="2"></i><b>(2)</b>
				.doAfterRetry(rs -&gt; System.out.println("retried at " + LocalTime.now())) <i class="conum" data-value="3"></i><b>(3)</b>
				.onRetryExhaustedThrow((spec, rs) -&gt; rs.failure()) <i class="conum" data-value="4"></i><b>(4)</b>
		);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We will log the time of errors emitted by the source and count them. 	æä»¬å°è®°å½æºååºçéè¯¯çæ¶é´å¹¶è®¡æ°å®ä»¬ã</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We configure an exponential backoff retry with at most 3 attempts and no jitter. æä»¬éç½®ä¸ä¸ªææ°å¤ä»½éè¯ï¼æå¤3æ¬¡å°è¯ï¼æ²¡ææå¨ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We also log the time at which the retry happens. æä»¬è¿è®°å½äºéè¯åççæ¶é´ã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>By default an Exceptions.retryExhausted exception would be thrown, with the last failure() as a cause. Here we customize that to directly emit the cause as onError. é»è®¤æåµä¸ï¼Exceptions.retryExhausted å¼å¸¸å°è¢«æåºï¼æåä¸ä¸ªfailure()ä½ä¸ºåå ã å¨è¿éï¼æä»¬èªå®ä¹å®ï¼ä»¥ç´æ¥ååºåå ä½ä¸ºéè¯¯ã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>When subscribed to, this fails and terminates after printing out the following:
å¦æè®¢éï¼åå¤±è´¥å¹¶å¨æå°åºä»¥ä¸åå®¹åç»æ­¢ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>java.lang.IllegalArgumentException at 18:02:29.338
retried at 18:02:29.459 <i class="conum" data-value="1"></i><b>(1)</b>
java.lang.IllegalArgumentException at 18:02:29.460
retried at 18:02:29.663 <i class="conum" data-value="2"></i><b>(2)</b>
java.lang.IllegalArgumentException at 18:02:29.663
retried at 18:02:29.964 <i class="conum" data-value="3"></i><b>(3)</b>
java.lang.IllegalArgumentException at 18:02:29.964</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>å¤§çº¦100æ¯«ç§åç¬¬ä¸æ¬¡éè¯</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¤§çº¦200æ¯«ç§åçç¬¬äºæ¬¡éè¯</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¤§çº¦300æ¯«ç§åçç¬¬ä¸æ¬¡éè¯</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="faq.thread-affinity-publishon"><a class="anchor" href="#faq.thread-affinity-publishon"></a>B.5. How Do I Ensure Thread Affinity when I Use <code>publishOn()</code>?</h3>
<div class="paragraph">
<p>As described in <a href="#schedulers">Schedulers</a>, <code>publishOn()</code> can be used to switch
execution contexts. The <code>publishOn</code> operator influences the threading context
where the rest of the operators in the chain below it run, up to a new
occurrence of <code>publishOn</code>. So the placement of <code>publishOn</code> is significant.</p>
</div>
<div class="paragraph">
<p>æ­£å¦è°åº¦ç¨åºä¸­ææè¿°çï¼`publishOn()`å¯ç¨äºåæ¢æ§è¡ä¸ä¸æã è¿ä¸ª`publishOn()`æä½ç¬¦å½±åçº¿ç¨ä¸ä¸æï¼å¶ä¸­å®ä¸é¢çé¾ä¸­çå¶ä»æä½ç¬¦è¿è¡ï¼
ç´å°åå¸æ°ç`publishOn`åºç°ã å æ­¤ï¼`publishOn`çä½ç½®æ¯éè¦çã</p>
</div>
<div class="paragraph">
<p>Consider the following example:
èèä»¥ä¸ä¾å­ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EmitterProcessor&lt;Integer&gt; processor = EmitterProcessor.create();
processor.publishOn(scheduler1)
         .map(i -&gt; transform(i))
         .publishOn(scheduler2)
         .doOnNext(i -&gt; processNext(i))
         .subscribe();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>transform</code> function in <code>map()</code> is
run on a worker of <code>scheduler1</code>, and the <code>processNext</code> method in
<code>doOnNext()</code> is run on a worker of <code>scheduler2</code>. Each subscription gets
its own worker, so all elements pushed to the corresponding subscriber are published
on the same <code>Thread</code>.</p>
</div>
<div class="paragraph">
<p>`map()`ä¸­ç`transform`å½æ°å¨`è°åº¦ç¨åº1`çä¸è¿è¡ï¼èå¨`doOnNext()`ä¸­ç`processNext`æ¹æ³å¨è°åº¦ç¨åº2ä¸è¿è¡ã
æ¯ä¸ªè®¢éé½æèªå·±çå·¥ä½äººåï¼å æ­¤æ¨éå°ç¸åºè®¢éèçææåç´ é½åå¸å¨åä¸ä¸ªçº¿ç¨ä¸ã</p>
</div>
<div class="paragraph">
<p>You can use single-threaded schedulers to ensure thread affinity for different stages in the
chain or for different subscribers.</p>
</div>
<div class="paragraph">
<p>æ¨å¯ä»¥ä½¿ç¨åçº¿ç¨è°åº¦ç¨åºæ¥ç¡®ä¿é¾ä¸­ä¸åé¶æ®µæä¸åè®¢éèççº¿ç¨äº²ååã</p>
</div>
</div>
<div class="sect2">
<h3 id="faq.mdc"><a class="anchor" href="#faq.mdc"></a>B.6. What Is a Good Pattern for Contextual Logging? (MDC)</h3>
<div class="paragraph">
<p>Most logging frameworks allow contextual logging, letting users store variables that are reflected in the logging pattern, generally by way of a <code>Map</code> called the MDC ("Mapped Diagnostic Context").
This is one of the most recurring use of <code>ThreadLocal</code> in Java, and as a consequence this pattern assumes that the code being logged is tied in a one-to-one relationship with a <code>Thread</code>.</p>
</div>
<div class="paragraph">
<p>å¤§å¤æ°æ¥å¿æ¡æ¶åè®¸ä¸ä¸ææ¥å¿è®°å½ï¼åè®¸ç¨æ·å­å¨æ¥å¿æ¨¡å¼ä¸­åæ çåéï¼éå¸¸æ¯éè¿åä¸ºMDCçMapï¼âMapped Diagnostic Contextâï¼ã
è¿æ¯Javaä¸­æç»å¸¸ä½¿ç¨ThreadLocalçæ¹æ³ä¹ä¸ï¼å æ­¤ï¼è¿ç§æ¨¡å¼åè®¾æ­£å¨è®°å½çä»£ç ä¸Threadè¿è¡ä¸å¯¹ä¸çå³ç³»ç»å®ã</p>
</div>
<div class="paragraph">
<p>That might have been a safe assumption to make before Java 8, but with the advent of functional programming elements in the Java language things have changed a bit&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>å¨Java8ä¹åï¼è¿å¯è½æ¯ä¸ä¸ªå®å¨çåè®¾ï¼ä½æ¯éçJavaè¯­è¨ä¸­å½æ°ç¼ç¨åç´ çåºç°ï¼äºæåçäºä¸äºåå&#8230;&#8203;âã</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take the example of a API that was imperative and used the template method pattern, then switches to a more functional style.
With the template method pattern, inheritance was at play. Now in its more functional approach, higher order functions are passed to define the "steps" of the algorithm.
Things are now more declarative than imperative, and that frees the library to make decisions about where each step should run.
For instance, knowing which steps of the underlying algorithm can be parallelized, the library can use an <code>ExecutorService</code> to execute some of the steps in parallel.</p>
</div>
<div class="paragraph">
<p>è®©æä»¬ä¸¾ä¸ä¸ªAPIçä¾å­ï¼å®æ¯å¿éçï¼å¹¶ä½¿ç¨æ¨¡æ¿æ¹æ³æ¨¡å¼ï¼ç¶ååæ¢å°ä¸ä¸ªæ´å®ç¨çæ ·å¼ã
ä½¿ç¨æ¨¡æ¿æ¹æ³æ¨¡å¼ï¼ç»§æ¿æ­£å¨åæ¥ä½ç¨ã ç°å¨ï¼å¨å¶æ´å¤çåè½æ¹æ³ä¸­ï¼ä¼ éé«é¶å½æ°æ¥å®ä¹ç®æ³çâæ­¥éª¤âã
äºæç°å¨æ´å¤çæ¯éè¿°æ§çèä¸æ¯å½ä»¤æ§çï¼è¿ä½¿å¾åºå¯ä»¥èªç±å°å³å®æ¯ä¸ªæ­¥éª¤åºè¯¥è¿è¡å¨åªéã
ä¾å¦ï¼ç¥éåºå±ç®æ³çåªäºæ­¥éª¤å¯ä»¥å¹¶è¡åï¼åºå¯ä»¥ä½¿ç¨`ExecutorService`å¹¶è¡æ§è¡ä¸äºæ­¥éª¤ã</p>
</div>
<div class="paragraph">
<p>One concrete example of such a functional API is the <code>Stream</code> API introduced in Java 8 and its <code>parallel()</code> flavor.
Logging with a MDC in a parallel <code>Stream</code> is not a free lunch: one need to ensure the MDC is captured and reapplied in each step.</p>
</div>
<div class="paragraph">
<p>è¿ç§åè½APIçä¸ä¸ªå·ä½ä¾å­æ¯Java8ä¸­å¼å¥çStreamAPIå`parallel()`é£å³ã
å¨å¹³è¡ç`Stream`ä¸­éè¿MDCè®°å½ä¿¡æ¯å¹¶ä¸æ¯åè´¹åé¤ï¼éè¦ç¡®ä¿å¨æ¯ä¸ªæ­¥éª¤ä¸­æè·åéæ°åºç¨ MDCã</p>
</div>
<div class="paragraph">
<p>The functional style enables such optimizations, because each step is thread-agnostic and referentially transparent, but it can break the MDC assumption of a single <code>Thread</code>.
The most idiomatic way of ensuring any kind of contextual information is accessible to all stages would be to pass that context around through the composition chain.
During the development of Reactor we encountered the same general class of problem, and we wanted to avoid this very hands-down and explicit approach.
This is why the <code>Context</code> was introduced: it propagates through the execution chain as long as <code>Flux</code> and <code>Mono</code> are used as the return value, by letting stages (operators) peek at the <code>Context</code> of their downstream stage.
So instead of using <code>ThreadLocal</code>, Reactor offers this map-like object that is tied to a <code>Subscription</code> and not a <code>Thread</code>.</p>
</div>
<div class="paragraph">
<p>åè½æ ·å¼åè®¸è¿æ ·çä¼åï¼å ä¸ºæ¯ä¸ªæ­¥éª¤é½æ¯çº¿ç¨ä¸å¯ç¥çååºåéæçï¼ä½å®å¯ä»¥æç ´åä¸ªçº¿ç¨çMDCåè®¾ã
ç¡®ä¿ææé¶æ®µé½è½è·å¾ä»»ä½ç±»åçä¸ä¸æä¿¡æ¯çææ¯ç¨çæ¹æ³æ¯éè¿ç»åé¾ä¼ éè¿ç§ä¸ä¸æã
å¨Reactorçåå±è¿ç¨ä¸­ï¼æä»¬éå°äºåæ ·çä¸è¬é®é¢ï¼æä»¬å¸æé¿åè¿ç§éå¸¸ç´æ¥åæç¡®çæ¹æ³ã
è¿å°±æ¯ä¸ºä»ä¹å¼å¥`Context`ï¼å®éè¿æ§è¡é¾ä¼ æ­ï¼åªè¦FluxåMonoè¢«ç¨ä½è¿åå¼ï¼å°±å¯ä»¥è®©é¶æ®µï¼è¿ç®ç¬¦ï¼çª¥è§å¶ä¸æ¸¸é¶æ®µçä¸ä¸æã
å æ­¤ï¼`Reactor`æ²¡æä½¿ç¨ThreadLocalï¼èæ¯æä¾äºè¿ä¸ªä¸è®¢éèä¸æ¯çº¿ç¨ç»å®çç±»ä¼¼æ å°çå¯¹è±¡ã</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve established that MDC "just working" is not the best assumption to make in a declarative API, how can we perform contextualized log statements in relation to events in a Reactive Stream (<code>onNext</code>, <code>onError</code>, and <code>onComplete</code>)?</p>
</div>
<div class="paragraph">
<p>æ¢ç¶æä»¬å·²ç»ç¡®å®MDCâåªæ¯è½ç¨âä¸æ¯å¨å£°ææ§APIä¸­ååºçæä½³ä½¿ç¨ï¼é£ä¹æä»¬å¦ä½æè½å¯¹Reactiveä¸­çäºä»¶æ§è¡ä¸ä¸æåçæ¥å¿å£°æ (<code>onNext</code>, <code>onError</code>, and <code>onComplete</code>)ï¼</p>
</div>
<div class="paragraph">
<p>This entry of the FAQ offers a possible intermediate solution when one wants to log in relation to these signals in a straightforward and explicit manner.
Make sure to read the <a href="#context">Adding a Context to a Reactive Sequence</a> section beforehand, and especially how a write must happen towards the bottom of the operator chain for operators above it to see it.</p>
</div>
<div class="paragraph">
<p>å½ä¸ä¸ªäººå¸æä»¥ç´æ¥åæç¡®çæ¹å¼è®°å½è¿äºä¿¡å·æ¶ï¼å¸¸è§é®é¢çè¿ä¸æ¡ç®æä¾äºä¸ä¸ªå¯è½çä¸­é´è§£å³æ¹æ¡ã
ç¡®ä¿äºåéè¯»æ·»å ä¸ä¸æå°ååºæ§åºåé¨åï¼ç¹å«æ¯åå¿é¡»å¦ä½åçå¨æä½ç¬¦é¾çåºé¨ï¼ä»¥ä¾¿ä¸é¢çæä½ç¬¦çå°å®ã</p>
</div>
<div class="paragraph">
<p>To get contextual information from the <code>Context</code> to the MDC, the simplest way is to wrap logging statements in a <code>doOnEach</code> operator with a little bit of boilerplate code.
This boilerplate depends on both the logging framework/abstraction of your choice and the information you want to put in the MDC, so it has to be in your codebase.</p>
</div>
<div class="paragraph">
<p>è¦ä»ä¸ä¸æä¸­è·åä¸ä¸ä¿¡æ¯å°MDCï¼æç®åçæ¹æ³æ¯ç¨ä¸ç¹ç¹æ ·æ¿ä»£ç å°æ¥å¿è¯­å¥åè£å¨æ¯ä¸ªæä½ç¬¦ä¸ã
è¿ä¸ªæ ·æ¿åå³äºæ¨éæ©çæ¥å¿æ¡æ¶/æ½è±¡ä»¥åæ¨æ³å¨MDCä¸­æ¾ç½®çä¿¡æ¯ï¼å æ­¤å®å¿é¡»ä½äºä»£ç åºä¸­ã</p>
</div>
<div class="paragraph">
<p>The following is an example of such a helper function around a single MDC variable and focused on logging <code>onNext</code> events, using Java 9 enhanced <code>Optional</code> API:</p>
</div>
<div class="paragraph">
<p>ä¸é¢æ¯å´ç»åä¸ªMDCåéçè¿ç§è¾å©å½æ°çç¤ºä¾ï¼éç¹æ¯ä½¿ç¨Java9å¢å¼ºçå¯éçAPIè®°å½ <code>onNext</code> äºä»¶ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static &lt;T&gt; Consumer&lt;Signal&lt;T&gt;&gt; logOnNext(Consumer&lt;T&gt; logStatement) {
	return signal -&gt; {
		if (!signal.isOnNext()) return; <i class="conum" data-value="1"></i><b>(1)</b>
		Optional&lt;String&gt; toPutInMdc = signal.getContext().getOrEmpty("CONTEXT_KEY"); <i class="conum" data-value="2"></i><b>(2)</b>

		toPutInMdc.ifPresentOrElse(tpim -&gt; {
			try (MDC.MDCCloseable cMdc = MDC.putCloseable("MDC_KEY", tpim)) { <i class="conum" data-value="3"></i><b>(3)</b>
				logStatement.accept(signal.get()); <i class="conum" data-value="4"></i><b>(4)</b>
			}
		},
		() -&gt; logStatement.accept(signal.get())); <i class="conum" data-value="5"></i><b>(5)</b>
	};
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>doOnEachä¿¡å·åæ¬onCompleteåonErrorãå¨æ­¤ç¤ºä¾ä¸­ï¼æä»¬ä»å¯¹æ¥å¿è®°å½æå´è¶£`onNext`</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>æä»¬å°ä»åReactorä¸ä¸æä¸­æåä¸ä¸ªæè¶£çå¼(åè§<a href="#context.api">The <code>Context</code> API</a>é¨å)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>å¨æ¬ä¾ä¸­ï¼æä»¬ä½¿ç¨SLF4J2ä¸­çMDCCloseï¼åè®¸å¨æ¥å¿è¯­å¥æ§è¡åä½¿ç¨try-withresourceè¯­æ³èªå¨æ¸çMDCã</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>æ­£ç¡®çæ¥å¿å£°æç±è°ç¨è Consumer&lt;T&gt;ï¼ä¸ä¸ä¸ªå¼çæ¶è´¹èï¼æä¾</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>å¦æé¢æçé®æ²¡æè®¾ç½®å¨ä¸ä¸æä¸­ï¼æä»¬ä½¿ç¨æ¿ä»£è·¯å¾ï¼å¶ä¸­å¨MDCä¸­æ²¡æä»»ä½åå®¹</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Using this boilerplate code ensures that we are good citizens with the MDC: we set a key right before we execute a logging statement and remove it immediately after.
There is no risk of polluting the MDC for subsequent logging statements.</p>
</div>
<div class="paragraph">
<p>ä½¿ç¨è¿ä¸ªæ ·æ¿ä»£ç å¯ä»¥ç¡®ä¿æä»¬æ¯MDCçå¥½å¬æ°ï¼æä»¬å¨æ§è¡æ¥å¿è®°å½è¯­å¥ä¹åè®¾ç½®äºä¸ä¸ªé®ï¼å¹¶å¨ä¹åç«å³å é¤å®ã
æ²¡ææ±¡æMDCçé£é©ï¼ä»¥ä¾¿éåçæ¥å¿è®°å½ã</p>
</div>
<div class="paragraph">
<p>Of course, this is a suggestion. You might be interested in extracting multiple values from the <code>Context</code> or in logging things in case of <code>onError</code>.
You might want to create additional helper methods for these cases or craft a single method that makes use of additional lambdas to cover more ground.</p>
</div>
<div class="paragraph">
<p>å½ç¶ï¼è¿æ¯ä¸ªå»ºè®®ã æ¨å¯è½æå´è¶£ä»ä¸ä¸æä¸­æåå¤ä¸ªå¼ï¼æèå¨åçéè¯¯çæåµä¸è®°å½äºç©ã
æ¨å¯è½å¸æä¸ºè¿äºæ¡ä¾åå»ºé¢å¤çè¾å©æ¹æ³ï¼æèåå»ºä¸ä¸ªä½¿ç¨é¢å¤lambdasè¦çæ´å¤èå´çåä¸æ¹æ³ã</p>
</div>
<div class="paragraph">
<p>In any case, the usage of the preceding helper method could look like the following reactive web controller:</p>
</div>
<div class="paragraph">
<p>å¨ä»»ä½æåµä¸ï¼åé¢çhelperæ¹æ³çä½¿ç¨å¯è½çèµ·æ¥åä»¥ä¸reactive web æ§å¶å¨ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@GetMapping("/byPrice")
public Flux&lt;Restaurant&gt; byPrice(@RequestParam Double maxPrice, @RequestHeader(required = false, name = "X-UserId") String userId) {
	String apiId = userId == null ? "" : userId; <i class="conum" data-value="1"></i><b>(1)</b>

	return restaurantService.byPrice(maxPrice))
			   .doOnEach(logOnNext(r -&gt; LOG.debug("found restaurant {} for ${}", <i class="conum" data-value="2"></i><b>(2)</b>
					r.getName(), r.getPricePerPerson())))
			   .subscriberContext(Context.of("CONTEXT_KEY", apiId)); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>æä»¬éè¦ä»è¯·æ±å¤´è·åä¸ä¸æä¿¡æ¯ï¼ä»¥ä¾¿å°å¶æ¾å¥ä¸ä¸æä¸­</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>å¨è¿éï¼æä»¬åºç¨æä»¬çå©ææ¹æ³å°Fluxï¼ä½¿ç¨doOnEachã è®°ä½ï¼æä½ç¬¦çå°å®ä»¬ä¸é¢å®ä¹çä¸ä¸æå¼ã</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>æä»¬ä½¿ç¨æéçé®CONTEXT_KEYå°å¼ä»æ é¢ åå¥ä¸ä¸æã</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In this configuration, the <code>restaurantService</code> can emit its data on a shared thread, yet the logs will still reference the correct <code>X-UserId</code> for each request.</p>
</div>
<div class="paragraph">
<p>å¨æ­¤éç½®ä¸­ï¼<code>restaurantService`å¯ä»¥å¨å±äº«çº¿ç¨ä¸ååºå¶æ°æ®ï¼ä½æ¯æ¥å¿ä»ç¶ä¼ä¸ºæ¯ä¸ªè¯·æ±å¼ç¨æ­£ç¡®ç`X-UserID</code>ã</p>
</div>
<div class="paragraph">
<p>For completeness, we can also see what an error-logging helper could look like:</p>
</div>
<div class="paragraph">
<p>ä¸ºäºå®æ´èµ·è§ï¼æä»¬è¿å¯ä»¥çå°éè¯¯è®°å½å©æçå¤è§ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static Consumer&lt;Signal&lt;?&gt;&gt; logOnError(Consumer&lt;Throwable&gt; errorLogStatement) {
	return signal -&gt; {
		if (!signal.isOnError()) return;
		Optional&lt;String&gt; toPutInMdc = signal.getContext().getOrEmpty("CONTEXT_KEY");

		toPutInMdc.ifPresentOrElse(tpim -&gt; {
			try (MDC.MDCCloseable cMdc = MDC.putCloseable("MDC_KEY", tpim)) {
				errorLogStatement.accept(signal.getThrowable());
			}
		},
		() -&gt; errorLogStatement.accept(signal.getThrowable()));
	};
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Nothing much has changed, except for the fact that we check that the <code>Signal</code> is effectively an <code>onError</code>, and that we provide said error (a <code>Throwable</code>) to the log statement lambda.</p>
</div>
<div class="paragraph">
<p>æ²¡æä»ä¹ååï¼é¤äºæä»¬æ£æ¥ä¿¡å·å®éä¸æ¯ä¸ä¸ª`onError`ï¼ä»¥åæä»¬åæ¥å¿å£°æçlambdaæä¾æè¯´çéè¯¯ï¼ä¸ä¸ªå¯æåºçï¼ã</p>
</div>
<div class="paragraph">
<p>Applying this helper in the controller is very similar to what we&#8217;ve done before:</p>
</div>
<div class="paragraph">
<p>å¨æ§å¶å¨ä¸­åºç¨è¿ä¸ªå©æä¸æä»¬ä»¥åæåçéå¸¸ç¸ä¼¼ï¼</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@GetMapping("/byPrice")
public Flux&lt;Restaurant&gt; byPrice(@RequestParam Double maxPrice, @RequestHeader(required = false, name = "X-UserId") String userId) {
	String apiId = userId == null ? "" : userId;

	return restaurantService.byPrice(maxPrice))
			   .doOnEach(logOnNext(v -&gt; LOG.info("found restaurant {}", v))
			   .doOnEach(logOnError(e -&gt; LOG.error("error when searching restaurants", e)) <i class="conum" data-value="1"></i><b>(1)</b>
			   .subscriberContext(Context.of("CONTEXT_KEY", apiId));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In case the <code>restaurantService</code> emits an error, it will be logged with MDC context here å¦æ`restaurantService`ååºéè¯¯ï¼å®å°å¨è¿éä½¿ç¨MDCä¸ä¸æä¸­è®°å½</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/faq.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#faq">FAQ, Best Practices, and "How do I&#8230;&#8203;?"</a>"</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactor-extra"><a class="anchor" href="#reactor-extra"></a>Appendix C: Reactor-Extra</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>reactor-extra</code> artifact contains additional operators and utilities that are for
users of <code>reactor-core</code> with advanced needs.</p>
</div>
<div class="paragraph">
<p>As this is a separate artifact, you need to explicitly add it to your build. The following
example shows how to do so in Gradle:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
     compile 'io.projectreactor:reactor-core'
     compile 'io.projectreactor.addons:reactor-extra' <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add the reactor extra artifact in addition to core. See <a href="#getting">Getting Reactor</a> for details
about why you do not need to specify a version if you use the BOM, usage in Maven, and other details.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="extra-tuples"><a class="anchor" href="#extra-tuples"></a>C.1. <code>TupleUtils</code> and Functional Interfaces</h3>
<div class="paragraph">
<p>The <code>reactor.function</code> package contains functional interfaces that complement the Java 8
<code>Function</code>, <code>Predicate</code>, and <code>Consumer</code> interfaces, for three to eight values.</p>
</div>
<div class="paragraph">
<p><code>TupleUtils</code> offers static methods that act as a bridge between lambdas of these functional
interfaces to a similar interface on the corresponding <code>Tuple</code>.</p>
</div>
<div class="paragraph">
<p>This lets you easily work with independent parts of any <code>Tuple</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.map(tuple -&gt; {
  String firstName = tuple.getT1();
  String lastName = tuple.getT2();
  String address = tuple.getT3();

  return new Customer(firstName, lastName, address);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can rewrite the preceding example as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.map(TupleUtils.function(Customer::new)); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>(as <code>Customer</code> constructor conforms to <code>Consumer3</code> functional interface signature)</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="extra-math"><a class="anchor" href="#extra-math"></a>C.2. Math Operators With <code>MathFlux</code></h3>
<div class="paragraph">
<p>The <code>reactor.math</code> package contains a <code>MathFlux</code> specialized version of <code>Flux</code> that offers
mathematical operators, including <code>max</code>, <code>min</code>, <code>sumInt</code>, <code>averageDouble</code>, and others.</p>
</div>
</div>
<div class="sect2">
<h3 id="extra-repeat-retry"><a class="anchor" href="#extra-repeat-retry"></a>C.3. Repeat and Retry Utilities</h3>
<div class="paragraph">
<p>The <code>reactor.retry</code> package contains utilities to help in writing <code>Flux#repeatWhen</code> and
<code>Flux#retryWhen</code> functions. The entry points are factory methods in the <code>Repeat</code>
and <code>Retry</code> interfaces, respectively.</p>
</div>
<div class="paragraph">
<p>You can use both interfaces as a mutative builder, and they implement the correct
<code>Function</code> signature to be used in their counterpart operators.</p>
</div>
<div class="paragraph">
<p>Since 3.2.0, one of the most advanced retry strategies offered by these utilities is
also part of the <code>reactor-core</code> main artifact directly. Exponential backoff is
available as the <code>Flux#retryBackoff</code> operator.</p>
</div>
</div>
<div class="sect2">
<h3 id="extra-schedulers"><a class="anchor" href="#extra-schedulers"></a>C.4. Schedulers</h3>
<div class="paragraph">
<p>Reactor-extra comes with several specialized schedulers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ForkJoinPoolScheduler</code> (in the <code>reactor.scheduler.forkjoin</code> package): Uses the Java <code>ForkJoinPool</code> to execute tasks.</p>
</li>
<li>
<p><code>SwingScheduler</code> (in the <code>reactor.swing</code> package): Runs tasks in the Swing UI event loop thread, the <code>EDT</code>.</p>
</li>
<li>
<p><code>SwtScheduler</code> (in the <code>reactor.swing</code> package): Runs tasks in the SWT UI event loop thread.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/reactor/reactor-core/edit/master/docs/asciidoc/apdx-reactorExtra.adoc" class="fa fa-edit" title="Suggest an edit to the above section via github" target="_blank" rel="noopener">Suggest Edit</a>
to "<a href="#reactor-extra">Reactor-Extra</a>"</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-02-23 13:48:49 +0800
</div>
</div>
</body>
</html>